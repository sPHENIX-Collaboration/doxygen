<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=9" />
<title>Analysis Software: coresoftware/blob/master/calibrations/tpc/generator/AnnularFieldSim.cc Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script> <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script> 
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-155388685-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-155388685-2');
</script>
</head>
<body>
	<div id="top">
		<!-- do not remove this div, it is closed by doxygen! -->
		<div id="titlearea">
			<table cellspacing="0" cellpadding="0">
				<tbody>
					<tr style="height: 56px;">
						<td id="projectlogo"><a href="https://wiki.bnl.gov/sPHENIX/index.php/Main_Page"><img
								alt="Logo" src="../../sphenix.png" /></a></td>
						<td style="padding-left: 0.5em;">
							<div id="projectname">
								Analysis Software
							</div> 
							<div id="projectbrief">
								Documentation for <a href="https://wiki.bnl.gov/sPHENIX/index.php/Main_Page">sPHENIX</a> simulation software
							</div> 
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Home&#160;page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
      <li><a href="../../usergroup0.html"><span>External&#160;Links</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dc/d90/AnnularFieldSim_8cc_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">AnnularFieldSim.cc</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../dc/d90/AnnularFieldSim_8cc.html">Go to the documentation of this file.</a> Or view <a target="top" href="https://github.com/sPHENIX-Collaboration/coresoftware/blob/master/calibrations/tpc/generator/AnnularFieldSim.cc">the newest version in sPHENIX GitHub for file AnnularFieldSim.cc</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../dd/d5b/AnnularFieldSim_8h.html">AnnularFieldSim.h</a>&quot;</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../da/d79/AnalyticFieldModel_8h.html">AnalyticFieldModel.h</a>&quot;</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d8/d43/ChargeMapReader_8h.html">ChargeMapReader.h</a>&quot;</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d5/d3e/MultiArray_8h.html">MultiArray.h</a>&quot;</span>  <span class="comment">//for TH3 alternative</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d4/d25/Rossegger_8h.html">Rossegger.h</a>&quot;</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &lt;TCanvas.h&gt;</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &lt;TFile.h&gt;</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &lt;TH1.h&gt;</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &lt;TH2.h&gt;</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &lt;TH3.h&gt;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &lt;TLatex.h&gt;</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &lt;TPad.h&gt;</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &lt;TString.h&gt;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &lt;TStyle.h&gt;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &lt;TTree.h&gt;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &lt;TVector3.h&gt;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &lt;boost/format.hpp&gt;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &lt;cassert&gt;</span>  <span class="comment">// for assert</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &lt;cmath&gt;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &lt;cstdio&gt;</span>   <span class="comment">// for printf, sprintf</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;cstdlib&gt;</span>  <span class="comment">// for abs</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div>
<div class="line"><a name="l00028"></a><span class="lineno"><a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">   28</a></span>&#160;<span class="preprocessor">#define ALMOST_ZERO 0.00001</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00030"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#aee9c260f8d4fb96ca8f91e9dfbee868d">   30</a></span>&#160;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a1345fb27558efc4651d8fa5f4ac36db9">AnnularFieldSim::AnnularFieldSim</a>(<span class="keywordtype">float</span> in_innerRadius, <span class="keywordtype">float</span> in_outerRadius, <span class="keywordtype">float</span> in_outerZ,</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;                                 <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <span class="keywordtype">int</span> roi_r0, <span class="keywordtype">int</span> roi_r1, <span class="keywordtype">int</span> <span class="comment">/*in_rLowSpacing*/</span>, <span class="keywordtype">int</span> <span class="comment">/*in_rHighSize*/</span>,</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;                                 <span class="keywordtype">int</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">int</span> roi_phi0, <span class="keywordtype">int</span> roi_phi1, <span class="keywordtype">int</span> <span class="comment">/*in_phiLowSpacing*/</span>, <span class="keywordtype">int</span> <span class="comment">/*in_phiHighSize*/</span>,</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;                                 <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>, <span class="keywordtype">int</span> roi_z0, <span class="keywordtype">int</span> roi_z1, <span class="keywordtype">int</span> <span class="comment">/*in_zLowSpacing*/</span>, <span class="keywordtype">int</span> <span class="comment">/*in_zHighSize*/</span>,</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;                                 <span class="keywordtype">float</span> vdr, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912">LookupCase</a> in_lookupCase, <a class="code" href="../../de/d64/classAnnularFieldSim.html#acb7667cb9f4bba130299af053fdc51f0">ChargeCase</a> in_chargeCase)</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;{</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;  <span class="comment">// check well-ordering:</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  <span class="keywordflow">if</span> (roi_r0 &gt;= r || roi_r1 &gt; r || roi_r0 &gt;= roi_r1)</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  {</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 2);</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  }</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;  <span class="keywordflow">if</span> (roi_phi0 &gt;= phi || roi_phi1 &gt; phi || roi_phi0 &gt;= roi_phi1)</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;  {</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;phi roi is out of range or spans the wrap-around.  Please spare me that math.\n&quot;</span>);</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 2);</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  }</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  <span class="keywordflow">if</span> (roi_z0 &gt;= z || roi_z1 &gt; z || roi_z0 &gt;= roi_z1)</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  {</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 2);</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  }</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a> = <span class="keyword">false</span>;  <span class="comment">// we never have a twin to start with.</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad37e2804a3e394e5617951c6bb444f84">green_shift</a> = 0;  <span class="comment">// and so we don&#39;t shift our greens functions unless told to.</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::AnnularFieldSim with (%dx%dx%d) grid\n&quot;</span>, r, phi, z);</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;units m=%1.2E, cm=%1.2E, mm=%1.2E, um=%1.2E,\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#af0f7dd48bf037176a3148a5183f67150">m</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a25cf8a456e60f15aa09e467c7c73e6b2">mm</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2a4fbc3d65ef9a797ecefaa35c74b074">um</a>);</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;units s=%1.2E, us=%1.2E, ns=%1.2E,\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a50f6e78f93f158e6ab693cc119250cc6">s</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4e5c8f9814a8b08c8d30cfe74b1f1ab6">us</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a732d3249f679913d83aada91efb092bd">ns</a>);</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;units C=%1.2E, nC=%1.2E, fC=%1.2E, \n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3122217cae55b22ab3c6b157cd96b695">C</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a51064bace549d13506a470e8da8b7915">nC</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9d6b07e6c9851ded2f4cbeb4420a3566">fC</a>);</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;units Tesla=%1.2E, kGauss=%1.2E\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad3398b737ec329b9f9dca579bf123bb0">Tesla</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a50493c2c71d69d44ed9ae9b29d8dbb75">kGauss</a>);</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  <span class="comment">// debug defaults:</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac15a558ac9d5c8252702c3b5ddd76c9b">debug_printActionEveryN</a> = -1;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#afe1556a1293f9395a1aca920cd28065e">debug_printCounter</a> = 0;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a> = 5;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  <span class="comment">// internal states used for the debug flag</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  <span class="comment">// goes with: if(debugFlag()) printf(&quot;%d: blah\n&quot;,__LINE__);</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  <span class="comment">// load constants of motion, dimensions, etc:</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a517b31827f7563eeb6c9c54182b5655e">Enominal</a> = 400 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#add22fc45f5d33e13cfc422f3e8c8c997">V</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>;  <span class="comment">// v/cm</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace424fdd41ee18b156ca4356cdfa736e">Bnominal</a> = 1.4 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad3398b737ec329b9f9dca579bf123bb0">Tesla</a>;   <span class="comment">// Tesla</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae83b1b7d69b7029daf8a9ed58314e5c1">vdrift</a> = vdr * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a50f6e78f93f158e6ab693cc119250cc6">s</a>;    <span class="comment">// cm/s</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1062463e699885ded88f6c1a3a07a533">langevin_T1</a> = 1.0;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a217aae0018d7122b91d6cc9b5709c61b">langevin_T2</a> = 1.0;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae94da38b14049881cc6c9e36b84a05d2">omegatau_nominal</a> = -10 * (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ace424fdd41ee18b156ca4356cdfa736e">Bnominal</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a50493c2c71d69d44ed9ae9b29d8dbb75">kGauss</a>) * (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ae83b1b7d69b7029daf8a9ed58314e5c1">vdrift</a> / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4e5c8f9814a8b08c8d30cfe74b1f1ab6">us</a>)) / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a517b31827f7563eeb6c9c54182b5655e">Enominal</a> / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#add22fc45f5d33e13cfc422f3e8c8c997">V</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>));  <span class="comment">// to match to the familiar formula</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a> = in_innerRadius * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a5b910d33cbf61449e7b78071d2403ec2">rmax</a> = in_outerRadius * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a> = 0;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a> = in_outerZ * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a> &gt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a>)</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  {</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a> = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a>;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a> = 0;  <span class="comment">// for now, we continue to assume one end of the TPC is at z=0.</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  }</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>.SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <span class="comment">// define the size of the volume:</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa47cb66417a01a48e56d6b02789264f6">dim</a>.SetXYZ(1, 0, 0);</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa47cb66417a01a48e56d6b02789264f6">dim</a>.SetPerp(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a5b910d33cbf61449e7b78071d2403ec2">rmax</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>);</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa47cb66417a01a48e56d6b02789264f6">dim</a>.SetPhi(0);</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad599b2a5ac68da60609b8892b8f82032">phispan</a> = 2 * M_PI;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa47cb66417a01a48e56d6b02789264f6">dim</a>.SetZ(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>);</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <span class="comment">// set the green&#39;s functions model:</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  <span class="comment">// UseFreeSpaceGreens();</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <span class="comment">// blah</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a261ec743956234d0e225c1e12e701a78">green</a> = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="comment">// load parameters of the whole-volume tiling</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a> = <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a> = <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a> = <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>;  <span class="comment">// number of fundamental bins (f-bins) in each direction</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::AnnularFieldSim set variables nr=%d, nphi=%d, nz=%d\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>);</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  <span class="comment">// and set the default truncation distance:</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac8d43e1809336ebb1b7b3f97e04c17cf">truncation_length</a> = -1;  <span class="comment">// anything &lt;1 and it won&#39;t truncate.</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  <span class="comment">// calculate the size of an f-bin:</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  <span class="comment">// note that you have to set a non-zero value to start or perp won&#39;t update.</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.SetXYZ(1, 0, 0);</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.SetPerp(<a class="code" href="../../de/d64/classAnnularFieldSim.html#aa47cb66417a01a48e56d6b02789264f6">dim</a>.Perp() / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>);</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.SetPhi(<a class="code" href="../../de/d64/classAnnularFieldSim.html#ad599b2a5ac68da60609b8892b8f82032">phispan</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>);</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.SetZ(<a class="code" href="../../de/d64/classAnnularFieldSim.html#aa47cb66417a01a48e56d6b02789264f6">dim</a>.Z() / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>);</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;f-bin size:  r=%f,phi=%f, z=%f, wanted %f,%f\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a5b910d33cbf61449e7b78071d2403ec2">rmax</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>) / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ad599b2a5ac68da60609b8892b8f82032">phispan</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>), (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>) / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>);</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  <span class="comment">// create an array to store the charge in each f-bin</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <span class="comment">//  q = new MultiArray&lt;double&gt;(nr, nphi, nz);</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  <span class="comment">// q-&gt;SetAll(0);</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a002f26208e71c2e801523bd82a015f9e">q</a> = <span class="keyword">new</span> <a class="code" href="../../d4/d14/classChargeMapReader.html">ChargeMapReader</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a5b910d33cbf61449e7b78071d2403ec2">rmax</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, 0, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad599b2a5ac68da60609b8892b8f82032">phispan</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a>);</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  sprintf(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a7eb439bec285eceabc0470598486ea7b">chargestring</a>, <span class="stringliteral">&quot;No spacecharge present.&quot;</span>);</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  <span class="comment">// load parameters of our region of interest</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a> = roi_r0;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a> = roi_phi0;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a> = roi_z0;  <span class="comment">// lower edge of our region of interest, measured in f-bins</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a> = roi_r1;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a> = roi_phi1;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a> = roi_z1;  <span class="comment">// exlcuded upper edge of our region of interest, measured in f-bins</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::AnnularFieldSim set roi variables rmin=%d phimin=%d zmin=%d rmax=%d phimax=%d zmax=%d\n&quot;</span>,</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;         <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a>);</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  <span class="comment">// calculate the dimensions, in f-bins in our region of interest</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a> = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9038e19b32063a3c67c00853cd325b8">nphi_roi</a> = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a> = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::AnnularFieldSim calc&#39;d roi variables nr=%d nphi=%d nz=%d\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9038e19b32063a3c67c00853cd325b8">nphi_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>);</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  <span class="comment">// create an array to hold the SC-induced electric field in the roi with the specified dimensions</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aeeaac1b3cbe466eac8fec86af99172d2">Efield</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9038e19b32063a3c67c00853cd325b8">nphi_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>);</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#aeeaac1b3cbe466eac8fec86af99172d2">Efield</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a724a354269ec724f79ab24f2c9210c28">Length</a>(); <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  {</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aeeaac1b3cbe466eac8fec86af99172d2">Efield</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  }</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  <span class="comment">// and to hold the external electric fieldmap over the region of interest</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aedd910db5278318b852bfc65ca976cf6">Eexternal</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9038e19b32063a3c67c00853cd325b8">nphi_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>);</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#aedd910db5278318b852bfc65ca976cf6">Eexternal</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a724a354269ec724f79ab24f2c9210c28">Length</a>(); <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  {</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aedd910db5278318b852bfc65ca976cf6">Eexternal</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  }</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <span class="comment">// ditto the external magnetic fieldmap</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9038e19b32063a3c67c00853cd325b8">nphi_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>);</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a724a354269ec724f79ab24f2c9210c28">Length</a>(); <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  {</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  }</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="comment">// handle the lookup table construction:</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> = in_lookupCase;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa182d2d11e0e8216fa7ebb1dcdd4a68c">chargeCase</a> = in_chargeCase;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#aa182d2d11e0e8216fa7ebb1dcdd4a68c">chargeCase</a> == ChargeCase::NoSpacecharge)</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  {</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> = LookupCase::NoLookup;  <span class="comment">// don&#39;t build a lookup model if there&#39;s no charge.  It just wastes time.</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  }</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912ac20b14fd6f49ea685f1efa42313344cf">Full3D</a>)</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  {</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::AnnularFieldSim building Epartial (full3D) with  nr_roi=%d nphi_roi=%d nz_roi=%d  =~%2.2fM TVector3 objects\n&quot;</span>, nr_roi, nphi_roi, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>,</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;           nr_roi * nphi_roi * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a> / (1.0e6));</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a12dd10a36307c5896ef633b5edf6d67d">Epartial</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9038e19b32063a3c67c00853cd325b8">nphi_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>);</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a12dd10a36307c5896ef633b5edf6d67d">Epartial</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a724a354269ec724f79ab24f2c9210c28">Length</a>(); <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    {</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;      <a class="code" href="../../de/d64/classAnnularFieldSim.html#a12dd10a36307c5896ef633b5edf6d67d">Epartial</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    }</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <span class="comment">// and kill the arrays we shouldn&#39;t be using:</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa8a5aed287dd1ad723d2f897c61fc08c">Epartial_highres</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(1);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa8a5aed287dd1ad723d2f897c61fc08c">Epartial_highres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa4cc4892f9e2ca6b8ce07383fb1897f6">Epartial_lowres</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(1);</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa4cc4892f9e2ca6b8ce07383fb1897f6">Epartial_lowres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(1);</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a908de0cdfdcde19201e7c18f1c81db07">q_lowres</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;double&gt;</a>(1);</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    *(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a908de0cdfdcde19201e7c18f1c81db07">q_lowres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)) = 0;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a17ab62844a52175c4b2439b1a6beb78e">q_local</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;double&gt;</a>(1);</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    *(q_local-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)) = 0;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  }</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912ab2ebc633d33ad7912d9290d256ea4819">HybridRes</a>)</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  {</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;lookupCase==HybridRes\n&quot;</span>);</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    <span class="comment">// zero out the other two:</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a12dd10a36307c5896ef633b5edf6d67d">Epartial</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(1);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a12dd10a36307c5896ef633b5edf6d67d">Epartial</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(1);</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  }</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912aa9a7b26da725426bb440409274d09ca5">PhiSlice</a>)</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;  {</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;lookupCase==PhiSlice\n&quot;</span>);</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, 1, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>);</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a724a354269ec724f79ab24f2c9210c28">Length</a>(); <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    {</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;      <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    }</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    <span class="comment">// zero out the other two:</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a12dd10a36307c5896ef633b5edf6d67d">Epartial</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(1);</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a12dd10a36307c5896ef633b5edf6d67d">Epartial</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa8a5aed287dd1ad723d2f897c61fc08c">Epartial_highres</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(1);</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa8a5aed287dd1ad723d2f897c61fc08c">Epartial_highres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa4cc4892f9e2ca6b8ce07383fb1897f6">Epartial_lowres</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(1);</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa4cc4892f9e2ca6b8ce07383fb1897f6">Epartial_lowres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a908de0cdfdcde19201e7c18f1c81db07">q_lowres</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;double&gt;</a>(1);</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    *(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a908de0cdfdcde19201e7c18f1c81db07">q_lowres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)) = 0;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a17ab62844a52175c4b2439b1a6beb78e">q_local</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;double&gt;</a>(1);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    *(q_local-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)) = 0;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;  }</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912afd1a80e709f9494e2123081ec7d33f90">Analytic</a> || <a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912af7578ea26890f328d41266f6216e723a">NoLookup</a>)</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;  {</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;lookupCase==Analytic (or NoLookup)\n&quot;</span>);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="comment">// zero them all out:</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(1);</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a12dd10a36307c5896ef633b5edf6d67d">Epartial</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(1);</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a12dd10a36307c5896ef633b5edf6d67d">Epartial</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa8a5aed287dd1ad723d2f897c61fc08c">Epartial_highres</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(1);</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa8a5aed287dd1ad723d2f897c61fc08c">Epartial_highres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa4cc4892f9e2ca6b8ce07383fb1897f6">Epartial_lowres</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a>(1);</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa4cc4892f9e2ca6b8ce07383fb1897f6">Epartial_lowres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)-&gt;SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a908de0cdfdcde19201e7c18f1c81db07">q_lowres</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;double&gt;</a>(1);</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    *(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a908de0cdfdcde19201e7c18f1c81db07">q_lowres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)) = 0;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a17ab62844a52175c4b2439b1a6beb78e">q_local</a> = <span class="keyword">new</span> <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;double&gt;</a>(1);</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    *(q_local-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(0)) = 0;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  }</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  {</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;Ran into wrong lookupCase logic in constructor.\n&quot;</span>);</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 2);</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;  }</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;}</div>
<div class="line"><a name="l00254"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a50538db65e4974732e5519dc6ec7e950">  254</a></span>&#160;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a1345fb27558efc4651d8fa5f4ac36db9">AnnularFieldSim::AnnularFieldSim</a>(<span class="keywordtype">float</span> in_innerRadius, <span class="keywordtype">float</span> in_outerRadius, <span class="keywordtype">float</span> in_outerZ,</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                                 <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <span class="keywordtype">int</span> roi_r0, <span class="keywordtype">int</span> roi_r1, <span class="keywordtype">int</span> in_rLowSpacing, <span class="keywordtype">int</span> in_rHighSize,</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                                 <span class="keywordtype">int</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">int</span> roi_phi0, <span class="keywordtype">int</span> roi_phi1, <span class="keywordtype">int</span> in_phiLowSpacing, <span class="keywordtype">int</span> in_phiHighSize,</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;                                 <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>, <span class="keywordtype">int</span> roi_z0, <span class="keywordtype">int</span> roi_z1, <span class="keywordtype">int</span> in_zLowSpacing, <span class="keywordtype">int</span> in_zHighSize,</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                                 <span class="keywordtype">float</span> vdr, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912">LookupCase</a> in_lookupCase)</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  : <a class="code" href="../../de/d64/classAnnularFieldSim.html">AnnularFieldSim</a>(in_innerRadius, in_outerRadius, in_outerZ,</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;                    r, roi_r0, roi_r1, in_rLowSpacing, in_rHighSize,</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;                    phi, roi_phi0, roi_phi1, in_phiLowSpacing, in_phiHighSize,</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;                    z, roi_z0, roi_z1, in_zLowSpacing, in_zHighSize,</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;                    vdr, in_lookupCase, <a class="code" href="../../de/d64/classAnnularFieldSim.html#acb7667cb9f4bba130299af053fdc51f0">ChargeCase</a>::FromFile)</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;{</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::OldConstructor building AnnularFieldSim with ChargeCase::FromFile\n&quot;</span>);</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;}</div>
<div class="line"><a name="l00268"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#afbcf2c1d718aa6af8863d641c85545e2">  268</a></span>&#160;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a1345fb27558efc4651d8fa5f4ac36db9">AnnularFieldSim::AnnularFieldSim</a>(<span class="keywordtype">float</span> in_innerRadius, <span class="keywordtype">float</span> in_outerRadius, <span class="keywordtype">float</span> in_outerZ,</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;                                 <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <span class="keywordtype">int</span> roi_r0, <span class="keywordtype">int</span> roi_r1,</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;                                 <span class="keywordtype">int</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">int</span> roi_phi0, <span class="keywordtype">int</span> roi_phi1,</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                                 <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>, <span class="keywordtype">int</span> roi_z0, <span class="keywordtype">int</span> roi_z1,</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;                                 <span class="keywordtype">float</span> vdr, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912">LookupCase</a> in_lookupCase)</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;  : <a class="code" href="../../de/d64/classAnnularFieldSim.html">AnnularFieldSim</a>(in_innerRadius, in_outerRadius, in_outerZ,</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;                    r, roi_r0, roi_r1, 1, 3,</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;                    phi, roi_phi0, roi_phi1, 1, 3,</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;                    z, roi_z0, roi_z1, 1, 3,</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;                    vdr, in_lookupCase, <a class="code" href="../../de/d64/classAnnularFieldSim.html#acb7667cb9f4bba130299af053fdc51f0">ChargeCase</a>::FromFile)</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;{</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;  <span class="comment">// just passing through for the old version again</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;  <span class="comment">// creates a region with high-res size of 3 (enough to definitely cover the eight local l-bins) and low-res spacing of 1, which ought to match the behavior (with a little more overhead) from when there was no highres-lowres distinction</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::OldConstructor building AnnularFieldSim with local_size=1 in all dimensions, lowres_spacing=1 in all dimensions\n&quot;</span>);</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;}</div>
<div class="line"><a name="l00284"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a1345fb27558efc4651d8fa5f4ac36db9">  284</a></span>&#160;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a1345fb27558efc4651d8fa5f4ac36db9">AnnularFieldSim::AnnularFieldSim</a>(<span class="keywordtype">float</span> rin, <span class="keywordtype">float</span> rout, <span class="keywordtype">float</span> <a class="code" href="../../df/d9f/PHG4EPDDetector_8cc.html#ae7ad3d414b6c5188eed2a2427237d90b">dz</a>, <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <span class="keywordtype">int</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>, <span class="keywordtype">float</span> vdr)</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  : <a class="code" href="../../de/d64/classAnnularFieldSim.html">AnnularFieldSim</a>(rin, rout, dz,</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                    r, 0, r,</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                    phi, 0, phi,</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                    z, 0, z,</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                    vdr, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912">LookupCase</a>::PhiSlice)</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;{</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  <span class="comment">// just a pass-through to go from the old style to the more detailed version.</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::OldConstructor building AnnularFieldSim with roi=full in all dimensions\n&quot;</span>);</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;}</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div>
<div class="line"><a name="l00296"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#aba83c13891c05b283eebd23b347a8c2b">  296</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#aba83c13891c05b283eebd23b347a8c2b">AnnularFieldSim::calc_unit_field</a>(TVector3 <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a6c8403cf1f00f8d2746f9fe1da683802">at</a>, TVector3 from)</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;{</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;  <span class="comment">// if(debugFlag()) printf(&quot;%d: AnnularFieldSim::calc_unit_field(at=(r=%f,phi=%f,z=%f))\n&quot;,__LINE__,at.Perp(),at.Phi(),at.Z());</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;  <span class="keywordtype">int</span> r_position;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#af41a4754a596a90505d15a5dcb1868a6">GetRindexAndCheckBounds</a>(at.Perp(), &amp;r_position) != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a>)</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;  {</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;something&#39;s asking for &#39;at&#39; with r=%f, which is index=%d\n&quot;</span>, at.Perp(), r_position);</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 2);</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  }</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;  <span class="comment">// note this is the field due to a fixed point charge in free space.</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  <span class="comment">// if doing cylindrical calcs with different boundary conditions, this needs to change.</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;  <span class="comment">// this could check roi bounds before returning, if things start acting funny.</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;  TVector3 <a class="code" href="../../d6/dee/namespaceckf.html#a46f483ab4625b683ee66025e18a10825">field</a>(0, 0, 0);</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;  <span class="comment">// if we&#39;re more than truncation_length away, don&#39;t bother? rcc food for thought.  right now _length is in bins, so tricky.</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;  <span class="comment">// if the green&#39;s function class is not present use free space:</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a261ec743956234d0e225c1e12e701a78">green</a> == <span class="keyword">nullptr</span>)</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  {</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    TVector3 delr = at - from;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    field = delr;  <span class="comment">// to set the direction.</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="keywordflow">if</span> (delr.Mag() &lt; <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a> * <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>)</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    {  <span class="comment">// note that this has blurred units -- it should scale with all three dimensions of stepsize.  For lots of phi bins, especially, this might start to read as small before it&#39;s really small.</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;       <span class="comment">// do nothing.  the vector is already zero, which will be our approximation.</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;       <span class="comment">// field.SetMag(0);//no contribution if we&#39;re in the same cell. -- but root warns if trying to resize something of magnitude zero.</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;    }</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    {</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;      field.SetMag(<a class="code" href="../../de/d64/classAnnularFieldSim.html#af7c1e4f13e1b7c9ab80e97485034e34a">k_perm</a> * 1 / (delr * delr));  <span class="comment">// scalar product on the bottom. unitful, since we defined k_perm and delr with their correct units. (native units V=1 C=1 cm=1)</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    }</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="comment">// printf(&quot;calc_unit_field at (%2.2f,%2.2f,%2.2f) from  (%2.2f,%2.2f,%2.2f).  Mag=%2.4fe-9\n&quot;,at.x(),at.Y(),at.Z(),from.X(),from.Y(),from.Z(),field.Mag()*1e9);</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;  }</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;  {</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <span class="keywordtype">double</span> atphi = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(at.Phi());</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <span class="keywordtype">double</span> fromphi = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(from.Phi());</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <span class="keywordtype">double</span> delphi = abs(at.DeltaPhi(from));</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    <span class="comment">// to allow us to use the same greens function set for both sides of the tpc, we shift into the valid greens region if needed:</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    at.SetZ(at.Z() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad37e2804a3e394e5617951c6bb444f84">green_shift</a>);</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    from.SetZ(from.Z() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad37e2804a3e394e5617951c6bb444f84">green_shift</a>);</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    <span class="keywordtype">double</span> Er = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a261ec743956234d0e225c1e12e701a78">green</a>-&gt;<a class="code" href="../../dc/de5/classRossegger.html#abe4f941ce3c19aebdd503b95cc332897">Er</a>(at.Perp(), atphi, at.Z(), from.Perp(), fromphi, from.Z());</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <span class="comment">// RCC manually disabled phi component of green -- actually, a correction to disallow trying to compute phi terms when at the same phi:</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    <span class="keywordtype">double</span> Ephi = 0;</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="keywordflow">if</span> (delphi &gt; <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>)</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    {</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;      Ephi = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a261ec743956234d0e225c1e12e701a78">green</a>-&gt;<a class="code" href="../../dc/de5/classRossegger.html#a38479f0b534b19547ec2dcbb96589a0e">Ephi</a>(at.Perp(), atphi, at.Z(), from.Perp(), fromphi, from.Z());</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;    }</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    <span class="keywordtype">double</span> Ez = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a261ec743956234d0e225c1e12e701a78">green</a>-&gt;<a class="code" href="../../dc/de5/classRossegger.html#a800985286d9c09cc230d62aaf083f69a">Ez</a>(at.Perp(), atphi, at.Z(), from.Perp(), fromphi, from.Z());</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    field.SetXYZ(-Er, -Ephi, -Ez);  <span class="comment">// now these are the correct components if our test point is at y=0 (hence phi=0);</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    field = field * <a class="code" href="../../de/d64/classAnnularFieldSim.html#acc1f15347d3bfeeb631b7e0e0a177e8d">epsinv</a>;         <span class="comment">// scale field strength, since the greens functions as of Apr 1 2020 do not build-in this factor.</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    field.RotateZ(at.Phi());        <span class="comment">// rotate to the coordinates of our &#39;at&#39; point, which is a small rotation for the phislice case.</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    <span class="comment">// but this does mean we need to be careful! If we are rotating so that this is pointing not in the R direction, then with azimuthally symmetric charge we will have some cancellation we don&#39;t want, maybe?  Make sure this matches how we rotate to sum_field!</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;  }</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../d6/dee/namespaceckf.html#a46f483ab4625b683ee66025e18a10825">field</a>;</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;}</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;</div>
<div class="line"><a name="l00354"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">  354</a></span>&#160;<span class="keywordtype">double</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">AnnularFieldSim::FilterPhiPos</a>(<span class="keywordtype">double</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>)</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;{</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  <span class="comment">// this primarily takes the region [-pi,0] and maps it to [pi,2pi] by adding 2pi to it.</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;  <span class="comment">// if math has pushed us past 2pi, it also subtracts to try to get us in range.</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;  <span class="keywordtype">double</span> <a class="code" href="../../dc/d78/namespacemerge__hashes.html#a63313c3a4f2b0cb6f7cea830c9ff269d">p</a> = <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;  <span class="keywordflow">if</span> (p &gt;= 2 * M_PI)  <span class="comment">// phispan)</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;  {</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    p -= 2 * M_PI;</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;  }</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;  <span class="keywordflow">if</span> (p &lt; 0)</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;  {</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    p += 2 * M_PI;</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  }</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;  <span class="keywordflow">if</span> (p &gt;= 2 * M_PI || p &lt; 0)</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;  {</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::FilterPhiPos asked to filter %f, which is more than range=%f out of bounds.  Check what called this.\n&quot;</span>, phi, 2 * M_PI);</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 2);</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;  }</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../dc/d78/namespacemerge__hashes.html#a63313c3a4f2b0cb6f7cea830c9ff269d">p</a>;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;}</div>
<div class="line"><a name="l00374"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">  374</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">AnnularFieldSim::FilterPhiIndex</a>(<span class="keywordtype">int</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">int</span> range = -1)</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;{</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  <span class="keywordflow">if</span> (range &lt; 0)</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;  {</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    range = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>;  <span class="comment">// default input is range=-1.  in that case, use the intrinsic resolution of the q grid.</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;  }</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  <span class="comment">// shifts phi up or down by nphi (=2pi in phi index space), and complains if this doesn&#39;t put it in range.</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../dc/d78/namespacemerge__hashes.html#a63313c3a4f2b0cb6f7cea830c9ff269d">p</a> = <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;  <span class="keywordflow">if</span> (p &gt;= range)</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;  {</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    p -= range;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  }</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  <span class="keywordflow">if</span> (p &lt; 0)</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;  {</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    p += range;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  }</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;  <span class="keywordflow">if</span> (p &gt;= range || p &lt; 0)</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  {</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::FilterPhiIndex asked to filter %d, which is more than range=%d out of bounds.  Check what called this.\n&quot;</span>, phi, range);</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 2);</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  }</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../dc/d78/namespacemerge__hashes.html#a63313c3a4f2b0cb6f7cea830c9ff269d">p</a>;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;}</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div>
<div class="line"><a name="l00399"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#af04bf96017270868073f53e74f2b8a51">  399</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#af04bf96017270868073f53e74f2b8a51">AnnularFieldSim::GetRindex</a>(<span class="keywordtype">float</span> <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>)</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;{</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  <span class="keywordtype">float</span> r0f = (pos - <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>) / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp();  <span class="comment">// the position in r, in units of step, starting from the low edge of the 0th bin.</span></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/d22/DetectorVolumeFindersTests_8cpp.html#aa0c60d277a47da3373ac179947098727">r0</a> = floor(r0f);</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../d0/d22/DetectorVolumeFindersTests_8cpp.html#aa0c60d277a47da3373ac179947098727">r0</a>;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;}</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div>
<div class="line"><a name="l00406"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a3dbe4c497e36fd3bca32e7e821921178">  406</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3dbe4c497e36fd3bca32e7e821921178">AnnularFieldSim::GetPhiIndex</a>(<span class="keywordtype">float</span> <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>)</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;{</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  <span class="keywordtype">float</span> p0f = (<a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>) / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi();  <span class="comment">// the position in phi, in units of step, starting from the low edge of the 0th bin.</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  <span class="keywordtype">int</span> phitemp = floor(p0f);</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;  <span class="keywordtype">int</span> p0 = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">FilterPhiIndex</a>(phitemp);</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  <span class="keywordflow">return</span> p0;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;}</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div>
<div class="line"><a name="l00414"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a012dc921d76beb8c5184b38b8c4577c5">  414</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a012dc921d76beb8c5184b38b8c4577c5">AnnularFieldSim::GetZindex</a>(<span class="keywordtype">float</span> <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>)</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;{</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;  <span class="keywordtype">float</span> z0f = (pos - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>) / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z();  <span class="comment">// the position in z, in units of step, starting from the low edge of the 0th bin.</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;  <span class="keywordtype">int</span> z0 = floor(z0f);</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;  <span class="keywordflow">return</span> z0;</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;}</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;</div>
<div class="line"><a name="l00421"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#af41a4754a596a90505d15a5dcb1868a6">  421</a></span>&#160;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563">AnnularFieldSim::BoundsCase</a> <a class="code" href="../../de/d64/classAnnularFieldSim.html#af41a4754a596a90505d15a5dcb1868a6">AnnularFieldSim::GetRindexAndCheckBounds</a>(<span class="keywordtype">float</span> <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>, <span class="keywordtype">int</span> *<a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>)</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;{</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;  <span class="comment">// if(debugFlag()) printf(&quot;%d: AnnularFieldSim::GetRindexAndCheckBounds(r=%f)\n&quot;,__LINE__,pos);</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  <span class="keywordtype">float</span> r0f = (pos - <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>) / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp();  <span class="comment">// the position in r, in units of step, starting from the low edge of the 0th bin.</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d0/d22/DetectorVolumeFindersTests_8cpp.html#aa0c60d277a47da3373ac179947098727">r0</a> = floor(r0f);</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;  *r = <a class="code" href="../../d0/d22/DetectorVolumeFindersTests_8cpp.html#aa0c60d277a47da3373ac179947098727">r0</a>;</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;  <span class="keywordtype">int</span> r0lowered_slightly = floor(r0f - <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>);</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  <span class="keywordtype">int</span> r0raised_slightly = floor(r0f + <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>);</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;  <span class="keywordflow">if</span> (r0lowered_slightly &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a> || r0raised_slightly &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>)</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;  {</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a5d6b1a005f45425192fb685b714dac15">OutOfBounds</a>;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;  }</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  <span class="comment">// now if we are out of bounds, it is because we are on an edge, within range of ALMOST_ZERO of being in fair territory.</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;  <span class="keywordflow">if</span> (r0 &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a>)</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;  {</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563aa857465f2cf8d2a2e910794e90ef30b9">OnHighEdge</a>;</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;  }</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;  <span class="keywordflow">if</span> (r0 &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>)</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  {</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a036052f156b5b8b74e2746185342bc43">OnLowEdge</a>;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  }</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;  <span class="comment">// if we&#39;re still here, we&#39;re in bounds.</span></div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a>;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;}</div>
<div class="line"><a name="l00448"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#aab5dee891f7302176821ad489549a18f">  448</a></span>&#160;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563">AnnularFieldSim::BoundsCase</a> <a class="code" href="../../de/d64/classAnnularFieldSim.html#aab5dee891f7302176821ad489549a18f">AnnularFieldSim::GetPhiIndexAndCheckBounds</a>(<span class="keywordtype">float</span> <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>, <span class="keywordtype">int</span> *<a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>)</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;{</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="comment">// if(debugFlag()) printf(&quot;%d: AnnularFieldSim::GetPhiIndexAndCheckBounds(phi=%f)\n\n&quot;,__LINE__,pos);</span></div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;  <span class="keywordtype">float</span> p0f = (<a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>) / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi();  <span class="comment">// the position in phi, in units of step, starting from the low edge of the 0th bin.</span></div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;  <span class="keywordtype">int</span> phitemp = floor(p0f);</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  <span class="keywordtype">int</span> p0 = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">FilterPhiIndex</a>(phitemp);</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;  *phi = p0;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;  phitemp = floor(p0f - <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>);</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;  <span class="keywordtype">int</span> p0lowered_slightly = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">FilterPhiIndex</a>(phitemp);</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;  phitemp = floor(p0f + <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>);</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  <span class="keywordtype">int</span> p0raised_slightly = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">FilterPhiIndex</a>(phitemp);</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;  <span class="comment">// annoying detail:  if we are at index 0, we might go above pmax by going down.</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;  <span class="comment">//  and if we are at nphi-1, we might go below pmin by going up.</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  <span class="comment">//  if we are not at p0=0 or nphi-1, the slight wiggles won&#39;t move us.</span></div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  <span class="comment">//  if we are at p0=0, we are not at or above the max, and lowering slightly won&#39;t change that,</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  <span class="comment">//  and is we are at p0=nphi-1, we are not below the min, and raising slightly won&#39;t change that</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  <span class="keywordflow">if</span> ((p0lowered_slightly &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a> &amp;&amp; p0 != 0) || (p0raised_slightly &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a> &amp;&amp; p0 != (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a> - 1)))</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  {</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a5d6b1a005f45425192fb685b714dac15">OutOfBounds</a>;</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;  }</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  <span class="comment">// now if we are out of bounds, it is because we are on an edge, within range of ALMOST_ZERO of being in fair territory.</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;  <span class="keywordflow">if</span> (p0 &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a>)</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;  {</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563aa857465f2cf8d2a2e910794e90ef30b9">OnHighEdge</a>;</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;  }</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;  <span class="keywordflow">if</span> (p0 &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>)</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;  {</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a036052f156b5b8b74e2746185342bc43">OnLowEdge</a>;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;  }</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;  <span class="comment">// if we&#39;re still here, we&#39;re in bounds.</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a>;</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;}</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;</div>
<div class="line"><a name="l00482"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">  482</a></span>&#160;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563">AnnularFieldSim::BoundsCase</a> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">AnnularFieldSim::GetZindexAndCheckBounds</a>(<span class="keywordtype">float</span> <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>, <span class="keywordtype">int</span> *<a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>)</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;{</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;  <span class="comment">// if(debugFlag()) printf(&quot;%d: AnnularFieldSim::GetZindexAndCheckBounds(z=%f)\n\n&quot;,__LINE__,pos);</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;  <span class="keywordtype">float</span> z0f = (pos - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>) / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z();  <span class="comment">// the position in z, in units of step, starting from the low edge of the 0th bin.</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;  <span class="keywordtype">int</span> z0 = floor(z0f);</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;  *z = z0;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  <span class="keywordtype">int</span> z0lowered_slightly = floor(z0f - <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>);</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;  <span class="keywordtype">int</span> z0raised_slightly = floor(z0f + <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>);</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;  <span class="keywordflow">if</span> (z0lowered_slightly &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a> || z0raised_slightly &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>)</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;  {</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a5d6b1a005f45425192fb685b714dac15">OutOfBounds</a>;</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;  }</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;  <span class="comment">// now if we are out of bounds, it is because we are on an edge, within range of ALMOST_ZERO of being in fair territory.</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;  <span class="keywordflow">if</span> (z0 &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a>)</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  {</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563aa857465f2cf8d2a2e910794e90ef30b9">OnHighEdge</a>;</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;  }</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;  <span class="keywordflow">if</span> (z0 &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>)</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;  {</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a036052f156b5b8b74e2746185342bc43">OnLowEdge</a>;</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;  }</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;  <span class="comment">// if we&#39;re still here, we&#39;re in bounds.</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a>;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;}</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;</div>
<div class="line"><a name="l00509"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a6c3d5fee508484e60454ab97ef63eea2">  509</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3451f4963ce7c171bfbd0d566d3f10b9">AnnularFieldSim::analyticFieldIntegral</a>(<span class="keywordtype">float</span> zdest, TVector3 <a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>, <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a> *<a class="code" href="../../d6/dee/namespaceckf.html#a46f483ab4625b683ee66025e18a10825">field</a>)</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;{</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;  <span class="comment">// integrates E dz, from the starting point to the selected z position.  The path is assumed to be along z for each step, with adjustments to x and y accumulated after each step.</span></div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;  <span class="comment">// if(debugFlag()) printf(&quot;%d: AnnularFieldSim::fieldIntegral(x=%f,y=%f, z=%f) to z=%f\n\n&quot;,__LINE__,start.X(),start.Y(),start.Z(),zdest);</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;  <span class="comment">//   printf(&quot;AnnularFieldSim::analyticFieldIntegral calculating from (%f,%f,%f) (rphiz)=(%f,%f,%f) to z=%f.\n&quot;,start.X(),start.Y(),start.Z(),start.Perp(),start.Phi(),start.Z(),zdest);</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;  <span class="comment">// coordinates are assumed to be in native units (cm=1);</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;  <span class="keywordtype">bool</span> rOkay = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#af41a4754a596a90505d15a5dcb1868a6">GetRindexAndCheckBounds</a>(start.Perp(), &amp;<a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>) == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a>);</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  <span class="keywordtype">bool</span> phiOkay = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#aab5dee891f7302176821ad489549a18f">GetPhiIndexAndCheckBounds</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(start.Phi()), &amp;phi) == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a>);</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;  <span class="comment">// bool isE=(field==Efield);</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;  <span class="comment">// bool isB=(field==Bfield);</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;  <span class="comment">// printf(&quot;anaFieldInt:  isE=%d, isB=%d, start=(%f,%f,%f)\n&quot;,isE,isB,start.X(),start.Y(),start.Z());</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;  <span class="keywordflow">if</span> (!rOkay || !phiOkay)</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;  {</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::analyticFieldIntegral asked to integrate along (r=%f,phi=%f), index=(%d,%d), which is out of bounds.  returning starting position.\n&quot;</span>, start.Perp(), start.Phi(), <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>);</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;  }</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;  <span class="keywordtype">int</span> dir = (start.Z() &gt; zdest ? -1 : 1);  <span class="comment">//+1 if going to larger z, -1 if going to smaller;  if they&#39;re the same, the sense doesn&#39;t matter.</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;  <span class="keywordtype">int</span> zi, zf;</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;  <span class="keywordtype">double</span> startz, endz;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563">BoundsCase</a> startBound, endBound;</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;  <span class="comment">// make sure &#39;zi&#39; is always the smaller of the two numbers, for handling the partial-steps.</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;  <span class="keywordflow">if</span> (dir &gt; 0)</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;  {</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    startBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(start.Z(), &amp;zi);  <span class="comment">// highest cell with lower bound less than lower bound of integral</span></div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    endBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(zdest, &amp;zf);        <span class="comment">// highest cell with lower bound less than upper lower bound of integral</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    startz = start.Z();</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    endz = zdest;</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;  }</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;  {</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    endBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(start.Z(), &amp;zf);  <span class="comment">// highest cell with lower bound less than lower bound of integral</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    startBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(zdest, &amp;zi);    <span class="comment">// highest cell with lower bound less than upper lower bound of integral</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    startz = zdest;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    endz = start.Z();</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;  }</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;  <span class="keywordtype">bool</span> startOkay = (startBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a>);</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;  <span class="keywordtype">bool</span> endOkay = (endBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> || endBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563aa857465f2cf8d2a2e910794e90ef30b9">OnHighEdge</a>);  <span class="comment">// if we just barely touch out-of-bounds on the high end, we can skip that piece of the integral</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;  <span class="keywordflow">if</span> (!startOkay || !endOkay)</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;  {</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::analyticFieldIntegral asked to integrate from z=%f to %f, index=%d to %d), which is out of bounds.  returning starting position.\n&quot;</span>, startz, endz, zi, zf);</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;  }</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;  start.SetZ(startz);</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;  TVector3 <a class="code" href="../../d7/db7/centrality__newplotbg__newsupp_8C.html#a0cfcacf2d36bb9e4ffd561793a2f00bf">integral</a>;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;  <span class="keywordflow">if</span> (field == <a class="code" href="../../de/d64/classAnnularFieldSim.html#aeeaac1b3cbe466eac8fec86af99172d2">Efield</a>)</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;  {</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    integral = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a843b7f4bccc385bb048c9a643a986582">aliceModel</a>-&gt;<a class="code" href="../../df/d10/classAnalyticFieldModel.html#a0d1c00c799055fe7b078d41ce1be1da2">Eint</a>(endz, start) + <a class="code" href="../../de/d64/classAnnularFieldSim.html#aedd910db5278318b852bfc65ca976cf6">Eexternal</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(r - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, phi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, zi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>) * (endz - startz);</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    <span class="keywordflow">return</span> dir * <a class="code" href="../../d7/db7/centrality__newplotbg__newsupp_8C.html#a0cfcacf2d36bb9e4ffd561793a2f00bf">integral</a>;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;  }</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (field == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>)</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  {</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef1291170f9342d354fd2d9e41706fb0">interpolatedFieldIntegral</a>(zdest, start, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>);</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;  }</div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../d7/db7/centrality__newplotbg__newsupp_8C.html#a0cfcacf2d36bb9e4ffd561793a2f00bf">integral</a>;</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;}</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;</div>
<div class="line"><a name="l00576"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#af49cb183b20be9a1ceba70f1a3b5c64e">  576</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#af49cb183b20be9a1ceba70f1a3b5c64e">AnnularFieldSim::fieldIntegral</a>(<span class="keywordtype">float</span> zdest, <span class="keyword">const</span> TVector3 &amp;<a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>, <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a> *<a class="code" href="../../d6/dee/namespaceckf.html#a46f483ab4625b683ee66025e18a10825">field</a>)</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;{</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;  <span class="comment">// integrates E dz, from the starting point to the selected z position.  The path is assumed to be along z for each step, with adjustments to x and y accumulated after each step.</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;  <span class="comment">// if(debugFlag()) printf(&quot;%d: AnnularFieldSim::fieldIntegral(x=%f,y=%f, z=%f) to z=%f\n\n&quot;,__LINE__,start.X(),start.Y(),start.Z(),zdest);</span></div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>;</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  <span class="keywordtype">bool</span> rOkay = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#af41a4754a596a90505d15a5dcb1868a6">GetRindexAndCheckBounds</a>(start.Perp(), &amp;<a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>) == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a>);</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;  <span class="keywordtype">bool</span> phiOkay = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#aab5dee891f7302176821ad489549a18f">GetPhiIndexAndCheckBounds</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(start.Phi()), &amp;phi) == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a>);</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;  <span class="keywordflow">if</span> (!rOkay || !phiOkay)</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;  {</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::fieldIntegral asked to integrate along (r=%f,phi=%f), index=(%d,%d), which is out of bounds.  returning starting position.\n&quot;</span>, start.Perp(), start.Phi(), <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>);</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  }</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  <span class="keywordtype">int</span> dir = (start.Z() &gt; zdest ? -1 : 1);  <span class="comment">//+1 if going to larger z, -1 if going to smaller;  if they&#39;re the same, the sense doesn&#39;t matter.</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;  <span class="keywordtype">int</span> zi, zf;</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;  <span class="keywordtype">double</span> startz, endz;</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563">BoundsCase</a> startBound, endBound;</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;  <span class="comment">// make sure &#39;zi&#39; is always the smaller of the two numbers, for handling the partial-steps.</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;  <span class="keywordflow">if</span> (dir &gt; 0)</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  {</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    startBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(start.Z(), &amp;zi);  <span class="comment">// highest cell with lower bound less than lower bound of integral</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    endBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(zdest, &amp;zf);        <span class="comment">// highest cell with lower bound less than upper lower bound of integral</span></div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    startz = start.Z();</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    endz = zdest;</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;  }</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;  {</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    endBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(start.Z(), &amp;zf);  <span class="comment">// highest cell with lower bound less than lower bound of integral</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    startBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(zdest, &amp;zi);    <span class="comment">// highest cell with lower bound less than upper lower bound of integral</span></div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    startz = zdest;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    endz = start.Z();</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;  }</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;  <span class="keywordtype">bool</span> startOkay = (startBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a>);</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;  <span class="keywordtype">bool</span> endOkay = (endBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> || endBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563aa857465f2cf8d2a2e910794e90ef30b9">OnHighEdge</a>);  <span class="comment">// if we just barely touch out-of-bounds on the high end, we can skip that piece of the integral</span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;  <span class="keywordflow">if</span> (!startOkay || !endOkay)</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;  {</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::fieldIntegral asked to integrate from z=%f to %f, index=%d to %d), which is out of bounds.  returning starting position.\n&quot;</span>, startz, endz, zi, zf);</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;  }</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;  TVector3 fieldInt(0, 0, 0);</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;  <span class="comment">// printf(&quot;AnnularFieldSim::fieldIntegral requesting (%d,%d,%d)-(%d,%d,%d) (inclusive) cells\n&quot;,r,phi,zi,r,phi,zf-1);</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;  TVector3 tf;</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = zi; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; zf; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;  {  <span class="comment">// count the whole cell of the lower end, and skip the whole cell of the high end.</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;    tf = field-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(r - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, phi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>);</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <span class="comment">// printf(&quot;fieldAt (%d,%d,%d)=(%f,%f,%f) step=%f\n&quot;,r,phi,i,tf.X(),tf.Y(),tf.Z(),step.Z());</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    fieldInt += tf * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z();</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;  }</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;  <span class="comment">// since bins contain their lower bound, but not their upper, I can safely remove the unused portion of the lower cell:</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;  fieldInt -= field-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(r - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, phi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, zi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>) * (startz - zi * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z());  <span class="comment">// remove the part of the low end cell we didn&#39;t travel through</span></div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;  <span class="comment">// but only need to add the used portion of the upper cell if we go past the edge of it meaningfully:</span></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;  <span class="keywordflow">if</span> (endz / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() - zf &gt; <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>)</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;  {</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    <span class="comment">// printf(&quot;endz/step.Z()=%f, zf=%f\n&quot;,endz/step.Z(),zf*1.0);</span></div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <span class="comment">// if our final step is actually in the next step.</span></div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    fieldInt += field-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(r - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, phi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, zf - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>) * (endz - zf * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z());  <span class="comment">// add the part of the high end cell we did travel through</span></div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;  }</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;  <span class="keywordflow">return</span> dir * fieldInt;</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;}</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div>
<div class="line"><a name="l00645"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a9c93ebfb51787f51897612bf70cdc9fa">  645</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9c93ebfb51787f51897612bf70cdc9fa">AnnularFieldSim::GetCellCenter</a>(<span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <span class="keywordtype">int</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>)</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;{</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;  <span class="comment">// returns the midpoint of the cell (halfway between each edge, not weighted center)</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;  TVector3 <a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a>(1, 0, 0);</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;  c.SetPerp((r + 0.5) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>);</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;  c.SetPhi((phi + 0.5) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi());</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;  c.SetZ((z + 0.5) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>);</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a>;</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;}</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;</div>
<div class="line"><a name="l00657"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#adbb9bba03c21915698421f313dc43071">  657</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbb9bba03c21915698421f313dc43071">AnnularFieldSim::GetRoiCellCenter</a>(<span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <span class="keywordtype">int</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>)</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;{</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;  <span class="comment">// returns the midpoint of the cell relative to the roi (halfway between each edge, not weighted center)</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;  <span class="comment">// return zero if it&#39;s out of bounds:</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;  <span class="keywordflow">if</span> (r &gt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a> || r &lt; 0 || phi &gt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9038e19b32063a3c67c00853cd325b8">nphi_roi</a> || phi &lt; 0 || z &gt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a> || z &lt; 0)</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;  {</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>;</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;  }</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;  TVector3 <a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a>(1, 0, 0);</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;  c.SetPerp((r + <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a> + 0.5) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>);</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;  c.SetPhi((phi + <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a> + 0.5) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi());</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;  c.SetZ((z + <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a> + 0.5) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>);</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a>;</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;}</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div>
<div class="line"><a name="l00675"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#aa3b4e8df7cf7fd8b70640312db83198e">  675</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa3b4e8df7cf7fd8b70640312db83198e">AnnularFieldSim::GetGroupCellCenter</a>(<span class="keywordtype">int</span> <a class="code" href="../../d0/d22/DetectorVolumeFindersTests_8cpp.html#aa0c60d277a47da3373ac179947098727">r0</a>, <span class="keywordtype">int</span> <a class="code" href="../../d0/d22/DetectorVolumeFindersTests_8cpp.html#ae1281efcda7144587a6f532807f9259e">r1</a>, <span class="keywordtype">int</span> phi0, <span class="keywordtype">int</span> phi1, <span class="keywordtype">int</span> z0, <span class="keywordtype">int</span> z1)</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;{</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;  <span class="comment">// returns the midpoint of the cell (halfway between each edge, not weighted center)</span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;  <span class="keywordtype">float</span> ravg = (r0 + <a class="code" href="../../d0/d22/DetectorVolumeFindersTests_8cpp.html#ae1281efcda7144587a6f532807f9259e">r1</a>) / 2.0 + 0.5;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;  <span class="keywordflow">if</span> (phi0 &gt; phi1)</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;  {</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    phi1 += <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>;</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;  }</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;  <span class="keywordflow">if</span> (phi0 &gt; phi1)</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;  {</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;phi1(%d)&lt;=phi0(%d) even after boosting phi1.  check what called this!\n&quot;</span>, phi1, phi0);</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 2);</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;  }</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;  <span class="keywordtype">float</span> phiavg = (r0 + <a class="code" href="../../d0/d22/DetectorVolumeFindersTests_8cpp.html#ae1281efcda7144587a6f532807f9259e">r1</a>) / 2.0 + 0.5;</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;  <span class="keywordflow">if</span> (phiavg &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>)</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;  {</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;    phiavg -= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>;</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;  }</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;  <span class="keywordtype">float</span> zavg = (z0 + z1) / 2.0 + 0.5;</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;  TVector3 <a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a>(1, 0, 0);</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;  c.SetPerp((ravg) *<a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>);</div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;  c.SetPhi((phiavg) *<a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi());</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;  c.SetZ((zavg) *<a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>);</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a>;</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;}</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;</div>
<div class="line"><a name="l00704"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#ae0865076b7af1f0c57ddd36c9af2cc22">  704</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae0865076b7af1f0c57ddd36c9af2cc22">AnnularFieldSim::GetWeightedCellCenter</a>(<span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <span class="keywordtype">int</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>)</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;{</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;  <span class="comment">// returns the weighted center of the cell by volume.</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;  <span class="comment">// todo:  this is vaguely hefty, and might be worth storing the result of, if speed is needed</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;  TVector3 <a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a>(1, 0, 0);</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;  <span class="keywordtype">float</span> rin = r * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;  <span class="keywordtype">float</span> rout = rin + <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp();</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;  <span class="keywordtype">float</span> rMid = (4 * sin(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi() / 2) * (pow(rout, 3) - pow(rin, 3)) / (3 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi() * (pow(rout, 2) - pow(rin, 2))));</div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;  c.SetPerp(rMid);</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;  c.SetPhi((phi + 0.5) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi());</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;  c.SetZ((z + 0.5) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z());</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a>;</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;}</div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;</div>
<div class="line"><a name="l00721"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a23ca76e682fef083886573b2f5473471">  721</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef1291170f9342d354fd2d9e41706fb0">AnnularFieldSim::interpolatedFieldIntegral</a>(<span class="keywordtype">float</span> zdest, <span class="keyword">const</span> TVector3 &amp;<a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>, <a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a> *<a class="code" href="../../d6/dee/namespaceckf.html#a46f483ab4625b683ee66025e18a10825">field</a>)</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;{</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;  <span class="comment">// printf(&quot;AnnularFieldSim::interpolatedFieldIntegral(x=%f,y=%f, z=%f)\n&quot;,start.X(),start.Y(),start.Z());</span></div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;  <span class="keywordtype">float</span> <a class="code" href="../../d0/d22/DetectorVolumeFindersTests_8cpp.html#aa0c60d277a47da3373ac179947098727">r0</a> = (start.Perp() - <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>) / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() - 0.5;  <span class="comment">// the position in r, in units of step, starting from the center of the 0th bin.</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;  <span class="keywordtype">int</span> r0i = floor(r0);                                   <span class="comment">// the integer portion of the position. -- what center is below our position?</span></div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;  <span class="keywordtype">float</span> r0d = r0 - r0i;                                  <span class="comment">// the decimal portion of the position. -- how far past center are we?</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;  <span class="keywordtype">int</span> ri[4];                                             <span class="comment">// the r position of the four cell centers to consider</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;  ri[0] = ri[1] = r0i;</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;  ri[2] = ri[3] = r0i + 1;</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;  <span class="keywordtype">float</span> rw[4];              <span class="comment">// the weight of that cell, linear in distance from the center of it</span></div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;  rw[0] = rw[1] = 1 - r0d;  <span class="comment">// 1 when we&#39;re on it, 0 when we&#39;re at the other one.</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;  rw[2] = rw[3] = r0d;      <span class="comment">// 1 when we&#39;re on it, 0 when we&#39;re at the other one</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;  <span class="keywordtype">bool</span> <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#ac02453702d24df24da23f57610e10499">skip</a>[] = {<span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>};</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;  <span class="keywordflow">if</span> (ri[0] &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>)</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;  {</div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    skip[0] = <span class="keyword">true</span>;  <span class="comment">// don&#39;t bother handling 0 and 1 in the coordinates.</span></div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    skip[1] = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    rw[2] = rw[3] = 1;  <span class="comment">// and weight like we&#39;re dead-center on the outer cells.</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;  }</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;  <span class="keywordflow">if</span> (ri[2] &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a>)</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;  {</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;    skip[2] = <span class="keyword">true</span>;  <span class="comment">// don&#39;t bother handling 2 and 3 in the coordinates.</span></div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    skip[3] = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    rw[0] = rw[1] = 1;  <span class="comment">// and weight like we&#39;re dead-center on the inner cells.</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;  }</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;  <span class="comment">// now repeat that structure for phi:</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;  <span class="keywordtype">float</span> p0 = (start.Phi()) / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi() - 0.5;  <span class="comment">// the position in phi, in units of step, starting from the center of the 0th bin.</span></div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;  <span class="keywordtype">int</span> p0i = floor(p0);                          <span class="comment">// the integer portion of the position. -- what center is below our position?</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;  <span class="keywordtype">float</span> p0d = p0 - p0i;                         <span class="comment">// the decimal portion of the position. -- how far past center are we?</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/db0/fjcore_8hh.html#a83ed6d79695912896ba03659228dc2b8">pi</a>[4];                                    <span class="comment">// the phi position of the four cell centers to consider</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;  pi[0] = pi[2] = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">FilterPhiIndex</a>(p0i);</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  pi[1] = pi[3] = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">FilterPhiIndex</a>(p0i + 1);</div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;  <span class="keywordtype">float</span> pw[4];              <span class="comment">// the weight of that cell, linear in distance from the center of it</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;  pw[0] = pw[2] = 1 - p0d;  <span class="comment">// 1 when we&#39;re on it, 0 when we&#39;re at the other one.</span></div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;  pw[1] = pw[3] = p0d;      <span class="comment">// 1 when we&#39;re on it, 0 when we&#39;re at the other one</span></div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;  <span class="comment">// to handle wrap-around</span></div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;  <span class="keywordflow">if</span> (pi[0] &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a> || pi[0] &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a>)</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;  {</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    skip[0] = <span class="keyword">true</span>;  <span class="comment">// don&#39;t bother handling 0 and 1 in the coordinates.</span></div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    skip[2] = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    pw[1] = pw[3] = 1;  <span class="comment">// and weight like we&#39;re dead-center on the outer cells.</span></div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;  }</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;  <span class="keywordflow">if</span> (pi[1] &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a> || pi[1] &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>)</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;  {</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    skip[1] = <span class="keyword">true</span>;  <span class="comment">// don&#39;t bother handling 2 and 3 in the coordinates.</span></div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    skip[3] = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    pw[0] = pw[2] = 1;  <span class="comment">// and weight like we&#39;re dead-center on the inner cells.</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;  }</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;  <span class="keywordtype">int</span> dir = (start.Z() &lt; zdest ? 1 : -1);  <span class="comment">//+1 if going to larger z, -1 if going to smaller;  if they&#39;re the same, the sense doesn&#39;t matter.</span></div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;</div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;  <span class="keywordtype">int</span> zi, zf;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;  <span class="keywordtype">double</span> startz, endz;</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563">BoundsCase</a> startBound, endBound;</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;  <span class="comment">// make sure &#39;zi&#39; is always the smaller of the two numbers, for handling the partial-steps.</span></div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;  <span class="keywordflow">if</span> (dir &gt; 0)</div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;  {</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    startBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(start.Z(), &amp;zi);  <span class="comment">// highest cell with lower bound less than lower bound of integral</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    endBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(zdest, &amp;zf);        <span class="comment">// highest cell with lower bound less than upper bound of integral</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    startz = start.Z();</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;    endz = zdest;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;  }</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;  {</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;    endBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(start.Z(), &amp;zf);  <span class="comment">// highest cell with lower bound less than lower bound of integral</span></div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    startBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(zdest, &amp;zi);    <span class="comment">// highest cell with lower bound less than upper bound of integral</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    startz = zdest;</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;    endz = start.Z();</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;  }</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;  <span class="keywordtype">bool</span> startOkay = (startBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> || startBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a036052f156b5b8b74e2746185342bc43">OnLowEdge</a>);  <span class="comment">// maybe todo: add handling for being just below the low edge.</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;  <span class="keywordtype">bool</span> endOkay = (endBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> || endBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563aa857465f2cf8d2a2e910794e90ef30b9">OnHighEdge</a>);       <span class="comment">// if we just barely touch out-of-bounds on the high end, we can skip that piece of the integral</span></div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;  <span class="keywordflow">if</span> (!startOkay || !endOkay)</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;  {</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::InterpolatedFieldIntegral asked to integrate from z=%f to %f, index=%d to %d), which is out of bounds.  returning zero\n&quot;</span>, startz, endz, zi, zf);</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>;</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;  }</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;  <span class="keywordflow">if</span> (startBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a036052f156b5b8b74e2746185342bc43">OnLowEdge</a>)</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;  {</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    <span class="comment">// we were just below the low edge, so we will be asked to sample a bin in z we&#39;re not actually using</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;    zi++;  <span class="comment">// avoid it.  We weren&#39;t integrating anything in it anyway.</span></div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  }</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">false</span>)</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;  {  <span class="comment">// debugging options</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    <span class="keywordtype">bool</span> isE = (field == <a class="code" href="../../de/d64/classAnnularFieldSim.html#aeeaac1b3cbe466eac8fec86af99172d2">Efield</a>);</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    <span class="keywordtype">bool</span> isB = (field == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>);</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;interpFieldInt:  isE=%d, isB=%d, start=(%2.4f,%2.4f,%2.4f) dest=%2.4f\n&quot;</span>, isE, isB, start.X(), start.Y(), start.Z(), zdest);</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;interpolating fieldInt for %s at  r=%f,phi=%f\n&quot;</span>, (field == <a class="code" href="../../de/d64/classAnnularFieldSim.html#aeeaac1b3cbe466eac8fec86af99172d2">Efield</a>) ? <span class="stringliteral">&quot;Efield&quot;</span> : <span class="stringliteral">&quot;Bfield&quot;</span>, r0, p0);</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;direction=%d, startz=%2.4f, endz=%2.4f, zi=%d, zf=%d\n&quot;</span>, dir, startz, endz, zi, zf);</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 4; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    {</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;      <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;skip[%d]=%d\tw[i]=%2.2f, (pw=%2.2f, rw=%2.2f)\n&quot;</span>, <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>, skip[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>], rw[i] * pw[i], pw[i], rw[i]);</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    }</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;  }</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;  TVector3 fieldInt(0, 0, 0), partialInt;  <span class="comment">// where we&#39;ll store integrals as we generate them.</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 4; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;  {</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="keywordflow">if</span> (skip[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>])</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    {</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;      <span class="comment">// printf(&quot;skipping element r=%d,phi=%d\n&quot;,ri[i],pi[i]);</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;      <span class="keywordflow">continue</span>;  <span class="comment">// we invalidated this one for some reason.</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    }</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    partialInt.SetXYZ(0, 0, 0);</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> = zi; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; zf; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>++)</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    {  <span class="comment">// count the whole cell of the lower end, and skip the whole cell of the high end.</span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;      partialInt += field-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(ri[i] - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, pi[i] - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z();</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    }</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    <span class="keywordflow">if</span> (startBound != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a036052f156b5b8b74e2746185342bc43">OnLowEdge</a>)</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    {</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;      partialInt -= field-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(ri[i] - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, pi[i] - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, zi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>) * (startz - (zi * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>));  <span class="comment">// remove the part of the low end cell we didn&#39;t travel through</span></div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;      <span class="comment">// printf(&quot;removing low end of cell we didn&#39;t travel through (zi-zmin_roi=%d, length=%f)\n&quot;,zi-zmin_roi, startz-(zi*step.Z()+zmin));</span></div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    }</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    <span class="keywordflow">if</span> ((endz - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>) / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() - zf &gt; <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>)</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;    {</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;      partialInt += field-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(ri[i] - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, pi[i] - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, zf - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>) * (endz - (zf * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>));  <span class="comment">// add the part of the high end cell we did travel through</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;      <span class="comment">// printf(&quot;adding low end of cell we did travel through (zf-zmin_roi=%d, length=%f)\n&quot;,zf-zmin_roi, endz-(zf*step.Z()+zmin));</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    }</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    <span class="comment">// printf(&quot;element r=%d,phi=%d, w=%f partialInt=(%2.2E,%2.2E,%2.2E)\n&quot;,ri[i],pi[i],rw[i]*pw[i],partialInt.X(),partialInt.Y(),partialInt.Z());</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    fieldInt += rw[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] * pw[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] * partialInt;</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;  }</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;  <span class="keywordflow">return</span> dir * fieldInt;</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;}</div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;</div>
<div class="line"><a name="l00856"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a2398cd69c5bb7b1409319ae44236d6b2">  856</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2398cd69c5bb7b1409319ae44236d6b2">AnnularFieldSim::load_analytic_spacecharge</a>(<span class="keywordtype">float</span> scalefactor = 1)</div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;{</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;  <span class="comment">// scalefactor should be chosen so Rho(pos) returns C/cm^3</span></div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;  <span class="comment">// sphenix:</span></div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;  <span class="comment">// double ifc_radius=20;</span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;  <span class="comment">// double ofc_radius=78;</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;  <span class="comment">//   double tpc_halfz=</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;  <span class="keywordtype">double</span> ifc_radius = 83.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;  <span class="keywordtype">double</span> ofc_radius = 254.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>;</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;  <span class="keywordtype">double</span> tpc_halfz = 250 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a843b7f4bccc385bb048c9a643a986582">aliceModel</a> = <span class="keyword">new</span> <a class="code" href="../../df/d10/classAnalyticFieldModel.html">AnalyticFieldModel</a>(ifc_radius / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>, ofc_radius / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>, tpc_halfz / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>, scalefactor);</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;  <span class="keywordtype">double</span> totalcharge = 0;</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;  <span class="keywordtype">double</span> localcharge = 0;</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;  TVector3 <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>;</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifr = 0; ifr &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>; ifr++)</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;  {</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifphi = 0; ifphi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>; ifphi++)</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    {</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifz = 0; ifz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>; ifz++)</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;      {</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;        pos = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9c93ebfb51787f51897612bf70cdc9fa">GetCellCenter</a>(ifr, ifphi, ifz);</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;        pos = pos * (1.0 / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>);  <span class="comment">// divide by cm so we&#39;re in units of cm when we query the charge model.</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;        <span class="keywordtype">double</span> vol = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi() * (2 * (ifr * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>) + <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp()) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp();</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;        <span class="comment">// if(debugFlag()) printf(&quot;%d: AnnularFieldSim::load_analytic_spacecharge adding Q=%f into cell (%d,%d,%d)\n&quot;,__LINE__,qbin,i,j,k,localr,localphi,localz);</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;        localcharge = vol * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a843b7f4bccc385bb048c9a643a986582">aliceModel</a>-&gt;<a class="code" href="../../df/d10/classAnalyticFieldModel.html#a700a921c94388051a5599829d3168348">Rho</a>(pos);  <span class="comment">// TODO:  figure out what units this is in.</span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        totalcharge += localcharge;</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;        <span class="comment">// q-&gt;Add(ifr, ifphi, ifz, localcharge);  //scalefactor must be applied to charge _and_ field, and so is handled in the aliceModel code.</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        <a class="code" href="../../de/d64/classAnnularFieldSim.html#a002f26208e71c2e801523bd82a015f9e">q</a>-&gt;<a class="code" href="../../d4/d14/classChargeMapReader.html#aedba92d22432856a02fd4ee0f4209cc3">AddChargeInBin</a>(ifr, ifphi, ifz, localcharge);  <span class="comment">// scalefactor must be applied to charge _and_ field, and so is handled in the aliceModel code.</span></div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;      }</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    }</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;  }</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::load_analytic_spacecharge:  Total charge Q=%E Coulombs\n&quot;</span>, totalcharge);</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912ab2ebc633d33ad7912d9290d256ea4819">HybridRes</a>)</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;  {</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    <span class="comment">// go through the q array and build q_lowres.</span></div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a908de0cdfdcde19201e7c18f1c81db07">q_lowres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a724a354269ec724f79ab24f2c9210c28">Length</a>(); <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    {</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;      *(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a908de0cdfdcde19201e7c18f1c81db07">q_lowres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>)) = 0;</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;    }</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;    <span class="comment">// fill our low-res</span></div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    <span class="comment">// note that this assumes the last bin is short or normal length, not long.</span></div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifr = 0; ifr &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>; ifr++)</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    {</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;      <span class="keywordtype">int</span> r_low = ifr / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3e84c61c56134d72992b940a889f297c">r_spacing</a>;  <span class="comment">// index of our l-bin is just the integer division of the index of our f-bin</span></div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifphi = 0; ifphi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>; ifphi++)</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;      {</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;        <span class="keywordtype">int</span> phi_low = ifphi / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a09f972e6da20da4bd6508ea919a566d4">phi_spacing</a>;</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifz = 0; ifz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>; ifz++)</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;        {</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;          <span class="keywordtype">int</span> z_low = ifz / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a90c13a6de122eaa34d8da6869b627104">z_spacing</a>;</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;          <a class="code" href="../../de/d64/classAnnularFieldSim.html#a908de0cdfdcde19201e7c18f1c81db07">q_lowres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a33bbe655697ef0d6b52428f200869917">Add</a>(r_low, phi_low, z_low, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a002f26208e71c2e801523bd82a015f9e">q</a>-&gt;<a class="code" href="../../d4/d14/classChargeMapReader.html#a2abb6186153f2d2b740a356023e7d0b5">GetChargeInBin</a>(ifr, ifphi, ifz));</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;        }</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;      }</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    }</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;  }</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;}</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;</div>
<div class="line"><a name="l00920"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f3bf08a1e0acb87ce83bdd442c6330f">  920</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f3bf08a1e0acb87ce83bdd442c6330f">AnnularFieldSim::loadEfield</a>(<span class="keyword">const</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a8e8ff5b11e64078831112677156cb111">std::string</a> &amp;<a class="code" href="../../d4/d23/Prototype2_2EMCal_2macros_2EnergyCalibFit_8m.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>, <span class="keyword">const</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a8e8ff5b11e64078831112677156cb111">std::string</a> &amp;treename, <span class="keywordtype">int</span> zsign)</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;{</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;  <span class="comment">// prep variables so that loadField can just iterate over the tree entries and fill our selected tree agnostically</span></div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;  <span class="comment">// assumes file stores fields as V/cm.</span></div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;  TFile fieldFile(filename.c_str(), <span class="stringliteral">&quot;READ&quot;</span>);</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;  TTree *fTree;</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;  fieldFile.GetObject(treename.c_str(), fTree);</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aee246a62e470501dc809be946330f11c">Efieldname</a> = <span class="stringliteral">&quot;E:&quot;</span> + filename + <span class="stringliteral">&quot;:&quot;</span> + treename;</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;  <span class="comment">//  sprintf(Efieldname,&quot;E:%s:%s&quot;,filename,treename);</span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;  <span class="keywordtype">float</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>;          <span class="comment">// coordinates</span></div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;  <span class="keywordtype">float</span> fr, fz, fphi;  <span class="comment">// field components at that coordinate</span></div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;r&quot;</span>, &amp;r);</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;er&quot;</span>, &amp;fr);</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;z&quot;</span>, &amp;z);</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;ez&quot;</span>, &amp;fz);</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;  <span class="comment">// phi would go here if we had it.</span></div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;  fphi = 0;  <span class="comment">// no phi components yet.</span></div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;  <span class="comment">// float phi = 0.;</span></div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;  <span class="comment">// phi += 1;</span></div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;  <span class="comment">// phi = 0;  //satisfy picky racf compiler</span></div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae2be7d3732a0dbab2ff6d49a219058be">loadField</a>(&amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#aedd910db5278318b852bfc65ca976cf6">Eexternal</a>, fTree, &amp;r, <span class="keyword">nullptr</span>, &amp;z, &amp;fr, &amp;fphi, &amp;fz, <a class="code" href="../../de/d64/classAnnularFieldSim.html#add22fc45f5d33e13cfc422f3e8c8c997">V</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>, zsign);</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;  fieldFile.Close();</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;}</div>
<div class="line"><a name="l00944"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a2358166b8d8066a216fc05c2858f0b9f">  944</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2358166b8d8066a216fc05c2858f0b9f">AnnularFieldSim::loadBfield</a>(<span class="keyword">const</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a8e8ff5b11e64078831112677156cb111">std::string</a> &amp;<a class="code" href="../../d4/d23/Prototype2_2EMCal_2macros_2EnergyCalibFit_8m.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>, <span class="keyword">const</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a8e8ff5b11e64078831112677156cb111">std::string</a> &amp;treename)</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;{</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;  <span class="comment">// prep variables so that loadField can just iterate over the tree entries and fill our selected tree agnostically</span></div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;  <span class="comment">// assumes file stores field as Tesla.</span></div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;  TFile fieldFile(filename.c_str(), <span class="stringliteral">&quot;READ&quot;</span>);</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;  TTree *fTree;</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;  fieldFile.GetObject(treename.c_str(), fTree);</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab032b553e141c1a6add587c42458f347">Bfieldname</a> = <span class="stringliteral">&quot;B:&quot;</span> + filename + <span class="stringliteral">&quot;:&quot;</span> + treename;</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;  <span class="keywordtype">float</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>;          <span class="comment">// coordinates</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;  <span class="keywordtype">float</span> fr, fz, fphi;  <span class="comment">// field components at that coordinate</span></div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;r&quot;</span>, &amp;r);</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;br&quot;</span>, &amp;fr);</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;z&quot;</span>, &amp;z);</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;bz&quot;</span>, &amp;fz);</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;  <span class="comment">// phi would go here if we had it.</span></div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;  fphi = 0;  <span class="comment">// no phi components yet.</span></div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;  <span class="comment">// float phi = 0.;</span></div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;  <span class="comment">// phi += 1;</span></div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;  <span class="comment">// phi = 0;  //satisfy picky racf compiler</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae2be7d3732a0dbab2ff6d49a219058be">loadField</a>(&amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>, fTree, &amp;r, <span class="keyword">nullptr</span>, &amp;z, &amp;fr, &amp;fphi, &amp;fz, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad3398b737ec329b9f9dca579bf123bb0">Tesla</a>, 1);</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;  fieldFile.Close();</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;}</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;</div>
<div class="line"><a name="l00969"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a9e8f466f311ca2ca6bd59ef2d65c7823">  969</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9e8f466f311ca2ca6bd59ef2d65c7823">AnnularFieldSim::load3dBfield</a>(<span class="keyword">const</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a8e8ff5b11e64078831112677156cb111">std::string</a> &amp;<a class="code" href="../../d4/d23/Prototype2_2EMCal_2macros_2EnergyCalibFit_8m.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>, <span class="keyword">const</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a8e8ff5b11e64078831112677156cb111">std::string</a> &amp;treename, <span class="keywordtype">int</span> zsign, <span class="keywordtype">float</span> scale)</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;{</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;  <span class="comment">// prep variables so that loadField can just iterate over the tree entries and fill our selected tree agnostically</span></div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;  <span class="comment">// assumes file stores field as Tesla.</span></div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;  TFile fieldFile(filename.c_str(), <span class="stringliteral">&quot;READ&quot;</span>);</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;  TTree *fTree;</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;  fieldFile.GetObject(treename.c_str(), fTree);</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab032b553e141c1a6add587c42458f347">Bfieldname</a> = <span class="stringliteral">&quot;B(3D):&quot;</span> + filename + <span class="stringliteral">&quot;:&quot;</span> + treename + <span class="stringliteral">&quot; Scale =&quot;</span> + <a class="code" href="../../d7/d38/ZipTests_8cpp.html#a2a98c1fe01d4f15bb6333773fbbe879c">boost::str</a>(<a class="code" href="../../da/da5/namespacematerial__mapping__optimisation.html#a90721d6c6b41b9882f4c9cd8cfc01cfd">boost::format</a>(<span class="stringliteral">&quot;%2.2f&quot;</span>) % scale);</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;  <span class="comment">//  sprintf(Bfieldname,&quot;B(3D):%s:%s Scale=%2.2f&quot;,filename,treename,scale);</span></div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;  <span class="keywordtype">float</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>, <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>;     <span class="comment">// coordinates</span></div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;  <span class="keywordtype">float</span> fr, fz, fphi;  <span class="comment">// field components at that coordinate</span></div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;rho&quot;</span>, &amp;r);</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;brho&quot;</span>, &amp;fr);</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;z&quot;</span>, &amp;z);</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;bz&quot;</span>, &amp;fz);</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;phi&quot;</span>, &amp;phi);</div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;  fTree-&gt;SetBranchAddress(<span class="stringliteral">&quot;bphi&quot;</span>, &amp;fphi);</div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae2be7d3732a0dbab2ff6d49a219058be">loadField</a>(&amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>, fTree, &amp;r, <span class="keyword">nullptr</span>, &amp;z, &amp;fr, &amp;fphi, &amp;fz, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad3398b737ec329b9f9dca579bf123bb0">Tesla</a> * scale, zsign);</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;}</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;</div>
<div class="line"><a name="l00990"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#ae2be7d3732a0dbab2ff6d49a219058be">  990</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae2be7d3732a0dbab2ff6d49a219058be">AnnularFieldSim::loadField</a>(<a class="code" href="../../d8/d64/classMultiArray.html">MultiArray&lt;TVector3&gt;</a> **<a class="code" href="../../d6/dee/namespaceckf.html#a46f483ab4625b683ee66025e18a10825">field</a>, TTree *<a class="code" href="../../d7/d6a/namespaceparse__cmake__options.html#a2601de4c948ba533c074a7701083ab7e">source</a>, <span class="keywordtype">float</span> *rptr, <span class="keywordtype">float</span> *phiptr, <span class="keywordtype">float</span> *zptr, <span class="keywordtype">float</span> *frptr, <span class="keywordtype">float</span> *fphiptr, <span class="keywordtype">float</span> *fzptr, <span class="keywordtype">float</span> fieldunit, <span class="keywordtype">int</span> zsign)</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;{</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;  <span class="comment">// we&#39;re loading a tree of unknown size and spacing -- and possibly uneven spacing -- into our local data.</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;  <span class="comment">// formally, we might want to interpolate or otherwise weight, but for now, carve this into our usual bins, and average, similar to the way we load spacecharge.</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;</div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;  <span class="keywordtype">bool</span> phiSymmetry = (phiptr == <span class="keyword">nullptr</span>);  <span class="comment">// if the phi pointer is zero, assume phi symmetry.</span></div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;  <span class="keywordtype">int</span> lowres_factor = 10;                  <span class="comment">// to fill in gaps, we group together loweres^3 cells into one block and use that average.</span></div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;loading field from %f&lt;z&lt;%f\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a>);</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;  TH3F *htEntries = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;htentries&quot;</span>, <span class="stringliteral">&quot;num of entries in the field loading&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, 0, M_PI * 2.0, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a5b910d33cbf61449e7b78071d2403ec2">rmax</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a>);</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;  TH3F *htSum[3];</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;  TH3F *htEntriesLow = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;htentrieslow&quot;</span>, <span class="stringliteral">&quot;num of lowres entries in the field loading&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a> / lowres_factor + 1, 0, M_PI * 2.0, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a> / lowres_factor + 1, <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a5b910d33cbf61449e7b78071d2403ec2">rmax</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a> / lowres_factor + 1, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a>);</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;  TH3F *htSumLow[3];</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;  <span class="keywordtype">char</span> axis[] = <span class="stringliteral">&quot;rpz&quot;</span>;</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 3; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;  {</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    htSum[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH3F(Form(<span class="stringliteral">&quot;htsum%d&quot;</span>, <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>), Form(<span class="stringliteral">&quot;sum of %c-axis entries in the field loading&quot;</span>, *(axis + <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>)), <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, 0, M_PI * 2.0, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a5b910d33cbf61449e7b78071d2403ec2">rmax</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a>);</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    htSumLow[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH3F(Form(<span class="stringliteral">&quot;htsumlow%d&quot;</span>, <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>), Form(<span class="stringliteral">&quot;sum of low %c-axis entries in the field loading&quot;</span>, *(axis + <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>)), <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a> / lowres_factor + 1, 0, M_PI * 2.0, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a> / lowres_factor + 1, <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a5b910d33cbf61449e7b78071d2403ec2">rmax</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a> / lowres_factor + 1, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a>);</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;  }</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;  <span class="keywordtype">int</span> nEntries = source-&gt;GetEntries();</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; nEntries; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;  {  <span class="comment">// could probably do this with an iterator</span></div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;    source-&gt;GetEntry(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>);</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    <span class="keywordtype">float</span> zval = *zptr * zsign;  <span class="comment">// right now, need the ability to flip the sign of the z coordinate.</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;    <span class="comment">// note that the z sign also needs to affect the field sign in that direction, which is handled outside in the z components of the fills</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;    <span class="comment">// if we aren&#39;t asking for phi symmetry, build just the one phi strip</span></div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    <span class="keywordflow">if</span> (!phiSymmetry)</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    {</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;      <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(phiptr);</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;      htEntries-&gt;Fill(*phiptr, *rptr, zval);  <span class="comment">// for legacy reasons this histogram, like others, goes phi-r-z.</span></div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;      htSum[0]-&gt;Fill(*phiptr, *rptr, zval, *frptr * fieldunit);</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;      htSum[1]-&gt;Fill(*phiptr, *rptr, zval, *fphiptr * fieldunit);</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;      htSum[2]-&gt;Fill(*phiptr, *rptr, zval, *fzptr * fieldunit * zsign);</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;      htEntriesLow-&gt;Fill(*phiptr, *rptr, zval);  <span class="comment">// for legacy reasons this histogram, like others, goes phi-r-z.</span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;      htSumLow[0]-&gt;Fill(*phiptr, *rptr, zval, *frptr * fieldunit);</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;      htSumLow[1]-&gt;Fill(*phiptr, *rptr, zval, *fphiptr * fieldunit);</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;      htSumLow[2]-&gt;Fill(*phiptr, *rptr, zval, *fzptr * fieldunit * zsign);</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;    }</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    {  <span class="comment">// if we do have phi symmetry, build every phi strip using this one.</span></div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>++)</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;      {</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;        htEntries-&gt;Fill(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), *rptr, zval);  <span class="comment">// for legacy reasons this histogram, like others, goes phi-r-z.</span></div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        htSum[0]-&gt;Fill(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), *rptr, zval, *frptr * fieldunit);</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;        htSum[1]-&gt;Fill(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), *rptr, zval, *fphiptr * fieldunit);</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;        htSum[2]-&gt;Fill(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), *rptr, zval, *fzptr * fieldunit * zsign);</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;        htEntriesLow-&gt;Fill(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), *rptr, zval);  <span class="comment">// for legacy reasons this histogram, like others, goes phi-r-z.</span></div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;        htSumLow[0]-&gt;Fill(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), *rptr, zval, *frptr * fieldunit);</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        htSumLow[1]-&gt;Fill(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), *rptr, zval, *fphiptr * fieldunit);</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;        htSumLow[2]-&gt;Fill(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), *rptr, zval, *fzptr * fieldunit * zsign);</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;      }</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;    }</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;  }</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;  <span class="comment">// now we just divide and fill our local plots (which should eventually be stored as histograms, probably) with the values from each hist cell:</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;  <span class="keywordtype">int</span> nemptybins = 0;</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;  {</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>++)</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;    {</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> = 0; <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>; <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a>++)</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;      {</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;        TVector3 cellcenter = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9c93ebfb51787f51897612bf70cdc9fa">GetCellCenter</a>(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>, <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>, <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a>);</div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;        <span class="keywordtype">int</span> bin = htEntries-&gt;FindBin(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(cellcenter.Phi()), cellcenter.Perp(), cellcenter.Z());</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;        TVector3 fieldvec(htSum[0]-&gt;GetBinContent(bin), htSum[1]-&gt;GetBinContent(bin), htSum[2]-&gt;GetBinContent(bin));</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;        fieldvec = fieldvec * (1.0 / htEntries-&gt;GetBinContent(bin));</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;        <span class="keywordflow">if</span> (htEntries-&gt;GetBinContent(bin) &lt; 0.99)</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;        {</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;          <span class="comment">// no entries here!</span></div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;          nemptybins++;</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;        }</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;        <span class="comment">// have to rotate this to the proper direction.</span></div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;        fieldvec.RotateZ(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(cellcenter.Phi()));  <span class="comment">// rcc caution.  Does this rotation shift the sense of &#39;up&#39;?</span></div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        (*field)-&gt;Set(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>, <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>, <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a>, fieldvec);</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;      }</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    }</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;  }</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;  <span class="keywordflow">if</span> (nemptybins &gt; 0)</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;  {</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;found %d empty bins when constructing %s.  Filling with lower resolution.\n&quot;</span>, nemptybins, (*field == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>) ? <span class="stringliteral">&quot;Bfield&quot;</span> : <span class="stringliteral">&quot;Eexternal&quot;</span>);</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    {</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>++)</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;      {</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> = 0; <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>; <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a>++)</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;        {</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;          TVector3 cellcenter = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9c93ebfb51787f51897612bf70cdc9fa">GetCellCenter</a>(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>, <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>, <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a>);</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;          <span class="keywordtype">int</span> bin = htEntries-&gt;FindBin(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(cellcenter.Phi()), cellcenter.Perp(), cellcenter.Z());</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;          <span class="keywordflow">if</span> (htEntries-&gt;GetBinContent(bin) == 0)</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;          {</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;            <span class="keywordtype">int</span> lowbin = htEntriesLow-&gt;FindBin(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(cellcenter.Phi()), cellcenter.Perp(), cellcenter.Z());</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;            TVector3 fieldvec(htSumLow[0]-&gt;GetBinContent(lowbin), htSumLow[1]-&gt;GetBinContent(lowbin), htSumLow[2]-&gt;GetBinContent(lowbin));</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;            fieldvec = fieldvec * (1.0 / htEntriesLow-&gt;GetBinContent(lowbin));</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;            <span class="keywordflow">if</span> (htEntriesLow-&gt;GetBinContent(lowbin) &lt; 0.99)</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;            {</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;              <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;not enough entries in source to fill fieldmap.  None near r=%f, phi=%f, z=%f. Pick lower granularity!\n&quot;</span>,</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;                     cellcenter.Perp(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(cellcenter.Phi()), cellcenter.Z());</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;              <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 2);</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;            }</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;            <span class="comment">// have to rotate this to the proper direction.</span></div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;            fieldvec.RotateZ(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(cellcenter.Phi()));  <span class="comment">// rcc caution.  Does this rotation shift the sense of &#39;up&#39;?</span></div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;            (*field)-&gt;Set(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>, <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>, <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a>, fieldvec);</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;          }</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;        }</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;      }</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    }</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;  }</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;}</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;</div>
<div class="line"><a name="l01099"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#aefaee12b378d8d529325ed6b80b9e41a"> 1099</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#aefaee12b378d8d529325ed6b80b9e41a">AnnularFieldSim::load_spacecharge</a>(<span class="keyword">const</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a8e8ff5b11e64078831112677156cb111">std::string</a> &amp;<a class="code" href="../../d4/d23/Prototype2_2EMCal_2macros_2EnergyCalibFit_8m.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>, <span class="keyword">const</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a8e8ff5b11e64078831112677156cb111">std::string</a> &amp;histname, <span class="keywordtype">float</span> zoffset, <span class="keywordtype">float</span> chargescale, <span class="keywordtype">float</span> cmscale, <span class="keywordtype">bool</span> isChargeDensity)</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;{</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;  TFile *<a class="code" href="../../d7/dde/ctrl_8cpp.html#a4d8dfd0d62f1f4d6ee444333ceefb7ba">f</a> = TFile::Open(filename.c_str());</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;  TH3 *scmap;</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;  f-&gt;GetObject(histname.c_str(), scmap);</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;  std::cout &lt;&lt; <span class="stringliteral">&quot;Loading spacecharge from &#39;&quot;</span> &lt;&lt; filename</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;&#39;.  Seeking histname &#39;&quot;</span> &lt;&lt; histname &lt;&lt; <span class="stringliteral">&quot;&#39;&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#af6badbda26dde7c29425e3eb65b1f081">chargesourcename</a> = filename + <span class="stringliteral">&quot;:&quot;</span> + histname;</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;  <span class="comment">//  sprintf(chargesourcename,&quot;%s:%s&quot;,filename,histname);</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aefaee12b378d8d529325ed6b80b9e41a">load_spacecharge</a>(scmap, zoffset, chargescale, cmscale, isChargeDensity, <a class="code" href="../../de/d64/classAnnularFieldSim.html#af6badbda26dde7c29425e3eb65b1f081">chargesourcename</a>.c_str());</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;  f-&gt;Close();</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;}</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;</div>
<div class="line"><a name="l01113"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#adbbe2204b3be7c779dcf3d0d08cc50ea"> 1113</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbbe2204b3be7c779dcf3d0d08cc50ea">AnnularFieldSim::load_and_resample_spacecharge</a>(<span class="keywordtype">int</span> new_nphi, <span class="keywordtype">int</span> new_nr, <span class="keywordtype">int</span> new_nz, <span class="keyword">const</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a8e8ff5b11e64078831112677156cb111">std::string</a> &amp;<a class="code" href="../../d4/d23/Prototype2_2EMCal_2macros_2EnergyCalibFit_8m.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>, <span class="keyword">const</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a8e8ff5b11e64078831112677156cb111">std::string</a> &amp;histname, <span class="keywordtype">float</span> zoffset, <span class="keywordtype">float</span> chargescale, <span class="keywordtype">float</span> cmscale, <span class="keywordtype">bool</span> isChargeDensity)</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;{</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;  TFile *<a class="code" href="../../d7/dde/ctrl_8cpp.html#a4d8dfd0d62f1f4d6ee444333ceefb7ba">f</a> = TFile::Open(filename.c_str());</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;  TH3 *scmap;</div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;  f-&gt;GetObject(histname.c_str(), scmap);</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;  std::cout &lt;&lt; <span class="stringliteral">&quot;Resampling spacecharge from &#39;&quot;</span> &lt;&lt; filename</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;&#39;.  Seeking histname &#39;&quot;</span> &lt;&lt; histname &lt;&lt; <span class="stringliteral">&quot;&#39;&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#af6badbda26dde7c29425e3eb65b1f081">chargesourcename</a> = filename + <span class="stringliteral">&quot;:&quot;</span> + histname;</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbbe2204b3be7c779dcf3d0d08cc50ea">load_and_resample_spacecharge</a>(new_nphi, new_nr, new_nz, scmap, zoffset, chargescale, cmscale, isChargeDensity);</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;  f-&gt;Close();</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;}</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;</div>
<div class="line"><a name="l01126"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a2a4327c30fd352e4745b38435ca3953e"> 1126</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbbe2204b3be7c779dcf3d0d08cc50ea">AnnularFieldSim::load_and_resample_spacecharge</a>(<span class="keywordtype">int</span> new_nphi, <span class="keywordtype">int</span> new_nr, <span class="keywordtype">int</span> new_nz, TH3 *<a class="code" href="../../dd/da4/namespaceadd__histos.html#a9ffe1f3beb7ee305602ee6c99ec12859">hist</a>, <span class="keywordtype">float</span> zoffset, <span class="keywordtype">float</span> chargescale, <span class="keywordtype">float</span> cmscale, <span class="keywordtype">bool</span> isChargeDensity)</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;{</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;  <span class="comment">// load spacecharge densities from a histogram, where scalefactor translates into local units of C/cm^3</span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;  <span class="comment">// and cmscale translate (hist coord) --&gt; (hist position in cm)</span></div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;  <span class="comment">// noting that the histogram limits may differ from the simulation size, and have different granularity</span></div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;  <span class="comment">// hist is assumed/required to be x=phi, y=r, z=z</span></div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;  <span class="comment">// z offset &#39;drifts&#39; the charge by that distance toward z=0.</span></div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;  <span class="comment">// Get dimensions of input</span></div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;  <span class="keywordtype">float</span> hrmin = hist-&gt;GetYaxis()-&gt;GetXmin();</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;  <span class="keywordtype">float</span> hrmax = hist-&gt;GetYaxis()-&gt;GetXmax();</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;  <span class="keywordtype">float</span> hphimin = hist-&gt;GetXaxis()-&gt;GetXmin();</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;  <span class="keywordtype">float</span> hphimax = hist-&gt;GetXaxis()-&gt;GetXmax();</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;  <span class="keywordtype">float</span> hzmin = hist-&gt;GetZaxis()-&gt;GetXmin();</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;  <span class="keywordtype">float</span> hzmax = hist-&gt;GetZaxis()-&gt;GetXmax();</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;  <span class="comment">// Get number of bins in each dimension</span></div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;  <span class="keywordtype">int</span> hrn = hist-&gt;GetNbinsY();</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;  <span class="keywordtype">int</span> hphin = hist-&gt;GetNbinsX();</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;  <span class="keywordtype">int</span> hzn = hist-&gt;GetNbinsZ();</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;From histogram, native r dimensions: %f&lt;r&lt;%f, hrn (Y axis)=%d\n&quot;</span>, hrmin, hrmax, hrn);</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;From histogram, native phi dimensions: %f&lt;phi&lt;%f, hrn (X axis)=%d\n&quot;</span>, hphimin, hphimax, hphin);</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;From histogram, native z dimensions: %f&lt;z&lt;%f, hrn (Z axis)=%d\n&quot;</span>, hzmin, hzmax, hzn);</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;  <span class="comment">// do some computation of steps:</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;  <span class="keywordtype">float</span> hrstep = (hrmax - hrmin) / hrn;</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;  <span class="keywordtype">float</span> hphistep = (hphimax - hphimin) / hphin;</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;  <span class="keywordtype">float</span> hzstep = (hzmax - hzmin) / hzn;</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;  <span class="keywordtype">float</span> halfrstep = hrstep * 0.5;</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;  <span class="keywordtype">float</span> halfphistep = hphistep * 0.5;</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;  <span class="keywordtype">float</span> halfzstep = hzstep * 0.5;</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;  <span class="comment">// All we have to do here is resample it so it fits into our expected grid, then pass it to the loader.</span></div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;  <span class="comment">// 1) convert the existing histogram to density if it isn&#39;t already:</span></div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;  <span class="keywordflow">if</span> (!isChargeDensity)</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;  {</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; hphin; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;    {</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;      <span class="keywordtype">float</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a> = hphimin + hphistep * <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>;</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; hrn; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>++)</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;      {</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;        <span class="keywordtype">float</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a> = hrmin + hrstep * <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>;</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> = 0; <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> &lt; hzn; <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a>++)</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;        {</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;          <span class="keywordtype">float</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a> = hzmin + hzstep * <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a>;</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;          <span class="keywordtype">int</span> bin = hist-&gt;FindBin(phi + halfphistep, r + halfrstep, z + halfzstep);</div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;          <span class="keywordtype">double</span> vol = hzstep * hphistep * (r + halfrstep) * hrstep;</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;          hist-&gt;SetBinContent(bin, hist-&gt;GetBinContent(bin) / vol);</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;        }</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;      }</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    }</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;  }</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;  <span class="comment">// I ought to consider a subtler approach that better preserves the overall integral, rather than just skipping the interpolation of the outer edges:</span></div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;  TH3F *resampled = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;resampled&quot;</span>, <span class="stringliteral">&quot;resampled charge&quot;</span>, new_nphi, hphimin, hphimax, new_nr, hrmin, hrmax, new_nz, hzmin, hzmax);</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;  <span class="keywordtype">float</span> new_phistep = (hphimax - hphimin) / new_nphi;</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;  <span class="keywordtype">float</span> new_rstep = (hrmax - hrmin) / new_nr;</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;  <span class="keywordtype">float</span> new_zstep = (hzmax - hzmin) / new_nz;</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;  <span class="comment">// 2 resample with interpolation on the interior, and with nearest-bin for the edge bins</span></div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; new_nphi; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;  {</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    <span class="keywordtype">float</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a> = hphimin + new_phistep * (<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> + 0.5);                  <span class="comment">// bin center of resampled</span></div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    <span class="keywordtype">float</span> hphi = (phi - hphimin) / hphistep;                        <span class="comment">// coord  in source hist</span></div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    <span class="keywordtype">bool</span> phisafe = ((hphi - 0.75) &gt; 0) &amp;&amp; ((hphi + 0.75) &lt; hphin);  <span class="comment">// we&#39;re past the halfway point of the lowest bin, and short of the halfway point of the highest bin.</span></div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; new_nr; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>++)</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;    {</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;      <span class="keywordtype">float</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a> = hrmin + new_rstep * (<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> + 0.5);              <span class="comment">// bin center of resampled</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;      <span class="keywordtype">float</span> hr = (r - hrmin) / hrstep;                      <span class="comment">// coord in source hist</span></div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;      <span class="keywordtype">bool</span> rsafe = ((hr - 0.5) &gt; 0) &amp;&amp; ((hr + 0.5) &lt; hrn);  <span class="comment">// we&#39;re past the halfway point of the lowest bin, and short of the halfway point of the highest bin.</span></div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> = 0; <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> &lt; new_nz; <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a>++)</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;      {</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;        <span class="keywordtype">float</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a> = hzmin + new_zstep * (<a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> + 0.5);              <span class="comment">// bin center of resampled</span></div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;        <span class="keywordtype">float</span> <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a03e49c2087d3ff25385eb2d4544bc8e8">hz</a> = (z - hzmin) / hzstep;                      <span class="comment">// coord in source hist</span></div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;        <span class="keywordtype">bool</span> zsafe = ((hz - 0.5) &gt; 0) &amp;&amp; ((hz + 0.5) &lt; hzn);  <span class="comment">// we&#39;re past the halfway point of the lowest bin, and short of the halfway point of the highest bin.</span></div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;        <span class="comment">// check if we need to do a bin lookup:</span></div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;        <span class="keywordflow">if</span> (phisafe &amp;&amp; rsafe &amp;&amp; zsafe)</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;        {</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;          <span class="comment">// printf(&quot;resampling (%d,%d,%d) from (%2.2f/%d,%2.2f/%d,%2.2f/%d) p:(%1.1f&lt;%1.1f&lt;%1.1f) r:(%1.1f&lt;%1.1f&lt;%1.1f) z:(%1.1f&lt;%1.1f&lt;%1.1f)\n&quot;,i,j,k,hphi,hphin,hr,hrn,hz,hzn,hphimin,phi,hphimax,hrmin,r,hrmax,hzmin,z,hzmax);</span></div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;          resampled-&gt;Fill(phi, r, z, hist-&gt;Interpolate(phi, r, z));  <span class="comment">// leave as a density</span></div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;        }</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;        {</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;          <span class="keywordtype">int</span> bin = hist-&gt;FindBin(phi, r, z);</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;          resampled-&gt;Fill(phi, r, z, hist-&gt;GetBinContent(bin));</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;        }</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;      }  <span class="comment">// k (z loop)</span></div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;    }    <span class="comment">// j (r loop)</span></div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;  }      <span class="comment">// i (phi loop)</span></div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;here in load_and_resample_spacecharge, I am going to call load_spacecharge.\n&quot;</span>);</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aefaee12b378d8d529325ed6b80b9e41a">load_spacecharge</a>(resampled, zoffset, chargescale, cmscale, <span class="keyword">true</span>);</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;}</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;</div>
<div class="line"><a name="l01219"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a1bc0702ec2614d55abe3574eb63da0f6"> 1219</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#aefaee12b378d8d529325ed6b80b9e41a">AnnularFieldSim::load_spacecharge</a>(TH3 *<a class="code" href="../../dd/da4/namespaceadd__histos.html#a9ffe1f3beb7ee305602ee6c99ec12859">hist</a>, <span class="keywordtype">float</span> zoffset, <span class="keywordtype">float</span> chargescale, <span class="keywordtype">float</span> cmscale, <span class="keywordtype">bool</span> isChargeDensity, <span class="keyword">const</span> <span class="keywordtype">char</span> *inputchargestring)</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;{</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;  <span class="comment">// new plan:  use ChargeMapReader:</span></div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;  <span class="keywordflow">if</span> (abs(zoffset) &gt; 0.001)</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;  {</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;nonzero zoffset given (%E) but new spacecharge loader can&#39;t deal with that.  Failing.\n&quot;</span>, zoffset);</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(<span class="keyword">false</span>);</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;  }</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;  <span class="keywordflow">if</span> (isChargeDensity)</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;  {</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;Input dataset is flagged as recording density not total charge, but new loader can&#39;t deal with that  Failing..\n&quot;</span>);</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(<span class="keyword">false</span>);</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;  }</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a002f26208e71c2e801523bd82a015f9e">q</a>-&gt;<a class="code" href="../../d4/d14/classChargeMapReader.html#a068ea2263b63982a8313c8dc3690827a">ReadSourceCharge</a>(hist, cmscale, chargescale);</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;</div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;  sprintf(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a7eb439bec285eceabc0470598486ea7b">chargestring</a>, <span class="stringliteral">&quot;SC loaded externally: %s.&quot;</span>, inputchargestring);</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;}</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;</div>
<div class="line"><a name="l01238"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#ade847e16308755dc3ebcb99f1f090a4f"> 1238</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#ade847e16308755dc3ebcb99f1f090a4f">AnnularFieldSim::load_digital_current</a>(TH3 *<a class="code" href="../../dd/da4/namespaceadd__histos.html#a9ffe1f3beb7ee305602ee6c99ec12859">hist</a>, TH2 *gainHist, <span class="keywordtype">float</span> chargescale, <span class="keywordtype">float</span> cmscale, <span class="keyword">const</span> <span class="keywordtype">char</span> *inputchargestring)</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;{</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a002f26208e71c2e801523bd82a015f9e">q</a>-&gt;<a class="code" href="../../d4/d14/classChargeMapReader.html#aa18322fd9e81c28af24ee272c74fee66">ReadSourceAdc</a>(hist, gainHist, cmscale, chargescale);</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;  sprintf(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a7eb439bec285eceabc0470598486ea7b">chargestring</a>, <span class="stringliteral">&quot;SC loaded externally: %s.&quot;</span>, inputchargestring);</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;}</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;</div>
<div class="line"><a name="l01246"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a28392dfc402d5111e2eb72a516c08671"> 1246</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a28392dfc402d5111e2eb72a516c08671">AnnularFieldSim::save_spacecharge</a>(<span class="keyword">const</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a8e8ff5b11e64078831112677156cb111">std::string</a> &amp;<a class="code" href="../../d4/d23/Prototype2_2EMCal_2macros_2EnergyCalibFit_8m.html#a2ff994e16bf9521154de4cf659a3b689">filename</a>)</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;{</div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;  <span class="comment">// save a histogram giving the spacecharge in our local coordinates, as we&#39;ll be using them..</span></div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;  TH3F *hsc = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hInternalSpaceCharge&quot;</span>, <span class="stringliteral">&quot;Internal Charge Histogram;phi(rad);r(cm);z(cm)&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, 0, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad599b2a5ac68da60609b8892b8f82032">phispan</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a5b910d33cbf61449e7b78071d2403ec2">rmax</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a>);</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;  {</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;    <span class="keywordtype">float</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a> = 0 + <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi() * (<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> + 0.5);</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>++)</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;    {</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;      <span class="keywordtype">float</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a> = <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a> + <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() * (<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> + 0.5);</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> = 0; <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>; <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a>++)</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;      {</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;        <span class="keywordtype">float</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a> = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a> + <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() * (<a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> + 0.5);</div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;        hsc-&gt;Fill(phi, r, z, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a002f26208e71c2e801523bd82a015f9e">q</a>-&gt;<a class="code" href="../../d4/d14/classChargeMapReader.html#a64364113cd14edf3a356e3a2eebd352e">GetChargeAtPosition</a>(r, phi, z));</div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;        <span class="comment">// old version: hsc-&gt;Fill(phi,r,z,q-&gt;Get(j,i,k));</span></div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;      }</div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;    }</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;  }</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;  hsc-&gt;SaveAs(filename.c_str());</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;}</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;</div>
<div class="line"><a name="l01268"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a93cf8cb06ee829f5890c6f45fbc100d2"> 1268</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a93cf8cb06ee829f5890c6f45fbc100d2">AnnularFieldSim::add_testcharge</a>(<span class="keywordtype">float</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <span class="keywordtype">float</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">float</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>, <span class="keywordtype">float</span> coulombs)</div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;{</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a002f26208e71c2e801523bd82a015f9e">q</a>-&gt;<a class="code" href="../../d4/d14/classChargeMapReader.html#ad01208955996b75fe8bdac8699cde2e2">AddChargeAtPosition</a>(r, phi, z, coulombs * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3122217cae55b22ab3c6b157cd96b695">C</a>);</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;<span class="comment">  int rcell, phicell, zcell;</span></div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;<span class="comment">  //translate to which cell we&#39;re in:</span></div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;<span class="comment">  BoundsCase rb = GetRindexAndCheckBounds(r, &amp;rcell);</span></div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;<span class="comment">  BoundsCase pb = GetPhiIndexAndCheckBounds(phi, &amp;phicell);</span></div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;<span class="comment">  BoundsCase zb = GetZindexAndCheckBounds(z, &amp;zcell);</span></div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;<span class="comment">  //really, we would like to confirm that the cell we find is in the charge map region, not the field map region.</span></div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;<span class="comment">  if (rb == BoundsCase::OutOfBounds || pb == BoundsCase::OutOfBounds || zb == BoundsCase::OutOfBounds)</span></div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;<span class="comment">  {</span></div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;<span class="comment">    printf(&quot;placing %f Coulombs at (r,p,z)=(%f,%f,%f).  Caution that that is out of the roi.\n&quot;, coulombs, r, phi, z);</span></div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;<span class="comment">  if (rcell &lt; 0 || phicell &lt; 0 || zcell &lt; 0)</span></div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;<span class="comment">  {</span></div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;<span class="comment">    printf(&quot;Tried placing %f Coulombs at (r,p,z)=(%f,%f,%f).  That is outside of the charge map region.\n&quot;, coulombs, r, phi, z);</span></div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;<span class="comment">    return;</span></div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;<span class="comment">  q-&gt;Add(rcell, phicell, zcell, coulombs * C);</span></div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;<span class="comment">  if (lookupCase == HybridRes)</span></div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;<span class="comment">  {</span></div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;<span class="comment">    printf(&quot;write the code you didn&#39;t write earlier about reloading the lowres map.\n&quot;);</span></div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;<span class="comment">    assert(1 == 2);</span></div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;<span class="comment">  return;</span></div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;}</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;<span class="comment">void AnnularFieldSim::populate_analytic_fieldmap(){</span></div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;<span class="comment">  //sum the E field at every point in the region of interest</span></div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;<span class="comment">  // remember that Efield uses relative indices</span></div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;<span class="comment">  printf(&quot;in pop_analytic_fieldmap, n=(%d,%d,%d)\n&quot;,nr,nphi,nz);</span></div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;<span class="comment">  TVector3 localF;//holder for the summed field at the current position.</span></div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;<span class="comment">  for (int ir=rmin_roi;ir&lt;rmax_roi;ir++){</span></div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;<span class="comment">    for (int iphi=phimin_roi;iphi&lt;phimax_roi;iphi++){</span></div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;<span class="comment">      for (int iz=zmin_roi;iz&lt;zmax_roi;iz++){</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;<span class="comment">        localF=aliceModel-&gt;E(GetCellCenter(ir, iphi, iz))+Eexternal-&gt;Get(ir-rmin_roi,iphi-phimin_roi,iz-zmin_roi);</span></div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;<span class="comment">        Efield-&gt;Set(ir-rmin_roi,iphi-phimin_roi,iz-zmin_roi,localF);</span></div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;<span class="comment">        //if (localF.Mag()&gt;1e-9)</span></div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;<span class="comment">        if(debugFlag()) printf(&quot;%d: AnnularFieldSim::populate_analytic_fieldmap fieldmap@ (%d,%d,%d) mag=%f\n&quot;,__LINE__,ir,iphi,iz,localF.Mag());</span></div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;<span class="comment">      }</span></div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;<span class="comment">  return;</span></div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;<span class="comment">}</span></div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;<span class="comment">*/</span></div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;</div>
<div class="line"><a name="l01322"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#aa99cdfc4fd947bfc8a90fd606bd78e2d"> 1322</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa99cdfc4fd947bfc8a90fd606bd78e2d">AnnularFieldSim::populate_fieldmap</a>()</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;{</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;  <span class="comment">// sum the E field at every point in the region of interest</span></div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;  <span class="comment">//  remember that Efield uses relative indices</span></div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;in pop_fieldmap, n=(%d,%d,%d)\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>);</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;populating fieldmap for (%dx%dx%d) grid with (%dx%dx%d) source \n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9038e19b32063a3c67c00853cd325b8">nphi_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>);</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac8d43e1809336ebb1b7b3f97e04c17cf">truncation_length</a> &gt; 0)</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;  {</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot; ==&gt; truncating anything more than %d cells away\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac8d43e1809336ebb1b7b3f97e04c17cf">truncation_length</a>);</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;  }</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> totalelements = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>;</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9038e19b32063a3c67c00853cd325b8">nphi_roi</a>;</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>;  <span class="comment">// breaking up this multiplication prevents a 32bit math overflow</span></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> percent = totalelements / 100 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a>;</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;total elements = %llu\n&quot;</span>, totalelements * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>);</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;  <span class="keywordtype">int</span> el = 0;</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;  TVector3 localF;  <span class="comment">// holder for the summed field at the current position.</span></div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ir = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>; ir &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a>; ir++)</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;  {</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iphi = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>; iphi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a>; iphi++)</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;    {</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iz = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>; iz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a>; iz++)</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;      {</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;        localF = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a7e5bfbb3d32ab1733d1fa653cdacbc1b">sum_field_at</a>(ir, iphi, iz);  <span class="comment">// asks in global coordinates</span></div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;        <span class="keywordflow">if</span> (!(el % percent))</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;        {</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;          <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;populate_fieldmap %d%%:  &quot;</span>, (<span class="keywordtype">int</span>) (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a> * el / percent));</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;          <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;sum_field_at (ir=%d,iphi=%d,iz=%d) gives (%E,%E,%E)\n&quot;</span>,</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;                 ir, iphi, iz, localF.X(), localF.Y(), localF.Z());</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;        }</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;        el++;</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;        <a class="code" href="../../de/d64/classAnnularFieldSim.html#aeeaac1b3cbe466eac8fec86af99172d2">Efield</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a0cf24ea8c5d6c9ae66222d7e32957890">Set</a>(ir - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, iphi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, iz - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>, localF);  <span class="comment">// sets in roi coordinates.</span></div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;                                                                               <span class="comment">// if (localF.Mag()&gt;1e-9)</span></div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;                                                                               <span class="comment">// if(debugFlag()) printf(&quot;%d: AnnularFieldSim::populate_fieldmap fieldmap@ (%d,%d,%d) mag=%f\n&quot;,__LINE__,ir,iphi,iz,localF.Mag());</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;      }</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;    }</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;  }</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;}</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;</div>
<div class="line"><a name="l01366"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a2f49f50c2bc4351587ab6cf8e660111e"> 1366</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2f49f50c2bc4351587ab6cf8e660111e">AnnularFieldSim::populate_lookup</a>()</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;{</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;  <span class="comment">// with &#39;f&#39; being the position the field is being measured at, and &#39;o&#39; being the position of the charge generating the field.</span></div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;  <span class="comment">// remember the &#39;f&#39; part of Epartial uses relative indices.</span></div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;  <span class="comment">//   TVector3 (*f)[fx][fy][fz][ox][oy][oz]=field_;</span></div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;  <span class="comment">// printf(&quot;populating lookup for (%dx%dx%d)x(%dx%dx%d) grid\n&quot;,fx,fy,fz,ox,oy,oz);</span></div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912ac20b14fd6f49ea685f1efa42313344cf">Full3D</a>)</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;  {</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;lookupCase==Full3D\n&quot;</span>);</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a0860caf13830e3b6ffb63477e5d5d90d">populate_full3d_lookup</a>();</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;  }</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912ab2ebc633d33ad7912d9290d256ea4819">HybridRes</a>)</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;  {</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;lookupCase==HybridRes\n&quot;</span>);</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2bc090942421a5a9f185be13f2689d5a">populate_highres_lookup</a>();</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8fcaff1d1d774fba15565f6990077ea0">populate_lowres_lookup</a>();</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;  }</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912aa9a7b26da725426bb440409274d09ca5">PhiSlice</a>)</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;  {</div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;Populating lookup:  lookupCase==PhiSlice\n&quot;</span>);</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a266e4d2f962db9ca8c4ff25d6a34a574">populate_phislice_lookup</a>();</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;  }</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912afd1a80e709f9494e2123081ec7d33f90">Analytic</a>)</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;  {</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;Populating lookup:  lookupCase==Analytic ===&gt; skipping!\n&quot;</span>);</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;  }</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912af7578ea26890f328d41266f6216e723a">NoLookup</a>)</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;  {</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;Populating lookup:  lookupCase==NoLookup ===&gt; skipping!\n&quot;</span>);</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;  }</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;  {</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 2);</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;  }</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;}</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;</div>
<div class="line"><a name="l01405"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a0860caf13830e3b6ffb63477e5d5d90d"> 1405</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a0860caf13830e3b6ffb63477e5d5d90d">AnnularFieldSim::populate_full3d_lookup</a>()</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;{</div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;  <span class="comment">// with &#39;f&#39; being the position the field is being measured at, and &#39;o&#39; being the position of the charge generating the field.</span></div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;  <span class="comment">// remember the &#39;f&#39; part of Epartial uses relative indices.</span></div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;  <span class="comment">//   TVector3 (*f)[fx][fy][fz][ox][oy][oz]=field_;</span></div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;populating full lookup table for (%dx%dx%d)x(%dx%dx%d) grid\n&quot;</span>,</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;         (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>), (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>), (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>), <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>);</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> totalelements = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>);</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;  totalelements *= (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>);</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;  totalelements *= (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>);</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>;</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>;</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>;  <span class="comment">// breaking up this multiplication prevents a 32bit math overflow</span></div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> percent = totalelements / 100 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a>;</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;total elements = %llu\n&quot;</span>, totalelements);</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;  TVector3 <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a6c8403cf1f00f8d2746f9fe1da683802">at</a>(1, 0, 0);</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;  TVector3 from(1, 0, 0);</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;  TVector3 <a class="code" href="../../d7/da4/namespaceKFPMath.html#a6025b2360c1c0f5710e7341037ac9d39">zero</a>(0, 0, 0);</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;  <span class="keywordtype">int</span> el = 0;</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifr = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>; ifr &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a>; ifr++)</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;  {</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifphi = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>; ifphi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a>; ifphi++)</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;    {</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifz = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>; ifz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a>; ifz++)</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;      {</div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;        at = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9c93ebfb51787f51897612bf70cdc9fa">GetCellCenter</a>(ifr, ifphi, ifz);</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ior = 0; ior &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>; ior++)</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;        {</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iophi = 0; iophi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>; iophi++)</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;          {</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ioz = 0; ioz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>; ioz++)</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;            {</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;              el++;</div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;              <span class="keywordflow">if</span> (!(el % percent))</div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;              {</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;                <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;populate_full3d_lookup %d%%\n&quot;</span>, (<span class="keywordtype">int</span>) (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a> * el / percent));</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;              }</div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;              from = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9c93ebfb51787f51897612bf70cdc9fa">GetCellCenter</a>(ior, iophi, ioz);</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;              <span class="comment">//*f[ifx][ify][ifz][iox][ioy][ioz]=cacl_unit_field(at,from);</span></div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;              <span class="comment">// printf(&quot;calc_unit_field...\n&quot;);</span></div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;              <span class="keywordflow">if</span> (ifr == ior &amp;&amp; ifphi == iophi &amp;&amp; ifz == ioz)</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;              {</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;                <a class="code" href="../../de/d64/classAnnularFieldSim.html#a12dd10a36307c5896ef633b5edf6d67d">Epartial</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a0cf24ea8c5d6c9ae66222d7e32957890">Set</a>(ifr - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, ifphi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, ifz - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>, ior, iophi, ioz, zero);</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;              }</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;              {</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;                <a class="code" href="../../de/d64/classAnnularFieldSim.html#a12dd10a36307c5896ef633b5edf6d67d">Epartial</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a0cf24ea8c5d6c9ae66222d7e32957890">Set</a>(ifr - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, ifphi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, ifz - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>, ior, iophi, ioz, <a class="code" href="../../de/d64/classAnnularFieldSim.html#aba83c13891c05b283eebd23b347a8c2b">calc_unit_field</a>(at, from));</div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;              }</div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;            }</div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;          }</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;        }</div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;      }</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;    }</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;  }</div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;}</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;</div>
<div class="line"><a name="l01464"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a2bc090942421a5a9f185be13f2689d5a"> 1464</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2bc090942421a5a9f185be13f2689d5a">AnnularFieldSim::populate_highres_lookup</a>()</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;{</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;  TVector3 <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a6c8403cf1f00f8d2746f9fe1da683802">at</a>(1, 0, 0);</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;  TVector3 from(1, 0, 0);</div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;  TVector3 <a class="code" href="../../d7/da4/namespaceKFPMath.html#a6025b2360c1c0f5710e7341037ac9d39">zero</a>(0, 0, 0);</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;</div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;  <span class="comment">// populate_highres_lookup();</span></div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;  <span class="keywordtype">int</span> r_highres_dist = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a7a8e3028b6f00782ef26683a18a9c351">nr_high</a> - 1) / 2;</div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;  <span class="keywordtype">int</span> phi_highres_dist = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a8b33436d6a20d9698c3dd39db4ba3784">nphi_high</a> - 1) / 2;</div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;  <span class="keywordtype">int</span> z_highres_dist = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a8594f9b21d7ab7f4938ae87793e79d1a">nz_high</a> - 1) / 2;</div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;</div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;  <span class="comment">// number of fbins contained in the 26 weirdly-shaped edge regions (and one center region which we won&#39;t use)</span></div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;  <span class="keyword">static</span> <span class="keywordtype">int</span> nfbinsin[3][3][3];</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;  <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> : nfbinsin)</div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;  {</div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; 3; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>++)</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;    {</div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> = 0; <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a> &lt; 3; <a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a>++)</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;      {</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;        <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>][<a class="code" href="../../db/d14/pythia__commons_8h.html#a7a16daa873b7e70e2e15b8e71b1fa971">k</a>] = 0;  <span class="comment">// we could count total volume, but without knowing the charge prior, it&#39;s not clear that&#39;d be /better/</span></div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;      }</div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;    }</div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;  }</div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;</div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;  <span class="comment">// todo: if this runs too slowly, I can do geometry instead of looping over all the cells that are possibly in range</span></div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;</div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;  <span class="comment">// loop over all the f-bins in the roi:</span></div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;  TVector3 currentf, newf;  <span class="comment">// the averaged field vector without, and then with the new contribution from the f-bin being considered.</span></div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifr = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>; ifr &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a>; ifr++)</div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;  {</div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;    <span class="keywordtype">int</span> r_parentlow = floor((ifr - r_highres_dist) / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a3e84c61c56134d72992b940a889f297c">r_spacing</a> * 1.0));       <span class="comment">// l-bin partly enclosed in our high-res region</span></div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;    <span class="keywordtype">int</span> r_parenthigh = floor((ifr + r_highres_dist) / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a3e84c61c56134d72992b940a889f297c">r_spacing</a> * 1.0)) + 1;  <span class="comment">// definitely not enclosed in our high-res region</span></div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;    <span class="keywordtype">int</span> r_startpoint = r_parentlow * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3e84c61c56134d72992b940a889f297c">r_spacing</a>;                                <span class="comment">// the first f-bin of the lowest-r f-bin that our h-region touches.  COuld be less than zero.</span></div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;    <span class="keywordtype">int</span> r_endpoint = r_parenthigh * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3e84c61c56134d72992b940a889f297c">r_spacing</a>;                                 <span class="comment">// the first f-bin of the lowest-r l-bin after that that our h-region does not touch.  could be larger than max.</span></div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;</div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifphi = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>; ifphi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a>; ifphi++)</div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;    {</div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;      <span class="keywordtype">int</span> phi_parentlow = floor(<a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">FilterPhiIndex</a>(ifphi - phi_highres_dist) / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a09f972e6da20da4bd6508ea919a566d4">phi_spacing</a> * 1.0));  <span class="comment">// note this may have wrapped around</span></div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;      <span class="keywordtype">bool</span> phi_parentlow_wrapped = (ifphi - phi_highres_dist &lt; 0);</div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;      <span class="keywordtype">int</span> phi_startpoint = phi_parentlow * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a09f972e6da20da4bd6508ea919a566d4">phi_spacing</a>;  <span class="comment">// the first f-bin of the lowest-z f-bin that our h-region touches.</span></div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;      <span class="keywordflow">if</span> (phi_parentlow_wrapped)</div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;      {</div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;        phi_startpoint -= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>;  <span class="comment">// if we wrapped, re-wrap us so we&#39;re negative again</span></div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;      }</div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;</div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;      <span class="keywordtype">int</span> phi_parenthigh = floor(<a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">FilterPhiIndex</a>(ifphi + phi_highres_dist) / (phi_spacing * 1.0)) + 1;  <span class="comment">// note that this may have wrapped around</span></div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;      <span class="keywordtype">bool</span> phi_parenthigh_wrapped = (ifphi + phi_highres_dist &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>);</div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;      <span class="keywordtype">int</span> phi_endpoint = phi_parenthigh * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a09f972e6da20da4bd6508ea919a566d4">phi_spacing</a>;</div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;      <span class="keywordflow">if</span> (phi_parenthigh_wrapped)</div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;      {</div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;        phi_endpoint += <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>;  <span class="comment">// if we wrapped, re-wrap us so we&#39;re larger than nphi again.  We use these relative coords to determine the position relative to the center of our h-region.</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;      }</div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;</div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifz = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>; ifz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a>; ifz++)</div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;      {</div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;        <span class="comment">// if(debugFlag()) printf(&quot;%d: AnnularFieldSim::populate_highres_lookup icell=(%d,%d,%d)\n&quot;,__LINE__,ifr,ifphi,ifz);</span></div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;</div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;        <span class="keywordtype">int</span> z_parentlow = floor((ifz - z_highres_dist) / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a90c13a6de122eaa34d8da6869b627104">z_spacing</a> * 1.0));</div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;        <span class="keywordtype">int</span> z_parenthigh = floor((ifz + z_highres_dist) / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a90c13a6de122eaa34d8da6869b627104">z_spacing</a> * 1.0)) + 1;</div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;        <span class="keywordtype">int</span> z_startpoint = z_parentlow * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a90c13a6de122eaa34d8da6869b627104">z_spacing</a>;  <span class="comment">// the first f-bin of the lowest-z f-bin that our h-region touches.</span></div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;        <span class="keywordtype">int</span> z_endpoint = z_parenthigh * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a90c13a6de122eaa34d8da6869b627104">z_spacing</a>;   <span class="comment">// the first f-bin of the lowest-z l-bin after that that our h-region does not touch.</span></div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;</div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;        <span class="comment">// our &#39;at&#39; position, in global coords:</span></div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;        at = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9c93ebfb51787f51897612bf70cdc9fa">GetCellCenter</a>(ifr, ifphi, ifz);</div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;        <span class="comment">// define the farthest-away parent l-bin cells we&#39;re dealing with here:</span></div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;        <span class="comment">// note we&#39;re still in absolute coordinates</span></div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;        <span class="comment">// for every f-bin in the l-bins we&#39;re dealing with, figure out which relative highres bin it&#39;s in, and average the field vector into that bin&#39;s vector</span></div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;        <span class="comment">// note most of these relative bins have exactly one f-bin in them.  It&#39;s only the edges that can get more.</span></div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;        <span class="comment">// note this is a running average:  Anew=(Aold*Nold+V)/(Nold+1) and so on.</span></div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;        <span class="comment">// note also that we automatically skip f-bins that would&#39;ve been out of the valid overall volume.</span></div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ir = r_startpoint; ir &lt; r_endpoint; ir++)</div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;        {</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;          <span class="comment">// skip parts that are out of range:</span></div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;          <span class="comment">// could speed this up by moving this into the definition of start and endpoint.</span></div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;          <span class="keywordflow">if</span> (ir &lt; 0)</div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;          {</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;            ir = 0;</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;          }</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;          <span class="keywordflow">if</span> (ir &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>)</div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;          {</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;          }</div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;          <span class="keywordtype">int</span> rbin = (ir - ifr) + r_highres_dist;  <span class="comment">// zeroth bin when we&#39;re at max distance below, etc.</span></div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;          <span class="keywordtype">int</span> rcell = 1;</div>
<div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;          <span class="keywordflow">if</span> (rbin &lt;= 0)</div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;          {</div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;            rbin = 0;</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;            rcell = 0;</div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;          }</div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;          <span class="keywordflow">if</span> (rbin &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a7a8e3028b6f00782ef26683a18a9c351">nr_high</a>)</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;          {</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;            rbin = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a7a8e3028b6f00782ef26683a18a9c351">nr_high</a> - 1;</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;            rcell = 2;</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;          }</div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;</div>
<div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iphi = phi_startpoint; iphi &lt; phi_endpoint; iphi++)</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;          {</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;            <span class="comment">// no phi out-of-range checks since it&#39;s circular, but we provide ourselves a filtered version:</span></div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;            <span class="keywordtype">int</span> phiFilt = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">FilterPhiIndex</a>(iphi);</div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;            <span class="keywordtype">int</span> phibin = (iphi - ifphi) + phi_highres_dist;</div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;            <span class="keywordtype">int</span> phicell = 1;</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;            <span class="keywordflow">if</span> (phibin &lt;= 0)</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;            {</div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;              phibin = 0;</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;              phicell = 0;</div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;            }</div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;            <span class="keywordflow">if</span> (phibin &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8b33436d6a20d9698c3dd39db4ba3784">nphi_high</a>)</div>
<div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;            {</div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;              phibin = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8b33436d6a20d9698c3dd39db4ba3784">nphi_high</a> - 1;</div>
<div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;              phicell = 2;</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;            }</div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iz = z_startpoint; iz &lt; z_endpoint; iz++)</div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;            {</div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;              <span class="keywordflow">if</span> (iz &lt; 0)</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;              {</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;                iz = 0;</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;              }</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;              <span class="keywordflow">if</span> (iz &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>)</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;              {</div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;              }</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;              <span class="keywordtype">int</span> zbin = (iz - ifz) + z_highres_dist;</div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;              <span class="keywordtype">int</span> zcell = 1;</div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;              <span class="keywordflow">if</span> (zbin &lt;= 0)</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;              {</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;                zbin = 0;</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;                zcell = 0;</div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;              }</div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;              <span class="keywordflow">if</span> (zbin &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8594f9b21d7ab7f4938ae87793e79d1a">nz_high</a>)</div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;              {</div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;                zbin = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8594f9b21d7ab7f4938ae87793e79d1a">nz_high</a> - 1;</div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;                zcell = 2;</div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;              }</div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;              <span class="comment">//&#39;from&#39; is in absolute coordinates</span></div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;              from = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9c93ebfb51787f51897612bf70cdc9fa">GetCellCenter</a>(ir, phiFilt, iz);</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;</div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;              nfbinsin[rcell][phicell][zcell]++;</div>
<div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;              <span class="keywordtype">int</span> <a class="code" href="../../db/ddd/namespaceJetscape.html#a982f7291b4b6c10573f7633c951ff0b4">nf</a> = nfbinsin[rcell][phicell][zcell];</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;              <span class="comment">// coordinates relative to the region of interest:</span></div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;              <span class="keywordtype">int</span> ir_rel = ifr - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>;</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;              <span class="keywordtype">int</span> iphi_rel = ifphi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>;</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;              <span class="keywordtype">int</span> iz_rel = ifz - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>;</div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;              <span class="keywordflow">if</span> (zcell != 1 || rcell != 1 || phicell != 1)</div>
<div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;              {</div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;                <span class="comment">// we&#39;re not in the center, so deal with our weird shapes by averaging:</span></div>
<div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;                <span class="comment">// but Epartial is in coordinates relative to the roi</span></div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;                <span class="keywordflow">if</span> (iphi_rel &lt; 0)</div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;                {</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;                  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;%d: Getting with phi=%d\n&quot;</span>, __LINE__, iphi_rel);</div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;                }</div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;                currentf = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa8a5aed287dd1ad723d2f897c61fc08c">Epartial_highres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(ir_rel, iphi_rel, iz_rel, rbin, phibin, zbin);</div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;                <span class="comment">// to keep this as the average, we multiply what&#39;s there back to its initial summed-but-not-divided value</span></div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;                <span class="comment">// then add our new value, and the divide the new sum by the total number of cells</span></div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;                newf = (currentf * (nf - 1) + <a class="code" href="../../de/d64/classAnnularFieldSim.html#aba83c13891c05b283eebd23b347a8c2b">calc_unit_field</a>(at, from)) * (1 / (nf * 1.0));</div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;                <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa8a5aed287dd1ad723d2f897c61fc08c">Epartial_highres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a0cf24ea8c5d6c9ae66222d7e32957890">Set</a>(ir_rel, iphi_rel, iz_rel, rbin, phibin, zbin, newf);</div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;              }</div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;              {</div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;                <span class="comment">// we&#39;re in the center cell, which means any f-bin that&#39;s not on the outer edge of our region:</span></div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;                <span class="comment">// calc_unit_field will return zero when at=from, so the center will be automatically zero here.</span></div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;                <span class="keywordflow">if</span> (ifr == rbin &amp;&amp; ifphi == phibin &amp;&amp; ifz == zbin)</div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;                {</div>
<div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;                  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa8a5aed287dd1ad723d2f897c61fc08c">Epartial_highres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a0cf24ea8c5d6c9ae66222d7e32957890">Set</a>(ir_rel, iphi_rel, iz_rel, rbin, phibin, zbin, zero);</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;                }</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;                {  <span class="comment">// for extra carefulness, only calc the field if it&#39;s not self-to-self.</span></div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;                  newf = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aba83c13891c05b283eebd23b347a8c2b">calc_unit_field</a>(at, from);</div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;                  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa8a5aed287dd1ad723d2f897c61fc08c">Epartial_highres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a0cf24ea8c5d6c9ae66222d7e32957890">Set</a>(ir_rel, iphi_rel, iz_rel, rbin, phibin, zbin, newf);</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;                }</div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;              }</div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;            }</div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;          }</div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;        }</div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;      }</div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;    }</div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;  }</div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;}</div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;</div>
<div class="line"><a name="l01645"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a8fcaff1d1d774fba15565f6990077ea0"> 1645</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8fcaff1d1d774fba15565f6990077ea0">AnnularFieldSim::populate_lowres_lookup</a>()</div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;{</div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;  TVector3 <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a6c8403cf1f00f8d2746f9fe1da683802">at</a>(1, 0, 0);</div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;  TVector3 from(1, 0, 0);</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;  TVector3 <a class="code" href="../../d7/da4/namespaceKFPMath.html#a6025b2360c1c0f5710e7341037ac9d39">zero</a>(0, 0, 0);</div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;  <span class="keywordtype">int</span> fphi_low, fphi_high, fz_low, fz_high;             <span class="comment">// edges of the outer l-bin</span></div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;  <span class="keywordtype">int</span> r_low, r_high, phi_low, phi_high, z_low, z_high;  <span class="comment">// edges of the inner l-bin</span></div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;</div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;  <span class="comment">// todo:  add in handling if roi_low is wrap-around in phi</span></div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifr = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a0414585861f707dd518182800e0beaa3">rmin_roi_low</a>; ifr &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2057ffce5f05b54a5713b4b1e5641309">rmax_roi_low</a>; ifr++)</div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;  {</div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;    <span class="keywordtype">int</span> fr_low = ifr * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3e84c61c56134d72992b940a889f297c">r_spacing</a>;</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;    <span class="keywordtype">int</span> fr_high = fr_low + r_spacing - 1;</div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;    <span class="keywordflow">if</span> (fr_high &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>)</div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;    {</div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;      fr_high = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a> - 1;</div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;    }</div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifphi = <a class="code" href="../../de/d64/classAnnularFieldSim.html#acabd7bc4c835302b2853feda70c52d05">phimin_roi_low</a>; ifphi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a18f3f677be3a854b1adf890dfa6dcd0e">phimax_roi_low</a>; ifphi++)</div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;    {</div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;      fphi_low = ifphi * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a09f972e6da20da4bd6508ea919a566d4">phi_spacing</a>;</div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;      fphi_high = fphi_low + phi_spacing - 1;</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;      <span class="keywordflow">if</span> (fphi_high &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>)</div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;      {</div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;        fphi_high = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a> - 1;  <span class="comment">// if our phi l-bins aren&#39;t evenly spaced, we need to catch that here.</span></div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;      }</div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifz = <a class="code" href="../../de/d64/classAnnularFieldSim.html#acc4cbafa5dbfe53f721b469d52185d3c">zmin_roi_low</a>; ifz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#afc016b1bbc9692da21268868f51fc3fb">zmax_roi_low</a>; ifz++)</div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;      {</div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;        fz_low = ifz * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a90c13a6de122eaa34d8da6869b627104">z_spacing</a>;</div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;        fz_high = fz_low + z_spacing - 1;</div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;        <span class="keywordflow">if</span> (fz_high &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>)</div>
<div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;        {</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;          fz_high = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a> - 1;</div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;        }</div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;        at = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa3b4e8df7cf7fd8b70640312db83198e">GetGroupCellCenter</a>(fr_low, fr_high, fphi_low, fphi_high, fz_low, fz_high);</div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;        <span class="comment">// printf(&quot;ifr=%d, rlow=%d,rhigh=%d,r_spacing=%d\n&quot;,ifr,r_low,r_high,r_spacing);</span></div>
<div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;        <span class="comment">// if(debugFlag())        printf(&quot;%d: AnnularFieldSim::populate_lowres_lookup icell=(%d,%d,%d)\n&quot;,__LINE__,ifr,ifphi,ifz);</span></div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ior = 0; ior &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#af6be58ea3979a6278bff906c943ea4a3">nr_low</a>; ior++)</div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;        {</div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;          r_low = ior * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3e84c61c56134d72992b940a889f297c">r_spacing</a>;</div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;          r_high = r_low + r_spacing - 1;</div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;          <span class="keywordtype">int</span> ir_rel = ifr - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a0414585861f707dd518182800e0beaa3">rmin_roi_low</a>;</div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;          <span class="keywordflow">if</span> (r_high &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>)</div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;          {</div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;            r_high = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a> - 1;</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;          }</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iophi = 0; iophi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#aed089501f43e4a12141981e52af26519">nphi_low</a>; iophi++)</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;          {</div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;            phi_low = iophi * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a09f972e6da20da4bd6508ea919a566d4">phi_spacing</a>;</div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;            phi_high = phi_low + phi_spacing - 1;</div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;            <span class="keywordflow">if</span> (phi_high &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>)</div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;            {</div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;              phi_high = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a> - 1;</div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;            }</div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;            <span class="keywordtype">int</span> iphi_rel = ifphi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#acabd7bc4c835302b2853feda70c52d05">phimin_roi_low</a>;</div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ioz = 0; ioz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9bdbb31e591c81d45912efa73fce654">nz_low</a>; ioz++)</div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;            {</div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;              z_low = ioz * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a90c13a6de122eaa34d8da6869b627104">z_spacing</a>;</div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;              z_high = z_low + z_spacing - 1;</div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;              <span class="keywordflow">if</span> (z_high &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>)</div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;              {</div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;                z_high = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a> - 1;</div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;              }</div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;              <span class="keywordtype">int</span> iz_rel = ifz - <a class="code" href="../../de/d64/classAnnularFieldSim.html#acc4cbafa5dbfe53f721b469d52185d3c">zmin_roi_low</a>;</div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;              from = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa3b4e8df7cf7fd8b70640312db83198e">GetGroupCellCenter</a>(r_low, r_high, phi_low, phi_high, z_low, z_high);</div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;</div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;              <span class="keywordflow">if</span> (ifr == ior &amp;&amp; ifphi == iophi &amp;&amp; ifz == ioz)</div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;              {</div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;                <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa4cc4892f9e2ca6b8ce07383fb1897f6">Epartial_lowres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a0cf24ea8c5d6c9ae66222d7e32957890">Set</a>(ir_rel, iphi_rel, iz_rel, ior, iophi, ioz, zero);</div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;              }</div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;              <span class="keywordflow">else</span></div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;              {  <span class="comment">// for extra carefulness, only calc the field if it&#39;s not self-to-self.</span></div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;                <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa4cc4892f9e2ca6b8ce07383fb1897f6">Epartial_lowres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a0cf24ea8c5d6c9ae66222d7e32957890">Set</a>(ir_rel, iphi_rel, iz_rel, ior, iophi, ioz, <a class="code" href="../../de/d64/classAnnularFieldSim.html#aba83c13891c05b283eebd23b347a8c2b">calc_unit_field</a>(at, from));</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;              }</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;</div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;              <span class="comment">//*f[ifx][ify][ifz][iox][ioy][ioz]=cacl_unit_field(at,from);</span></div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;              <span class="comment">// printf(&quot;calc_unit_field...\n&quot;);</span></div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;              <span class="comment">// this calc&#39;s okay.</span></div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;            }</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;          }</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;        }</div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;      }</div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;    }</div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;  }</div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;}</div>
<div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;</div>
<div class="line"><a name="l01733"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a266e4d2f962db9ca8c4ff25d6a34a574"> 1733</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a266e4d2f962db9ca8c4ff25d6a34a574">AnnularFieldSim::populate_phislice_lookup</a>()</div>
<div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;{</div>
<div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;  <span class="comment">// with &#39;f&#39; being the position the field is being measured at, and &#39;o&#39; being the position of the charge generating the field.</span></div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;  <span class="comment">// remember the &#39;f&#39; part of Epartial uses relative indices.</span></div>
<div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;  <span class="comment">//   TVector3 (*f)[fx][fy][fz][ox][oy][oz]=field_;</span></div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;populating phislice  lookup for (%dx%dx%d)x(%dx%dx%d) grid\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, 1, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>);</div>
<div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> totalelements = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>;  <span class="comment">// nr*nphi*nz*nr_roi*nz_roi</span></div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>;</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>;</div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>;</div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>;  <span class="comment">// breaking up this multiplication prevents a 32bit math overflow</span></div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> percent = totalelements / 100 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a>;</div>
<div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;total elements = %llu\n&quot;</span>, totalelements);</div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;  TVector3 <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a6c8403cf1f00f8d2746f9fe1da683802">at</a>(1, 0, 0);</div>
<div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;  TVector3 from(1, 0, 0);</div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;  TVector3 <a class="code" href="../../d7/da4/namespaceKFPMath.html#a6025b2360c1c0f5710e7341037ac9d39">zero</a>(0, 0, 0);</div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;</div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;  <span class="keywordtype">int</span> el = 0;</div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifr = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>; ifr &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a>; ifr++)</div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;  {</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ifz = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>; ifz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a>; ifz++)</div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;    {</div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;      at = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9c93ebfb51787f51897612bf70cdc9fa">GetCellCenter</a>(ifr, 0, ifz);</div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ior = 0; ior &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>; ior++)</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;      {</div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iophi = 0; iophi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>; iophi++)</div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;        {</div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ioz = 0; ioz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>; ioz++)</div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;          {</div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;            el++;</div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;            from = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9c93ebfb51787f51897612bf70cdc9fa">GetCellCenter</a>(ior, iophi, ioz);</div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;            <span class="comment">//*f[ifx][ify][ifz][iox][ioy][ioz]=cacl_unit_field(at,from);</span></div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;            <span class="comment">// printf(&quot;calc_unit_field...\n&quot;);</span></div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;            <span class="keywordflow">if</span> (ifr == ior &amp;&amp; 0 == iophi &amp;&amp; ifz == ioz)</div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;            {</div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;              <span class="keywordflow">if</span> (!(el % percent))</div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;              {</div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;                <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;populate_phislice_lookup %d%%:  &quot;</span>, (<span class="keywordtype">int</span>) (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a> * el / percent));</div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;                <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;self-to-self is zero (ir=%d,iphi=%d,iz=%d) to (or=%d,ophi=0,oz=%d) gives (%E,%E,%E)\n&quot;</span>,</div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;                       ior, iophi, ioz, ifr, ifz, zero.X(), zero.Y(), zero.Z());</div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;              }</div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;              <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a0cf24ea8c5d6c9ae66222d7e32957890">Set</a>(ifr - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, 0, ifz - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>, ior, iophi, ioz, zero);</div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;            }</div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;            {</div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;              TVector3 unitf = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aba83c13891c05b283eebd23b347a8c2b">calc_unit_field</a>(at, from);</div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;              <span class="keywordflow">if</span> (<span class="keyword">true</span>)</div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;              {</div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;                <span class="keywordflow">if</span> (!(el % percent))</div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;                {</div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;                  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;populate_phislice_lookup %d%%:  &quot;</span>, (<span class="keywordtype">int</span>) (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a> * el / percent));</div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;                  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;calc_unit_field (ir=%d,iphi=%d,iz=%d) to (or=%d,ophi=0,oz=%d) gives (%E,%E,%E)\n&quot;</span>,</div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;                         ior, iophi, ioz, ifr, ifz, unitf.X(), unitf.Y(), unitf.Z());</div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;                }</div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;              }</div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;</div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;              <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a0cf24ea8c5d6c9ae66222d7e32957890">Set</a>(ifr - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, 0, ifz - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>, ior, iophi, ioz, unitf);  <span class="comment">// the origin phi is relative to zero anyway.</span></div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;            }</div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;          }</div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;        }</div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;      }</div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;    }</div>
<div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;  }</div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;}</div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;</div>
<div class="line"><a name="l01799"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a621d21e9eeffb1498dd4b863d96f2566"> 1799</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a621d21e9eeffb1498dd4b863d96f2566">AnnularFieldSim::load_phislice_lookup</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sourcefile)</div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;{</div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;loading phislice  lookup for (%dx%dx%d)x(%dx%dx%d) grid from %s\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, 1, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>, sourcefile);</div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> totalelements = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>;  <span class="comment">// nr*nphi*nz*nr_roi*nz_roi</span></div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>;</div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>;</div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>;</div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>;  <span class="comment">// breaking up this multiplication prevents a 32bit math overflow</span></div>
<div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> percent = totalelements / 100 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a>;</div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;total elements = %llu\n&quot;</span>, totalelements);</div>
<div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;</div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;  TFile *<a class="code" href="../../dd/df3/namespacedigitization__config.html#ad5a5b3ef1d5c1a4830aa32b02920f70b">input</a> = TFile::Open(sourcefile, <span class="stringliteral">&quot;READ&quot;</span>);</div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;  TTree *tInfo;</div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;  input-&gt;GetObject(<span class="stringliteral">&quot;info&quot;</span>, tInfo);</div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;  <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(tInfo);</div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;  <span class="keywordtype">float</span> file_rmin, file_rmax, file_zmin, file_zmax;</div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;  <span class="keywordtype">int</span> file_rmin_roi, file_rmax_roi, file_zmin_roi, file_zmax_roi;</div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;  <span class="keywordtype">int</span> file_nr, file_np, file_nz;</div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;  tInfo-&gt;SetBranchAddress(<span class="stringliteral">&quot;rmin&quot;</span>, &amp;file_rmin);</div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;  tInfo-&gt;SetBranchAddress(<span class="stringliteral">&quot;rmax&quot;</span>, &amp;file_rmax);</div>
<div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;  tInfo-&gt;SetBranchAddress(<span class="stringliteral">&quot;zmin&quot;</span>, &amp;file_zmin);</div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;  tInfo-&gt;SetBranchAddress(<span class="stringliteral">&quot;zmax&quot;</span>, &amp;file_zmax);</div>
<div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;  tInfo-&gt;SetBranchAddress(<span class="stringliteral">&quot;rmin_roi_index&quot;</span>, &amp;file_rmin_roi);</div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;  tInfo-&gt;SetBranchAddress(<span class="stringliteral">&quot;rmax_roi_index&quot;</span>, &amp;file_rmax_roi);</div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;  tInfo-&gt;SetBranchAddress(<span class="stringliteral">&quot;zmin_roi_index&quot;</span>, &amp;file_zmin_roi);</div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;  tInfo-&gt;SetBranchAddress(<span class="stringliteral">&quot;zmax_roi_index&quot;</span>, &amp;file_zmax_roi);</div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;  tInfo-&gt;SetBranchAddress(<span class="stringliteral">&quot;nr&quot;</span>, &amp;file_nr);</div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;  tInfo-&gt;SetBranchAddress(<span class="stringliteral">&quot;nphi&quot;</span>, &amp;file_np);</div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;  tInfo-&gt;SetBranchAddress(<span class="stringliteral">&quot;nz&quot;</span>, &amp;file_nz);</div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;  tInfo-&gt;GetEntry(0);</div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;</div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;param\tobj\tfile\n&quot;</span>);</div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;nr\t%d\t%d\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, file_nr);</div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;np\t%d\t%d\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, file_np);</div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;nz\t%d\t%d\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>, file_nz);</div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;rmin\t%2.2f\t%2.2f\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>, file_rmin);</div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;rmax\t%2.2f\t%2.2f\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a5b910d33cbf61449e7b78071d2403ec2">rmax</a>, file_rmax);</div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;zmin\t%2.2f\t%2.2f\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>, file_zmin);</div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;zmax\t%2.2f\t%2.2f\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a>, file_zmax);</div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;rmin_roi\t%d\t%d\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, file_rmin_roi);</div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;rmax_roi\t%d\t%d\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a>, file_rmax_roi);</div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;zmin_roi\t%d\t%d\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>, file_zmin_roi);</div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;zmax_roi\t%d\t%d\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a>, file_zmax_roi);</div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;</div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;  <span class="keywordflow">if</span> (file_rmin != <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a> || file_rmax != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a5b910d33cbf61449e7b78071d2403ec2">rmax</a> ||</div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;      file_zmin != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a> || file_zmax != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a> ||</div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;      file_rmin_roi != <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a> || file_rmax_roi != <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a> ||</div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;      file_zmin_roi != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a> || file_zmax_roi != <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a> ||</div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;      file_nr != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a> || file_np != <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a> || file_nz != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>)</div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;  {</div>
<div class="line"><a name="l01850"></a><span class="lineno"> 1850</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;file parameters do not match fieldsim parameters:\n&quot;</span>);</div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;</div>
<div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 4);</div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;  }</div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;</div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;  TTree *tLookup;</div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;  input-&gt;GetObject(<span class="stringliteral">&quot;phislice&quot;</span>, tLookup);</div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;  <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(tLookup);</div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;  <span class="keywordtype">int</span> ior, ifr, iophi, ioz, ifz;</div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;  TVector3 *unitf = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;  tLookup-&gt;SetBranchAddress(<span class="stringliteral">&quot;ir_source&quot;</span>, &amp;ior);</div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;  tLookup-&gt;SetBranchAddress(<span class="stringliteral">&quot;ir_target&quot;</span>, &amp;ifr);</div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;  tLookup-&gt;SetBranchAddress(<span class="stringliteral">&quot;ip_source&quot;</span>, &amp;iophi);</div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;  <span class="comment">// always zero: tLookup-&gt;SetBranchAddress(&quot;ip_target&quot;,&amp;ifphi);</span></div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;  tLookup-&gt;SetBranchAddress(<span class="stringliteral">&quot;iz_source&quot;</span>, &amp;ioz);</div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;  tLookup-&gt;SetBranchAddress(<span class="stringliteral">&quot;iz_target&quot;</span>, &amp;ifz);</div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;  tLookup-&gt;SetBranchAddress(<span class="stringliteral">&quot;Evec&quot;</span>, &amp;unitf);  <span class="comment">// assume field has units V/(C*cm)</span></div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;</div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;  <span class="keywordtype">int</span> el = 0;</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;%s has %lld entries\n&quot;</span>, sourcefile, tLookup-&gt;GetEntries());</div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; (int) totalelements; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;  {</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;    el++;</div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;    tLookup-&gt;GetEntry(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>);</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;    <span class="comment">// printf(&quot;loading i=%d\n&quot;,i);</span></div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a0cf24ea8c5d6c9ae66222d7e32957890">Set</a>(ifr - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, 0, ifz - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>, ior, iophi, ioz, (*unitf) * (-1.0) * (<a class="code" href="../../de/d64/classAnnularFieldSim.html#add22fc45f5d33e13cfc422f3e8c8c997">V</a> / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3122217cae55b22ab3c6b157cd96b695">C</a>)));  <span class="comment">// load assuming field has units V/(C*cm), which is how we save it.</span></div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;    <span class="comment">// note that we save the gradient terms, not the field, hence we need to multiply by (-1.0)</span></div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;    <span class="keywordflow">if</span> (!(el % percent))</div>
<div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;    {</div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;      <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;load_phislice_lookup %d%%:  &quot;</span>, (<span class="keywordtype">int</span>) (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a> * el / percent));</div>
<div class="line"><a name="l01880"></a><span class="lineno"> 1880</span>&#160;      <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;field from (ir=%d,iphi=%d,iz=%d) to (or=%d,ophi=0,oz=%d) is (%E,%E,%E)\n&quot;</span>,</div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;             ior, iophi, ioz, ifr, ifz, unitf-&gt;X(), unitf-&gt;Y(), unitf-&gt;Z());</div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;    }</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;  }</div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;</div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;  input-&gt;Close();</div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;}</div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;</div>
<div class="line"><a name="l01889"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a72c5541a42b26e81855bac886333959b"> 1889</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a72c5541a42b26e81855bac886333959b">AnnularFieldSim::save_phislice_lookup</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *destfile)</div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;{</div>
<div class="line"><a name="l01891"></a><span class="lineno"> 1891</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;saving phislice  lookup for (%dx%dx%d)x(%dx%dx%d) grid to %s\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, 1, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>, destfile);</div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> totalelements = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>;  <span class="comment">// nr*nphi*nz*nr_roi*nz_roi</span></div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>;</div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>;</div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>;</div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;  totalelements *= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>;  <span class="comment">// breaking up this multiplication prevents a 32bit math overflow</span></div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> percent = totalelements / 100 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a>;</div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;total elements = %llu\n&quot;</span>, totalelements);</div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;</div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;  TFile *<a class="code" href="../../d2/df6/namespacecheck__smearing__config.html#adc0dbfc5cf78f15f015518ea94eb2cbb">output</a> = TFile::Open(destfile, <span class="stringliteral">&quot;RECREATE&quot;</span>);</div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;  output-&gt;cd();</div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;</div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;  TTree *tInfo = <span class="keyword">new</span> TTree(<span class="stringliteral">&quot;info&quot;</span>, <span class="stringliteral">&quot;Information about Lookup Table&quot;</span>);</div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;  tInfo-&gt;Branch(<span class="stringliteral">&quot;rmin&quot;</span>, &amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>);</div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;  tInfo-&gt;Branch(<span class="stringliteral">&quot;rmax&quot;</span>, &amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a5b910d33cbf61449e7b78071d2403ec2">rmax</a>);</div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;  tInfo-&gt;Branch(<span class="stringliteral">&quot;zmin&quot;</span>, &amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>);</div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;  tInfo-&gt;Branch(<span class="stringliteral">&quot;zmax&quot;</span>, &amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a>);</div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;  tInfo-&gt;Branch(<span class="stringliteral">&quot;rmin_roi_index&quot;</span>, &amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>);</div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;  tInfo-&gt;Branch(<span class="stringliteral">&quot;rmax_roi_index&quot;</span>, &amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a>);</div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;  tInfo-&gt;Branch(<span class="stringliteral">&quot;zmin_roi_index&quot;</span>, &amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>);</div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;  tInfo-&gt;Branch(<span class="stringliteral">&quot;zmax_roi_index&quot;</span>, &amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a>);</div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;  tInfo-&gt;Branch(<span class="stringliteral">&quot;nr&quot;</span>, &amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>);</div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;  tInfo-&gt;Branch(<span class="stringliteral">&quot;nphi&quot;</span>, &amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>);</div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;  tInfo-&gt;Branch(<span class="stringliteral">&quot;nz&quot;</span>, &amp;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>);</div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160;  tInfo-&gt;Fill();</div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;info tree built.\n&quot;</span>);</div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;</div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;  TTree *tLookup = <span class="keyword">new</span> TTree(<span class="stringliteral">&quot;phislice&quot;</span>, <span class="stringliteral">&quot;Phislice Lookup Table&quot;</span>);</div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;  <span class="keywordtype">int</span> ior, ifr, iophi, ioz, ifz;</div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;  TVector3 unitf;</div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;  tLookup-&gt;Branch(<span class="stringliteral">&quot;ir_source&quot;</span>, &amp;ior);</div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;  tLookup-&gt;Branch(<span class="stringliteral">&quot;ir_target&quot;</span>, &amp;ifr);</div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;  tLookup-&gt;Branch(<span class="stringliteral">&quot;ip_source&quot;</span>, &amp;iophi);</div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;  <span class="comment">// always zero: tLookup-&gt;Branch(&quot;ip_target&quot;,&amp;ifphi);</span></div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;  tLookup-&gt;Branch(<span class="stringliteral">&quot;iz_source&quot;</span>, &amp;ioz);</div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;  tLookup-&gt;Branch(<span class="stringliteral">&quot;iz_target&quot;</span>, &amp;ifz);</div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;  tLookup-&gt;Branch(<span class="stringliteral">&quot;Evec&quot;</span>, &amp;unitf);</div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;lookup tree built.\n&quot;</span>);</div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;</div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;  <span class="keywordtype">int</span> el = 0;</div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;  <span class="keywordflow">for</span> (ifr = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>; ifr &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a>; ifr++)</div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;  {</div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;    <span class="keywordflow">for</span> (ifz = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>; ifz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a>; ifz++)</div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;    {</div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;      <span class="keywordflow">for</span> (ior = 0; ior &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>; ior++)</div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;      {</div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;        <span class="keywordflow">for</span> (iophi = 0; iophi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>; iophi++)</div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;        {</div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;          <span class="keywordflow">for</span> (ioz = 0; ioz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>; ioz++)</div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;          {</div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;            el++;</div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;            unitf = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(ifr - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, 0, ifz - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>, ior, iophi, ioz) * (-1 / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#add22fc45f5d33e13cfc422f3e8c8c997">V</a> / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a3122217cae55b22ab3c6b157cd96b695">C</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>)));  <span class="comment">// save in units of V/(C*cm) note that we introduce a -1 here for legcy reasons.</span></div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;            <span class="keywordflow">if</span> (<span class="keyword">true</span>)</div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;            {</div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;              <span class="keywordflow">if</span> (!(el % percent))</div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;              {</div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;                <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;save_phislice_lookup %d%%:  &quot;</span>, (<span class="keywordtype">int</span>) (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a> * el / percent));</div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;                <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;field from (ir=%d,iphi=%d,iz=%d) to (or=%d,ophi=0,oz=%d) is (%E,%E,%E)\n&quot;</span>,</div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;                       ior, iophi, ioz, ifr, ifz, unitf.X(), unitf.Y(), unitf.Z());</div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;              }</div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;            }</div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;</div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;            tLookup-&gt;Fill();</div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;          }</div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;        }</div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;      }</div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;    }</div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;  }</div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;  output-&gt;cd();</div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;  tInfo-&gt;Write();</div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;  tLookup-&gt;Write();</div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;  <span class="comment">// output-&gt;Write();</span></div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;  output-&gt;Close();</div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;}</div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;</div>
<div class="line"><a name="l01967"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#ab9f595e36e6c7af8568afdace7fea051"> 1967</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab9f595e36e6c7af8568afdace7fea051">AnnularFieldSim::setFlatFields</a>(<span class="keywordtype">float</span> B, <span class="keywordtype">float</span> <a class="code" href="../../dc/d43/Proto2ShowerCalibFit_8m.html#a93b7cb110b782e59ebd44f83181b9e0e" title="Modifier of energy of the particle, fP[6].">E</a>)</div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;{</div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;  <span class="comment">// these only cover the roi, but since we address them flat, we don&#39;t need to know that here.</span></div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::setFlatFields(B=%f Tesla,E=%f V/cm)\n&quot;</span>, B, E);</div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;lengths:  Eext=%d, Bfie=%d\n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#aedd910db5278318b852bfc65ca976cf6">Eexternal</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a724a354269ec724f79ab24f2c9210c28">Length</a>(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a724a354269ec724f79ab24f2c9210c28">Length</a>());</div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;  <span class="keywordtype">char</span> fieldstr[100];</div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;  sprintf(fieldstr, <span class="stringliteral">&quot;%f&quot;</span>, E);</div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#aee246a62e470501dc809be946330f11c">Efieldname</a> = <span class="stringliteral">&quot;E:Flat:&quot;</span> + <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a8e8ff5b11e64078831112677156cb111">std::string</a>(fieldstr);</div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;  sprintf(fieldstr, <span class="stringliteral">&quot;%f&quot;</span>, B);</div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab032b553e141c1a6add587c42458f347">Bfieldname</a> = <span class="stringliteral">&quot;B:Flat:&quot;</span> + <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a8e8ff5b11e64078831112677156cb111">std::string</a>(fieldstr);</div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;</div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a517b31827f7563eeb6c9c54182b5655e">Enominal</a> = E * (<a class="code" href="../../de/d64/classAnnularFieldSim.html#add22fc45f5d33e13cfc422f3e8c8c997">V</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>);</div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace424fdd41ee18b156ca4356cdfa736e">Bnominal</a> = B * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad3398b737ec329b9f9dca579bf123bb0">Tesla</a>;</div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#aedd910db5278318b852bfc65ca976cf6">Eexternal</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a724a354269ec724f79ab24f2c9210c28">Length</a>(); <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;  {</div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#aedd910db5278318b852bfc65ca976cf6">Eexternal</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>)-&gt;SetXYZ(0, 0, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a517b31827f7563eeb6c9c54182b5655e">Enominal</a>);</div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;  }</div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a724a354269ec724f79ab24f2c9210c28">Length</a>(); <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;  {</div>
<div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>)-&gt;SetXYZ(0, 0, Bnominal);</div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;  }</div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a5dc85e1b1849249dd359df0a32bd907c">UpdateOmegaTau</a>();</div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160;}</div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;</div>
<div class="line"><a name="l01992"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a7e5bfbb3d32ab1733d1fa653cdacbc1b"> 1992</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#a7e5bfbb3d32ab1733d1fa653cdacbc1b">AnnularFieldSim::sum_field_at</a>(<span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <span class="keywordtype">int</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>)</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;{</div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;  <span class="comment">// sum the E field over all nr by ny by nz cells of sources, at the global coordinate position r,phi,z.</span></div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;  <span class="comment">// note the specific position in Epartial is in relative coordinates.</span></div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;  <span class="comment">//  if(debugFlag()) printf(&quot;%d: AnnularFieldSim::sum_field_at(r=%d,phi=%d, z=%d)\n&quot;,__LINE__,r,phi,z);</span></div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160;</div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;<span class="comment">    for the near future:</span></div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;<span class="comment">  TVector3 sum=(sum_local_field_at(r, phi, z)</span></div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;<span class="comment">                + sum_nonlocal_field_at(r,phi,z)</span></div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;<span class="comment">                + Escale*Eexternal-&gt;Get(r-rmin_roi,phi-phimin_roi,z-zmin_roi));</span></div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;<span class="comment">  return sum;</span></div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;</div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160;  TVector3 <a class="code" href="../../da/d55/TPCRateLayered_8m.html#a7507ef556477c204b499f1e189d40796">sum</a>(0, 0, 0);</div>
<div class="line"><a name="l02007"></a><span class="lineno"> 2007</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912ac20b14fd6f49ea685f1efa42313344cf">Full3D</a>)</div>
<div class="line"><a name="l02008"></a><span class="lineno"> 2008</span>&#160;  {</div>
<div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;    sum += <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaada41d72ff17cae02000b4bc9e4be15">sum_full3d_field_at</a>(r, phi, z);</div>
<div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;  }</div>
<div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912ab2ebc633d33ad7912d9290d256ea4819">HybridRes</a>)</div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160;  {</div>
<div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;    sum += <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad135dd5ff342110147544f8032671fb4">sum_local_field_at</a>(r, phi, z);</div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;    sum += <a class="code" href="../../de/d64/classAnnularFieldSim.html#a526ad468319e05b2cdbb37569c496048">sum_nonlocal_field_at</a>(r, phi, z);</div>
<div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;  }</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912aa9a7b26da725426bb440409274d09ca5">PhiSlice</a>)</div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;  {</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;    sum += <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4a7d310d527ef4d9b7ba5a986b996317">sum_phislice_field_at</a>(r, phi, z);</div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;  }</div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912afd1a80e709f9494e2123081ec7d33f90">Analytic</a>)</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;  {</div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;    sum += <a class="code" href="../../de/d64/classAnnularFieldSim.html#a843b7f4bccc385bb048c9a643a986582">aliceModel</a>-&gt;<a class="code" href="../../df/d10/classAnalyticFieldModel.html#a11b634b36f8be57e2785b180f149ba45">E</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a9c93ebfb51787f51897612bf70cdc9fa">GetCellCenter</a>(r, phi, z));</div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;  }</div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace93c2ce22b87fc89172a3f0df484912af7578ea26890f328d41266f6216e723a">NoLookup</a>)</div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;  {</div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;    <span class="comment">// do nothing.  We are forcibly assuming E from spacecharge is zero everywhere.</span></div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;  }</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;  sum += <a class="code" href="../../de/d64/classAnnularFieldSim.html#aedd910db5278318b852bfc65ca976cf6">Eexternal</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(r - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, phi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, z - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>);</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a41c47c61e74d8b39455b96b09890acba">debugFlag</a>())</div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;  {</div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;summed field at (%d,%d,%d)=(%f,%f,%f)\n&quot;</span>, r, phi, z, sum.X(), sum.Y(), sum.Z());</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;  }</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../da/d55/TPCRateLayered_8m.html#a7507ef556477c204b499f1e189d40796">sum</a>;</div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;}</div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;</div>
<div class="line"><a name="l02037"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#aaada41d72ff17cae02000b4bc9e4be15"> 2037</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaada41d72ff17cae02000b4bc9e4be15">AnnularFieldSim::sum_full3d_field_at</a>(<span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <span class="keywordtype">int</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>)</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;{</div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;  <span class="comment">// sum the E field over all nr by ny by nz cells of sources, at the specific position r,phi,z.</span></div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;  <span class="comment">// note the specific position in Epartial is in relative coordinates.</span></div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;  <span class="comment">// printf(&quot;AnnularFieldSim::sum_field_at(r=%d,phi=%d, z=%d)\n&quot;,r,phi,z);</span></div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;  TVector3 <a class="code" href="../../da/d55/TPCRateLayered_8m.html#a7507ef556477c204b499f1e189d40796">sum</a>(0, 0, 0);</div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160;  <span class="keywordtype">float</span> rdist, phidist, zdist, remdist;</div>
<div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ir = 0; ir &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>; ir++)</div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;  {</div>
<div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac8d43e1809336ebb1b7b3f97e04c17cf">truncation_length</a> &gt; 0)</div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;    {</div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;      rdist = abs(ir - r);</div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;      remdist = sqrt(<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac8d43e1809336ebb1b7b3f97e04c17cf">truncation_length</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac8d43e1809336ebb1b7b3f97e04c17cf">truncation_length</a> - rdist * rdist);</div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;      <span class="keywordflow">if</span> (remdist &lt; 0)</div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;      {</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;        <span class="keywordflow">continue</span>;  <span class="comment">// skip if we&#39;re too far away</span></div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;      }</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;    }</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iphi = 0; iphi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>; iphi++)</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;    {</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac8d43e1809336ebb1b7b3f97e04c17cf">truncation_length</a> &gt; 0)</div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;      {</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;        phidist = fmin(abs(iphi - phi), abs(abs(iphi - phi) - nphi));  <span class="comment">// think about this in phi... rcc food for thought.</span></div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;        remdist = sqrt(<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac8d43e1809336ebb1b7b3f97e04c17cf">truncation_length</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac8d43e1809336ebb1b7b3f97e04c17cf">truncation_length</a> - phidist * phidist);</div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;        <span class="keywordflow">if</span> (remdist &lt; 0)</div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;        {</div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;          <span class="keywordflow">continue</span>;  <span class="comment">// skip if we&#39;re too far away</span></div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;        }</div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;      }</div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iz = 0; iz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>; iz++)</div>
<div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;      {</div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac8d43e1809336ebb1b7b3f97e04c17cf">truncation_length</a> &gt; 0)</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;        {</div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;          zdist = abs(iz - z);</div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;          remdist = sqrt(<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac8d43e1809336ebb1b7b3f97e04c17cf">truncation_length</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac8d43e1809336ebb1b7b3f97e04c17cf">truncation_length</a> - zdist * zdist);</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;          <span class="keywordflow">if</span> (remdist &lt; 0)</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;          {</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;            <span class="keywordflow">continue</span>;  <span class="comment">// skip if we&#39;re too far away</span></div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;          }</div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;        }</div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;        <span class="comment">// sum+=*partial[x][phi][z][ix][iphi][iz] * *q[ix][iphi][iz];</span></div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;        <span class="keywordflow">if</span> (r == ir &amp;&amp; phi == iphi &amp;&amp; z == iz)</div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;        {</div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;          <span class="keywordflow">continue</span>;  <span class="comment">// dont&#39; compute self-to-self field.</span></div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;        }</div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;        sum += <a class="code" href="../../de/d64/classAnnularFieldSim.html#a12dd10a36307c5896ef633b5edf6d67d">Epartial</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(r - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, phi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, z - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>, ir, iphi, iz) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a002f26208e71c2e801523bd82a015f9e">q</a>-&gt;<a class="code" href="../../d4/d14/classChargeMapReader.html#a2abb6186153f2d2b740a356023e7d0b5">GetChargeInBin</a>(ir, iphi, iz);</div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;      }</div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;    }</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;  }</div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;  <span class="comment">// printf(&quot;summed field at (%d,%d,%d)=(%f,%f,%f)\n&quot;,x,y,z,sum.X(),sum.Y(),sum.Z());</span></div>
<div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../da/d55/TPCRateLayered_8m.html#a7507ef556477c204b499f1e189d40796">sum</a>;</div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;}</div>
<div class="line"><a name="l02089"></a><span class="lineno"> 2089</span>&#160;</div>
<div class="line"><a name="l02090"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#ad135dd5ff342110147544f8032671fb4"> 2090</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad135dd5ff342110147544f8032671fb4">AnnularFieldSim::sum_local_field_at</a>(<span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <span class="keywordtype">int</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>)</div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;{</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;  <span class="comment">// do the summation of the inner high-resolution region charges:</span></div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;  <span class="comment">//  bin 0  1 2 ...  n-2 n-1</span></div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;  <span class="comment">//   . . .|.|.|.|.|.|.|. . .</span></div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;  <span class="comment">//        | | | | | | |</span></div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;  <span class="comment">//   . . .|.|.|.|.|.|.|. . .</span></div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;  <span class="comment">//   -----+-+-+-+-+-+-+-----</span></div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;  <span class="comment">//   . . .|.|.|.|.|.|.|. . .</span></div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;  <span class="comment">//   -----+-+-+-+-+-+-+-----</span></div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;  <span class="comment">//   . . .|.|.|.|.|.|.|. . .</span></div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;  <span class="comment">//   -----+-+-+-+-+-+-+-----</span></div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;  <span class="comment">//   . . .|.|.|.|.|.|.|. . .</span></div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;  <span class="comment">//   -----+-+-+-+-+-+-+-----</span></div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;  <span class="comment">//   . . .|.|.|.|.|.|.|. . .</span></div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;  <span class="comment">//        | | | | | | |</span></div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;  <span class="comment">//   . . .|.|.|.|.|.|.|. . .</span></div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;</div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;  <span class="keywordtype">int</span> r_highres_dist = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a7a8e3028b6f00782ef26683a18a9c351">nr_high</a> - 1) / 2;</div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;  <span class="keywordtype">int</span> phi_highres_dist = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a8b33436d6a20d9698c3dd39db4ba3784">nphi_high</a> - 1) / 2;</div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;  <span class="keywordtype">int</span> z_highres_dist = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a8594f9b21d7ab7f4938ae87793e79d1a">nz_high</a> - 1) / 2;</div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;</div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;  <span class="keywordtype">int</span> r_parentlow = floor((r - r_highres_dist) / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a3e84c61c56134d72992b940a889f297c">r_spacing</a> * 1.0));       <span class="comment">// partly enclosed in our high-res region</span></div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;  <span class="keywordtype">int</span> r_parenthigh = floor((r + r_highres_dist) / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a3e84c61c56134d72992b940a889f297c">r_spacing</a> * 1.0)) + 1;  <span class="comment">// definitely not enclosed in our high-res region</span></div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;  <span class="keywordtype">int</span> phi_parentlow = floor((phi - phi_highres_dist) / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a09f972e6da20da4bd6508ea919a566d4">phi_spacing</a> * 1.0));</div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;  <span class="keywordtype">int</span> phi_parenthigh = floor((phi + phi_highres_dist) / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a09f972e6da20da4bd6508ea919a566d4">phi_spacing</a> * 1.0)) + 1;  <span class="comment">// note that this can be bigger than nphi!  We keep track of that.</span></div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;  <span class="keywordtype">int</span> z_parentlow = floor((z - z_highres_dist) / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a90c13a6de122eaa34d8da6869b627104">z_spacing</a> * 1.0));</div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;  <span class="keywordtype">int</span> z_parenthigh = floor((z + z_highres_dist) / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a90c13a6de122eaa34d8da6869b627104">z_spacing</a> * 1.0)) + 1;</div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::sum_local_field_at parents: rlow=%d,philow=%d,zlow=%d,rhigh=%d,phihigh=%d,zhigh=%d\n&quot;</span>, r_parentlow, phi_parentlow, z_parentlow, r_parenthigh, phi_parenthigh, z_parenthigh);</div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;</div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;  <span class="comment">// zero our current qlocal holder:</span></div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a17ab62844a52175c4b2439b1a6beb78e">q_local</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a724a354269ec724f79ab24f2c9210c28">Length</a>(); <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;  {</div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;    *(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a17ab62844a52175c4b2439b1a6beb78e">q_local</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a9600359f6801c3b0df50fad25beea350">GetFlat</a>(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>)) = 0;</div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;  }</div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;</div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;  <span class="comment">// get the charge involved in the local highres block:</span></div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ir = r_parentlow * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3e84c61c56134d72992b940a889f297c">r_spacing</a>; ir &lt; r_parenthigh * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3e84c61c56134d72992b940a889f297c">r_spacing</a>; ir++)</div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;  {</div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;    <span class="keywordflow">if</span> (ir &lt; 0)</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;    {</div>
<div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;      ir = 0;</div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;    }</div>
<div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;    <span class="keywordflow">if</span> (ir &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>)</div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;    {</div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;      <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;    }</div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;    <span class="keywordtype">int</span> rbin = (ir - <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>) + r_highres_dist;  <span class="comment">// index in our highres locale.  zeroth bin when we&#39;re at max distance below, etc.</span></div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;    <span class="keywordflow">if</span> (rbin &lt; 0)</div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;    {</div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;      rbin = 0;</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;    }</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;    <span class="keywordflow">if</span> (rbin &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a7a8e3028b6f00782ef26683a18a9c351">nr_high</a>)</div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;    {</div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;      rbin = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a7a8e3028b6f00782ef26683a18a9c351">nr_high</a> - 1;</div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;    }</div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iphi = phi_parentlow * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a09f972e6da20da4bd6508ea919a566d4">phi_spacing</a>; iphi &lt; phi_parenthigh * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a09f972e6da20da4bd6508ea919a566d4">phi_spacing</a>; iphi++)</div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;    {</div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;      <span class="comment">// no phi range checks since it&#39;s circular.</span></div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;      <span class="keywordtype">int</span> phiFilt = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">FilterPhiIndex</a>(iphi);</div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;      <span class="keywordtype">int</span> phibin = (iphi - <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>) + phi_highres_dist;</div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;      <span class="keywordflow">if</span> (phibin &lt; 0)</div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;      {</div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;        phibin = 0;</div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;      }</div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;      <span class="keywordflow">if</span> (phibin &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8b33436d6a20d9698c3dd39db4ba3784">nphi_high</a>)</div>
<div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;      {</div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;        phibin = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8b33436d6a20d9698c3dd39db4ba3784">nphi_high</a> - 1;</div>
<div class="line"><a name="l02161"></a><span class="lineno"> 2161</span>&#160;      }</div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iz = z_parentlow * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a90c13a6de122eaa34d8da6869b627104">z_spacing</a>; iz &lt; z_parenthigh * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a90c13a6de122eaa34d8da6869b627104">z_spacing</a>; iz++)</div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;      {</div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;        <span class="keywordflow">if</span> (iz &lt; 0)</div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;        {</div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;          iz = 0;</div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;        }</div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;        <span class="keywordflow">if</span> (iz &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>)</div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;        {</div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;          <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;        }</div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;        <span class="comment">// if(debugFlag()) printf(&quot;%d: AnnularFieldSim::sum_field_at, reading q in f-bin at(r=%d,phi=%d, z=%d)\n&quot;,__LINE__,ir,iphi,iz);</span></div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;</div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;        <span class="keywordtype">int</span> zbin = (iz - <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>) + z_highres_dist;</div>
<div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;        <span class="keywordflow">if</span> (zbin &lt; 0)</div>
<div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;        {</div>
<div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;          zbin = 0;</div>
<div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;        }</div>
<div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;        <span class="keywordflow">if</span> (zbin &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8594f9b21d7ab7f4938ae87793e79d1a">nz_high</a>)</div>
<div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;        {</div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;          zbin = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8594f9b21d7ab7f4938ae87793e79d1a">nz_high</a> - 1;</div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;        }</div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;        <span class="comment">// printf(&quot;filtering in local highres block\n&quot;);</span></div>
<div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;        <a class="code" href="../../de/d64/classAnnularFieldSim.html#a17ab62844a52175c4b2439b1a6beb78e">q_local</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#a33bbe655697ef0d6b52428f200869917">Add</a>(rbin, phibin, zbin, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a002f26208e71c2e801523bd82a015f9e">q</a>-&gt;<a class="code" href="../../d4/d14/classChargeMapReader.html#a2abb6186153f2d2b740a356023e7d0b5">GetChargeInBin</a>(ir, phiFilt, iz));</div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;        <span class="comment">// printf(&quot;done filtering in local highres block\n&quot;);</span></div>
<div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;      }</div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;    }</div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;  }</div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;</div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;  <span class="comment">// now q_highres is up to date for our current cell of interest.</span></div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;  <span class="comment">// start building our full sum by scaling the local lookup table by q.</span></div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;  <span class="comment">// note that the lookup table needs to have already accounted for cell centers.</span></div>
<div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;</div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;  TVector3 <a class="code" href="../../da/d55/TPCRateLayered_8m.html#a7507ef556477c204b499f1e189d40796">sum</a>(0, 0, 0);</div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;</div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;  <span class="comment">// note that Epartial_highres returns zero if we&#39;re outside of the global region.  q_local will also be zero there.</span></div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;  <span class="comment">// these are loops over the position in the epartial highres grid, so relative to the point in question:</span></div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;  <span class="comment">// reminder: variables r, phi, and z are global f-bin indices.</span></div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;</div>
<div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;  <span class="comment">// assuming highres correctly gives a zero when asked for the middle element in each of the last three indices,</span></div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;  <span class="comment">// and assuming q_local has no contribution from regions outside the global bounds, this is correct:</span></div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ir = 0; ir &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a7a8e3028b6f00782ef26683a18a9c351">nr_high</a>; ir++)</div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;  {</div>
<div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iphi = 0; iphi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8b33436d6a20d9698c3dd39db4ba3784">nphi_high</a>; iphi++)</div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;    {</div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iz = 0; iz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8594f9b21d7ab7f4938ae87793e79d1a">nz_high</a>; iz++)</div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;      {</div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;        <span class="comment">// first three are relative to the roi, last three are relative to the point in the first three.  ooph.</span></div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;        <span class="keywordflow">if</span> (phi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a> &lt; 0)</div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;        {</div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;          <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;%d: Getting with phi=%d\n&quot;</span>, __LINE__, phi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>);</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;        }</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;        sum += <a class="code" href="../../de/d64/classAnnularFieldSim.html#aa8a5aed287dd1ad723d2f897c61fc08c">Epartial_highres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(r - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, phi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, z - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>, ir, iphi, iz) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a17ab62844a52175c4b2439b1a6beb78e">q_local</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(ir, iphi, iz);</div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;      }</div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;    }</div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;  }</div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../da/d55/TPCRateLayered_8m.html#a7507ef556477c204b499f1e189d40796">sum</a>;</div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;}</div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;</div>
<div class="line"><a name="l02221"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a526ad468319e05b2cdbb37569c496048"> 2221</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#a526ad468319e05b2cdbb37569c496048">AnnularFieldSim::sum_nonlocal_field_at</a>(<span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <span class="keywordtype">int</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>)</div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;{</div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;  <span class="comment">// now we look for our low_res contribution, which will be the interpolated summed field from the eight blocks closest to our f-bin of interest:</span></div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;</div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;  <span class="comment">// find our interpolated position between the eight nearby lowres cells:</span></div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;  <span class="comment">// this is similar to the interpolated integral stuff, except we&#39;re at integer steps inside integer blocks</span></div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;  <span class="comment">// and we have z as well, now.</span></div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;  <span class="keywordtype">bool</span> <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#ac02453702d24df24da23f57610e10499">skip</a>[] = {<span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>};</div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;</div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;  <span class="keywordtype">float</span> <a class="code" href="../../d0/d22/DetectorVolumeFindersTests_8cpp.html#aa0c60d277a47da3373ac179947098727">r0</a> = r / (1.0 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3e84c61c56134d72992b940a889f297c">r_spacing</a>) - 0.5 - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a0414585861f707dd518182800e0beaa3">rmin_roi_low</a>;  <span class="comment">// the position in r, in units of r_spacing, starting from the center of the 0th l-bin in the roi.</span></div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;  <span class="keywordtype">int</span> r0i = floor(r0);                                    <span class="comment">// the integer portion of the position. -- what center is below our position?</span></div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;  <span class="keywordtype">float</span> r0d = r0 - r0i;                                   <span class="comment">// the decimal portion of the position. -- how far past center are we?</span></div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;  <span class="comment">// instead of listing all eight, I&#39;ll address these as i%2, (i/2)%2 and (i/4)%2 to avoid typos</span></div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;  <span class="keywordtype">int</span> ri[2];  <span class="comment">// the r position of the eight cell centers to consider.</span></div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;  ri[0] = r0i;</div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;  ri[1] = r0i + 1;</div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;  <span class="keywordtype">float</span> rw[2];      <span class="comment">// the weight of that cell, linear in distance from the center of it</span></div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;  rw[0] = 1 - r0d;  <span class="comment">// 1 when we&#39;re on it, 0 when we&#39;re at the other one.</span></div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;  rw[1] = r0d;      <span class="comment">// 1 when we&#39;re on it, 0 when we&#39;re at the other one</span></div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;</div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;  <span class="comment">// zero out if the requested l-bin is out of the roi (happens if we&#39;re close to the outer than the inner edge of the outermost l-bin)</span></div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;  <span class="keywordflow">if</span> (ri[0] &lt; 0)</div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;  {</div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 8; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;    {</div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;      <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> / 4) % 2 == 0)</div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;      {</div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;        skip[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">true</span>;  <span class="comment">// don&#39;t handle contributions from ri[0].</span></div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;      }</div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;    }</div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;    rw[1] = 1;  <span class="comment">// and weight like we&#39;re dead-center on the outer cells.</span></div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;  }</div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;  <span class="keywordflow">if</span> (ri[1] &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2582bbaaea39ee0668e6aae399828d8b">nr_roi_low</a>)</div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;  {</div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 8; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;    {</div>
<div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;      <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> / 4) % 2 == 1)</div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;      {</div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;        skip[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">true</span>;  <span class="comment">// don&#39;t bother handling ri[1].</span></div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;      }</div>
<div class="line"><a name="l02261"></a><span class="lineno"> 2261</span>&#160;    }</div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;    rw[0] = 1;  <span class="comment">// and weight like we&#39;re dead-center on the inner cells.</span></div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;  }</div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;  <span class="comment">// now repeat that structure for phi:</span></div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;</div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;  <span class="keywordtype">float</span> p0 = phi / (1.0 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a09f972e6da20da4bd6508ea919a566d4">phi_spacing</a>) - 0.5 - <a class="code" href="../../de/d64/classAnnularFieldSim.html#acabd7bc4c835302b2853feda70c52d05">phimin_roi_low</a>;  <span class="comment">// the position &#39;phi&#39; in  units of phi_spacing, starting from the center of the 0th bin.</span></div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;  <span class="comment">// printf(&quot;prepping to filter low, p0=%f, phi=%d, phi_spacing=%d, phimin_roi_low=%d\n&quot;,p0,phi,phi_spacing,phimin_roi_low);</span></div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;</div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;  <span class="keywordtype">int</span> p0i = floor(p0);   <span class="comment">// the integer portion of the position. -- what center is below our position?</span></div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;  <span class="keywordtype">float</span> p0d = p0 - p0i;  <span class="comment">// the decimal portion of the position. -- how far past center are we?</span></div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../d6/db0/fjcore_8hh.html#a83ed6d79695912896ba03659228dc2b8">pi</a>[4];             <span class="comment">// the local phi position of the four l-bin centers to consider</span></div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;  <span class="comment">// printf(&quot;filtering low, p0i=%d, nphi_low=%d\n&quot;,p0i,nphi_low);</span></div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;  <span class="comment">// Q: why do I need to filter here?</span></div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;  <span class="comment">// A: Worst case scenario, this produces -1&lt;p0&lt;0.  If that wraps around and is still in the roi, I should include it</span></div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;  <span class="comment">// A: Likewise, if I get p0&gt;nphi_low, then that means it ought to wrap around and be considered against the other limit.</span></div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;  pi[0] = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">FilterPhiIndex</a>(p0i, <a class="code" href="../../de/d64/classAnnularFieldSim.html#aed089501f43e4a12141981e52af26519">nphi_low</a>);</div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;  pi[1] = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">FilterPhiIndex</a>(p0i + 1, <a class="code" href="../../de/d64/classAnnularFieldSim.html#aed089501f43e4a12141981e52af26519">nphi_low</a>);</div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;  <span class="comment">// having filtered, we will always have a positive number.</span></div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;</div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;  <span class="comment">// printf(&quot;done filtering low\n&quot;);</span></div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;  <span class="keywordtype">float</span> pw[2];      <span class="comment">// the weight of that cell, linear in distance from the center of it</span></div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;  pw[0] = 1 - p0d;  <span class="comment">// 1 when we&#39;re on it, 0 when we&#39;re at the other one.</span></div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160;  pw[1] = p0d;      <span class="comment">// 1 when we&#39;re on it, 0 when we&#39;re at the other one</span></div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160;</div>
<div class="line"><a name="l02286"></a><span class="lineno"> 2286</span>&#160;  <span class="comment">// note that since phi wraps around itself, we have the possibility of being outside by being above/below the opposite end of where we thought we were</span></div>
<div class="line"><a name="l02287"></a><span class="lineno"> 2287</span>&#160;  <span class="comment">// remember these are coordinates wrt the beginning of the roi, and are positive because we filtered.  If that rotation didn&#39;t put them back in the roi, then they weren&#39;t before, either.</span></div>
<div class="line"><a name="l02288"></a><span class="lineno"> 2288</span>&#160;  <span class="keywordflow">if</span> (pi[0] &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1c136bb3ad3b004767131c421210c425">nphi_roi_low</a>)</div>
<div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;  {</div>
<div class="line"><a name="l02290"></a><span class="lineno"> 2290</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 8; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;    {</div>
<div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;      <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> / 2) % 2 == 0)</div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;      {</div>
<div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;        skip[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">true</span>;  <span class="comment">// don&#39;t bother handling pi[0].</span></div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;      }</div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;    }</div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;    pw[1] = 1;  <span class="comment">// and weight like we&#39;re dead-center on the high cells.</span></div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;  }</div>
<div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;  <span class="keywordflow">if</span> (pi[1] &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1c136bb3ad3b004767131c421210c425">nphi_roi_low</a>)</div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;  {</div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 8; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;    {</div>
<div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;      <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> / 2) % 2 == 1)</div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;      {</div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;        skip[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">true</span>;  <span class="comment">// don&#39;t bother handling pi[1].</span></div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;      }</div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;    }</div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;    pw[0] = 1;  <span class="comment">// and weight like we&#39;re dead-center on the high cells.</span></div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;  }</div>
<div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;</div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160;  <span class="comment">// and once more for z.  ooph.</span></div>
<div class="line"><a name="l02312"></a><span class="lineno"> 2312</span>&#160;</div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;  <span class="keywordtype">float</span> z0 = z / (1.0 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a90c13a6de122eaa34d8da6869b627104">z_spacing</a>) - 0.5 - <a class="code" href="../../de/d64/classAnnularFieldSim.html#acc4cbafa5dbfe53f721b469d52185d3c">zmin_roi_low</a>;  <span class="comment">// the position in r, in units of r_spacing, starting from the center of the 0th bin.</span></div>
<div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;  <span class="keywordtype">int</span> z0i = floor(z0);                                    <span class="comment">// the integer portion of the position. -- what center is below our position?</span></div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;  <span class="keywordtype">float</span> z0d = z0 - z0i;                                   <span class="comment">// the decimal portion of the position. -- how far past center are we?</span></div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;  <span class="comment">// instead of listing all eight, I&#39;ll address these as i%2, (i/2)%2 and (i/4)%2 to avoid typos</span></div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;  <span class="keywordtype">int</span> zi[2];  <span class="comment">// the r position of the eight cell centers to consider.</span></div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;  zi[0] = z0i;</div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;  zi[1] = z0i + 1;</div>
<div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;  <span class="keywordtype">float</span> zw[2];      <span class="comment">// the weight of that cell, linear in distance from the center of it</span></div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;  zw[0] = 1 - z0d;  <span class="comment">// 1 when we&#39;re on it, 0 when we&#39;re at the other one.</span></div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;  zw[1] = z0d;      <span class="comment">// 1 when we&#39;re on it, 0 when we&#39;re at the other one</span></div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;</div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;  <span class="keywordflow">if</span> (zi[0] &lt; 0)</div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;  {</div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 8; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;    {</div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;      <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>) % 2 == 0)</div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;      {</div>
<div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;        skip[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">true</span>;  <span class="comment">// don&#39;t bother handling zi[0].</span></div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;      }</div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;    }</div>
<div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;    zw[1] = 1;  <span class="comment">// and weight like we&#39;re dead-center on the higher cells.</span></div>
<div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160;  }</div>
<div class="line"><a name="l02335"></a><span class="lineno"> 2335</span>&#160;  <span class="keywordflow">if</span> (zi[1] &gt;= <a class="code" href="../../de/d64/classAnnularFieldSim.html#a36f0e932c673e595833e38570bb03e8a">nz_roi_low</a>)</div>
<div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;  {</div>
<div class="line"><a name="l02337"></a><span class="lineno"> 2337</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 8; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;    {</div>
<div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;      <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>) % 2 == 1)</div>
<div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;      {</div>
<div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;        skip[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">true</span>;  <span class="comment">// don&#39;t bother handling zi[1].</span></div>
<div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;      }</div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;    }</div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;    zw[0] = 1;  <span class="comment">// and weight like we&#39;re dead-center on the lower cells.</span></div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;  }</div>
<div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;</div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;  TVector3 <a class="code" href="../../da/d55/TPCRateLayered_8m.html#a7507ef556477c204b499f1e189d40796">sum</a>(0, 0, 0);</div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;  <span class="comment">// at this point, we should be skipping all destination l-bins that are out-of-bounds.</span></div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;  <span class="comment">// note that if any out-of-bounds ones survive somehow, the call to Epartial_lowres will fail loudly.</span></div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;  <span class="keywordtype">int</span> lBinEdge[2];              <span class="comment">// lower and upper (included) edges of the low-res bin, measured in f-bins, reused per-dimension</span></div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;  <span class="keywordtype">int</span> hRegionEdge[2];           <span class="comment">// lower and upper edge of the high-res region, measured in f-bins, reused per-dimension.</span></div>
<div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;  <span class="keywordtype">bool</span> overlapsPhi, overlapsZ;  <span class="comment">// whether we overlap in R, phi, and z.</span></div>
<div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;</div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;  <span class="keywordtype">int</span> r_highres_dist = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a7a8e3028b6f00782ef26683a18a9c351">nr_high</a> - 1) / 2;</div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;  <span class="keywordtype">int</span> phi_highres_dist = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a8b33436d6a20d9698c3dd39db4ba3784">nphi_high</a> - 1) / 2;</div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;  <span class="keywordtype">int</span> z_highres_dist = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a8594f9b21d7ab7f4938ae87793e79d1a">nz_high</a> - 1) / 2;</div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160;</div>
<div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ir = 0; ir &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#af6be58ea3979a6278bff906c943ea4a3">nr_low</a>; ir++)</div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;  {</div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;    lBinEdge[0] = ir * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3e84c61c56134d72992b940a889f297c">r_spacing</a>;</div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;    lBinEdge[1] = (ir + 1) * r_spacing - 1;</div>
<div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;    hRegionEdge[0] = r - r_highres_dist;</div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;    hRegionEdge[1] = r + r_highres_dist;</div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;    <span class="keywordtype">bool</span> overlapsR = (lBinEdge[0] &lt;= hRegionEdge[1] &amp;&amp; hRegionEdge[0] &lt;= lBinEdge[1]);</div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iphi = 0; iphi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#aed089501f43e4a12141981e52af26519">nphi_low</a>; iphi++)</div>
<div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;    {</div>
<div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;      lBinEdge[0] = iphi * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a09f972e6da20da4bd6508ea919a566d4">phi_spacing</a>;</div>
<div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;      lBinEdge[1] = (iphi + 1) * phi_spacing - 1;</div>
<div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;      hRegionEdge[0] = phi - phi_highres_dist;</div>
<div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;      hRegionEdge[1] = phi + phi_highres_dist;</div>
<div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;      overlapsPhi = (lBinEdge[0] &lt;= hRegionEdge[1] &amp;&amp; hRegionEdge[0] &lt;= lBinEdge[1]);</div>
<div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iz = 0; iz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9bdbb31e591c81d45912efa73fce654">nz_low</a>; iz++)</div>
<div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;      {</div>
<div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;        lBinEdge[0] = iz * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a90c13a6de122eaa34d8da6869b627104">z_spacing</a>;</div>
<div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;        lBinEdge[1] = (iz + 1) * z_spacing - 1;</div>
<div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;        hRegionEdge[0] = z - z_highres_dist;</div>
<div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;        hRegionEdge[1] = z + z_highres_dist;</div>
<div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;        overlapsZ = (lBinEdge[0] &lt;= hRegionEdge[1] &amp;&amp; hRegionEdge[0] &lt;= lBinEdge[1]);</div>
<div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;        <span class="comment">// conceptually: see if the l-bin overlaps with the high-res region:</span></div>
<div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;        <span class="comment">// the high-res region includes all indices from r-(nr_high-1)/2 to r+(nr_high-1)/2.</span></div>
<div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;        <span class="comment">// each low-res region includes all indices from ir*r_spacing to (ir+1)*r_spacing-1.</span></div>
<div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;        <span class="keywordflow">if</span> (overlapsR &amp;&amp; overlapsPhi &amp;&amp; overlapsZ)</div>
<div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;        {</div>
<div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;          <span class="comment">// if their bounds are interleaved in all dimensions, there is overlap, and we&#39;ve already summed this region.</span></div>
<div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;          <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;        }</div>
<div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;        {</div>
<div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;          <span class="comment">// if(debugFlag()) printf(&quot;%d: AnnularFieldSim::sum_field_at, considering l-bin at(r=%d,phi=%d, z=%d)\n&quot;,__LINE__,ir,iphi,iz);</span></div>
<div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;</div>
<div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 8; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;          {</div>
<div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;            <span class="keywordflow">if</span> (skip[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>])</div>
<div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;            {</div>
<div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;              <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;            }</div>
<div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;            <span class="keywordflow">if</span> (ri[(i / 4) % 2] + <a class="code" href="../../de/d64/classAnnularFieldSim.html#a0414585861f707dd518182800e0beaa3">rmin_roi_low</a> == ir &amp;&amp; pi[(i / 2) % 2] + <a class="code" href="../../de/d64/classAnnularFieldSim.html#acabd7bc4c835302b2853feda70c52d05">phimin_roi_low</a> == iphi &amp;&amp; zi[(i) % 2] + <a class="code" href="../../de/d64/classAnnularFieldSim.html#acc4cbafa5dbfe53f721b469d52185d3c">zmin_roi_low</a> == iz)</div>
<div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;            {</div>
<div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;              <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;considering an l-bins effect on itself, r=%d,phi=%d,z=%d (matches i=%d, not skipped), means we&#39;re not interpolating fairly\n&quot;</span>, ir, iphi, iz, i);</div>
<div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;              <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 2);</div>
<div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;            }</div>
<div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;            <span class="comment">// the ri, pi, and zi elements are relative to the roi, as needed for Epartial.</span></div>
<div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;            <span class="comment">// the ir, iphi, and iz are all absolute, as needed for q_lowres</span></div>
<div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;            <span class="keywordflow">if</span> (pi[(i / 2) % 2] &lt; 0)</div>
<div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;            {</div>
<div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;              <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;%d: Getting with phi=%d\n&quot;</span>, __LINE__, pi[(i / 2) % 2]);</div>
<div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;            }</div>
<div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;            sum += (<a class="code" href="../../de/d64/classAnnularFieldSim.html#aa4cc4892f9e2ca6b8ce07383fb1897f6">Epartial_lowres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(ri[(i / 4) % 2], pi[(i / 2) % 2], zi[(i) % 2], ir, iphi, iz) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a908de0cdfdcde19201e7c18f1c81db07">q_lowres</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(ir, iphi, iz)) * zw[(i) % 2] * pw[(i / 2) % 2] * rw[(i / 4) % 2];</div>
<div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;          }</div>
<div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;        }</div>
<div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;      }</div>
<div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;    }</div>
<div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;  }</div>
<div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;</div>
<div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../da/d55/TPCRateLayered_8m.html#a7507ef556477c204b499f1e189d40796">sum</a>;</div>
<div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;}</div>
<div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;</div>
<div class="line"><a name="l02418"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a4a7d310d527ef4d9b7ba5a986b996317"> 2418</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4a7d310d527ef4d9b7ba5a986b996317">AnnularFieldSim::sum_phislice_field_at</a>(<span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <span class="keywordtype">int</span> <a class="code" href="../../d6/d34/namespaceActsTests_1_1PropagationDatasets.html#a4722f5524134f5f139681f91e6c50038">phi</a>, <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>)</div>
<div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;{</div>
<div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;  <span class="comment">// sum the E field over all nr by ny by nz cells of sources, at the specific position r,phi,z.</span></div>
<div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;  <span class="comment">// note the specific position in Epartial is in relative coordinates.</span></div>
<div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;  <span class="comment">// printf(&quot;AnnularFieldSim::sum_field_at(r=%d,phi=%d, z=%d)\n&quot;,r,phi,z);</span></div>
<div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;  TVector3 <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a> = <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbb9bba03c21915698421f313dc43071">GetRoiCellCenter</a>(r - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, phi - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, z - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>);</div>
<div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;  TVector3 slicepos = <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbb9bba03c21915698421f313dc43071">GetRoiCellCenter</a>(r - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, 0, z - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>);</div>
<div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;  <span class="keywordtype">float</span> rotphi = pos.Phi() - slicepos.Phi();  <span class="comment">// probably this is phi*step.Phi();</span></div>
<div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;</div>
<div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;  <span class="comment">// caution:  if you print progress of each of these, it will print a great deal of data, since this is called per-bin</span></div>
<div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;  <span class="comment">// unsigned long long totalelements=nr*nphi*nz;</span></div>
<div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;  <span class="comment">//  unsigned long long percent=totalelements/100;</span></div>
<div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;</div>
<div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;  <span class="comment">// unsigned long long el=0;</span></div>
<div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;</div>
<div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;  TVector3 <a class="code" href="../../da/d55/TPCRateLayered_8m.html#a7507ef556477c204b499f1e189d40796">sum</a>(0, 0, 0);</div>
<div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;  TVector3 unrotatedField(0, 0, 0);</div>
<div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;  TVector3 unitField(0, 0, 0);</div>
<div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;  <span class="keywordtype">int</span> phirel;</div>
<div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ir = 0; ir &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>; ir++)</div>
<div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;  {</div>
<div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iphi = 0; iphi &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>; iphi++)</div>
<div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;    {</div>
<div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iz = 0; iz &lt; <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>; iz++)</div>
<div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;      {</div>
<div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;        <span class="comment">// sum+=*partial[x][phi][z][ix][iphi][iz] * *q[ix][iphi][iz];</span></div>
<div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;        <span class="keywordflow">if</span> (r == ir &amp;&amp; phi == iphi &amp;&amp; z == iz)</div>
<div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;        {</div>
<div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;          <span class="keywordflow">continue</span>;  <span class="comment">// dont&#39; compute self-to-self field.</span></div>
<div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;        }</div>
<div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160;        phirel = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae7f3aaa01498d1b9259f05559c5bac7e">FilterPhiIndex</a>(iphi - phi);</div>
<div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;        unitField = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aaca0e0273dbdea674cb59f3b0466c4c9">Epartial_phislice</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(r - <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, 0, z - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>, ir, phirel, iz);</div>
<div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;        unitField.RotateZ(rotphi);  <span class="comment">// previously was rotate by the step.Phi()*phi.    //annoying that I can&#39;t rename this to &#39;rotated field&#39; here without unnecessary overhead.</span></div>
<div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;</div>
<div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;        sum += unitField * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a002f26208e71c2e801523bd82a015f9e">q</a>-&gt;<a class="code" href="../../d4/d14/classChargeMapReader.html#a2abb6186153f2d2b740a356023e7d0b5">GetChargeInBin</a>(ir, iphi, iz);</div>
<div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;        ;</div>
<div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;</div>
<div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;        <span class="comment">/*</span></div>
<div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;<span class="comment">        if(!(el%percent)) {printf(&quot;summing phislices %d%%:  &quot;,(int)(el/percent));</span></div>
<div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;<span class="comment">          printf(&quot;unit field at (r=%d,p=%d,z=%d) from  (ir=%d,ip=%d,iz=%d) is (%E,%E,%E) (xyz), q=%E\n&quot;,</span></div>
<div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;<span class="comment">                 r,phi,z,ir,iphi,iz,unitField.X(),unitField.Y(),unitField.Z(),q-&gt;GetChargeInBin(ir,iphi,iz));</span></div>
<div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;<span class="comment">        }</span></div>
<div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;<span class="comment">        el++;</span></div>
<div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;<span class="comment">        */</span></div>
<div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;      }</div>
<div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;    }</div>
<div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;  }</div>
<div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;  <span class="comment">// printf(&quot;summed field at (%d,%d,%d)=(%f,%f,%f)\n&quot;,x,y,z,sum.X(),sum.Y(),sum.Z());</span></div>
<div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../da/d55/TPCRateLayered_8m.html#a7507ef556477c204b499f1e189d40796">sum</a>;</div>
<div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160;}</div>
<div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;</div>
<div class="line"><a name="l02469"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a5868eb5808ec182e9299bee9be6f5b0f"> 2469</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#a5868eb5808ec182e9299bee9be6f5b0f">AnnularFieldSim::swimToInAnalyticSteps</a>(<span class="keywordtype">float</span> zdest, TVector3 <a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>, <span class="keywordtype">int</span> <a class="code" href="../../dc/dd5/namespacepropagation__timing.html#ac99fb9b6044121fe2ca6e5246c9103ac">steps</a> = 1, <span class="keywordtype">int</span> *goodToStep = <span class="keyword">nullptr</span>)</div>
<div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;{</div>
<div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;  <span class="comment">// assume coordinates are given in native units (cm=1 unless that changed!).</span></div>
<div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;  <span class="keywordtype">double</span> zdist = (zdest - start.Z()) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>;</div>
<div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;  <span class="keywordtype">double</span> zstep = zdist / <a class="code" href="../../dc/dd5/namespacepropagation__timing.html#ac99fb9b6044121fe2ca6e5246c9103ac">steps</a>;</div>
<div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;  start = start * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>;  <span class="comment">// scale us to cm.</span></div>
<div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;</div>
<div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;  TVector3 ret = <a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;</div>
<div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;  TVector3 accumulated_distortion(0, 0, 0);</div>
<div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;  TVector3 accumulated_drift(0, 0, 0);</div>
<div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;  TVector3 drift_step(0, 0, zstep);</div>
<div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;</div>
<div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;  <span class="keywordtype">int</span> rt, <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a7d6c8b4d417ed50c799a1e0fd32d9ce2">pt</a>, zt;  <span class="comment">// just placeholders for the bounds-checking.</span></div>
<div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563">BoundsCase</a> zBound;</div>
<div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; <a class="code" href="../../dc/dd5/namespacepropagation__timing.html#ac99fb9b6044121fe2ca6e5246c9103ac">steps</a>; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;  {</div>
<div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;    zBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(ret.Z(), &amp;zt);</div>
<div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160;    <span class="keywordflow">if</span> (zBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a036052f156b5b8b74e2746185342bc43">OnLowEdge</a>)</div>
<div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;    {</div>
<div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;      <span class="comment">// printf(&quot;AnnularFieldSIm::swimToInAnalyticSteps requests z-nudge from z=%f to %f\n&quot;, ret.Z(), ret.Z()+ALMOST_ZERO);//nudge it in z:</span></div>
<div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;      ret.SetZ(ret.Z() + <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>);</div>
<div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;    }</div>
<div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#af41a4754a596a90505d15a5dcb1868a6">GetRindexAndCheckBounds</a>(ret.Perp(), &amp;rt) != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> || <a class="code" href="../../de/d64/classAnnularFieldSim.html#aab5dee891f7302176821ad489549a18f">GetPhiIndexAndCheckBounds</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(ret.Phi()), &amp;pt) != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> || (zBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a5d6b1a005f45425192fb685b714dac15">OutOfBounds</a>))</div>
<div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160;    {</div>
<div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;      <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(</div>
<div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;          <span class="stringliteral">&quot;AnnularFieldSim::swimToInAnalyticSteps at step %d,&quot;</span></div>
<div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;          <span class="stringliteral">&quot;asked to swim particle from (%f,%f,%f)(cm) (rphiz)=(%fcm,%frad,%fcm)which is outside the ROI.\n&quot;</span>,</div>
<div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;          <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>, ret.X() / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>, ret.Y() / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>, ret.Z() / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>, ret.Perp() / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>, ret.Phi(), ret.Z() / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>);</div>
<div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160;      <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot; -- %f &lt;= r &lt; %f \t%f &lt;= phi &lt; %f \t%f &lt;= z &lt; %f \n&quot;</span>,</div>
<div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;             <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>,</div>
<div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;             <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(),</div>
<div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160;             <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z());</div>
<div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;      <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;Returning last valid position.\n&quot;</span>);</div>
<div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;      <span class="keywordflow">if</span> (!(goodToStep == <span class="keyword">nullptr</span>))</div>
<div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;      {</div>
<div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;        *goodToStep = <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> - 1;</div>
<div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;      }</div>
<div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;      <span class="keywordflow">return</span> ret * (1.0 / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>);</div>
<div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;    }</div>
<div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;    <span class="comment">// printf(&quot;AnnularFieldSim::swimToInAnalyticSteps at step %d, asked to swim particle from (%f,%f,%f) (rphiz)=(%f,%f,%f).\n&quot;,i,ret.X(),ret.Y(),ret.Z(),ret.Perp(),ret.Phi(),ret.Z());</span></div>
<div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;    <span class="comment">// rcc note: once I put the z distoriton back in, I need to check that ret.Z+zstep is still in bounds:</span></div>
<div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;    accumulated_distortion += <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac961e366f82550417663d8604e55aec2">GetStepDistortion</a>(ret.Z() + zstep, ret, <span class="keyword">true</span>, <span class="keyword">true</span>);</div>
<div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;</div>
<div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;    accumulated_drift += drift_step;</div>
<div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;</div>
<div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;    <span class="comment">// this seems redundant, but if the distortions are small they may lose precision and stop actually changing the position when step size is small.  This allows them to accumulate separately so they can grow properly:</span></div>
<div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;    ret = start + accumulated_distortion + accumulated_drift;</div>
<div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;  }</div>
<div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;</div>
<div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;  <span class="keywordflow">return</span> ret * (1.0 / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>);</div>
<div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;}</div>
<div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;</div>
<div class="line"><a name="l02521"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a61f0b23cecab5b9f7e5feac62a3838e4"> 2521</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#a61f0b23cecab5b9f7e5feac62a3838e4">AnnularFieldSim::swimToInSteps</a>(<span class="keywordtype">float</span> zdest, <span class="keyword">const</span> TVector3 &amp;<a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>, <span class="keywordtype">int</span> <a class="code" href="../../dc/dd5/namespacepropagation__timing.html#ac99fb9b6044121fe2ca6e5246c9103ac">steps</a> = 1, <span class="keywordtype">bool</span> <a class="code" href="../../da/d7b/namespaceActs.html#a2d4349d85a14c2f358714e95dd15046c" title="performs linear interpolation inside a hyper box">interpolate</a> = <span class="keyword">false</span>, <span class="keywordtype">int</span> *goodToStep = <span class="keyword">nullptr</span>)</div>
<div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;{</div>
<div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;  <span class="keywordtype">int</span> *success = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;  TVector3 straightline(start.X(), start.Y(), zdest);</div>
<div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;  TVector3 distortion = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aae2d9b9913d410d22242028c08c6865a">GetTotalDistortion</a>(zdest, start, <a class="code" href="../../dc/dd5/namespacepropagation__timing.html#ac99fb9b6044121fe2ca6e5246c9103ac">steps</a>, <a class="code" href="../../da/d7b/namespaceActs.html#a2d4349d85a14c2f358714e95dd15046c" title="performs linear interpolation inside a hyper box">interpolate</a>, goodToStep, success);</div>
<div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;  <span class="keywordflow">return</span> straightline + distortion;</div>
<div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;}</div>
<div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;</div>
<div class="line"><a name="l02529"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#aae2d9b9913d410d22242028c08c6865a"> 2529</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#aae2d9b9913d410d22242028c08c6865a">AnnularFieldSim::GetTotalDistortion</a>(<span class="keywordtype">float</span> zdest, <span class="keyword">const</span> TVector3 &amp;<a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>, <span class="keywordtype">int</span> <a class="code" href="../../dc/dd5/namespacepropagation__timing.html#ac99fb9b6044121fe2ca6e5246c9103ac">steps</a>, <span class="keywordtype">bool</span> <a class="code" href="../../da/d7b/namespaceActs.html#a2d4349d85a14c2f358714e95dd15046c" title="performs linear interpolation inside a hyper box">interpolate</a>, <span class="keywordtype">int</span> *goodToStep, <span class="keywordtype">int</span> *success)</div>
<div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;{</div>
<div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;  <span class="comment">// work in native units is automatic.</span></div>
<div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;  <span class="comment">// double zdist=(zdest-start.Z())*cm;</span></div>
<div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;  <span class="comment">// start=start*cm;</span></div>
<div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;</div>
<div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;  <span class="comment">// check the z bounds:</span></div>
<div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160;  <span class="keywordtype">int</span> rt, <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a7d6c8b4d417ed50c799a1e0fd32d9ce2">pt</a>, zt;  <span class="comment">// just placeholders for the bounds-checking.</span></div>
<div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563">BoundsCase</a> zBound;</div>
<div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;  zBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(zdest, &amp;zt);</div>
<div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;  <span class="keywordtype">bool</span> rdrswitch = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a72e4f32ad0f054c334723f04907b3283">RdeltaRswitch</a>;</div>
<div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;  *success = 0;</div>
<div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160;  <span class="keywordflow">if</span> (zBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a5d6b1a005f45425192fb685b714dac15">OutOfBounds</a>)</div>
<div class="line"><a name="l02542"></a><span class="lineno"> 2542</span>&#160;  {</div>
<div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l02544"></a><span class="lineno"> 2544</span>&#160;    {  <span class="comment">// check if this destination is valid for our twin, if we have one:</span></div>
<div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;      zBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(-zdest, &amp;zt);</div>
<div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;      <span class="keywordflow">if</span> (zBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> || zBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a036052f156b5b8b74e2746185342bc43">OnLowEdge</a>)</div>
<div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;      {</div>
<div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;        <span class="comment">// destination is in the twin</span></div>
<div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6743c036ddac97dd925c0df7db7ea501">twin</a>-&gt;<a class="code" href="../../de/d64/classAnnularFieldSim.html#aae2d9b9913d410d22242028c08c6865a">GetTotalDistortion</a>(zdest, start, steps, interpolate, goodToStep, success);</div>
<div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;      }</div>
<div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;    }</div>
<div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;    <span class="comment">// otherwise, we&#39;re not in the twin, and default to our usual gripe:</span></div>
<div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::GetTotalDistortion starting at (%f,%f,%f)=(r%f,p%f,z%f) asked to drift to z=%f, which is outside the ROI.  hasTwin= %d.  Returning zero_vector.\n&quot;</span>, start.X(), start.Y(), start.Z(), start.Perp(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(start.Phi()), start.Z(), zdest, (int) <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>);</div>
<div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot; -- %f &lt;= r &lt; %f \t%f &lt;= phi &lt; %f \t%f &lt;= z &lt; %f \n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z());</div>
<div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;    *goodToStep = 0;</div>
<div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;    *success = 0;</div>
<div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>;  <span class="comment">// rcchere</span></div>
<div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;  }</div>
<div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a036052f156b5b8b74e2746185342bc43">OnLowEdge</a>)</div>
<div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;  {</div>
<div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;    <span class="comment">// nudge it in z:</span></div>
<div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;    zdest += <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>;</div>
<div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;  }</div>
<div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;  zBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(start.Z(), &amp;zt);</div>
<div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;  <span class="keywordflow">if</span> (zBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a5d6b1a005f45425192fb685b714dac15">OutOfBounds</a>)</div>
<div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;  {</div>
<div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;AnnularFieldSim::GetTotalDistortion starting at (%f,%f,%f)=(r%f,p%f,z%f) asked to drift from z=%f, which is outside the ROI.  Returning zero_vector.\n&quot;</span>, start.X(), start.Y(), start.Z(), start.Perp(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(start.Phi()), start.Z(), start.Z());</div>
<div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot; -- %f &lt;= r &lt; %f \t%f &lt;= phi &lt; %f \t%f &lt;= z &lt; %f \n&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() + <a class="code" href="../../de/d64/classAnnularFieldSim.html#abc6e7cc71ac9688d76f0d72016df3e34">rmin</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z());</div>
<div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;    *goodToStep = 0;</div>
<div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;    *success = 0;</div>
<div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>;</div>
<div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;  }</div>
<div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a036052f156b5b8b74e2746185342bc43">OnLowEdge</a>)</div>
<div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;  {</div>
<div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;    <span class="comment">// nudge it in z:</span></div>
<div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;    zdest += <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>;</div>
<div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;  }</div>
<div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;</div>
<div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;  <span class="comment">// now we are guaranteed the z limits are in range, and don&#39;t need to check them again.</span></div>
<div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;</div>
<div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;  <span class="keywordtype">double</span> zstep = (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a1d48f893997408b32ded5f0f3b8e3bfd">zmax</a> - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a>) / steps;  <span class="comment">// always a positive number</span></div>
<div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;  <span class="comment">// printf(&quot;Lets do some handy math here, the value of the first zstep: %f \n&quot;,zstep);</span></div>
<div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;  <span class="comment">// printf(&quot;Lets do some handy math here, the value of zmax is: %f \n&quot;,zmax);</span></div>
<div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;  <span class="comment">// printf(&quot;Lets do some handy math here, the value of zmin is: %f \n&quot;,zmin);</span></div>
<div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;  <span class="comment">// printf(&quot;Lets do some handy math here, the value of steps is: %d \n&quot;,steps);</span></div>
<div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;  <span class="keywordflow">if</span> ((zdest - start.Z()) &lt; 0)</div>
<div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;  {</div>
<div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;    zstep = -zstep;  <span class="comment">// It goes two directions, so there will be positive and negative value</span></div>
<div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;  }</div>
<div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;  <span class="keywordtype">int</span> integernumbersteps = (zdest - start.Z()) / zstep;</div>
<div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;  <span class="comment">// printf(&quot;Lets do some handy math here, the value of integernumbersteps is: %d \n&quot;,integernumbersteps);</span></div>
<div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;  <span class="comment">// printf(&quot;Lets do some handy math here, the value of zdest is: %f \n&quot;,zdest);</span></div>
<div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;  <span class="comment">// printf(&quot;Lets do some handy math here, the value of start.Z() is: %f \n&quot;,start.Z());</span></div>
<div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;  <span class="comment">// printf(&quot;Lets do some handy math here, the value of zstep is: %f \n&quot;,zstep);</span></div>
<div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;</div>
<div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;  <span class="comment">// printf(&quot;Hello, this is the zmax-zmin length: %f\n&quot;, (zmax-zmin));</span></div>
<div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;  <span class="comment">// printf(&quot;Hello, this is the zdest-start.Z(): %f\n&quot;, (zdest-start.Z()));</span></div>
<div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;  <span class="comment">// printf(&quot;Hello, this is the zstep number: %f\n&quot;, zstep);</span></div>
<div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;  <span class="comment">// printf(&quot;Hello, this is the integernumbersteps number: %d\n&quot;, integernumbersteps);</span></div>
<div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;</div>
<div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;  TVector3 <a class="code" href="../../dc/d59/Proto4ShowerCalibFit_8m.html#a7130b1618285588513fd1ff97884b9d9">position</a> = <a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;</div>
<div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;  TVector3 accumulated_distortion(0, 0, 0);</div>
<div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;  TVector3 accumulated_drift(0, 0, 0);</div>
<div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;  TVector3 drift_step(0, 0, zstep);</div>
<div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;</div>
<div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;  <span class="comment">// the conceptual approach here is to get the vector distortion in each z step, and use the transverse component of that to update the position of the particle for the next step, while accumulating the total distortion separately from the position.  This allows a small residual to accumulate, rather than being lost.  We do not correct the z position, so that the stepping does not &#39;skip&#39; parts of the trajectory.</span></div>
<div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;</div>
<div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160;  <span class="comment">// describe what you&#39;re doing here:</span></div>
<div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;  <span class="comment">// printf(&quot;Hello again, this is the zdest: %f\n&quot;, (zdest));</span></div>
<div class="line"><a name="l02610"></a><span class="lineno"> 2610</span>&#160;  <span class="comment">// printf(&quot;Hello again, this is the start.Z(): %f\n&quot;, (start.Z()));</span></div>
<div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;</div>
<div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;  accumulated_distortion += <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac961e366f82550417663d8604e55aec2">GetStepDistortion</a>(zdest - (integernumbersteps * zstep), position, <span class="keyword">true</span>, <span class="keyword">false</span>);</div>
<div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;</div>
<div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;  <span class="comment">// short-circuit if there&#39;s no travel length:</span></div>
<div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;</div>
<div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;  position.SetX(start.X() + accumulated_distortion.X());</div>
<div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;  position.SetY(start.Y() + accumulated_distortion.Y());</div>
<div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;  position.SetZ(zdest - (integernumbersteps * zstep));</div>
<div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;</div>
<div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;  <span class="keywordtype">float</span> StartR, FinalR;</div>
<div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;  <span class="keywordtype">float</span> DeltaR;</div>
<div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; integernumbersteps; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;  {</div>
<div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#af41a4754a596a90505d15a5dcb1868a6">GetRindexAndCheckBounds</a>(position.Perp(), &amp;rt) != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> || <a class="code" href="../../de/d64/classAnnularFieldSim.html#aab5dee891f7302176821ad489549a18f">GetPhiIndexAndCheckBounds</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(position.Phi()), &amp;pt) != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> || (zBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a5d6b1a005f45425192fb685b714dac15">OutOfBounds</a>))</div>
<div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;    {</div>
<div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;      <span class="comment">// printf(&quot;AnnularFieldSim::GetTotalDistortion starting at (%f,%f,%f)=(r%f,p%f,z%f) with drift_step=%f, at step %d, asked to swim particle from (%f,%f,%f) (rphiz)=(%f,%f,%f)which is outside the ROI.\n&quot;, start.X(), start.Y(), start.Z(), start.Perp(), FilterPhiPos(start.Phi()), start.Z(), zstep, i, position.X(), position.Y(), position.Z(), position.Perp(), position.Phi(), position.Z());</span></div>
<div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;      <span class="comment">// printf(&quot; -- %f &lt;= r &lt; %f \t%f &lt;= phi &lt; %f \t%f &lt;= z &lt; %f \n&quot;, rmin_roi * step.Perp() + rmin, rmax_roi * step.Perp() + rmin, phimin_roi * step.Phi(), phimax_roi * step.Phi(), zmin_roi * step.Z(), zmax_roi * step.Z());</span></div>
<div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;      <span class="comment">// printf(&quot;Returning last good position.\n&quot;);</span></div>
<div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;      <span class="keywordflow">if</span> (!(goodToStep == <span class="keyword">nullptr</span>))</div>
<div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;      {</div>
<div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;        *goodToStep = <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> - 1, *success = 0;</div>
<div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160;      }</div>
<div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;      <span class="comment">// assert (1==2);</span></div>
<div class="line"><a name="l02634"></a><span class="lineno"> 2634</span>&#160;      <span class="keywordflow">return</span> (accumulated_distortion);</div>
<div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;    }</div>
<div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;</div>
<div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;    StartR = position.Perp();</div>
<div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;    <span class="comment">// as we accumulate distortions, add these to the x and y positions, but do not change the z position, otherwise we will &#39;skip&#39; parts of the drift, which is not the intended behavior.</span></div>
<div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;    accumulated_distortion += <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac961e366f82550417663d8604e55aec2">GetStepDistortion</a>(position.Z() + zstep, <a class="code" href="../../dc/d59/Proto4ShowerCalibFit_8m.html#a7130b1618285588513fd1ff97884b9d9">position</a>, <span class="keyword">true</span>, <span class="keyword">false</span>);</div>
<div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;    position.SetX(start.X() + accumulated_distortion.X());</div>
<div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;    position.SetY(start.Y() + accumulated_distortion.Y());</div>
<div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;    FinalR = position.Perp();</div>
<div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;    <span class="comment">// PositionXAfter=start.X() + accumulated_distortion.X();</span></div>
<div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;    <span class="comment">// PositionYAfter=start.Y() + accumulated_distortion.Y();//</span></div>
<div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;</div>
<div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;    <span class="comment">// StartR=sqrt(PositionXBefore*PositionXBefore+PositionYBefore*PositionYBefore);</span></div>
<div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;    DeltaR = FinalR - StartR;  <span class="comment">// sqrt(PositionXAfter*PositionXAfter+PositionYAfter*PositionYAfter)-StartR;</span></div>
<div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;    <span class="keywordflow">if</span> (rdrswitch)</div>
<div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;    {</div>
<div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;      <a class="code" href="../../de/d64/classAnnularFieldSim.html#a19e0ccae97c9eaaf9778c5bb938e8b1d">hRdeltaRComponent</a>-&gt;Fill(StartR, DeltaR);</div>
<div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;    }</div>
<div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;    position.SetZ(position.Z() + zstep);</div>
<div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;  }</div>
<div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#af41a4754a596a90505d15a5dcb1868a6">GetRindexAndCheckBounds</a>(position.Perp(), &amp;rt) != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> || <a class="code" href="../../de/d64/classAnnularFieldSim.html#aab5dee891f7302176821ad489549a18f">GetPhiIndexAndCheckBounds</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(position.Phi()), &amp;pt) != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> || (zBound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a5d6b1a005f45425192fb685b714dac15">OutOfBounds</a>))</div>
<div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;  {</div>
<div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;    *goodToStep = integernumbersteps - 1;</div>
<div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;    *success = 0;</div>
<div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;    <span class="keywordflow">return</span> (accumulated_distortion);</div>
<div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;  }</div>
<div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;  *goodToStep = integernumbersteps;</div>
<div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;  *success = 1;</div>
<div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;  <span class="keywordflow">return</span> accumulated_distortion;</div>
<div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;}</div>
<div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;</div>
<div class="line"><a name="l02665"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a4823b727adb1568c6f26c033e059288f"> 2665</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4823b727adb1568c6f26c033e059288f">AnnularFieldSim::PlotFieldSlices</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filebase, <span class="keyword">const</span> TVector3 &amp;<a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>, <span class="keywordtype">char</span> which)</div>
<div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;{</div>
<div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;  <span class="keywordtype">bool</span> mapEfield = <span class="keyword">true</span>;</div>
<div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;  <span class="keywordflow">if</span> (which == <span class="charliteral">&#39;B&#39;</span>)</div>
<div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;  {</div>
<div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;    mapEfield = <span class="keyword">false</span>;</div>
<div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;  }</div>
<div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;  which = mapEfield ? <span class="charliteral">&#39;E&#39;</span> : <span class="charliteral">&#39;B&#39;</span>;</div>
<div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;  <span class="keywordtype">char</span> units[5];</div>
<div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;  <span class="keywordflow">if</span> (mapEfield)</div>
<div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;  {</div>
<div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;    sprintf(units, <span class="stringliteral">&quot;V/cm&quot;</span>);</div>
<div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;  }</div>
<div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;  {</div>
<div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;    sprintf(units, <span class="stringliteral">&quot;T&quot;</span>);</div>
<div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;  }</div>
<div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;</div>
<div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;plotting field slices for %c field, slicing at (%1.2F,%1.2f,%1.2f)...\n&quot;</span>, which, pos.Perp(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(pos.Phi()), pos.Z());</div>
<div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;  std::cout &lt;&lt; <span class="stringliteral">&quot;file=&quot;</span> &lt;&lt; filebase &lt;&lt; std::endl;</div>
<div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;  ;</div>
<div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;  TString plotfilename = TString::Format(<span class="stringliteral">&quot;%s.%cfield_slices.pdf&quot;</span>, filebase, which);</div>
<div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;  TVector3 inner = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a33dfea024e1870e3a8ce09a5bee6d5cf">GetInnerEdge</a>();</div>
<div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;  TVector3 outer = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89aa84314e52d84ff41305d0c74e93b4">GetOuterEdge</a>();</div>
<div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;  TVector3 steplocal = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3106a1618f3f51868239210deaee3c5">GetFieldStep</a>();</div>
<div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;</div>
<div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;  TCanvas *<a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a>;</div>
<div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;</div>
<div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;  TH2F *hEfield[3][3];</div>
<div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;  TH2F *hCharge[3];</div>
<div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;  TH1F *hEfieldComp[3][3];</div>
<div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;  <span class="keywordtype">char</span> axis[] = <span class="stringliteral">&quot;rpzrpz&quot;</span>;</div>
<div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;  <span class="keywordtype">float</span> axisval[] = {(float) pos.Perp(), (float) <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(pos.Phi()), (<span class="keywordtype">float</span>) pos.Z(), (float) pos.Perp(), (float) <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(pos.Phi()), (<span class="keywordtype">float</span>) pos.Z()};</div>
<div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;  <span class="keywordtype">int</span> axn[] = {<a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9038e19b32063a3c67c00853cd325b8">nphi_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9038e19b32063a3c67c00853cd325b8">nphi_roi</a>, nz_roi};</div>
<div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;  <span class="keywordtype">float</span> axtop[] = {(float) outer.Perp(), 2 * M_PI, (float) outer.Z(), (float) outer.Perp(), 2 * M_PI, (float) outer.Z()};</div>
<div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;  <span class="keywordtype">float</span> axbot[] = {(float) inner.Perp(), 0, (float) inner.Z(), (float) inner.Perp(), 0, (float) inner.Z()};</div>
<div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;</div>
<div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;  <span class="comment">// if we are in charge of a twin, extend our axes:</span></div>
<div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;  {</div>
<div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;    <span class="comment">// axtop[2]=axtop[5]=(float)(twin-&gt;GetOuterEdge().Z());</span></div>
<div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;    axbot[2] = axbot[5] = (float) (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a6743c036ddac97dd925c0df7db7ea501">twin</a>-&gt;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a33dfea024e1870e3a8ce09a5bee6d5cf">GetInnerEdge</a>().Z());</div>
<div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;  }</div>
<div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;rpz bounds are %f&lt;r%f\t %f&lt;phi%f\t %f&lt;z%f\n&quot;</span>, axbot[0], axtop[0], axbot[1], axtop[1], axbot[2], axtop[2]);</div>
<div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;  <span class="keywordtype">float</span> axstep[6];</div>
<div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 6; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;  {</div>
<div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;    axstep[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = (axtop[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] - axbot[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]) / (1.0 * axn[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]);</div>
<div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;  }</div>
<div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;  TVector3 <a class="code" href="../../d6/dee/namespaceckf.html#a46f483ab4625b683ee66025e18a10825">field</a>;</div>
<div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;  TVector3 lpos;</div>
<div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;</div>
<div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;  <span class="comment">// it&#39;s a bit meta, but this loop over axes is a compact way to generate all the histogram titles.</span></div>
<div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> = 0; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> &lt; 3; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>++)</div>
<div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;  {</div>
<div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;    <span class="comment">// loop over which axis slice to take</span></div>
<div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;    hCharge[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>] = <span class="keyword">new</span> TH2F(Form(<span class="stringliteral">&quot;hCharge%c&quot;</span>, axis[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>]),</div>
<div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;                           Form(<span class="stringliteral">&quot;Spacecharge Distribution in the %c%c plane at %c=%2.3f (C/cm^3);%c;%c&quot;</span>,</div>
<div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;                                axis[ax + 1], axis[ax + 2], axis[ax], axisval[ax], axis[ax + 1], axis[ax + 2]),</div>
<div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;                           axn[ax + 1], axbot[ax + 1], axtop[ax + 1],</div>
<div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;                           axn[ax + 2], axbot[ax + 2], axtop[ax + 2]);</div>
<div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 3; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;    {</div>
<div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;      <span class="comment">// loop over which axis of the field to read</span></div>
<div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;      hEfield[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH2F(Form(<span class="stringliteral">&quot;h%cfield%c_%c%c&quot;</span>, which, axis[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>], axis[ax + 1], axis[ax + 2]),</div>
<div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;                                Form(<span class="stringliteral">&quot;%c component of %c Field in the %c%c plane at %c=%2.3f (%s);%c;%c&quot;</span>,</div>
<div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;                                     axis[i], which, axis[ax + 1], axis[ax + 2], axis[ax], axisval[ax], units, axis[ax + 1], axis[ax + 2]),</div>
<div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;                                axn[ax + 1], axbot[ax + 1], axtop[ax + 1],</div>
<div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;                                axn[ax + 2], axbot[ax + 2], axtop[ax + 2]);</div>
<div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;      hEfieldComp[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH1F(Form(<span class="stringliteral">&quot;h%cfieldComp%c_%c%c&quot;</span>, which, axis[i], axis[ax + 1], axis[ax + 2]),</div>
<div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;                                    Form(<span class="stringliteral">&quot;Log Magnitude of %c component of %c Field in the %c%c plane at %c=%2.3f;log10(mag)&quot;</span>,</div>
<div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;                                         axis[i], which, axis[ax + 1], axis[ax + 2], axis[ax], axisval[ax]),</div>
<div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;                                    200, -5, 5);</div>
<div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;    }</div>
<div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;  }</div>
<div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;</div>
<div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;  <span class="keywordtype">float</span> rpz_coord[3];</div>
<div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> = 0; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> &lt; 3; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>++)</div>
<div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;  {  <span class="comment">// we have three sets of &#39;slices&#39;.  the R slice is a 2d plot in phi-z, etc.</span></div>
<div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;    rpz_coord[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>] = axisval[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>] + axstep[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>] / 2;</div>
<div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; axn[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1]; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;    {  <span class="comment">// for each slice, loop over the bins of the 2d plot:</span></div>
<div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;      rpz_coord[(<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1) % 3] = axbot[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1] + (<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> + 0.5) * axstep[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1];</div>
<div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; axn[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 2]; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>++)</div>
<div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;      {</div>
<div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;        rpz_coord[(<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 2) % 3] = axbot[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 2] + (<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> + 0.5) * axstep[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 2];</div>
<div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;        lpos.SetXYZ(rpz_coord[0], 0, rpz_coord[2]);</div>
<div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;        lpos.SetPhi(rpz_coord[1]);</div>
<div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;        <span class="keywordflow">if</span> (<span class="keyword">false</span> &amp;&amp; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> == 0)</div>
<div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;        {</div>
<div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;          <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;sampling rpz=(%f,%f,%f)=(%f,%f,%f) after conversion to xyz=(%f,%f,%f)\n&quot;</span>,</div>
<div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;                 rpz_coord[0], rpz_coord[1], rpz_coord[2],</div>
<div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;                 lpos.Perp(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(lpos.Phi()), lpos.Z(), lpos.X(), lpos.Y(), lpos.Z());</div>
<div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;        }</div>
<div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;        <span class="keywordflow">if</span> (mapEfield)</div>
<div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;        {</div>
<div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;          <span class="comment">// GetFieldAt automatically asks the twin if we are out of bounds here.</span></div>
<div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;          field = <a class="code" href="../../de/d64/classAnnularFieldSim.html#afcbd44db4d9cf22a4c80a737c35ef634">GetFieldAt</a>(lpos) * (1.0 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#add22fc45f5d33e13cfc422f3e8c8c997">V</a>);  <span class="comment">// get units so we&#39;re drawing in V/cm when we draw.</span></div>
<div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;        }</div>
<div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;        {</div>
<div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;          field = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aacf7dde3b9fea13b430836afa2a01ffa">GetBFieldAt</a>(lpos) * (1.0 / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad3398b737ec329b9f9dca579bf123bb0">Tesla</a>);  <span class="comment">// get units so we&#39;re drawing in Tesla when we draw.</span></div>
<div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;          <span class="comment">// if (hasTwin &amp;&amp; lpos.Z()&lt;0) field=twin-&gt;GetBFieldAt(lpos)*1.0/Tesla;</span></div>
<div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;        }</div>
<div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;        field.RotateZ(-rpz_coord[1]);  <span class="comment">// rotate us so we can read the y component as the phi component</span></div>
<div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;        <span class="comment">// if (field.Mag()&gt;0) continue; //nothing has mag zero because of the drift field.</span></div>
<div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;        hEfield[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][0]-&gt;Fill(rpz_coord[(<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1) % 3], rpz_coord[(<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 2) % 3], field.X());</div>
<div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;        hEfield[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][1]-&gt;Fill(rpz_coord[(<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1) % 3], rpz_coord[(<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 2) % 3], field.Y());</div>
<div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;        hEfield[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][2]-&gt;Fill(rpz_coord[(<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1) % 3], rpz_coord[(<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 2) % 3], field.Z());</div>
<div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;        hCharge[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>]-&gt;Fill(rpz_coord[(<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1) % 3], rpz_coord[(<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 2) % 3], <a class="code" href="../../de/d64/classAnnularFieldSim.html#a7508f125c1980cf816424b0e3b0e0f8b">GetChargeAt</a>(lpos));</div>
<div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;        hEfieldComp[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][0]-&gt;Fill((abs(field.X())));</div>
<div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;        hEfieldComp[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][1]-&gt;Fill((abs(field.Y())));</div>
<div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;        hEfieldComp[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][2]-&gt;Fill((abs(field.Z())));</div>
<div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;      }</div>
<div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;    }</div>
<div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;  }</div>
<div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;</div>
<div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;  c = <span class="keyword">new</span> TCanvas(<span class="stringliteral">&quot;cfieldslices&quot;</span>, <span class="stringliteral">&quot;electric field&quot;</span>, 1200, 800);</div>
<div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;  c-&gt;Divide(4, 3);</div>
<div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;  gStyle-&gt;SetOptStat();</div>
<div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> = 0; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> &lt; 3; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>++)</div>
<div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;  {</div>
<div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 3; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;    {</div>
<div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;      c-&gt;cd(<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> * 4 + <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> + 1);</div>
<div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;      gPad-&gt;SetRightMargin(0.15);</div>
<div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;      hEfield[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;      hEfield[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Draw(<span class="stringliteral">&quot;colz&quot;</span>);</div>
<div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;      <span class="comment">// hEfield[ax][i]-&gt;GetListOfFunctions()-&gt;Print();</span></div>
<div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;      gPad-&gt;Modified();</div>
<div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;      <span class="comment">// hEfieldComp[ax][i]-&gt;Draw();//&quot;colz&quot;);</span></div>
<div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;    }</div>
<div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;    c-&gt;cd(<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> * 4 + 4);</div>
<div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;    gPad-&gt;SetRightMargin(0.15);</div>
<div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;    hCharge[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;    hCharge[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>]-&gt;Draw(<span class="stringliteral">&quot;colz&quot;</span>);</div>
<div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;    <span class="comment">// pal=dynamic_cast&lt;TPaletteAxis*&gt;(hCharge[ax]-&gt;GetListOfFunctions()-&gt;FindObject(&quot;palette&quot;));</span></div>
<div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;    <span class="keywordflow">if</span> (<span class="keyword">false</span>)</div>
<div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;    {</div>
<div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;      <span class="comment">// pal-&gt;SetX1NDC(0.86);</span></div>
<div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;      <span class="comment">// pal-&gt;SetX2NDC(0.91);</span></div>
<div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;      gPad-&gt;Modified();</div>
<div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;    }</div>
<div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;  }</div>
<div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;  c-&gt;SaveAs(plotfilename);</div>
<div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;after plotting field slices...\n&quot;</span>);</div>
<div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;  std::cout &lt;&lt; <span class="stringliteral">&quot;file=&quot;</span> &lt;&lt; filebase &lt;&lt; std::endl;</div>
<div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;</div>
<div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;}</div>
<div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;</div>
<div class="line"><a name="l02816"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#ab6b9599145f96645b103f9f1c1c1e397"> 2816</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab6b9599145f96645b103f9f1c1c1e397">AnnularFieldSim::GenerateSeparateDistortionMaps</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filebase, <span class="keywordtype">int</span> nSteps, <span class="keywordtype">int</span> r_subsamples, <span class="keywordtype">int</span> p_subsamples, <span class="keywordtype">int</span> z_subsamples, <span class="keywordtype">int</span> <span class="comment">/*z_substeps*/</span>, <span class="keywordtype">bool</span> andCartesian)</div>
<div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;{</div>
<div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;  <span class="comment">// generates the distortion map for one or both sides of the detector, separating them so</span></div>
<div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;  <span class="comment">// they do not try to interpolate across the CM.</span></div>
<div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;</div>
<div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;  <span class="comment">// 1) pick a map spacing (&#39;s&#39;)</span></div>
<div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;  TVector3 steplocal(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() / r_subsamples, 0, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() / z_subsamples);</div>
<div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;  steplocal.SetPhi(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi() / p_subsamples);</div>
<div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;  <span class="keywordtype">float</span> deltar = steplocal.Perp();  <span class="comment">//(rf-ri)/nr;</span></div>
<div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;  <span class="keywordtype">float</span> deltap = steplocal.Phi();   <span class="comment">//(pf-pi)/np;</span></div>
<div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;  <span class="keywordtype">float</span> deltaz = steplocal.Z();     <span class="comment">//(zf-zi)/nz;</span></div>
<div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;  <span class="keywordtype">bool</span> rdrswitch = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a72e4f32ad0f054c334723f04907b3283">RdeltaRswitch</a>;</div>
<div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;  TVector3 stepzvec(0, 0, deltaz);</div>
<div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;</div>
<div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;  <span class="comment">//  int nSteps = 500;  //how many steps to take in the particle path.  hardcoded for now.  Think about this later.</span></div>
<div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;</div>
<div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;  <span class="keywordtype">int</span> nSides = 1;</div>
<div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;  {</div>
<div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;    nSides = 2;</div>
<div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;  }</div>
<div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;  <span class="comment">// idea for a faster way to build a map:</span></div>
<div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;</div>
<div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;  <span class="comment">// 2) generate the distortions steplocal.Z() away from the readout</span></div>
<div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;  <span class="comment">// 3) generate the distortion from (i)*steplocal.Z() away to (i-1) away, then add the interpolated value from the (i-1) layer</span></div>
<div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;</div>
<div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;  <span class="comment">// for interpolation, Henry needs one extra buffer bin on each side.</span></div>
<div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;</div>
<div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;  <span class="comment">// so we define the histogram bounds (the &#39;h&#39; suffix) to be the full range</span></div>
<div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;  <span class="comment">// plus an additional step in each direction so interpolation can work at the edges</span></div>
<div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;  TVector3 lowerEdge = <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbb9bba03c21915698421f313dc43071">GetRoiCellCenter</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>);</div>
<div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;  TVector3 upperEdge = <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbb9bba03c21915698421f313dc43071">GetRoiCellCenter</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a> - 1, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a> - 1, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a> - 1);</div>
<div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;  <span class="keywordtype">int</span> nph = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a> * p_subsamples + 2;  <span class="comment">// number of phibins in the histogram</span></div>
<div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;  <span class="keywordtype">int</span> nrh = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a> * r_subsamples + 2;    <span class="comment">// number of r bins in the histogram</span></div>
<div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;  <span class="keywordtype">int</span> nzh = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a> * z_subsamples + 2;    <span class="comment">// number of z you get the idea.</span></div>
<div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;</div>
<div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;  <span class="keywordtype">float</span> rih = lowerEdge.Perp() - 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() - steplocal.Perp();             <span class="comment">// lower bound of roi, minus one</span></div>
<div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;  <span class="keywordtype">float</span> rfh = upperEdge.Perp() + 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() + steplocal.Perp();             <span class="comment">// upper bound of roi, plus one</span></div>
<div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;  <span class="keywordtype">float</span> pih = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(lowerEdge.Phi()) - 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi() - steplocal.Phi();  <span class="comment">// can&#39;t automate this or we&#39;ll run afoul of phi looping.</span></div>
<div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;  <span class="keywordtype">float</span> pfh = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(upperEdge.Phi()) + 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi() + steplocal.Phi();  <span class="comment">// can&#39;t automate this or we&#39;ll run afoul of phi looping.</span></div>
<div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;  <span class="keywordtype">float</span> zih = lowerEdge.Z() - 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() - steplocal.Z();                      <span class="comment">// lower bound of roi, minus one</span></div>
<div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;  <span class="keywordtype">float</span> zfh = upperEdge.Z() + 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() + steplocal.Z();                      <span class="comment">// upper bound of roi, plus one</span></div>
<div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;  <span class="keywordtype">float</span> z_readout = upperEdge.Z() + 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z();                                <span class="comment">// readout plane.  Note we assume this is positive.</span></div>
<div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;</div>
<div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;generating distortion map...\n&quot;</span>);</div>
<div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;file=%s\n&quot;</span>, filebase);</div>
<div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;Phi:  %d steps from %f to %f (field has %d steps)\n&quot;</span>, nph, pih, pfh, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ababaa9675b4f7a0ea774b3145623b892">GetFieldStepsPhi</a>());</div>
<div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;R:  %d steps from %f to %f (field has %d steps)\n&quot;</span>, nrh, rih, rfh, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9bd7d94036eb0cbe4cf182af460bee0e">GetFieldStepsR</a>());</div>
<div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;Z:  %d steps from %f to %f (field has %d steps)\n&quot;</span>, nzh, zih, zfh, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a983fff01de22f2bafd88331d636cd8ac">GetFieldStepsZ</a>());</div>
<div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;  TString distortionFilename;</div>
<div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;  distortionFilename.Form(<span class="stringliteral">&quot;%s.distortion_map.hist.root&quot;</span>, filebase);</div>
<div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;  TString summaryFilename;</div>
<div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;  summaryFilename.Form(<span class="stringliteral">&quot;%s.distortion_summary.pdf&quot;</span>, filebase);</div>
<div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;  TString diffSummaryFilename;</div>
<div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;  diffSummaryFilename.Form(<span class="stringliteral">&quot;%s.differential_summary.pdf&quot;</span>, filebase);</div>
<div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;</div>
<div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;  TFile *outf = TFile::Open(distortionFilename.Data(), <span class="stringliteral">&quot;RECREATE&quot;</span>);</div>
<div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;  outf-&gt;cd();</div>
<div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;</div>
<div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;  <span class="comment">// actual output maps:</span></div>
<div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;</div>
<div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;  TH3F *hDistortionR = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hDistortionR&quot;</span>, <span class="stringliteral">&quot;Per-z-bin Distortion in the R direction as a function of (phi,r,z) (centered in r,phi, z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;  TH3F *hDistortionP = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hDistortionP&quot;</span>, <span class="stringliteral">&quot;Per-z-bin Distortion in the RPhi direction as a function of (phi,r,z)  (centered in r,phi, z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;  TH3F *hDistortionZ = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hDistortionZ&quot;</span>, <span class="stringliteral">&quot;Per-z-bin Distortion in the Z direction as a function of (phi,r,z)  (centered in r,phi, z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;  TH3F *hIntDistortionR = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hIntDistortionR&quot;</span>, <span class="stringliteral">&quot;Integrated R Distortion from (phi,r,z) to z=0 (centered in r,phi, and z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;  TH3F *hIntDistortionP = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hIntDistortionP&quot;</span>, <span class="stringliteral">&quot;Integrated R Distortion from (phi,r,z) to z=0 (centered in r,phi, and z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;  TH3F *hIntDistortionZ = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hIntDistortionZ&quot;</span>, <span class="stringliteral">&quot;Integrated R Distortion from (phi,r,z) to z=0  (centered in r,phi, and z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;</div>
<div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;  TH3F *hIntDistortionX = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hIntDistortionX&quot;</span>, <span class="stringliteral">&quot;Integrated X Distortion from (phi,r,z) to z=0 (centered in r,phi, and z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;  TH3F *hIntDistortionY = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hIntDistortionY&quot;</span>, <span class="stringliteral">&quot;Integrated Y Distortion from (phi,r,z) to z=0 (centered in r,phi, and z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;</div>
<div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">int</span> nMapComponents = 6;</div>
<div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;  TH3F *hSeparatedMapComponent[2][6];  <span class="comment">// side, then xyzrp</span></div>
<div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;  TH3F *hValidToStepComponent[2];</div>
<div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;  TH3F *hReachesReadout[2];</div>
<div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;  TString side[2];</div>
<div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;  side[0] = <span class="stringliteral">&quot;soloz&quot;</span>;</div>
<div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;  {</div>
<div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;    side[0] = <span class="stringliteral">&quot;posz&quot;</span>;</div>
<div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;    side[1] = <span class="stringliteral">&quot;negz&quot;</span>;</div>
<div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;  }</div>
<div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;  TString sepAxis[] = {<span class="stringliteral">&quot;X&quot;</span>, <span class="stringliteral">&quot;Y&quot;</span>, <span class="stringliteral">&quot;Z&quot;</span>, <span class="stringliteral">&quot;R&quot;</span>, <span class="stringliteral">&quot;P&quot;</span>, <span class="stringliteral">&quot;RPhi&quot;</span>};</div>
<div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;  <span class="keywordtype">float</span> zlower, zupper;</div>
<div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; nSides; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;  {</div>
<div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> == 0)</div>
<div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;    {  <span class="comment">// doing the positive side</span></div>
<div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;      zlower = fmin(zih, zfh);</div>
<div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;      zupper = fmax(zih, zfh);</div>
<div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;    }</div>
<div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;    {</div>
<div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;      zlower = -1 * fmax(zih, zfh);</div>
<div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;      zupper = -1 * fmin(zih, zfh);</div>
<div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;    }</div>
<div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; nMapComponents; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>++)</div>
<div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;    {</div>
<div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;      hSeparatedMapComponent[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>] = <span class="keyword">new</span> TH3F(Form(<span class="stringliteral">&quot;hIntDistortion%s_%s&quot;</span>, sepAxis[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>].<a class="code" href="../../da/de5/ThicknessScan_8m.html#af5baa506e65b4caa6be6d1c6661dfe63">Data</a>(), side[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>].<a class="code" href="../../da/de5/ThicknessScan_8m.html#af5baa506e65b4caa6be6d1c6661dfe63">Data</a>()),</div>
<div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;                                              Form(<span class="stringliteral">&quot;Integrated %s Deflection drifting from (phi,r,z) to z=endcap;phi;r;z (%s side)&quot;</span>, sepAxis[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>].<a class="code" href="../../da/de5/ThicknessScan_8m.html#af5baa506e65b4caa6be6d1c6661dfe63">Data</a>(), side[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>].<a class="code" href="../../da/de5/ThicknessScan_8m.html#af5baa506e65b4caa6be6d1c6661dfe63">Data</a>()),</div>
<div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;                                              nph, pih, pfh, nrh, rih, rfh, nzh, zlower, zupper);</div>
<div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;    }</div>
<div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;    hValidToStepComponent[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH3F(Form(<span class="stringliteral">&quot;hValidToStep_%s&quot;</span>, side[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>].<a class="code" href="../../da/de5/ThicknessScan_8m.html#af5baa506e65b4caa6be6d1c6661dfe63">Data</a>()),</div>
<div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;                                        Form(<span class="stringliteral">&quot;Step before out of bounds drifting from (phi,r,z) to z=endcap;phi;r;z (%s side)&quot;</span>, side[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>].<a class="code" href="../../da/de5/ThicknessScan_8m.html#af5baa506e65b4caa6be6d1c6661dfe63">Data</a>()),</div>
<div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;                                        nph, pih, pfh, nrh, rih, rfh, nzh, zlower, zupper);</div>
<div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;    hReachesReadout[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH3F(Form(<span class="stringliteral">&quot;hReachesReadout_%s&quot;</span>, side[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>].<a class="code" href="../../da/de5/ThicknessScan_8m.html#af5baa506e65b4caa6be6d1c6661dfe63">Data</a>()),</div>
<div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;                                  Form(<span class="stringliteral">&quot;Bool value for checking if successfuly drifting from (phi,r,z) to z=endcap and reaches the readout;phi;r;z (%s side)&quot;</span>, side[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>].<a class="code" href="../../da/de5/ThicknessScan_8m.html#af5baa506e65b4caa6be6d1c6661dfe63">Data</a>()),</div>
<div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;                                  nph, pih, pfh, nrh, rih, rfh, nzh, zlower, zupper);</div>
<div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;  }</div>
<div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;  <span class="keywordflow">if</span> (rdrswitch)</div>
<div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;  {</div>
<div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a19e0ccae97c9eaaf9778c5bb938e8b1d">hRdeltaRComponent</a> = <span class="keyword">new</span> TH2F(<span class="stringliteral">&quot;hRdeltaR&quot;</span>, <span class="stringliteral">&quot;Bool value of input for a 2D R_versus_deltaR plot from Zstart to Zend;R;deltaR&quot;</span>, nrh, rih, rfh, 10 * nrh, rih - 70, rfh + 170);</div>
<div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;    <span class="comment">// hRdeltaRComponent = new TH2F(&quot;hRdeltaR&quot;,&quot;Bool value of input for a 2D R_versus_deltaR plot from Zstart to Zend;R;deltaR&quot;, nrh, rih, rfh, 10*nrh, rih-20, rfh-77);</span></div>
<div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6743c036ddac97dd925c0df7db7ea501">twin</a>-&gt;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a19e0ccae97c9eaaf9778c5bb938e8b1d">hRdeltaRComponent</a> = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a19e0ccae97c9eaaf9778c5bb938e8b1d">hRdeltaRComponent</a>;</div>
<div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;  }</div>
<div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;  <span class="comment">// monitor plots, and the position that that plot monitors at:</span></div>
<div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;</div>
<div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;  <span class="comment">// TVector3 pos((nrh/2+0.5)*s.Perp()+rih,0,(nzh/2+0.5)*s.Z()+zih);</span></div>
<div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;  TVector3 <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>(((<span class="keywordtype">int</span>) (nrh / 2) + 0.5) * steplocal.Perp() + rih, 0, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a> + ((int) (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a> / 2) + 0.5) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z());</div>
<div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;  <span class="keywordtype">float</span> posphi = ((int) (nph / 2) + 0.5) * steplocal.Phi() + pih;</div>
<div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;  <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.SetPhi(posphi);</div>
<div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;  <span class="comment">// int xi[3]={nrh/2,nph/2,nzh/2};</span></div>
<div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;  <span class="keywordtype">int</span> xi[3] = {(int) floor((<a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Perp() - rih) / steplocal.Perp()), (<span class="keywordtype">int</span>) floor((posphi - pih) / steplocal.Phi()), (<span class="keywordtype">int</span>) floor((<a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Z() - zih) / steplocal.Z())};</div>
<div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;  {</div>
<div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;rpz slice indices= (%d,%d,%d) (no twin)\n&quot;</span>, xi[0], xi[1], xi[2]);</div>
<div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;  }</div>
<div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;  <span class="keywordtype">int</span> twinz = (-<a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Z() - zih) / steplocal.Z();</div>
<div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;  {</div>
<div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;rpz slice indices= (%d,%d,%d) twinz=%d\n&quot;</span>, xi[0], xi[1], xi[2], twinz);</div>
<div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160;  }</div>
<div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;</div>
<div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">char</span> axname[] = <span class="stringliteral">&quot;rpzrpz&quot;</span>;</div>
<div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;  <span class="keywordtype">int</span> axn[] = {nrh, nph, nzh, nrh, nph, nzh};</div>
<div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;  <span class="keywordtype">float</span> axval[] = {(float) <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Perp(), (float) <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Phi(), (float) <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Z(), (float) <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Perp(), (float) <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Phi(), (float) <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Z()};</div>
<div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;  <span class="keywordtype">float</span> axbot[] = {rih, pih, zih, rih, pih, zih};</div>
<div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;  <span class="keywordtype">float</span> axtop[] = {rfh, pfh, zfh, rfh, pfh, zfh};</div>
<div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;  TH2F *hIntDist[3][3];</div>
<div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;  TH1F *hRDist[2][3];  <span class="comment">// now with a paired friend for the negative side</span></div>
<div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;  TH2F *hDiffDist[3][3];</div>
<div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;  TH1F *hRDiffDist[2][3];</div>
<div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 3; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;  {</div>
<div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;    <span class="comment">// loop over which axis of the distortion to read</span></div>
<div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> = 0; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> &lt; 3; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>++)</div>
<div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;    {</div>
<div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;      <span class="comment">// loop over which plane to work in</span></div>
<div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;      hDiffDist[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH2F(TString::Format(<span class="stringliteral">&quot;hDiffDist%c_%c%c&quot;</span>, axname[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>], axname[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1], axname[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 2]),</div>
<div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;                                  TString::Format(<span class="stringliteral">&quot;%c component of diff. distortion in  %c%c plane at %c=%2.3f;%c;%c&quot;</span>,</div>
<div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;                                                  axname[i], axname[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1], axname[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 2], axname[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>], axval[ax], axname[ax + 1], axname[ax + 2]),</div>
<div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;                                  axn[ax + 1], axbot[ax + 1], axtop[ax + 1],</div>
<div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;                                  axn[ax + 2], axbot[ax + 2], axtop[ax + 2]);</div>
<div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;      hIntDist[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH2F(TString::Format(<span class="stringliteral">&quot;hIntDist%c_%c%c&quot;</span>, axname[i], axname[ax + 1], axname[ax + 2]),</div>
<div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;                                 TString::Format(<span class="stringliteral">&quot;%c component of int. distortion in  %c%c plane at %c=%2.3f;%c;%c&quot;</span>,</div>
<div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;                                                 axname[i], axname[ax + 1], axname[ax + 2], axname[ax], axval[ax], axname[ax + 1], axname[ax + 2]),</div>
<div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;                                 axn[ax + 1], axbot[ax + 1], axtop[ax + 1],</div>
<div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;                                 axn[ax + 2], axbot[ax + 2], axtop[ax + 2]);</div>
<div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;    }</div>
<div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160;    hRDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH1F(TString::Format(<span class="stringliteral">&quot;hRDist%c&quot;</span>, axname[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]),</div>
<div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;                            TString::Format(<span class="stringliteral">&quot;%c component of int. distortion vs r with %c=%2.3f and %c=%2.3f;r(cm);#delta (cm)&quot;</span>,</div>
<div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;                                            axname[i], axname[1], axval[1], axname[2], axval[2]),</div>
<div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;                            axn[0], axbot[0], axtop[0]);</div>
<div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;    hRDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH1F(TString::Format(<span class="stringliteral">&quot;hRDist%cNeg&quot;</span>, axname[i]),</div>
<div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160;                            TString::Format(<span class="stringliteral">&quot;%c component of int. distortion vs r with %c=%2.3f and %c=-%2.3f;r(cm);#delta (cm)&quot;</span>,</div>
<div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;                                            axname[i], axname[1], axval[1], axname[2], axval[2]),</div>
<div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;                            axn[0], axbot[0], axtop[0]);</div>
<div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;    hRDiffDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH1F(TString::Format(<span class="stringliteral">&quot;hRDiffDist%c&quot;</span>, axname[i]),</div>
<div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;                                TString::Format(<span class="stringliteral">&quot;%c component of diff. distortion vs r with %c=%2.3f and %c=%2.3f;r(cm);#delta (cm)&quot;</span>,</div>
<div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;                                                axname[i], axname[1], axval[1], axname[2], axval[2]),</div>
<div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;                                axn[0], axbot[0], axtop[0]);</div>
<div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;    hRDiffDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH1F(TString::Format(<span class="stringliteral">&quot;hRDiffDist%cNeg&quot;</span>, axname[i]),</div>
<div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;                                TString::Format(<span class="stringliteral">&quot;%c component of diff. distortion vs r with %c=%2.3f and %c=-%2.3f;r(cm);#delta (cm)&quot;</span>,</div>
<div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;                                                axname[i], axname[1], axval[1], axname[2], axval[2]),</div>
<div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;                                axn[0], axbot[0], axtop[0]);</div>
<div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;  }</div>
<div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;</div>
<div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;  TVector3 inpart, outpart;</div>
<div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;  TVector3 diffdistort, distort;</div>
<div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;  <span class="keywordtype">int</span> validToStep;</div>
<div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;  <span class="keywordtype">int</span> successCheck;</div>
<div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;</div>
<div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;  <span class="comment">// TTree version:</span></div>
<div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;  <span class="keywordtype">float</span> partR, partP, partZ;</div>
<div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;  <span class="keywordtype">int</span> ir, ip, iz;</div>
<div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;  <span class="keywordtype">float</span> distortR, distortP, distortZ;</div>
<div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;  <span class="keywordtype">float</span> distortX, distortY;</div>
<div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;  <span class="keywordtype">float</span> diffdistR, diffdistP, diffdistZ;</div>
<div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;  TTree *dTree = <span class="keyword">new</span> TTree(<span class="stringliteral">&quot;dTree&quot;</span>, <span class="stringliteral">&quot;Distortion per step z&quot;</span>);</div>
<div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;r&quot;</span>, &amp;partR);</div>
<div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;p&quot;</span>, &amp;partP);</div>
<div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;z&quot;</span>, &amp;partZ);</div>
<div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;ir&quot;</span>, &amp;ir);</div>
<div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;ip&quot;</span>, &amp;ip);</div>
<div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;iz&quot;</span>, &amp;iz);</div>
<div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;dr&quot;</span>, &amp;distortR);</div>
<div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;drp&quot;</span>, &amp;distortP);</div>
<div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;dz&quot;</span>, &amp;distortZ);</div>
<div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;</div>
<div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;generating separated distortion map with (%dx%dx%d) grid \n&quot;</span>, nrh, nph, nzh);</div>
<div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> totalelements = nrh;</div>
<div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160;  totalelements *= nph;</div>
<div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;  totalelements *= nzh;  <span class="comment">// breaking up this multiplication prevents a 32bit math overflow</span></div>
<div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;  {</div>
<div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;    totalelements *= 2;  <span class="comment">// if we have a twin, we have twice as many z bins as we thought.</span></div>
<div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;  }</div>
<div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;</div>
<div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> percent = totalelements / 100;</div>
<div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> waypoint = percent * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a>;</div>
<div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;total elements = %llu\n&quot;</span>, totalelements);</div>
<div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;</div>
<div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160;  <span class="keywordtype">int</span> el = 0;</div>
<div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;</div>
<div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;  <span class="comment">// we want to loop over the entire region to be mapped, but we also need to include</span></div>
<div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;  <span class="comment">// one additional bin at each edge, to allow the mc drift code to interpolate properly.</span></div>
<div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;  <span class="comment">// hence we count from -1 to n+1, and manually adjust the position in those edge cases</span></div>
<div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;  <span class="comment">// to avoid sampling nonphysical regions in r and z.  the phi case is free to wrap as</span></div>
<div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160;  <span class="comment">//  normal.</span></div>
<div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;</div>
<div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;  <span class="comment">// note that we apply the adjustment to the particle position (inpart) and not the plotted position (partR etc)</span></div>
<div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;  inpart.SetXYZ(1, 0, 0);</div>
<div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;  <span class="keywordflow">for</span> (ir = 0; ir &lt; nrh; ir++)</div>
<div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160;  {</div>
<div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;    partR = (ir + 0.5) * deltar + rih;</div>
<div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160;    <span class="keywordflow">if</span> (ir == 0)</div>
<div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;    {</div>
<div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;      inpart.SetPerp(partR + deltar);</div>
<div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;    }</div>
<div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ir == nrh - 1)</div>
<div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;    {</div>
<div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;      inpart.SetPerp(partR - deltar);</div>
<div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;    }</div>
<div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;    {</div>
<div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;      inpart.SetPerp(partR);</div>
<div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;    }</div>
<div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;    <span class="keywordflow">for</span> (ip = 0; ip &lt; nph; ip++)</div>
<div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;    {</div>
<div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;      partP = (ip + 0.5) * deltap + pih;</div>
<div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;      inpart.SetPhi(partP);</div>
<div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;      <span class="comment">// since phi loops, there&#39;s no need to adjust phis that are out of bounds.</span></div>
<div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;      <span class="keywordflow">for</span> (iz = 0; iz &lt; nzh; iz++)</div>
<div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160;      {</div>
<div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;        partZ = (iz) *deltaz + zih;  <span class="comment">// start us at the EDGE of the bin,</span></div>
<div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;        <span class="keywordflow">if</span> (iz == 0)</div>
<div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;        {</div>
<div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;          inpart.SetZ(partZ + deltaz);</div>
<div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;        }</div>
<div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iz == nzh - 1)</div>
<div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;        {</div>
<div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;          inpart.SetZ(partZ - deltaz);</div>
<div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;        }</div>
<div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;        {</div>
<div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160;          inpart.SetZ(partZ);</div>
<div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;        }</div>
<div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;        partZ += 0.5 * deltaz;  <span class="comment">// move to center of histogram bin.</span></div>
<div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> localside = 0; localside &lt; nSides; localside++)</div>
<div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;        {</div>
<div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;          <span class="keywordflow">if</span> (localside == 0)</div>
<div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;          {</div>
<div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;            diffdistort = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>;  <span class="comment">// GetTotalDistortion(inpart.Z() + deltaz, inpart, nSteps, true, &amp;validToStep, &amp;successCheck);</span></div>
<div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;            distort = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aae2d9b9913d410d22242028c08c6865a">GetTotalDistortion</a>(z_readout, inpart, nSteps, <span class="keyword">true</span>, &amp;validToStep, &amp;successCheck);</div>
<div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;          }</div>
<div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;          {</div>
<div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;            <span class="comment">// if we have more than one side,</span></div>
<div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;            <span class="comment">// flip z coords and do the twin instead:</span></div>
<div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;            partZ *= -1;                   <span class="comment">// position to place in histogram</span></div>
<div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;            inpart.SetZ(-1 * inpart.Z());  <span class="comment">// position to seek in sim</span></div>
<div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;            diffdistort = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>;     <span class="comment">// twin-&gt;GetTotalDistortion(inpart.Z() - deltaz, inpart, nSteps, true, &amp;validToStep, &amp;successCheck);</span></div>
<div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;            distort = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6743c036ddac97dd925c0df7db7ea501">twin</a>-&gt;<a class="code" href="../../de/d64/classAnnularFieldSim.html#aae2d9b9913d410d22242028c08c6865a">GetTotalDistortion</a>(-z_readout, inpart, nSteps, <span class="keyword">true</span>, &amp;validToStep, &amp;successCheck);</div>
<div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;          }</div>
<div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;</div>
<div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;          diffdistort.RotateZ(-inpart.Phi());  <span class="comment">// rotate so that distortion components are wrt the x axis</span></div>
<div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160;          diffdistP = diffdistort.Y();         <span class="comment">// the phi component is now the y component.</span></div>
<div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;          diffdistR = diffdistort.X();         <span class="comment">// and the r component is the x component</span></div>
<div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;          diffdistZ = diffdistort.Z();</div>
<div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;</div>
<div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;          distortX = distort.X();</div>
<div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;          distortY = distort.Y();</div>
<div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;          distort.RotateZ(-inpart.Phi());  <span class="comment">// rotate so that distortion components are wrt the x axis</span></div>
<div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;          distortP = distort.Y();          <span class="comment">// the phi component is now the y component.</span></div>
<div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;          distortR = distort.X();          <span class="comment">// and the r component is the x component</span></div>
<div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;          distortZ = distort.Z();</div>
<div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;</div>
<div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160;          <span class="keywordtype">float</span> distComp[nMapComponents];  <span class="comment">// by components</span></div>
<div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;          distComp[0] = distortX;</div>
<div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;          distComp[1] = distortY;</div>
<div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;          distComp[2] = distortZ;</div>
<div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;          distComp[3] = distortR;</div>
<div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;          distComp[4] = distortP / partR;  <span class="comment">// &#39;P&#39; now refers to phi in radians, rather than unitful</span></div>
<div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;          distComp[5] = distortP;          <span class="comment">// &#39;RPhi&#39; is the one that correponds to the []meter unitful phi-hat value</span></div>
<div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;</div>
<div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a> = 0; <a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a> &lt; nMapComponents; <a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a>++)</div>
<div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;          {</div>
<div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160;            hSeparatedMapComponent[localside][<a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a>]-&gt;Fill(partP, partR, partZ, distComp[<a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a>]);</div>
<div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;          }</div>
<div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160;</div>
<div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;          hValidToStepComponent[localside]-&gt;Fill(partP, partR, partZ, validToStep);</div>
<div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160;          hReachesReadout[localside]-&gt;Fill(partP, partR, partZ, successCheck);</div>
<div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;</div>
<div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160;          <span class="comment">// recursive integral distortion:</span></div>
<div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;          <span class="comment">// get others working first!</span></div>
<div class="line"><a name="l03121"></a><span class="lineno"> 3121</span>&#160;</div>
<div class="line"><a name="l03122"></a><span class="lineno"> 3122</span>&#160;          <span class="comment">// printf(&quot;part=(rpz)(%f,%f,%f),distortP=%f\n&quot;,partP,partR,partZ,distortP);</span></div>
<div class="line"><a name="l03123"></a><span class="lineno"> 3123</span>&#160;          hIntDistortionR-&gt;Fill(partP, partR, partZ, distortR);</div>
<div class="line"><a name="l03124"></a><span class="lineno"> 3124</span>&#160;          hIntDistortionP-&gt;Fill(partP, partR, partZ, distortP);</div>
<div class="line"><a name="l03125"></a><span class="lineno"> 3125</span>&#160;          hIntDistortionZ-&gt;Fill(partP, partR, partZ, distortZ);</div>
<div class="line"><a name="l03126"></a><span class="lineno"> 3126</span>&#160;</div>
<div class="line"><a name="l03127"></a><span class="lineno"> 3127</span>&#160;          <span class="keywordflow">if</span> (andCartesian)</div>
<div class="line"><a name="l03128"></a><span class="lineno"> 3128</span>&#160;          {</div>
<div class="line"><a name="l03129"></a><span class="lineno"> 3129</span>&#160;            hIntDistortionX-&gt;Fill(partP, partR, partZ, distortX);</div>
<div class="line"><a name="l03130"></a><span class="lineno"> 3130</span>&#160;            hIntDistortionY-&gt;Fill(partP, partR, partZ, distortY);</div>
<div class="line"><a name="l03131"></a><span class="lineno"> 3131</span>&#160;          }</div>
<div class="line"><a name="l03132"></a><span class="lineno"> 3132</span>&#160;</div>
<div class="line"><a name="l03133"></a><span class="lineno"> 3133</span>&#160;          <span class="comment">// now we fill particular slices for integral visualizations:</span></div>
<div class="line"><a name="l03134"></a><span class="lineno"> 3134</span>&#160;          <span class="keywordflow">if</span> (ir == xi[0] &amp;&amp; localside == 0)</div>
<div class="line"><a name="l03135"></a><span class="lineno"> 3135</span>&#160;          {  <span class="comment">// r slice</span></div>
<div class="line"><a name="l03136"></a><span class="lineno"> 3136</span>&#160;            <span class="comment">// printf(&quot;ir=%d, r=%f (pz)=(%d,%d), distortR=%2.2f, distortP=%2.2f\n&quot;,ir,partR,ip,iz,distortR,distortP);</span></div>
<div class="line"><a name="l03137"></a><span class="lineno"> 3137</span>&#160;            hIntDist[0][0]-&gt;Fill(partP, partZ, distortR);</div>
<div class="line"><a name="l03138"></a><span class="lineno"> 3138</span>&#160;            hIntDist[0][1]-&gt;Fill(partP, partZ, distortP);</div>
<div class="line"><a name="l03139"></a><span class="lineno"> 3139</span>&#160;            hIntDist[0][2]-&gt;Fill(partP, partZ, distortZ);</div>
<div class="line"><a name="l03140"></a><span class="lineno"> 3140</span>&#160;            hDiffDist[0][0]-&gt;Fill(partP, partZ, diffdistR);</div>
<div class="line"><a name="l03141"></a><span class="lineno"> 3141</span>&#160;            hDiffDist[0][1]-&gt;Fill(partP, partZ, diffdistP);</div>
<div class="line"><a name="l03142"></a><span class="lineno"> 3142</span>&#160;            hDiffDist[0][2]-&gt;Fill(partP, partZ, diffdistZ);</div>
<div class="line"><a name="l03143"></a><span class="lineno"> 3143</span>&#160;          }</div>
<div class="line"><a name="l03144"></a><span class="lineno"> 3144</span>&#160;          <span class="keywordflow">if</span> (ip == xi[1] &amp;&amp; localside == 0)</div>
<div class="line"><a name="l03145"></a><span class="lineno"> 3145</span>&#160;          {  <span class="comment">// phi slice</span></div>
<div class="line"><a name="l03146"></a><span class="lineno"> 3146</span>&#160;            <span class="comment">// printf(&quot;ip=%d, p=%f (rz)=(%d,%d), distortR=%2.2f, distortP=%2.2f\n&quot;,ip,partP,ir,iz,distortR,distortP);</span></div>
<div class="line"><a name="l03147"></a><span class="lineno"> 3147</span>&#160;            hIntDist[1][0]-&gt;Fill(partZ, partR, distortR);</div>
<div class="line"><a name="l03148"></a><span class="lineno"> 3148</span>&#160;            hIntDist[1][1]-&gt;Fill(partZ, partR, distortP);</div>
<div class="line"><a name="l03149"></a><span class="lineno"> 3149</span>&#160;            hIntDist[1][2]-&gt;Fill(partZ, partR, distortZ);</div>
<div class="line"><a name="l03150"></a><span class="lineno"> 3150</span>&#160;            hDiffDist[1][0]-&gt;Fill(partZ, partR, diffdistR);</div>
<div class="line"><a name="l03151"></a><span class="lineno"> 3151</span>&#160;            hDiffDist[1][1]-&gt;Fill(partZ, partR, diffdistP);</div>
<div class="line"><a name="l03152"></a><span class="lineno"> 3152</span>&#160;            hDiffDist[1][2]-&gt;Fill(partZ, partR, diffdistZ);</div>
<div class="line"><a name="l03153"></a><span class="lineno"> 3153</span>&#160;</div>
<div class="line"><a name="l03154"></a><span class="lineno"> 3154</span>&#160;            <span class="keywordflow">if</span> (iz == xi[2] &amp;&amp; localside == 0)</div>
<div class="line"><a name="l03155"></a><span class="lineno"> 3155</span>&#160;            {  <span class="comment">// z slices of phi slices= r line at mid phi, mid z:</span></div>
<div class="line"><a name="l03156"></a><span class="lineno"> 3156</span>&#160;              hRDist[0][0]-&gt;Fill(partR, distortR);</div>
<div class="line"><a name="l03157"></a><span class="lineno"> 3157</span>&#160;              hRDist[0][1]-&gt;Fill(partR, distortP);</div>
<div class="line"><a name="l03158"></a><span class="lineno"> 3158</span>&#160;              hRDist[0][2]-&gt;Fill(partR, distortZ);</div>
<div class="line"><a name="l03159"></a><span class="lineno"> 3159</span>&#160;              hRDiffDist[0][0]-&gt;Fill(partR, diffdistR);</div>
<div class="line"><a name="l03160"></a><span class="lineno"> 3160</span>&#160;              hRDiffDist[0][1]-&gt;Fill(partR, diffdistP);</div>
<div class="line"><a name="l03161"></a><span class="lineno"> 3161</span>&#160;              hRDiffDist[0][2]-&gt;Fill(partR, diffdistZ);</div>
<div class="line"><a name="l03162"></a><span class="lineno"> 3162</span>&#160;            }</div>
<div class="line"><a name="l03163"></a><span class="lineno"> 3163</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a> &amp;&amp; iz == twinz &amp;&amp; localside == 1)</div>
<div class="line"><a name="l03164"></a><span class="lineno"> 3164</span>&#160;            {  <span class="comment">// z slices of phi slices= r line at mid phi, mid z:</span></div>
<div class="line"><a name="l03165"></a><span class="lineno"> 3165</span>&#160;              hRDist[1][0]-&gt;Fill(partR, distortR);</div>
<div class="line"><a name="l03166"></a><span class="lineno"> 3166</span>&#160;              hRDist[1][1]-&gt;Fill(partR, distortP);</div>
<div class="line"><a name="l03167"></a><span class="lineno"> 3167</span>&#160;              hRDist[1][2]-&gt;Fill(partR, distortZ);</div>
<div class="line"><a name="l03168"></a><span class="lineno"> 3168</span>&#160;              hRDiffDist[1][0]-&gt;Fill(partR, diffdistR);</div>
<div class="line"><a name="l03169"></a><span class="lineno"> 3169</span>&#160;              hRDiffDist[1][1]-&gt;Fill(partR, diffdistP);</div>
<div class="line"><a name="l03170"></a><span class="lineno"> 3170</span>&#160;              hRDiffDist[1][2]-&gt;Fill(partR, diffdistZ);</div>
<div class="line"><a name="l03171"></a><span class="lineno"> 3171</span>&#160;            }</div>
<div class="line"><a name="l03172"></a><span class="lineno"> 3172</span>&#160;          }</div>
<div class="line"><a name="l03173"></a><span class="lineno"> 3173</span>&#160;          <span class="keywordflow">if</span> (iz == xi[2] &amp;&amp; localside == 0)</div>
<div class="line"><a name="l03174"></a><span class="lineno"> 3174</span>&#160;          {  <span class="comment">// z slice</span></div>
<div class="line"><a name="l03175"></a><span class="lineno"> 3175</span>&#160;            <span class="comment">// printf(&quot;iz=%d, z=%f (rp)=(%d,%d), distortR=%2.2f, distortP=%2.2f\n&quot;,iz,partZ,ir,ip,distortR,distortP);</span></div>
<div class="line"><a name="l03176"></a><span class="lineno"> 3176</span>&#160;</div>
<div class="line"><a name="l03177"></a><span class="lineno"> 3177</span>&#160;            hIntDist[2][0]-&gt;Fill(partR, partP, distortR);</div>
<div class="line"><a name="l03178"></a><span class="lineno"> 3178</span>&#160;            hIntDist[2][1]-&gt;Fill(partR, partP, distortP);</div>
<div class="line"><a name="l03179"></a><span class="lineno"> 3179</span>&#160;            hIntDist[2][2]-&gt;Fill(partR, partP, distortZ);</div>
<div class="line"><a name="l03180"></a><span class="lineno"> 3180</span>&#160;            hDiffDist[2][0]-&gt;Fill(partR, partP, diffdistR);</div>
<div class="line"><a name="l03181"></a><span class="lineno"> 3181</span>&#160;            hDiffDist[2][1]-&gt;Fill(partR, partP, diffdistP);</div>
<div class="line"><a name="l03182"></a><span class="lineno"> 3182</span>&#160;            hDiffDist[2][2]-&gt;Fill(partR, partP, diffdistZ);</div>
<div class="line"><a name="l03183"></a><span class="lineno"> 3183</span>&#160;          }</div>
<div class="line"><a name="l03184"></a><span class="lineno"> 3184</span>&#160;</div>
<div class="line"><a name="l03185"></a><span class="lineno"> 3185</span>&#160;          <span class="keywordflow">if</span> (!(el % waypoint))</div>
<div class="line"><a name="l03186"></a><span class="lineno"> 3186</span>&#160;          {</div>
<div class="line"><a name="l03187"></a><span class="lineno"> 3187</span>&#160;            <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;generating distortions %d%%:  &quot;</span>, (<span class="keywordtype">int</span>) (el / percent));</div>
<div class="line"><a name="l03188"></a><span class="lineno"> 3188</span>&#160;            <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;distortion at (ir=%d,ip=%d,iz=%d) is (%E,%E,%E)\n&quot;</span>,</div>
<div class="line"><a name="l03189"></a><span class="lineno"> 3189</span>&#160;                   ir, ip, iz, distortR, distortP, distortZ);</div>
<div class="line"><a name="l03190"></a><span class="lineno"> 3190</span>&#160;          }</div>
<div class="line"><a name="l03191"></a><span class="lineno"> 3191</span>&#160;          el++;</div>
<div class="line"><a name="l03192"></a><span class="lineno"> 3192</span>&#160;        }</div>
<div class="line"><a name="l03193"></a><span class="lineno"> 3193</span>&#160;      }</div>
<div class="line"><a name="l03194"></a><span class="lineno"> 3194</span>&#160;    }</div>
<div class="line"><a name="l03195"></a><span class="lineno"> 3195</span>&#160;  }</div>
<div class="line"><a name="l03196"></a><span class="lineno"> 3196</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;Completed distortion generation.  Saving outputs...\n&quot;</span>);</div>
<div class="line"><a name="l03197"></a><span class="lineno"> 3197</span>&#160;</div>
<div class="line"><a name="l03198"></a><span class="lineno"> 3198</span>&#160;  TCanvas *canvas = <span class="keyword">new</span> TCanvas(<span class="stringliteral">&quot;cdistort&quot;</span>, <span class="stringliteral">&quot;distortion integrals&quot;</span>, 1200, 800);</div>
<div class="line"><a name="l03199"></a><span class="lineno"> 3199</span>&#160;  <span class="comment">// take 10 of the bottom of this for data?</span></div>
<div class="line"><a name="l03200"></a><span class="lineno"> 3200</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;was able to make a tcanvas\n&quot;</span>);</div>
<div class="line"><a name="l03201"></a><span class="lineno"> 3201</span>&#160;  canvas-&gt;cd();</div>
<div class="line"><a name="l03202"></a><span class="lineno"> 3202</span>&#160;  TPad *<a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a> = <span class="keyword">new</span> TPad(<span class="stringliteral">&quot;cplots&quot;</span>, <span class="stringliteral">&quot;distortion integral plots&quot;</span>, 0, 0.2, 1, 1);</div>
<div class="line"><a name="l03203"></a><span class="lineno"> 3203</span>&#160;  canvas-&gt;cd();</div>
<div class="line"><a name="l03204"></a><span class="lineno"> 3204</span>&#160;  TPad *textpad = <span class="keyword">new</span> TPad(<span class="stringliteral">&quot;ctext&quot;</span>, <span class="stringliteral">&quot;distortion integral plots&quot;</span>, 0, 0.0, 1, 0.2);</div>
<div class="line"><a name="l03205"></a><span class="lineno"> 3205</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;was able to make some tpads\n&quot;</span>);</div>
<div class="line"><a name="l03206"></a><span class="lineno"> 3206</span>&#160;</div>
<div class="line"><a name="l03207"></a><span class="lineno"> 3207</span>&#160;  c-&gt;Divide(4, 3);</div>
<div class="line"><a name="l03208"></a><span class="lineno"> 3208</span>&#160;  gStyle-&gt;SetOptStat();</div>
<div class="line"><a name="l03209"></a><span class="lineno"> 3209</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;was able to interact with gStyle\n&quot;</span>);</div>
<div class="line"><a name="l03210"></a><span class="lineno"> 3210</span>&#160;</div>
<div class="line"><a name="l03211"></a><span class="lineno"> 3211</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 3; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l03212"></a><span class="lineno"> 3212</span>&#160;  {</div>
<div class="line"><a name="l03213"></a><span class="lineno"> 3213</span>&#160;    <span class="comment">// component</span></div>
<div class="line"><a name="l03214"></a><span class="lineno"> 3214</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> = 0; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> &lt; 3; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>++)</div>
<div class="line"><a name="l03215"></a><span class="lineno"> 3215</span>&#160;    {</div>
<div class="line"><a name="l03216"></a><span class="lineno"> 3216</span>&#160;      <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;looping over components i=%d ax=%d\n&quot;</span>, <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>, <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>);</div>
<div class="line"><a name="l03217"></a><span class="lineno"> 3217</span>&#160;</div>
<div class="line"><a name="l03218"></a><span class="lineno"> 3218</span>&#160;      <span class="comment">// plane</span></div>
<div class="line"><a name="l03219"></a><span class="lineno"> 3219</span>&#160;      c-&gt;cd(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> * 4 + <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1);</div>
<div class="line"><a name="l03220"></a><span class="lineno"> 3220</span>&#160;      gPad-&gt;SetRightMargin(0.15);</div>
<div class="line"><a name="l03221"></a><span class="lineno"> 3221</span>&#160;      hIntDist[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l03222"></a><span class="lineno"> 3222</span>&#160;      hIntDist[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Draw(<span class="stringliteral">&quot;colz&quot;</span>);</div>
<div class="line"><a name="l03223"></a><span class="lineno"> 3223</span>&#160;    }</div>
<div class="line"><a name="l03224"></a><span class="lineno"> 3224</span>&#160;</div>
<div class="line"><a name="l03225"></a><span class="lineno"> 3225</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;drawing R profile %d\n&quot;</span>, <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>);</div>
<div class="line"><a name="l03226"></a><span class="lineno"> 3226</span>&#160;</div>
<div class="line"><a name="l03227"></a><span class="lineno"> 3227</span>&#160;    c-&gt;cd(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> * 4 + 4);</div>
<div class="line"><a name="l03228"></a><span class="lineno"> 3228</span>&#160;    hRDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l03229"></a><span class="lineno"> 3229</span>&#160;    hRDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetFillColor(kRed);</div>
<div class="line"><a name="l03230"></a><span class="lineno"> 3230</span>&#160;    hRDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Draw(<span class="stringliteral">&quot;hist&quot;</span>);</div>
<div class="line"><a name="l03231"></a><span class="lineno"> 3231</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l03232"></a><span class="lineno"> 3232</span>&#160;    {</div>
<div class="line"><a name="l03233"></a><span class="lineno"> 3233</span>&#160;      <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;drawing R profile twin %d\n&quot;</span>, <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>);</div>
<div class="line"><a name="l03234"></a><span class="lineno"> 3234</span>&#160;      hRDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l03235"></a><span class="lineno"> 3235</span>&#160;      hRDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetLineColor(kBlue);</div>
<div class="line"><a name="l03236"></a><span class="lineno"> 3236</span>&#160;      hRDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Draw(<span class="stringliteral">&quot;hist,same&quot;</span>);</div>
<div class="line"><a name="l03237"></a><span class="lineno"> 3237</span>&#160;    }</div>
<div class="line"><a name="l03238"></a><span class="lineno"> 3238</span>&#160;  }</div>
<div class="line"><a name="l03239"></a><span class="lineno"> 3239</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;switching to textpad\n&quot;</span>);</div>
<div class="line"><a name="l03240"></a><span class="lineno"> 3240</span>&#160;</div>
<div class="line"><a name="l03241"></a><span class="lineno"> 3241</span>&#160;  textpad-&gt;cd();</div>
<div class="line"><a name="l03242"></a><span class="lineno"> 3242</span>&#160;  <span class="keywordtype">float</span> texpos = 0.9;</div>
<div class="line"><a name="l03243"></a><span class="lineno"> 3243</span>&#160;  <span class="keywordtype">float</span> texshift = 0.12;</div>
<div class="line"><a name="l03244"></a><span class="lineno"> 3244</span>&#160;  TLatex *<a class="code" href="../../d2/d72/upsilons__sphenix__5yesrs_8C.html#a4e721c2d345d18d80d240cbaf1597be5">tex</a> = <span class="keyword">new</span> TLatex(0.0, texpos, <span class="stringliteral">&quot;Fill Me In&quot;</span>);</div>
<div class="line"><a name="l03245"></a><span class="lineno"> 3245</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;built TLatex\n&quot;</span>);</div>
<div class="line"><a name="l03246"></a><span class="lineno"> 3246</span>&#160;</div>
<div class="line"><a name="l03247"></a><span class="lineno"> 3247</span>&#160;  tex-&gt;SetTextSize(texshift * 0.8);</div>
<div class="line"><a name="l03248"></a><span class="lineno"> 3248</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a146ebec611255de008dd779f3092f893">GetFieldString</a>());</div>
<div class="line"><a name="l03249"></a><span class="lineno"> 3249</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03250"></a><span class="lineno"> 3250</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a98979ea683686b965fa9d6f17b5499ed">GetChargeString</a>());</div>
<div class="line"><a name="l03251"></a><span class="lineno"> 3251</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03252"></a><span class="lineno"> 3252</span>&#160;  <span class="comment">// tex-&gt;DrawLatex(0.05,texpos,Form(&quot;Drift Field = %2.2f V/cm&quot;,GetNominalE()));texpos-=texshift;</span></div>
<div class="line"><a name="l03253"></a><span class="lineno"> 3253</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, Form(<span class="stringliteral">&quot;Drifting grid of (rp)=(%d x %d) electrons with %d steps&quot;</span>, nrh, nph, nSteps));</div>
<div class="line"><a name="l03254"></a><span class="lineno"> 3254</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03255"></a><span class="lineno"> 3255</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a7968214559bb324459390f9cce7e8a88">GetLookupString</a>());</div>
<div class="line"><a name="l03256"></a><span class="lineno"> 3256</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03257"></a><span class="lineno"> 3257</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#af0c340523f69f514b60be663c0422f26">GetGasString</a>());</div>
<div class="line"><a name="l03258"></a><span class="lineno"> 3258</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03259"></a><span class="lineno"> 3259</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Mag() &gt; 0)</div>
<div class="line"><a name="l03260"></a><span class="lineno"> 3260</span>&#160;  {</div>
<div class="line"><a name="l03261"></a><span class="lineno"> 3261</span>&#160;    tex-&gt;DrawLatex(0.05, texpos, Form(<span class="stringliteral">&quot;Distortion scaled by (r,p,z)=(%2.2f,%2.2f,%2.2f)&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.X(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Y(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Z()));</div>
<div class="line"><a name="l03262"></a><span class="lineno"> 3262</span>&#160;    texpos -= texshift;</div>
<div class="line"><a name="l03263"></a><span class="lineno"> 3263</span>&#160;  }</div>
<div class="line"><a name="l03264"></a><span class="lineno"> 3264</span>&#160;  texpos = 0.9;</div>
<div class="line"><a name="l03265"></a><span class="lineno"> 3265</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;cd&#39;ing to canvas:\n&quot;</span>);</div>
<div class="line"><a name="l03266"></a><span class="lineno"> 3266</span>&#160;</div>
<div class="line"><a name="l03267"></a><span class="lineno"> 3267</span>&#160;  canvas-&gt;cd();</div>
<div class="line"><a name="l03268"></a><span class="lineno"> 3268</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;draw1\n&quot;</span>);</div>
<div class="line"><a name="l03269"></a><span class="lineno"> 3269</span>&#160;</div>
<div class="line"><a name="l03270"></a><span class="lineno"> 3270</span>&#160;  c-&gt;Draw();</div>
<div class="line"><a name="l03271"></a><span class="lineno"> 3271</span>&#160;  canvas-&gt;cd();</div>
<div class="line"><a name="l03272"></a><span class="lineno"> 3272</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;draw2\n&quot;</span>);</div>
<div class="line"><a name="l03273"></a><span class="lineno"> 3273</span>&#160;  textpad-&gt;Draw();</div>
<div class="line"><a name="l03274"></a><span class="lineno"> 3274</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;was able to complete drawing on both pads\n&quot;</span>);</div>
<div class="line"><a name="l03275"></a><span class="lineno"> 3275</span>&#160;</div>
<div class="line"><a name="l03276"></a><span class="lineno"> 3276</span>&#160;  canvas-&gt;SaveAs(summaryFilename.Data());</div>
<div class="line"><a name="l03277"></a><span class="lineno"> 3277</span>&#160;</div>
<div class="line"><a name="l03278"></a><span class="lineno"> 3278</span>&#160;  <span class="comment">// canvas-&gt;cd();</span></div>
<div class="line"><a name="l03279"></a><span class="lineno"> 3279</span>&#160;  <span class="comment">// already done TPad *c=new TPad(&quot;cplots&quot;,&quot;distortion differential plots&quot;,0,0.2,1,1);</span></div>
<div class="line"><a name="l03280"></a><span class="lineno"> 3280</span>&#160;  <span class="comment">// canvas-&gt;cd();</span></div>
<div class="line"><a name="l03281"></a><span class="lineno"> 3281</span>&#160;  <span class="comment">// already done TPad *textpad=new TPad(&quot;ctext&quot;,&quot;distortion differential plots&quot;,0,0.0,1,0.2);</span></div>
<div class="line"><a name="l03282"></a><span class="lineno"> 3282</span>&#160;  <span class="comment">// already done c-&gt;Divide(4,3);</span></div>
<div class="line"><a name="l03283"></a><span class="lineno"> 3283</span>&#160;  <span class="comment">// gStyle-&gt;SetOptStat();</span></div>
<div class="line"><a name="l03284"></a><span class="lineno"> 3284</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 3; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l03285"></a><span class="lineno"> 3285</span>&#160;  {</div>
<div class="line"><a name="l03286"></a><span class="lineno"> 3286</span>&#160;    <span class="comment">// component</span></div>
<div class="line"><a name="l03287"></a><span class="lineno"> 3287</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> = 0; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> &lt; 3; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>++)</div>
<div class="line"><a name="l03288"></a><span class="lineno"> 3288</span>&#160;    {</div>
<div class="line"><a name="l03289"></a><span class="lineno"> 3289</span>&#160;      <span class="comment">// plane</span></div>
<div class="line"><a name="l03290"></a><span class="lineno"> 3290</span>&#160;      c-&gt;cd(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> * 4 + <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1);</div>
<div class="line"><a name="l03291"></a><span class="lineno"> 3291</span>&#160;      gPad-&gt;SetRightMargin(0.15);</div>
<div class="line"><a name="l03292"></a><span class="lineno"> 3292</span>&#160;      hDiffDist[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l03293"></a><span class="lineno"> 3293</span>&#160;      hDiffDist[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Draw(<span class="stringliteral">&quot;colz&quot;</span>);</div>
<div class="line"><a name="l03294"></a><span class="lineno"> 3294</span>&#160;    }</div>
<div class="line"><a name="l03295"></a><span class="lineno"> 3295</span>&#160;    c-&gt;cd(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> * 4 + 4);</div>
<div class="line"><a name="l03296"></a><span class="lineno"> 3296</span>&#160;    hRDiffDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l03297"></a><span class="lineno"> 3297</span>&#160;    hRDiffDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetFillColor(kRed);</div>
<div class="line"><a name="l03298"></a><span class="lineno"> 3298</span>&#160;    hRDiffDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Draw(<span class="stringliteral">&quot;hist&quot;</span>);</div>
<div class="line"><a name="l03299"></a><span class="lineno"> 3299</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l03300"></a><span class="lineno"> 3300</span>&#160;    {</div>
<div class="line"><a name="l03301"></a><span class="lineno"> 3301</span>&#160;      hRDiffDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l03302"></a><span class="lineno"> 3302</span>&#160;      hRDiffDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetLineColor(kBlue);</div>
<div class="line"><a name="l03303"></a><span class="lineno"> 3303</span>&#160;      hRDiffDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Draw(<span class="stringliteral">&quot;hist same&quot;</span>);</div>
<div class="line"><a name="l03304"></a><span class="lineno"> 3304</span>&#160;    }</div>
<div class="line"><a name="l03305"></a><span class="lineno"> 3305</span>&#160;  }</div>
<div class="line"><a name="l03306"></a><span class="lineno"> 3306</span>&#160;  textpad-&gt;cd();</div>
<div class="line"><a name="l03307"></a><span class="lineno"> 3307</span>&#160;  texpos = 0.9;</div>
<div class="line"><a name="l03308"></a><span class="lineno"> 3308</span>&#160;  texshift = 0.12;</div>
<div class="line"><a name="l03309"></a><span class="lineno"> 3309</span>&#160;  tex-&gt;SetTextSize(texshift * 0.8);</div>
<div class="line"><a name="l03310"></a><span class="lineno"> 3310</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a146ebec611255de008dd779f3092f893">GetFieldString</a>());</div>
<div class="line"><a name="l03311"></a><span class="lineno"> 3311</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03312"></a><span class="lineno"> 3312</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a98979ea683686b965fa9d6f17b5499ed">GetChargeString</a>());</div>
<div class="line"><a name="l03313"></a><span class="lineno"> 3313</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03314"></a><span class="lineno"> 3314</span>&#160;  <span class="comment">// tex-&gt;DrawLatex(0.05,texpos,Form(&quot;Drift Field = %2.2f V/cm&quot;,GetNominalE()));texpos-=texshift;</span></div>
<div class="line"><a name="l03315"></a><span class="lineno"> 3315</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, Form(<span class="stringliteral">&quot;Drifting grid of (rp)=(%d x %d) electrons with %d steps&quot;</span>, nrh, nph, nSteps));</div>
<div class="line"><a name="l03316"></a><span class="lineno"> 3316</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03317"></a><span class="lineno"> 3317</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a7968214559bb324459390f9cce7e8a88">GetLookupString</a>());</div>
<div class="line"><a name="l03318"></a><span class="lineno"> 3318</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03319"></a><span class="lineno"> 3319</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#af0c340523f69f514b60be663c0422f26">GetGasString</a>());</div>
<div class="line"><a name="l03320"></a><span class="lineno"> 3320</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03321"></a><span class="lineno"> 3321</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <span class="stringliteral">&quot;Differential Plots&quot;</span>);</div>
<div class="line"><a name="l03322"></a><span class="lineno"> 3322</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03323"></a><span class="lineno"> 3323</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Mag() &gt; 0)</div>
<div class="line"><a name="l03324"></a><span class="lineno"> 3324</span>&#160;  {</div>
<div class="line"><a name="l03325"></a><span class="lineno"> 3325</span>&#160;    tex-&gt;DrawLatex(0.05, texpos, Form(<span class="stringliteral">&quot;Distortion scaled by (r,p,z)=(%2.2f,%2.2f,%2.2f)&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.X(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Y(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Z()));</div>
<div class="line"><a name="l03326"></a><span class="lineno"> 3326</span>&#160;    texpos -= texshift;</div>
<div class="line"><a name="l03327"></a><span class="lineno"> 3327</span>&#160;  }</div>
<div class="line"><a name="l03328"></a><span class="lineno"> 3328</span>&#160;  texpos = 0.9;</div>
<div class="line"><a name="l03329"></a><span class="lineno"> 3329</span>&#160;</div>
<div class="line"><a name="l03330"></a><span class="lineno"> 3330</span>&#160;  canvas-&gt;cd();</div>
<div class="line"><a name="l03331"></a><span class="lineno"> 3331</span>&#160;  c-&gt;Draw();</div>
<div class="line"><a name="l03332"></a><span class="lineno"> 3332</span>&#160;  canvas-&gt;cd();</div>
<div class="line"><a name="l03333"></a><span class="lineno"> 3333</span>&#160;  textpad-&gt;Draw();</div>
<div class="line"><a name="l03334"></a><span class="lineno"> 3334</span>&#160;  canvas-&gt;SaveAs(diffSummaryFilename.Data());</div>
<div class="line"><a name="l03335"></a><span class="lineno"> 3335</span>&#160;</div>
<div class="line"><a name="l03336"></a><span class="lineno"> 3336</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;saving map histograms to:%s.\n&quot;</span>, distortionFilename.Data());</div>
<div class="line"><a name="l03337"></a><span class="lineno"> 3337</span>&#160;</div>
<div class="line"><a name="l03338"></a><span class="lineno"> 3338</span>&#160;  outf-&gt;cd();</div>
<div class="line"><a name="l03339"></a><span class="lineno"> 3339</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; nSides; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l03340"></a><span class="lineno"> 3340</span>&#160;  {</div>
<div class="line"><a name="l03341"></a><span class="lineno"> 3341</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;Saving side &#39;%s&#39;\n&quot;</span>, side[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>].<a class="code" href="../../da/de5/ThicknessScan_8m.html#af5baa506e65b4caa6be6d1c6661dfe63">Data</a>());</div>
<div class="line"><a name="l03342"></a><span class="lineno"> 3342</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a> &lt; nMapComponents; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>++)</div>
<div class="line"><a name="l03343"></a><span class="lineno"> 3343</span>&#160;    {</div>
<div class="line"><a name="l03344"></a><span class="lineno"> 3344</span>&#160;      hSeparatedMapComponent[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>]-&gt;GetSumw2()-&gt;Set(0);</div>
<div class="line"><a name="l03345"></a><span class="lineno"> 3345</span>&#160;      hSeparatedMapComponent[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a37d972ae0b47b9099e30983131d31916">j</a>]-&gt;Write();</div>
<div class="line"><a name="l03346"></a><span class="lineno"> 3346</span>&#160;    }</div>
<div class="line"><a name="l03347"></a><span class="lineno"> 3347</span>&#160;    hValidToStepComponent[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;GetSumw2()-&gt;Set(0);</div>
<div class="line"><a name="l03348"></a><span class="lineno"> 3348</span>&#160;    hValidToStepComponent[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Write();</div>
<div class="line"><a name="l03349"></a><span class="lineno"> 3349</span>&#160;</div>
<div class="line"><a name="l03350"></a><span class="lineno"> 3350</span>&#160;    hReachesReadout[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;GetSumw2()-&gt;Set(0);</div>
<div class="line"><a name="l03351"></a><span class="lineno"> 3351</span>&#160;    hReachesReadout[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Write();</div>
<div class="line"><a name="l03352"></a><span class="lineno"> 3352</span>&#160;  }</div>
<div class="line"><a name="l03353"></a><span class="lineno"> 3353</span>&#160;  <span class="keywordflow">if</span> (rdrswitch)</div>
<div class="line"><a name="l03354"></a><span class="lineno"> 3354</span>&#160;  {</div>
<div class="line"><a name="l03355"></a><span class="lineno"> 3355</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a19e0ccae97c9eaaf9778c5bb938e8b1d">hRdeltaRComponent</a>-&gt;GetSumw2()-&gt;Set(0);</div>
<div class="line"><a name="l03356"></a><span class="lineno"> 3356</span>&#160;    <a class="code" href="../../de/d64/classAnnularFieldSim.html#a19e0ccae97c9eaaf9778c5bb938e8b1d">hRdeltaRComponent</a>-&gt;Write();</div>
<div class="line"><a name="l03357"></a><span class="lineno"> 3357</span>&#160;  }</div>
<div class="line"><a name="l03358"></a><span class="lineno"> 3358</span>&#160;</div>
<div class="line"><a name="l03359"></a><span class="lineno"> 3359</span>&#160;  hDistortionR-&gt;GetSumw2()-&gt;Set(0);</div>
<div class="line"><a name="l03360"></a><span class="lineno"> 3360</span>&#160;  hDistortionP-&gt;GetSumw2()-&gt;Set(0);</div>
<div class="line"><a name="l03361"></a><span class="lineno"> 3361</span>&#160;  hDistortionZ-&gt;GetSumw2()-&gt;Set(0);</div>
<div class="line"><a name="l03362"></a><span class="lineno"> 3362</span>&#160;  hIntDistortionR-&gt;GetSumw2()-&gt;Set(0);</div>
<div class="line"><a name="l03363"></a><span class="lineno"> 3363</span>&#160;  hIntDistortionP-&gt;GetSumw2()-&gt;Set(0);</div>
<div class="line"><a name="l03364"></a><span class="lineno"> 3364</span>&#160;  hIntDistortionZ-&gt;GetSumw2()-&gt;Set(0);</div>
<div class="line"><a name="l03365"></a><span class="lineno"> 3365</span>&#160;  <span class="keywordflow">if</span> (andCartesian)</div>
<div class="line"><a name="l03366"></a><span class="lineno"> 3366</span>&#160;  {</div>
<div class="line"><a name="l03367"></a><span class="lineno"> 3367</span>&#160;    hIntDistortionX-&gt;GetSumw2()-&gt;Set(0);</div>
<div class="line"><a name="l03368"></a><span class="lineno"> 3368</span>&#160;    hIntDistortionY-&gt;GetSumw2()-&gt;Set(0);</div>
<div class="line"><a name="l03369"></a><span class="lineno"> 3369</span>&#160;  }</div>
<div class="line"><a name="l03370"></a><span class="lineno"> 3370</span>&#160;  hDistortionR-&gt;Write();</div>
<div class="line"><a name="l03371"></a><span class="lineno"> 3371</span>&#160;  hDistortionP-&gt;Write();</div>
<div class="line"><a name="l03372"></a><span class="lineno"> 3372</span>&#160;  hDistortionZ-&gt;Write();</div>
<div class="line"><a name="l03373"></a><span class="lineno"> 3373</span>&#160;  hIntDistortionR-&gt;Write();</div>
<div class="line"><a name="l03374"></a><span class="lineno"> 3374</span>&#160;  hIntDistortionP-&gt;Write();</div>
<div class="line"><a name="l03375"></a><span class="lineno"> 3375</span>&#160;  hIntDistortionZ-&gt;Write();</div>
<div class="line"><a name="l03376"></a><span class="lineno"> 3376</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">false</span> &amp;&amp; andCartesian)</div>
<div class="line"><a name="l03377"></a><span class="lineno"> 3377</span>&#160;  {</div>
<div class="line"><a name="l03378"></a><span class="lineno"> 3378</span>&#160;    hIntDistortionX-&gt;Write();</div>
<div class="line"><a name="l03379"></a><span class="lineno"> 3379</span>&#160;    hIntDistortionY-&gt;Write();</div>
<div class="line"><a name="l03380"></a><span class="lineno"> 3380</span>&#160;  }</div>
<div class="line"><a name="l03381"></a><span class="lineno"> 3381</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;finished writing histograms\n&quot;</span>);</div>
<div class="line"><a name="l03382"></a><span class="lineno"> 3382</span>&#160;  <span class="comment">// dTree-&gt;Write();</span></div>
<div class="line"><a name="l03383"></a><span class="lineno"> 3383</span>&#160;  <span class="comment">//  printf(&quot;wrote dTree\n&quot;);</span></div>
<div class="line"><a name="l03384"></a><span class="lineno"> 3384</span>&#160;  outf-&gt;Close();</div>
<div class="line"><a name="l03385"></a><span class="lineno"> 3385</span>&#160;  <span class="comment">// printf(&quot;map:%s.closed\n&quot;,distortionFilename.Data());</span></div>
<div class="line"><a name="l03386"></a><span class="lineno"> 3386</span>&#160;</div>
<div class="line"><a name="l03387"></a><span class="lineno"> 3387</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;wrote separated map and summary to %s.\n&quot;</span>, filebase);</div>
<div class="line"><a name="l03388"></a><span class="lineno"> 3388</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;map:%s.\n&quot;</span>, distortionFilename.Data());</div>
<div class="line"><a name="l03389"></a><span class="lineno"> 3389</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;summary:%s.\n&quot;</span>, summaryFilename.Data());</div>
<div class="line"><a name="l03390"></a><span class="lineno"> 3390</span>&#160;  <span class="comment">// printf(&quot;wrote map and summary to %s and %s.\n&quot;,distortionFilename.Data(),summaryFilename.Data());</span></div>
<div class="line"><a name="l03391"></a><span class="lineno"> 3391</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03392"></a><span class="lineno"> 3392</span>&#160;}</div>
<div class="line"><a name="l03393"></a><span class="lineno"> 3393</span>&#160;</div>
<div class="line"><a name="l03394"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a69085e0758c28f66750ab848c3d35a8f"> 3394</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a69085e0758c28f66750ab848c3d35a8f">AnnularFieldSim::GenerateDistortionMaps</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filebase, <span class="keywordtype">int</span> r_subsamples, <span class="keywordtype">int</span> p_subsamples, <span class="keywordtype">int</span> z_subsamples, <span class="keywordtype">int</span> <span class="comment">/*z_substeps*/</span>, <span class="keywordtype">bool</span> andCartesian)</div>
<div class="line"><a name="l03395"></a><span class="lineno"> 3395</span>&#160;{</div>
<div class="line"><a name="l03396"></a><span class="lineno"> 3396</span>&#160;  <span class="comment">// generates the distortion map for the full detector instead of one map per side.</span></div>
<div class="line"><a name="l03397"></a><span class="lineno"> 3397</span>&#160;  <span class="comment">// This produces wrong behavior when interpolating across the CM and should not be used</span></div>
<div class="line"><a name="l03398"></a><span class="lineno"> 3398</span>&#160;  <span class="comment">// unless you&#39;re doing some debugging/backward compatibility checking.  Eventually this should be removed  (said in early 2022)</span></div>
<div class="line"><a name="l03399"></a><span class="lineno"> 3399</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;WARNING:  You called the version of the distortion generator that generates a unified map.  Are you sure you meant to do this?\n&quot;</span>);</div>
<div class="line"><a name="l03400"></a><span class="lineno"> 3400</span>&#160;</div>
<div class="line"><a name="l03401"></a><span class="lineno"> 3401</span>&#160;  <span class="comment">// 1) pick a map spacing (&#39;s&#39;)</span></div>
<div class="line"><a name="l03402"></a><span class="lineno"> 3402</span>&#160;  <span class="keywordtype">bool</span> makeUnifiedMap = <span class="keyword">true</span>;  <span class="comment">// if true, generate a single map across the whole TPC.  if false, save two maps, one for each side.</span></div>
<div class="line"><a name="l03403"></a><span class="lineno"> 3403</span>&#160;</div>
<div class="line"><a name="l03404"></a><span class="lineno"> 3404</span>&#160;  TVector3 steplocal(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() / r_subsamples, 0, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() / z_subsamples);</div>
<div class="line"><a name="l03405"></a><span class="lineno"> 3405</span>&#160;  steplocal.SetPhi(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi() / p_subsamples);</div>
<div class="line"><a name="l03406"></a><span class="lineno"> 3406</span>&#160;  <span class="keywordtype">float</span> deltar = steplocal.Perp();  <span class="comment">//(rf-ri)/nr;</span></div>
<div class="line"><a name="l03407"></a><span class="lineno"> 3407</span>&#160;  <span class="keywordtype">float</span> deltap = steplocal.Phi();   <span class="comment">//(pf-pi)/np;</span></div>
<div class="line"><a name="l03408"></a><span class="lineno"> 3408</span>&#160;  <span class="keywordtype">float</span> deltaz = steplocal.Z();     <span class="comment">//(zf-zi)/nz;</span></div>
<div class="line"><a name="l03409"></a><span class="lineno"> 3409</span>&#160;  TVector3 stepzvec(0, 0, deltaz);</div>
<div class="line"><a name="l03410"></a><span class="lineno"> 3410</span>&#160;  <span class="keywordtype">int</span> nSteps = 500;  <span class="comment">// how many steps to take in the particle path.  hardcoded for now.  Think about this later.</span></div>
<div class="line"><a name="l03411"></a><span class="lineno"> 3411</span>&#160;</div>
<div class="line"><a name="l03412"></a><span class="lineno"> 3412</span>&#160;  <span class="comment">// idea for a faster way to build a map:</span></div>
<div class="line"><a name="l03413"></a><span class="lineno"> 3413</span>&#160;</div>
<div class="line"><a name="l03414"></a><span class="lineno"> 3414</span>&#160;  <span class="comment">// 2) generate the distortions steplocal.Z() away from the readout</span></div>
<div class="line"><a name="l03415"></a><span class="lineno"> 3415</span>&#160;  <span class="comment">// 3) generate the distortion from (i)*steplocal.Z() away to (i-1) away, then add the interpolated value from the (i-1) layer</span></div>
<div class="line"><a name="l03416"></a><span class="lineno"> 3416</span>&#160;</div>
<div class="line"><a name="l03417"></a><span class="lineno"> 3417</span>&#160;  <span class="comment">// for interpolation, Henry needs one extra buffer bin on each side.</span></div>
<div class="line"><a name="l03418"></a><span class="lineno"> 3418</span>&#160;</div>
<div class="line"><a name="l03419"></a><span class="lineno"> 3419</span>&#160;  <span class="comment">// so we define the histogram bounds (the &#39;h&#39; suffix) to be the full range</span></div>
<div class="line"><a name="l03420"></a><span class="lineno"> 3420</span>&#160;  <span class="comment">// plus an additional step in each direction so interpolation can work at the edges</span></div>
<div class="line"><a name="l03421"></a><span class="lineno"> 3421</span>&#160;  TVector3 lowerEdge = <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbb9bba03c21915698421f313dc43071">GetRoiCellCenter</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#aef30f781970f4b7a0709ee1da6defc90">rmin_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a46d75be3799c796b5ef085326fe9c3fe">phimin_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a100a33387d110f6fc985fb11b066fc0d">zmin_roi</a>);</div>
<div class="line"><a name="l03422"></a><span class="lineno"> 3422</span>&#160;  TVector3 upperEdge = <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbb9bba03c21915698421f313dc43071">GetRoiCellCenter</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac3e28c48fc1f03956561cdcfbc650999">rmax_roi</a> - 1, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac1e93ff3f4e623449e6d10d2f1910cc6">phimax_roi</a> - 1, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab07f230e28b39f3910eab9318400513c">zmax_roi</a> - 1);</div>
<div class="line"><a name="l03423"></a><span class="lineno"> 3423</span>&#160;  <span class="keywordtype">int</span> nph = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a> * p_subsamples + 2;  <span class="comment">// nuber of phibins in the histogram</span></div>
<div class="line"><a name="l03424"></a><span class="lineno"> 3424</span>&#160;  <span class="keywordtype">int</span> nrh = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a> * r_subsamples + 2;    <span class="comment">// number of r bins in the histogram</span></div>
<div class="line"><a name="l03425"></a><span class="lineno"> 3425</span>&#160;  <span class="keywordtype">int</span> nzh = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a> * z_subsamples + 2;    <span class="comment">// number of z you get the idea.</span></div>
<div class="line"><a name="l03426"></a><span class="lineno"> 3426</span>&#160;  <span class="keywordtype">int</span> successCheck;</div>
<div class="line"><a name="l03427"></a><span class="lineno"> 3427</span>&#160;</div>
<div class="line"><a name="l03428"></a><span class="lineno"> 3428</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a> &amp;&amp; makeUnifiedMap)</div>
<div class="line"><a name="l03429"></a><span class="lineno"> 3429</span>&#160;  {  <span class="comment">// double the z range if we have a twin.  r and phi are the same, unless we had a phi roi...</span></div>
<div class="line"><a name="l03430"></a><span class="lineno"> 3430</span>&#160;    lowerEdge.SetZ(-1 * upperEdge.Z());</div>
<div class="line"><a name="l03431"></a><span class="lineno"> 3431</span>&#160;    nzh += <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a> * z_subsamples;</div>
<div class="line"><a name="l03432"></a><span class="lineno"> 3432</span>&#160;  }</div>
<div class="line"><a name="l03433"></a><span class="lineno"> 3433</span>&#160;</div>
<div class="line"><a name="l03434"></a><span class="lineno"> 3434</span>&#160;  <span class="keywordtype">float</span> rih = lowerEdge.Perp() - 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() - steplocal.Perp();             <span class="comment">// lower bound of roi, minus one</span></div>
<div class="line"><a name="l03435"></a><span class="lineno"> 3435</span>&#160;  <span class="keywordtype">float</span> rfh = upperEdge.Perp() + 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Perp() + steplocal.Perp();             <span class="comment">// upper bound of roi, plus one</span></div>
<div class="line"><a name="l03436"></a><span class="lineno"> 3436</span>&#160;  <span class="keywordtype">float</span> pih = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(lowerEdge.Phi()) - 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi() - steplocal.Phi();  <span class="comment">// can&#39;t automate this or we&#39;ll run afoul of phi looping.</span></div>
<div class="line"><a name="l03437"></a><span class="lineno"> 3437</span>&#160;  <span class="keywordtype">float</span> pfh = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(upperEdge.Phi()) + 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Phi() + steplocal.Phi();  <span class="comment">// can&#39;t automate this or we&#39;ll run afoul of phi looping.</span></div>
<div class="line"><a name="l03438"></a><span class="lineno"> 3438</span>&#160;  <span class="keywordtype">float</span> zih = lowerEdge.Z() - 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() - steplocal.Z();                      <span class="comment">// lower bound of roi, minus one</span></div>
<div class="line"><a name="l03439"></a><span class="lineno"> 3439</span>&#160;  <span class="keywordtype">float</span> zfh = upperEdge.Z() + 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z() + steplocal.Z();                      <span class="comment">// upper bound of roi, plus one</span></div>
<div class="line"><a name="l03440"></a><span class="lineno"> 3440</span>&#160;  <span class="keywordtype">float</span> z_readout = upperEdge.Z() + 0.5 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z();                                <span class="comment">// readout plane.  Note we assume this is positive.</span></div>
<div class="line"><a name="l03441"></a><span class="lineno"> 3441</span>&#160;</div>
<div class="line"><a name="l03442"></a><span class="lineno"> 3442</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;generating distortion map...\n&quot;</span>);</div>
<div class="line"><a name="l03443"></a><span class="lineno"> 3443</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;file=%s\n&quot;</span>, filebase);</div>
<div class="line"><a name="l03444"></a><span class="lineno"> 3444</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;Phi:  %d steps from %f to %f (field has %d steps)\n&quot;</span>, nph, pih, pfh, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ababaa9675b4f7a0ea774b3145623b892">GetFieldStepsPhi</a>());</div>
<div class="line"><a name="l03445"></a><span class="lineno"> 3445</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;R:  %d steps from %f to %f (field has %d steps)\n&quot;</span>, nrh, rih, rfh, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9bd7d94036eb0cbe4cf182af460bee0e">GetFieldStepsR</a>());</div>
<div class="line"><a name="l03446"></a><span class="lineno"> 3446</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;Z:  %d steps from %f to %f (field has %d steps)\n&quot;</span>, nzh, zih, zfh, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a983fff01de22f2bafd88331d636cd8ac">GetFieldStepsZ</a>());</div>
<div class="line"><a name="l03447"></a><span class="lineno"> 3447</span>&#160;  TString distortionFilename;</div>
<div class="line"><a name="l03448"></a><span class="lineno"> 3448</span>&#160;  distortionFilename.Form(<span class="stringliteral">&quot;%s.distortion_map.hist.root&quot;</span>, filebase);</div>
<div class="line"><a name="l03449"></a><span class="lineno"> 3449</span>&#160;  TString summaryFilename;</div>
<div class="line"><a name="l03450"></a><span class="lineno"> 3450</span>&#160;  summaryFilename.Form(<span class="stringliteral">&quot;%s.distortion_summary.pdf&quot;</span>, filebase);</div>
<div class="line"><a name="l03451"></a><span class="lineno"> 3451</span>&#160;  TString diffSummaryFilename;</div>
<div class="line"><a name="l03452"></a><span class="lineno"> 3452</span>&#160;  diffSummaryFilename.Form(<span class="stringliteral">&quot;%s.differential_summary.pdf&quot;</span>, filebase);</div>
<div class="line"><a name="l03453"></a><span class="lineno"> 3453</span>&#160;</div>
<div class="line"><a name="l03454"></a><span class="lineno"> 3454</span>&#160;  TFile *outf = TFile::Open(distortionFilename.Data(), <span class="stringliteral">&quot;RECREATE&quot;</span>);</div>
<div class="line"><a name="l03455"></a><span class="lineno"> 3455</span>&#160;  outf-&gt;cd();</div>
<div class="line"><a name="l03456"></a><span class="lineno"> 3456</span>&#160;</div>
<div class="line"><a name="l03457"></a><span class="lineno"> 3457</span>&#160;  <span class="comment">// actual output maps:</span></div>
<div class="line"><a name="l03458"></a><span class="lineno"> 3458</span>&#160;</div>
<div class="line"><a name="l03459"></a><span class="lineno"> 3459</span>&#160;  TH3F *hDistortionR = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hDistortionR&quot;</span>, <span class="stringliteral">&quot;Per-z-bin Distortion in the R direction as a function of (phi,r,z) (centered in r,phi, z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l03460"></a><span class="lineno"> 3460</span>&#160;  TH3F *hDistortionP = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hDistortionP&quot;</span>, <span class="stringliteral">&quot;Per-z-bin Distortion in the RPhi direction as a function of (phi,r,z)  (centered in r,phi, z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l03461"></a><span class="lineno"> 3461</span>&#160;  TH3F *hDistortionZ = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hDistortionZ&quot;</span>, <span class="stringliteral">&quot;Per-z-bin Distortion in the Z direction as a function of (phi,r,z)  (centered in r,phi, z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l03462"></a><span class="lineno"> 3462</span>&#160;  TH3F *hIntDistortionR = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hIntDistortionR&quot;</span>, <span class="stringliteral">&quot;Integrated R Distortion from (phi,r,z) to z=0 (centered in r,phi, and z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l03463"></a><span class="lineno"> 3463</span>&#160;  TH3F *hIntDistortionP = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hIntDistortionP&quot;</span>, <span class="stringliteral">&quot;Integrated R Distortion from (phi,r,z) to z=0 (centered in r,phi, and z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l03464"></a><span class="lineno"> 3464</span>&#160;  TH3F *hIntDistortionZ = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hIntDistortionZ&quot;</span>, <span class="stringliteral">&quot;Integrated R Distortion from (phi,r,z) to z=0  (centered in r,phi, and z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l03465"></a><span class="lineno"> 3465</span>&#160;</div>
<div class="line"><a name="l03466"></a><span class="lineno"> 3466</span>&#160;  TH3F *hIntDistortionX = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hIntDistortionX&quot;</span>, <span class="stringliteral">&quot;Integrated X Distortion from (phi,r,z) to z=0 (centered in r,phi, and z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l03467"></a><span class="lineno"> 3467</span>&#160;  TH3F *hIntDistortionY = <span class="keyword">new</span> TH3F(<span class="stringliteral">&quot;hIntDistortionY&quot;</span>, <span class="stringliteral">&quot;Integrated Y Distortion from (phi,r,z) to z=0 (centered in r,phi, and z);phi;r;z&quot;</span>, nph, pih, pfh, nrh, rih, rfh, nzh, zih, zfh);</div>
<div class="line"><a name="l03468"></a><span class="lineno"> 3468</span>&#160;</div>
<div class="line"><a name="l03469"></a><span class="lineno"> 3469</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l03470"></a><span class="lineno"> 3470</span>&#160;<span class="comment">  TH3F* hNewIntDistortionR=new TH3F(&quot;hNewIntDistortionR&quot;,&quot;Recursively Integrated R Distortion from (r,phi,z) to z=0 (centered in r,phi, and z);phi;r;z&quot;,nph,pih,pfh,nrh,rih,rfh,nzh,zih,zfh);</span></div>
<div class="line"><a name="l03471"></a><span class="lineno"> 3471</span>&#160;<span class="comment">  TH3F* hNewIntDistortionP=new TH3F(&quot;hNewIntDistortionP&quot;,&quot;Recursively Integrated R Distortion from (r,phi,z) to z=0 (centered in r,phi, and z);phi;r;z&quot;,nph,pih,pfh,nrh,rih,rfh,nzh,zih,zfh);</span></div>
<div class="line"><a name="l03472"></a><span class="lineno"> 3472</span>&#160;<span class="comment">  TH3F* hNewIntDistortionZ=new TH3F(&quot;hNewIntDistortionZ&quot;,&quot;Recursively Integrated R Distortion from (r,phi,z) to z=0  (centered in r,phi, and z);phi;r;z&quot;,nph,pih,pfh,nrh,rih,rfh,nzh,zih,zfh);</span></div>
<div class="line"><a name="l03473"></a><span class="lineno"> 3473</span>&#160;<span class="comment">//for the interchanging distortion maps.</span></div>
<div class="line"><a name="l03474"></a><span class="lineno"> 3474</span>&#160;<span class="comment">    TH2F* hNewIntDistortionR=new TH3F(&quot;hNewIntDistortionR&quot;,&quot;Recursively Integrated R Distortion from (r,phi,z) to z=0 (centered in r,phi, and z);phi;r;z&quot;,nph,pih,pfh,nrh,rih,rfh,nzh,zih,zfh);</span></div>
<div class="line"><a name="l03475"></a><span class="lineno"> 3475</span>&#160;<span class="comment">  TH3F* hNewIntDistortionP=new TH3F(&quot;hNewIntDistortionP&quot;,&quot;Recursively Integrated R Distortion from (r,phi,z) to z=0 (centered in r,phi, and z);phi;r;z&quot;,nph,pih,pfh,nrh,rih,rfh,nzh,zih,zfh);</span></div>
<div class="line"><a name="l03476"></a><span class="lineno"> 3476</span>&#160;<span class="comment">  TH3F* hNewIntDistortionZ=new TH3F(&quot;hNewIntDistortionZ&quot;,&quot;Recursively Integrated R Distortion from (r,phi,z) to z=0  (centered in r,phi, and z);phi;r;z&quot;,nph,pih,pfh,nrh,rih,rfh,nzh,zih,zfh);</span></div>
<div class="line"><a name="l03477"></a><span class="lineno"> 3477</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l03478"></a><span class="lineno"> 3478</span>&#160;</div>
<div class="line"><a name="l03479"></a><span class="lineno"> 3479</span>&#160;  <span class="comment">// monitor plots, and the position that plot monitors at:</span></div>
<div class="line"><a name="l03480"></a><span class="lineno"> 3480</span>&#160;</div>
<div class="line"><a name="l03481"></a><span class="lineno"> 3481</span>&#160;  <span class="comment">// TVector3 pos((nrh/2+0.5)*steplocal.Perp()+rih,0,(nzh/2+0.5)*steplocal.Z()+zih);</span></div>
<div class="line"><a name="l03482"></a><span class="lineno"> 3482</span>&#160;  TVector3 <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>(((<span class="keywordtype">int</span>) (nrh / 2) + 0.5) * steplocal.Perp() + rih, 0, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4b55cef465021cb15d4ddf315cb29aaa">zmin</a> + ((int) (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a> / 2) + 0.5) * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z());</div>
<div class="line"><a name="l03483"></a><span class="lineno"> 3483</span>&#160;  <span class="keywordtype">float</span> posphi = ((int) (nph / 2) + 0.5) * steplocal.Phi() + pih;</div>
<div class="line"><a name="l03484"></a><span class="lineno"> 3484</span>&#160;  <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.SetPhi(posphi);</div>
<div class="line"><a name="l03485"></a><span class="lineno"> 3485</span>&#160;  <span class="comment">// int xi[3]={nrh/2,nph/2,nzh/2};</span></div>
<div class="line"><a name="l03486"></a><span class="lineno"> 3486</span>&#160;  <span class="keywordtype">int</span> xi[3] = {(int) floor((<a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Perp() - rih) / steplocal.Perp()), (<span class="keywordtype">int</span>) floor((posphi - pih) / steplocal.Phi()), (<span class="keywordtype">int</span>) floor((<a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Z() - zih) / steplocal.Z())};</div>
<div class="line"><a name="l03487"></a><span class="lineno"> 3487</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l03488"></a><span class="lineno"> 3488</span>&#160;  {</div>
<div class="line"><a name="l03489"></a><span class="lineno"> 3489</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;rpz slice indices= (%d,%d,%d) (no twin)\n&quot;</span>, xi[0], xi[1], xi[2]);</div>
<div class="line"><a name="l03490"></a><span class="lineno"> 3490</span>&#160;  }</div>
<div class="line"><a name="l03491"></a><span class="lineno"> 3491</span>&#160;  <span class="keywordtype">int</span> twinz = 0;  <span class="comment">// this is meant to be the matching position to xi[2] in the twin, hence generally -1*pos.  Better to just ask the twin rather than trying to calculate it ourselves...</span></div>
<div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;  {</div>
<div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;    twinz = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6743c036ddac97dd925c0df7db7ea501">twin</a>-&gt;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a012dc921d76beb8c5184b38b8c4577c5">GetZindex</a>(-1 * <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Z());</div>
<div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;rpz slice indices= (%d,%d,%d) twinz=%d\n&quot;</span>, xi[0], xi[1], xi[2], twinz);</div>
<div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;  }</div>
<div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;</div>
<div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">char</span> axname[] = <span class="stringliteral">&quot;rpzrpz&quot;</span>;</div>
<div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;  <span class="keywordtype">int</span> axn[] = {nrh, nph, nzh, nrh, nph, nzh};</div>
<div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;  <span class="keywordtype">float</span> axval[] = {(float) <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Perp(), (float) <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Phi(), (float) <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Z(), (float) <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Perp(), (float) <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Phi(), (float) <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>.Z()};</div>
<div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;  <span class="keywordtype">float</span> axbot[] = {rih, pih, zih, rih, pih, zih};</div>
<div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;  <span class="keywordtype">float</span> axtop[] = {rfh, pfh, zfh, rfh, pfh, zfh};</div>
<div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160;  TH2F *hIntDist[3][3];</div>
<div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;  TH1F *hRDist[2][3];  <span class="comment">// now with a paired friend for the negative side</span></div>
<div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;  TH2F *hDiffDist[3][3];</div>
<div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;  TH1F *hRDiffDist[2][3];</div>
<div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 3; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;  {</div>
<div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;    <span class="comment">// loop over which axis of the distortion to read</span></div>
<div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> = 0; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> &lt; 3; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>++)</div>
<div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;    {</div>
<div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160;      <span class="comment">// loop over which plane to work in</span></div>
<div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;      hDiffDist[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH2F(TString::Format(<span class="stringliteral">&quot;hDiffDist%c_%c%c&quot;</span>, axname[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>], axname[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1], axname[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 2]),</div>
<div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;                                  TString::Format(<span class="stringliteral">&quot;%c component of diff. distortion in  %c%c plane at %c=%2.3f;%c;%c&quot;</span>,</div>
<div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;                                                  axname[i], axname[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1], axname[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 2], axname[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>], axval[ax], axname[ax + 1], axname[ax + 2]),</div>
<div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;                                  axn[ax + 1], axbot[ax + 1], axtop[ax + 1],</div>
<div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;                                  axn[ax + 2], axbot[ax + 2], axtop[ax + 2]);</div>
<div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;      hIntDist[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH2F(TString::Format(<span class="stringliteral">&quot;hIntDist%c_%c%c&quot;</span>, axname[i], axname[ax + 1], axname[ax + 2]),</div>
<div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;                                 TString::Format(<span class="stringliteral">&quot;%c component of int. distortion in  %c%c plane at %c=%2.3f;%c;%c&quot;</span>,</div>
<div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;                                                 axname[i], axname[ax + 1], axname[ax + 2], axname[ax], axval[ax], axname[ax + 1], axname[ax + 2]),</div>
<div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;                                 axn[ax + 1], axbot[ax + 1], axtop[ax + 1],</div>
<div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160;                                 axn[ax + 2], axbot[ax + 2], axtop[ax + 2]);</div>
<div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;    }</div>
<div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;    hRDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH1F(TString::Format(<span class="stringliteral">&quot;hRDist%c&quot;</span>, axname[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]),</div>
<div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;                            TString::Format(<span class="stringliteral">&quot;%c component of int. distortion vs r with %c=%2.3f and %c=%2.3f;r(cm);#delta (cm)&quot;</span>,</div>
<div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;                                            axname[i], axname[1], axval[1], axname[2], axval[2]),</div>
<div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160;                            axn[0], axbot[0], axtop[0]);</div>
<div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;    hRDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH1F(TString::Format(<span class="stringliteral">&quot;hRDist%cNeg&quot;</span>, axname[i]),</div>
<div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;                            TString::Format(<span class="stringliteral">&quot;%c component of int. distortion vs r with %c=%2.3f and %c=-%2.3f;r(cm);#delta (cm)&quot;</span>,</div>
<div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160;                                            axname[i], axname[1], axval[1], axname[2], axval[2]),</div>
<div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160;                            axn[0], axbot[0], axtop[0]);</div>
<div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;    hRDiffDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH1F(TString::Format(<span class="stringliteral">&quot;hRDist%c&quot;</span>, axname[i]),</div>
<div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;                                TString::Format(<span class="stringliteral">&quot;%c component of diff. distortion vs r with %c=%2.3f and %c=%2.3f;r(cm);#delta (cm)&quot;</span>,</div>
<div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;                                                axname[i], axname[1], axval[1], axname[2], axval[2]),</div>
<div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160;                                axn[0], axbot[0], axtop[0]);</div>
<div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;    hRDiffDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <span class="keyword">new</span> TH1F(TString::Format(<span class="stringliteral">&quot;hRDist%cNeg&quot;</span>, axname[i]),</div>
<div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;                                TString::Format(<span class="stringliteral">&quot;%c component of diff. distortion vs r with %c=%2.3f and %c=-%2.3f;r(cm);#delta (cm)&quot;</span>,</div>
<div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;                                                axname[i], axname[1], axval[1], axname[2], axval[2]),</div>
<div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;                                axn[0], axbot[0], axtop[0]);</div>
<div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160;  }</div>
<div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;</div>
<div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;  TVector3 inpart, outpart;</div>
<div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;  TVector3 distort;</div>
<div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;  <span class="keywordtype">int</span> validToStep;</div>
<div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160;</div>
<div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;  <span class="comment">// TTree version:</span></div>
<div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;  <span class="keywordtype">float</span> partR, partP, partZ;</div>
<div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160;  <span class="keywordtype">int</span> ir, ip, iz;</div>
<div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;  <span class="keywordtype">float</span> distortR, distortP, distortZ;</div>
<div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;  <span class="keywordtype">float</span> distortX, distortY;</div>
<div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160;  <span class="keywordtype">float</span> diffdistR, diffdistP, diffdistZ;</div>
<div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;  TTree *dTree = <span class="keyword">new</span> TTree(<span class="stringliteral">&quot;dTree&quot;</span>, <span class="stringliteral">&quot;Distortion per step z&quot;</span>);</div>
<div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;r&quot;</span>, &amp;partR);</div>
<div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;p&quot;</span>, &amp;partP);</div>
<div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;z&quot;</span>, &amp;partZ);</div>
<div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;ir&quot;</span>, &amp;ir);</div>
<div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;ip&quot;</span>, &amp;ip);</div>
<div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;iz&quot;</span>, &amp;iz);</div>
<div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;dr&quot;</span>, &amp;distortR);</div>
<div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;drp&quot;</span>, &amp;distortP);</div>
<div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;  dTree-&gt;Branch(<span class="stringliteral">&quot;dz&quot;</span>, &amp;distortZ);</div>
<div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;</div>
<div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;generating distortion map with (%dx%dx%d) grid \n&quot;</span>, nrh, nph, nzh);</div>
<div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> totalelements = nrh;</div>
<div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;  totalelements *= nph;</div>
<div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;  totalelements *= nzh;  <span class="comment">// breaking up this multiplication prevents a 32bit math overflow</span></div>
<div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> percent = totalelements / 100 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a>;</div>
<div class="line"><a name="l03568"></a><span class="lineno"> 3568</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;total elements = %llu\n&quot;</span>, totalelements);</div>
<div class="line"><a name="l03569"></a><span class="lineno"> 3569</span>&#160;</div>
<div class="line"><a name="l03570"></a><span class="lineno"> 3570</span>&#160;  <span class="keywordtype">int</span> el = 0;</div>
<div class="line"><a name="l03571"></a><span class="lineno"> 3571</span>&#160;</div>
<div class="line"><a name="l03572"></a><span class="lineno"> 3572</span>&#160;  <span class="comment">// we want to loop over the entire region to be mapped, but we also need to include</span></div>
<div class="line"><a name="l03573"></a><span class="lineno"> 3573</span>&#160;  <span class="comment">// one additional bin at each edge, to allow the mc drift code to interpolate properly.</span></div>
<div class="line"><a name="l03574"></a><span class="lineno"> 3574</span>&#160;  <span class="comment">// hence we count from -1 to n+1, and manually adjust the position in those edge cases</span></div>
<div class="line"><a name="l03575"></a><span class="lineno"> 3575</span>&#160;  <span class="comment">// to avoid sampling nonphysical regions in r and z.  the phi case is free to wrap as</span></div>
<div class="line"><a name="l03576"></a><span class="lineno"> 3576</span>&#160;  <span class="comment">//  normal.</span></div>
<div class="line"><a name="l03577"></a><span class="lineno"> 3577</span>&#160;</div>
<div class="line"><a name="l03578"></a><span class="lineno"> 3578</span>&#160;  <span class="comment">// note that we apply the adjustment to the particle position (inpart) and not the plotted position (partR etc)</span></div>
<div class="line"><a name="l03579"></a><span class="lineno"> 3579</span>&#160;  inpart.SetXYZ(1, 0, 0);</div>
<div class="line"><a name="l03580"></a><span class="lineno"> 3580</span>&#160;  <span class="keywordflow">for</span> (ir = 0; ir &lt; nrh; ir++)</div>
<div class="line"><a name="l03581"></a><span class="lineno"> 3581</span>&#160;  {</div>
<div class="line"><a name="l03582"></a><span class="lineno"> 3582</span>&#160;    partR = (ir + 0.5) * deltar + rih;</div>
<div class="line"><a name="l03583"></a><span class="lineno"> 3583</span>&#160;    <span class="keywordflow">if</span> (ir == 0)</div>
<div class="line"><a name="l03584"></a><span class="lineno"> 3584</span>&#160;    {</div>
<div class="line"><a name="l03585"></a><span class="lineno"> 3585</span>&#160;      inpart.SetPerp(partR + deltar);</div>
<div class="line"><a name="l03586"></a><span class="lineno"> 3586</span>&#160;    }</div>
<div class="line"><a name="l03587"></a><span class="lineno"> 3587</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ir == nrh - 1)</div>
<div class="line"><a name="l03588"></a><span class="lineno"> 3588</span>&#160;    {</div>
<div class="line"><a name="l03589"></a><span class="lineno"> 3589</span>&#160;      inpart.SetPerp(partR - deltar);</div>
<div class="line"><a name="l03590"></a><span class="lineno"> 3590</span>&#160;    }</div>
<div class="line"><a name="l03591"></a><span class="lineno"> 3591</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l03592"></a><span class="lineno"> 3592</span>&#160;    {</div>
<div class="line"><a name="l03593"></a><span class="lineno"> 3593</span>&#160;      inpart.SetPerp(partR);</div>
<div class="line"><a name="l03594"></a><span class="lineno"> 3594</span>&#160;    }</div>
<div class="line"><a name="l03595"></a><span class="lineno"> 3595</span>&#160;    <span class="keywordflow">for</span> (ip = 0; ip &lt; nph; ip++)</div>
<div class="line"><a name="l03596"></a><span class="lineno"> 3596</span>&#160;    {</div>
<div class="line"><a name="l03597"></a><span class="lineno"> 3597</span>&#160;      partP = (ip + 0.5) * deltap + pih;</div>
<div class="line"><a name="l03598"></a><span class="lineno"> 3598</span>&#160;      inpart.SetPhi(partP);</div>
<div class="line"><a name="l03599"></a><span class="lineno"> 3599</span>&#160;      <span class="comment">// since phi loops, there&#39;s no need to adjust phis that are out of bounds.</span></div>
<div class="line"><a name="l03600"></a><span class="lineno"> 3600</span>&#160;      <span class="keywordflow">for</span> (iz = 0; iz &lt; nzh; iz++)</div>
<div class="line"><a name="l03601"></a><span class="lineno"> 3601</span>&#160;      {</div>
<div class="line"><a name="l03602"></a><span class="lineno"> 3602</span>&#160;        partZ = (iz) *deltaz + zih;  <span class="comment">// start us at the EDGE of the bin, maybe has problems at the CM when twinned.</span></div>
<div class="line"><a name="l03603"></a><span class="lineno"> 3603</span>&#160;        <span class="keywordflow">if</span> (iz == 0)</div>
<div class="line"><a name="l03604"></a><span class="lineno"> 3604</span>&#160;        {</div>
<div class="line"><a name="l03605"></a><span class="lineno"> 3605</span>&#160;          inpart.SetZ(partZ + deltaz);</div>
<div class="line"><a name="l03606"></a><span class="lineno"> 3606</span>&#160;        }</div>
<div class="line"><a name="l03607"></a><span class="lineno"> 3607</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iz == nzh - 1)</div>
<div class="line"><a name="l03608"></a><span class="lineno"> 3608</span>&#160;        {</div>
<div class="line"><a name="l03609"></a><span class="lineno"> 3609</span>&#160;          inpart.SetZ(partZ - deltaz);</div>
<div class="line"><a name="l03610"></a><span class="lineno"> 3610</span>&#160;        }</div>
<div class="line"><a name="l03611"></a><span class="lineno"> 3611</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03612"></a><span class="lineno"> 3612</span>&#160;        {</div>
<div class="line"><a name="l03613"></a><span class="lineno"> 3613</span>&#160;          inpart.SetZ(partZ);</div>
<div class="line"><a name="l03614"></a><span class="lineno"> 3614</span>&#160;        }</div>
<div class="line"><a name="l03615"></a><span class="lineno"> 3615</span>&#160;        partZ += 0.5 * deltaz;  <span class="comment">// move to center of histogram bin.</span></div>
<div class="line"><a name="l03616"></a><span class="lineno"> 3616</span>&#160;</div>
<div class="line"><a name="l03617"></a><span class="lineno"> 3617</span>&#160;        <span class="comment">// printf(&quot;iz=%d, zcoord=%2.2f, bin=%d\n&quot;,iz,partZ,  hIntDist[0][0]-&gt;GetYaxis()-&gt;FindBin(partZ));</span></div>
<div class="line"><a name="l03618"></a><span class="lineno"> 3618</span>&#160;</div>
<div class="line"><a name="l03619"></a><span class="lineno"> 3619</span>&#160;        <span class="comment">// differential distortion:</span></div>
<div class="line"><a name="l03620"></a><span class="lineno"> 3620</span>&#160;        <span class="comment">// be careful with the math of a distortion.  The R distortion is NOT the perp() component of outpart-inpart -- that&#39;s the transverse magnitude of the distortion!</span></div>
<div class="line"><a name="l03621"></a><span class="lineno"> 3621</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a> &amp;&amp; inpart.Z() &lt; 0)</div>
<div class="line"><a name="l03622"></a><span class="lineno"> 3622</span>&#160;        {</div>
<div class="line"><a name="l03623"></a><span class="lineno"> 3623</span>&#160;          distort = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6743c036ddac97dd925c0df7db7ea501">twin</a>-&gt;<a class="code" href="../../de/d64/classAnnularFieldSim.html#aae2d9b9913d410d22242028c08c6865a">GetTotalDistortion</a>(inpart.Z(), inpart + stepzvec, nSteps, <span class="keyword">true</span>, &amp;validToStep, &amp;successCheck);  <span class="comment">// step across the cell in the opposite direction, starting at the high side and going to the low side..</span></div>
<div class="line"><a name="l03624"></a><span class="lineno"> 3624</span>&#160;        }</div>
<div class="line"><a name="l03625"></a><span class="lineno"> 3625</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03626"></a><span class="lineno"> 3626</span>&#160;        {</div>
<div class="line"><a name="l03627"></a><span class="lineno"> 3627</span>&#160;          distort = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aae2d9b9913d410d22242028c08c6865a">GetTotalDistortion</a>(inpart.Z() + deltaz, inpart, nSteps, <span class="keyword">true</span>, &amp;validToStep, &amp;successCheck);</div>
<div class="line"><a name="l03628"></a><span class="lineno"> 3628</span>&#160;        }</div>
<div class="line"><a name="l03629"></a><span class="lineno"> 3629</span>&#160;        distort.RotateZ(-inpart.Phi());  <span class="comment">// rotate so that that is on the x axis</span></div>
<div class="line"><a name="l03630"></a><span class="lineno"> 3630</span>&#160;        diffdistP = distort.Y();         <span class="comment">// the phi component is now the y component.</span></div>
<div class="line"><a name="l03631"></a><span class="lineno"> 3631</span>&#160;        diffdistR = distort.X();         <span class="comment">// and the r component is the x component</span></div>
<div class="line"><a name="l03632"></a><span class="lineno"> 3632</span>&#160;        diffdistZ = distort.Z();</div>
<div class="line"><a name="l03633"></a><span class="lineno"> 3633</span>&#160;        hDistortionR-&gt;Fill(partP, partR, partZ, diffdistR);</div>
<div class="line"><a name="l03634"></a><span class="lineno"> 3634</span>&#160;        hDistortionP-&gt;Fill(partP, partR, partZ, diffdistP);</div>
<div class="line"><a name="l03635"></a><span class="lineno"> 3635</span>&#160;        hDistortionZ-&gt;Fill(partP, partR, partZ, diffdistZ);</div>
<div class="line"><a name="l03636"></a><span class="lineno"> 3636</span>&#160;        dTree-&gt;Fill();</div>
<div class="line"><a name="l03637"></a><span class="lineno"> 3637</span>&#160;</div>
<div class="line"><a name="l03638"></a><span class="lineno"> 3638</span>&#160;        <span class="comment">// integral distortion:</span></div>
<div class="line"><a name="l03639"></a><span class="lineno"> 3639</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a> &amp;&amp; makeUnifiedMap &amp;&amp; inpart.Z() &lt; 0)</div>
<div class="line"><a name="l03640"></a><span class="lineno"> 3640</span>&#160;        {</div>
<div class="line"><a name="l03641"></a><span class="lineno"> 3641</span>&#160;          distort = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6743c036ddac97dd925c0df7db7ea501">twin</a>-&gt;<a class="code" href="../../de/d64/classAnnularFieldSim.html#aae2d9b9913d410d22242028c08c6865a">GetTotalDistortion</a>(-z_readout, inpart + stepzvec, nSteps, <span class="keyword">true</span>, &amp;validToStep, &amp;successCheck);</div>
<div class="line"><a name="l03642"></a><span class="lineno"> 3642</span>&#160;        }</div>
<div class="line"><a name="l03643"></a><span class="lineno"> 3643</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03644"></a><span class="lineno"> 3644</span>&#160;        {</div>
<div class="line"><a name="l03645"></a><span class="lineno"> 3645</span>&#160;          distort = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aae2d9b9913d410d22242028c08c6865a">GetTotalDistortion</a>(z_readout, inpart, nSteps, <span class="keyword">true</span>, &amp;validToStep, &amp;successCheck);</div>
<div class="line"><a name="l03646"></a><span class="lineno"> 3646</span>&#160;        }</div>
<div class="line"><a name="l03647"></a><span class="lineno"> 3647</span>&#160;        distortX = distort.X();</div>
<div class="line"><a name="l03648"></a><span class="lineno"> 3648</span>&#160;        distortY = distort.Y();</div>
<div class="line"><a name="l03649"></a><span class="lineno"> 3649</span>&#160;        distort.RotateZ(-inpart.Phi());  <span class="comment">// rotate so that that is on the x axis</span></div>
<div class="line"><a name="l03650"></a><span class="lineno"> 3650</span>&#160;        distortP = distort.Y();          <span class="comment">// the phi component is now the y component.</span></div>
<div class="line"><a name="l03651"></a><span class="lineno"> 3651</span>&#160;        distortR = distort.X();          <span class="comment">// and the r component is the x component</span></div>
<div class="line"><a name="l03652"></a><span class="lineno"> 3652</span>&#160;        distortZ = distort.Z();</div>
<div class="line"><a name="l03653"></a><span class="lineno"> 3653</span>&#160;</div>
<div class="line"><a name="l03654"></a><span class="lineno"> 3654</span>&#160;        <span class="comment">// recursive integral distortion:</span></div>
<div class="line"><a name="l03655"></a><span class="lineno"> 3655</span>&#160;        <span class="comment">// get others working first!</span></div>
<div class="line"><a name="l03656"></a><span class="lineno"> 3656</span>&#160;</div>
<div class="line"><a name="l03657"></a><span class="lineno"> 3657</span>&#160;        <span class="comment">// printf(&quot;part=(rpz)(%f,%f,%f),distortP=%f\n&quot;,partP,partR,partZ,distortP);</span></div>
<div class="line"><a name="l03658"></a><span class="lineno"> 3658</span>&#160;        hIntDistortionR-&gt;Fill(partP, partR, partZ, distortR);</div>
<div class="line"><a name="l03659"></a><span class="lineno"> 3659</span>&#160;        hIntDistortionP-&gt;Fill(partP, partR, partZ, distortP);</div>
<div class="line"><a name="l03660"></a><span class="lineno"> 3660</span>&#160;        hIntDistortionZ-&gt;Fill(partP, partR, partZ, distortZ);</div>
<div class="line"><a name="l03661"></a><span class="lineno"> 3661</span>&#160;</div>
<div class="line"><a name="l03662"></a><span class="lineno"> 3662</span>&#160;        <span class="keywordflow">if</span> (andCartesian)</div>
<div class="line"><a name="l03663"></a><span class="lineno"> 3663</span>&#160;        {</div>
<div class="line"><a name="l03664"></a><span class="lineno"> 3664</span>&#160;          hIntDistortionX-&gt;Fill(partP, partR, partZ, distortX);</div>
<div class="line"><a name="l03665"></a><span class="lineno"> 3665</span>&#160;          hIntDistortionY-&gt;Fill(partP, partR, partZ, distortY);</div>
<div class="line"><a name="l03666"></a><span class="lineno"> 3666</span>&#160;        }</div>
<div class="line"><a name="l03667"></a><span class="lineno"> 3667</span>&#160;</div>
<div class="line"><a name="l03668"></a><span class="lineno"> 3668</span>&#160;        <span class="comment">// now we fill particular slices for integral visualizations:</span></div>
<div class="line"><a name="l03669"></a><span class="lineno"> 3669</span>&#160;        <span class="keywordflow">if</span> (ir == xi[0])</div>
<div class="line"><a name="l03670"></a><span class="lineno"> 3670</span>&#160;        {  <span class="comment">// r slice</span></div>
<div class="line"><a name="l03671"></a><span class="lineno"> 3671</span>&#160;          <span class="comment">// printf(&quot;ir=%d, r=%f (pz)=(%d,%d), distortR=%2.2f, distortP=%2.2f\n&quot;,ir,partR,ip,iz,distortR,distortP);</span></div>
<div class="line"><a name="l03672"></a><span class="lineno"> 3672</span>&#160;          hIntDist[0][0]-&gt;Fill(partP, partZ, distortR);</div>
<div class="line"><a name="l03673"></a><span class="lineno"> 3673</span>&#160;          hIntDist[0][1]-&gt;Fill(partP, partZ, distortP);</div>
<div class="line"><a name="l03674"></a><span class="lineno"> 3674</span>&#160;          hIntDist[0][2]-&gt;Fill(partP, partZ, distortZ);</div>
<div class="line"><a name="l03675"></a><span class="lineno"> 3675</span>&#160;          hDiffDist[0][0]-&gt;Fill(partP, partZ, diffdistR);</div>
<div class="line"><a name="l03676"></a><span class="lineno"> 3676</span>&#160;          hDiffDist[0][1]-&gt;Fill(partP, partZ, diffdistP);</div>
<div class="line"><a name="l03677"></a><span class="lineno"> 3677</span>&#160;          hDiffDist[0][2]-&gt;Fill(partP, partZ, diffdistZ);</div>
<div class="line"><a name="l03678"></a><span class="lineno"> 3678</span>&#160;        }</div>
<div class="line"><a name="l03679"></a><span class="lineno"> 3679</span>&#160;        <span class="keywordflow">if</span> (ip == xi[1])</div>
<div class="line"><a name="l03680"></a><span class="lineno"> 3680</span>&#160;        {  <span class="comment">// phi slice</span></div>
<div class="line"><a name="l03681"></a><span class="lineno"> 3681</span>&#160;          <span class="comment">// printf(&quot;ip=%d, p=%f (rz)=(%d,%d), distortR=%2.2f, distortP=%2.2f\n&quot;,ip,partP,ir,iz,distortR,distortP);</span></div>
<div class="line"><a name="l03682"></a><span class="lineno"> 3682</span>&#160;          hIntDist[1][0]-&gt;Fill(partZ, partR, distortR);</div>
<div class="line"><a name="l03683"></a><span class="lineno"> 3683</span>&#160;          hIntDist[1][1]-&gt;Fill(partZ, partR, distortP);</div>
<div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;          hIntDist[1][2]-&gt;Fill(partZ, partR, distortZ);</div>
<div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;          hDiffDist[1][0]-&gt;Fill(partZ, partR, diffdistR);</div>
<div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;          hDiffDist[1][1]-&gt;Fill(partZ, partR, diffdistP);</div>
<div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;          hDiffDist[1][2]-&gt;Fill(partZ, partR, diffdistZ);</div>
<div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;</div>
<div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;          <span class="keywordflow">if</span> (iz == xi[2])</div>
<div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;          {  <span class="comment">// z slices of phi slices= r line at mid phi, mid z:</span></div>
<div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;            hRDist[0][0]-&gt;Fill(partR, distortR);</div>
<div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;            hRDist[0][1]-&gt;Fill(partR, distortP);</div>
<div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;            hRDist[0][2]-&gt;Fill(partR, distortZ);</div>
<div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;            hRDiffDist[0][0]-&gt;Fill(partR, diffdistR);</div>
<div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;            hRDiffDist[0][1]-&gt;Fill(partR, diffdistP);</div>
<div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;            hRDiffDist[0][2]-&gt;Fill(partR, diffdistZ);</div>
<div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;          }</div>
<div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a> &amp;&amp; iz == twinz)</div>
<div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;          {  <span class="comment">// z slices of phi slices= r line at mid phi, mid z:</span></div>
<div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;            hRDist[1][0]-&gt;Fill(partR, distortR);</div>
<div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;            hRDist[1][1]-&gt;Fill(partR, distortP);</div>
<div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;            hRDist[1][2]-&gt;Fill(partR, distortZ);</div>
<div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;            hRDiffDist[1][0]-&gt;Fill(partR, diffdistR);</div>
<div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;            hRDiffDist[1][1]-&gt;Fill(partR, diffdistP);</div>
<div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;            hRDiffDist[1][2]-&gt;Fill(partR, diffdistZ);</div>
<div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160;          }</div>
<div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;        }</div>
<div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;        <span class="keywordflow">if</span> (iz == xi[2])</div>
<div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;        {  <span class="comment">// z slice</span></div>
<div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;          <span class="comment">// printf(&quot;iz=%d, z=%f (rp)=(%d,%d), distortR=%2.2f, distortP=%2.2f\n&quot;,iz,partZ,ir,ip,distortR,distortP);</span></div>
<div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160;</div>
<div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;          hIntDist[2][0]-&gt;Fill(partR, partP, distortR);</div>
<div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;          hIntDist[2][1]-&gt;Fill(partR, partP, distortP);</div>
<div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;          hIntDist[2][2]-&gt;Fill(partR, partP, distortZ);</div>
<div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;          hDiffDist[2][0]-&gt;Fill(partR, partP, diffdistR);</div>
<div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;          hDiffDist[2][1]-&gt;Fill(partR, partP, diffdistP);</div>
<div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;          hDiffDist[2][2]-&gt;Fill(partR, partP, diffdistZ);</div>
<div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160;        }</div>
<div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;</div>
<div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;        <span class="keywordflow">if</span> (!(el % percent))</div>
<div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;        {</div>
<div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;          <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;generating distortions %d%%:  &quot;</span>, (<span class="keywordtype">int</span>) (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2e301ad1adea89d30124c628d6d34d7e">debug_npercent</a> * (el / percent)));</div>
<div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160;          <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;distortion at (ir=%d,ip=%d,iz=%d) is (%E,%E,%E)\n&quot;</span>,</div>
<div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;                 ir, ip, iz, distortR, distortP, distortZ);</div>
<div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;        }</div>
<div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;        el++;</div>
<div class="line"><a name="l03727"></a><span class="lineno"> 3727</span>&#160;      }</div>
<div class="line"><a name="l03728"></a><span class="lineno"> 3728</span>&#160;    }</div>
<div class="line"><a name="l03729"></a><span class="lineno"> 3729</span>&#160;  }</div>
<div class="line"><a name="l03730"></a><span class="lineno"> 3730</span>&#160;</div>
<div class="line"><a name="l03731"></a><span class="lineno"> 3731</span>&#160;  TCanvas *canvas = <span class="keyword">new</span> TCanvas(<span class="stringliteral">&quot;cdistort&quot;</span>, <span class="stringliteral">&quot;distortion integrals&quot;</span>, 1200, 800);</div>
<div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;  <span class="comment">// take 10 of the bottom of this for data?</span></div>
<div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;  canvas-&gt;cd();</div>
<div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;  TPad *<a class="code" href="../../db/d33/namespaceActs_1_1PhysicalConstants.html#a1d84e7732ed0bc3272bff096737d2b6e">c</a> = <span class="keyword">new</span> TPad(<span class="stringliteral">&quot;cplots&quot;</span>, <span class="stringliteral">&quot;distortion integral plots&quot;</span>, 0, 0.2, 1, 1);</div>
<div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;  canvas-&gt;cd();</div>
<div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160;  TPad *textpad = <span class="keyword">new</span> TPad(<span class="stringliteral">&quot;ctext&quot;</span>, <span class="stringliteral">&quot;distortion integral plots&quot;</span>, 0, 0.0, 1, 0.2);</div>
<div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;  c-&gt;Divide(4, 3);</div>
<div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;  gStyle-&gt;SetOptStat();</div>
<div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 3; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;  {</div>
<div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;    <span class="comment">// component</span></div>
<div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> = 0; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> &lt; 3; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>++)</div>
<div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;    {</div>
<div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;      <span class="comment">// plane</span></div>
<div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;      c-&gt;cd(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> * 4 + <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1);</div>
<div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;      gPad-&gt;SetRightMargin(0.15);</div>
<div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160;      hIntDist[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160;      hIntDist[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Draw(<span class="stringliteral">&quot;colz&quot;</span>);</div>
<div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;    }</div>
<div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;    c-&gt;cd(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> * 4 + 4);</div>
<div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;    hRDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;    hRDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetFillColor(kRed);</div>
<div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;    hRDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Draw(<span class="stringliteral">&quot;hist&quot;</span>);</div>
<div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;    {</div>
<div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;      hRDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;      hRDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetLineColor(kBlue);</div>
<div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;      hRDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Draw(<span class="stringliteral">&quot;hist,same&quot;</span>);</div>
<div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;    }</div>
<div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;    <span class="comment">/*</span></div>
<div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;<span class="comment">      double Cut = 40;</span></div>
<div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;<span class="comment">      h-&gt;SetFillColor(kRed);</span></div>
<div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;<span class="comment">      TH1F *hNeg = (TH1F*)hRDist[i]-&gt;Clone(Form(&quot;hNegRDist%d&quot;,i));</span></div>
<div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160;<span class="comment">      hNeg-&gt;SetFillColor(kGreen);</span></div>
<div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;<span class="comment">      for (int n = 1; n &lt;= hNeg-&gt;GetNbinsX(); n++) {</span></div>
<div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;<span class="comment">      hNeg-&gt;SetBinContent(n,Cut);</span></div>
<div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;<span class="comment">      }</span></div>
<div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;<span class="comment">      h3-&gt;Draw(); h.Draw(&quot;same&quot;);</span></div>
<div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;<span class="comment">      TH1F *h2 = (TH1F*)h-&gt;Clone(&quot;h2&quot;);</span></div>
<div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;<span class="comment">      h2-&gt;SetFillColor(kGray-4);</span></div>
<div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;<span class="comment">      h2-&gt;SetMaximum(Cut);</span></div>
<div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;<span class="comment">      h2-&gt;Draw(&quot;same&quot;);</span></div>
<div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;<span class="comment">    */</span></div>
<div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;  }</div>
<div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;  textpad-&gt;cd();</div>
<div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;  <span class="keywordtype">float</span> texpos = 0.9;</div>
<div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160;  <span class="keywordtype">float</span> texshift = 0.12;</div>
<div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;  TLatex *<a class="code" href="../../d2/d72/upsilons__sphenix__5yesrs_8C.html#a4e721c2d345d18d80d240cbaf1597be5">tex</a> = <span class="keyword">new</span> TLatex(0.0, texpos, <span class="stringliteral">&quot;Fill Me In&quot;</span>);</div>
<div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160;  tex-&gt;SetTextSize(texshift * 0.8);</div>
<div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a146ebec611255de008dd779f3092f893">GetFieldString</a>());</div>
<div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a98979ea683686b965fa9d6f17b5499ed">GetChargeString</a>());</div>
<div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;  <span class="comment">// tex-&gt;DrawLatex(0.05,texpos,Form(&quot;Drift Field = %2.2f V/cm&quot;,GetNominalE()));texpos-=texshift;</span></div>
<div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, Form(<span class="stringliteral">&quot;Drifting grid of (rp)=(%d x %d) electrons with %d steps&quot;</span>, nrh, nph, nSteps));</div>
<div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a7968214559bb324459390f9cce7e8a88">GetLookupString</a>());</div>
<div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#af0c340523f69f514b60be663c0422f26">GetGasString</a>());</div>
<div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Mag() &gt; 0)</div>
<div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;  {</div>
<div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;    tex-&gt;DrawLatex(0.05, texpos, Form(<span class="stringliteral">&quot;Distortion scaled by (r,p,z)=(%2.2f,%2.2f,%2.2f)&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.X(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Y(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Z()));</div>
<div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;    texpos -= texshift;</div>
<div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;  }</div>
<div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;  texpos = 0.9;</div>
<div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;</div>
<div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;  canvas-&gt;cd();</div>
<div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;  c-&gt;Draw();</div>
<div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;  canvas-&gt;cd();</div>
<div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;  textpad-&gt;Draw();</div>
<div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;  canvas-&gt;SaveAs(summaryFilename.Data());</div>
<div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;</div>
<div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;  <span class="comment">// canvas-&gt;cd();</span></div>
<div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;  <span class="comment">// already done TPad *c=new TPad(&quot;cplots&quot;,&quot;distortion differential plots&quot;,0,0.2,1,1);</span></div>
<div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;  <span class="comment">// canvas-&gt;cd();</span></div>
<div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;  <span class="comment">// already done TPad *textpad=new TPad(&quot;ctext&quot;,&quot;distortion differential plots&quot;,0,0.0,1,0.2);</span></div>
<div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;  <span class="comment">// already done c-&gt;Divide(4,3);</span></div>
<div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;  <span class="comment">// gStyle-&gt;SetOptStat();</span></div>
<div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> &lt; 3; <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>++)</div>
<div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;  {</div>
<div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;    <span class="comment">// component</span></div>
<div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> = 0; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> &lt; 3; <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>++)</div>
<div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;    {</div>
<div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;      <span class="comment">// plane</span></div>
<div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;      c-&gt;cd(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> * 4 + <a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a> + 1);</div>
<div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160;      gPad-&gt;SetRightMargin(0.15);</div>
<div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;      hDiffDist[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;      hDiffDist[<a class="code" href="../../de/d6e/namespaceCKF__timing__vs__mu.html#aa2b521f788eda02bb09083946af96ad7">ax</a>][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Draw(<span class="stringliteral">&quot;colz&quot;</span>);</div>
<div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;    }</div>
<div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;    c-&gt;cd(<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> * 4 + 4);</div>
<div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;    hRDiffDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;    hRDiffDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetFillColor(kRed);</div>
<div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;    hRDiffDist[0][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Draw(<span class="stringliteral">&quot;hist&quot;</span>);</div>
<div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;    {</div>
<div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;      hRDiffDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetStats(<span class="keyword">false</span>);</div>
<div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;      hRDiffDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;SetLineColor(kBlue);</div>
<div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;      hRDiffDist[1][<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>]-&gt;Draw(<span class="stringliteral">&quot;hist same&quot;</span>);</div>
<div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;    }</div>
<div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;  }</div>
<div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;  textpad-&gt;cd();</div>
<div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;  texpos = 0.9;</div>
<div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;  texshift = 0.12;</div>
<div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;  tex-&gt;SetTextSize(texshift * 0.8);</div>
<div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a146ebec611255de008dd779f3092f893">GetFieldString</a>());</div>
<div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a98979ea683686b965fa9d6f17b5499ed">GetChargeString</a>());</div>
<div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;  <span class="comment">// tex-&gt;DrawLatex(0.05,texpos,Form(&quot;Drift Field = %2.2f V/cm&quot;,GetNominalE()));texpos-=texshift;</span></div>
<div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, Form(<span class="stringliteral">&quot;Drifting grid of (rp)=(%d x %d) electrons with %d steps&quot;</span>, nrh, nph, nSteps));</div>
<div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a7968214559bb324459390f9cce7e8a88">GetLookupString</a>());</div>
<div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <a class="code" href="../../de/d64/classAnnularFieldSim.html#af0c340523f69f514b60be663c0422f26">GetGasString</a>());</div>
<div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;  tex-&gt;DrawLatex(0.05, texpos, <span class="stringliteral">&quot;Differential Plots&quot;</span>);</div>
<div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;  texpos -= texshift;</div>
<div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Mag() &gt; 0)</div>
<div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;  {</div>
<div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;    tex-&gt;DrawLatex(0.05, texpos, Form(<span class="stringliteral">&quot;Distortion scaled by (r,p,z)=(%2.2f,%2.2f,%2.2f)&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.X(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Y(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Z()));</div>
<div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;    texpos -= texshift;</div>
<div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;  }</div>
<div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;  texpos = 0.9;</div>
<div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;</div>
<div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;  canvas-&gt;cd();</div>
<div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160;  c-&gt;Draw();</div>
<div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;  canvas-&gt;cd();</div>
<div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;  textpad-&gt;Draw();</div>
<div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;  canvas-&gt;SaveAs(diffSummaryFilename.Data());</div>
<div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;</div>
<div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;  <span class="comment">//  printf(&quot;map:%s.\n&quot;,distortionFilename.Data());</span></div>
<div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;</div>
<div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;  outf-&gt;cd();</div>
<div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;</div>
<div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;  hDistortionR-&gt;Write();</div>
<div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;  hDistortionP-&gt;Write();</div>
<div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;  hDistortionZ-&gt;Write();</div>
<div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;  hIntDistortionR-&gt;Write();</div>
<div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;  hIntDistortionP-&gt;Write();</div>
<div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160;  hIntDistortionZ-&gt;Write();</div>
<div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;  <span class="keywordflow">if</span> (andCartesian)</div>
<div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;  {</div>
<div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;    hIntDistortionX-&gt;Write();</div>
<div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;    hIntDistortionY-&gt;Write();</div>
<div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;  }</div>
<div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160;  dTree-&gt;Write();</div>
<div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;  outf-&gt;Close();</div>
<div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;  <span class="comment">// printf(&quot;map:%s.closed\n&quot;,distortionFilename.Data());</span></div>
<div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;</div>
<div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;<span class="comment">  //all histograms associated with this file should be deleted when we closed the file.</span></div>
<div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160;<span class="comment">  //delete the histograms we made:</span></div>
<div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;<span class="comment">  TH3F *m;</span></div>
<div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;<span class="comment">  m = (TH3F*)gROOT&gt;FindObject(&quot;hDistortionR&quot;);  if(m) { printf(&quot;found in memory still.\n&quot;); m&gt;Delete();}</span></div>
<div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;<span class="comment">  m = (TH3F*)gROOT&gt;FindObject(&quot;hDistortionP&quot;);  if(m) m&gt;Delete();</span></div>
<div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;<span class="comment">  m = (TH3F*)gROOT&gt;FindObject(&quot;hDistortionZ&quot;);  if(m) m&gt;Delete();</span></div>
<div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;<span class="comment">  m = (TH3F*)gROOT&gt;FindObject(&quot;hIntDistortionR&quot;);  if(m) m&gt;Delete();</span></div>
<div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;<span class="comment">  m = (TH3F*)gROOT&gt;FindObject(&quot;hIntDistortionP&quot;);  if(m) m&gt;Delete();</span></div>
<div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;<span class="comment">  m = (TH3F*)gROOT&gt;FindObject(&quot;hIntDistortionZ&quot;);  if(m) m&gt;Delete();</span></div>
<div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;<span class="comment">  printf(&quot;map:%s.deleted via convoluted call.  sigh.\n&quot;,distortionFilename.Data());</span></div>
<div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;<span class="comment">  for (int i=0;i&lt;3;i++){</span></div>
<div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;<span class="comment">    //loop over which axis of the distortion to read</span></div>
<div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;<span class="comment">    for (int ax=0;ax&lt;3;ax++){</span></div>
<div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;<span class="comment">      //loop over which plane to work in</span></div>
<div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160;<span class="comment">      hIntDist[ax][i]-&gt;Delete();</span></div>
<div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;<span class="comment">    hRDist[i]-&gt;Delete();</span></div>
<div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;wrote map and summary to %s.\n&quot;</span>, filebase);</div>
<div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;map:%s.\n&quot;</span>, distortionFilename.Data());</div>
<div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160;  <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;summary:%s.\n&quot;</span>, summaryFilename.Data());</div>
<div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;  <span class="comment">// printf(&quot;wrote map and summary to %s and %s.\n&quot;,distortionFilename.Data(),summaryFilename.Data());</span></div>
<div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;  <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;}</div>
<div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;</div>
<div class="line"><a name="l03909"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a9760cf7606953c4fcecb75ba9c5831e7"> 3909</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#a9760cf7606953c4fcecb75ba9c5831e7">AnnularFieldSim::swimTo</a>(<span class="keywordtype">float</span> zdest, <span class="keyword">const</span> TVector3 &amp;<a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>, <span class="keywordtype">bool</span> <a class="code" href="../../da/d7b/namespaceActs.html#a2d4349d85a14c2f358714e95dd15046c" title="performs linear interpolation inside a hyper box">interpolate</a>, <span class="keywordtype">bool</span> useAnalytic)</div>
<div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;{</div>
<div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160;  <span class="keywordtype">int</span> defaultsteps = 100;</div>
<div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;  <span class="keywordtype">int</span> goodtostep = 0;</div>
<div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;  <span class="keywordflow">if</span> (useAnalytic)</div>
<div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;  {</div>
<div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a5868eb5808ec182e9299bee9be6f5b0f">swimToInAnalyticSteps</a>(zdest, start, defaultsteps, &amp;goodtostep);</div>
<div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;  }</div>
<div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a61f0b23cecab5b9f7e5feac62a3838e4">swimToInSteps</a>(zdest, start, defaultsteps, interpolate, &amp;goodtostep);</div>
<div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;}</div>
<div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;</div>
<div class="line"><a name="l03920"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#ac961e366f82550417663d8604e55aec2"> 3920</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac961e366f82550417663d8604e55aec2">AnnularFieldSim::GetStepDistortion</a>(<span class="keywordtype">float</span> zdest, <span class="keyword">const</span> TVector3 &amp;<a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>, <span class="keywordtype">bool</span> <a class="code" href="../../da/d7b/namespaceActs.html#a2d4349d85a14c2f358714e95dd15046c" title="performs linear interpolation inside a hyper box">interpolate</a>, <span class="keywordtype">bool</span> useAnalytic)</div>
<div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;{</div>
<div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;  <span class="comment">// getting the distortion instead of the post-step position allows us to accumulate small deviations from the original position that might be lost in the large number</span></div>
<div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;</div>
<div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;  <span class="comment">// using second order langevin expansion from http://skipper.physics.sunysb.edu/~prakhar/tpc/Papers/ALICE-INT-2010-016.pdf</span></div>
<div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;  <span class="comment">// TVector3 (*field)[nr][ny][nz]=field_;</span></div>
<div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;  <span class="keywordtype">int</span> rt, <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a7d6c8b4d417ed50c799a1e0fd32d9ce2">pt</a>, zt;  <span class="comment">// these are filled by the checkbounds that follow, but are not used.</span></div>
<div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563">BoundsCase</a> zBound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(start.Z(), &amp;zt);</div>
<div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#af41a4754a596a90505d15a5dcb1868a6">GetRindexAndCheckBounds</a>(start.Perp(), &amp;rt) != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> || <a class="code" href="../../de/d64/classAnnularFieldSim.html#aab5dee891f7302176821ad489549a18f">GetPhiIndexAndCheckBounds</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(start.Phi()), &amp;pt) != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> || (zBound != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a001a15105ff79311da52488c96571fd8">InBounds</a> &amp;&amp; zBound != <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563aa857465f2cf8d2a2e910794e90ef30b9">OnHighEdge</a>))</div>
<div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160;  {</div>
<div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;    <span class="comment">// printf(&quot;AnnularFieldSim::swimTo asked to swim particle from (xyz)=(%f,%f,%f) which is outside the ROI:\n&quot;, start.X(), start.Y(), start.Z());</span></div>
<div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;    <span class="comment">// printf(&quot; -- %f &lt;= r &lt; %f \t%f &lt;= phi &lt; %f \t%f &lt;= z &lt; %f \n&quot;, rmin_roi * step.Perp(), rmax_roi * step.Perp(), phimin_roi * step.Phi(), phimax_roi * step.Phi(), zmin_roi * step.Z(), zmax_roi * step.Z());</span></div>
<div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;    <span class="comment">// printf(&quot;Returning original position.\n&quot;);</span></div>
<div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../d7/dde/ctrl_8cpp.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;</div>
<div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;  }</div>
<div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;</div>
<div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;  <span class="comment">// set the direction of the external fields.</span></div>
<div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160;</div>
<div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;  <span class="keywordtype">double</span> zdist = zdest - start.Z();</div>
<div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;</div>
<div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;  <span class="comment">// short-circuit if there&#39;s no travel length:</span></div>
<div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;</div>
<div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;  <span class="keywordflow">if</span> (fabs(zdist) &lt; <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a> * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3f741c62fa309bcceb685d8718f6ceab">step</a>.Z())</div>
<div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;  {</div>
<div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;    <span class="comment">//   printf(&quot;Asked  particle from (%f,%f,%f) to z=%f, which is a distance of %fcm.  Returning zero.\n&quot;, start.X(), start.Y(), start.Z(), zdest, zdist);</span></div>
<div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>;</div>
<div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;  }</div>
<div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;</div>
<div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160;  TVector3 fieldInt;   <span class="comment">// integral of E field along path</span></div>
<div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;  TVector3 fieldIntB;  <span class="comment">// integral of B field along path</span></div>
<div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;</div>
<div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160;  <span class="comment">// note that using analytic takes priority over interpolating todo: clean this up to use a status rther than a pair of flags</span></div>
<div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160;  <span class="keywordflow">if</span> (useAnalytic)</div>
<div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;  {</div>
<div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;    fieldInt = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3451f4963ce7c171bfbd0d566d3f10b9">analyticFieldIntegral</a>(zdest, start, <a class="code" href="../../de/d64/classAnnularFieldSim.html#aeeaac1b3cbe466eac8fec86af99172d2">Efield</a>);</div>
<div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;    fieldIntB = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a3451f4963ce7c171bfbd0d566d3f10b9">analyticFieldIntegral</a>(zdest, start, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>);</div>
<div class="line"><a name="l03956"></a><span class="lineno"> 3956</span>&#160;  }</div>
<div class="line"><a name="l03957"></a><span class="lineno"> 3957</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (interpolate)</div>
<div class="line"><a name="l03958"></a><span class="lineno"> 3958</span>&#160;  {</div>
<div class="line"><a name="l03959"></a><span class="lineno"> 3959</span>&#160;    fieldInt = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef1291170f9342d354fd2d9e41706fb0">interpolatedFieldIntegral</a>(zdest, start, <a class="code" href="../../de/d64/classAnnularFieldSim.html#aeeaac1b3cbe466eac8fec86af99172d2">Efield</a>);</div>
<div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;    fieldIntB = <a class="code" href="../../de/d64/classAnnularFieldSim.html#aef1291170f9342d354fd2d9e41706fb0">interpolatedFieldIntegral</a>(zdest, start, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>);</div>
<div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;  }</div>
<div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;  {</div>
<div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160;    fieldInt = <a class="code" href="../../de/d64/classAnnularFieldSim.html#af49cb183b20be9a1ceba70f1a3b5c64e">fieldIntegral</a>(zdest, start, <a class="code" href="../../de/d64/classAnnularFieldSim.html#aeeaac1b3cbe466eac8fec86af99172d2">Efield</a>);</div>
<div class="line"><a name="l03965"></a><span class="lineno"> 3965</span>&#160;    fieldIntB = <a class="code" href="../../de/d64/classAnnularFieldSim.html#af49cb183b20be9a1ceba70f1a3b5c64e">fieldIntegral</a>(zdest, start, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>);</div>
<div class="line"><a name="l03966"></a><span class="lineno"> 3966</span>&#160;  }</div>
<div class="line"><a name="l03967"></a><span class="lineno"> 3967</span>&#160;</div>
<div class="line"><a name="l03968"></a><span class="lineno"> 3968</span>&#160;  <span class="keywordflow">if</span> (abs(fieldInt.Z() / zdist) &lt; <a class="code" href="../../dc/d90/AnnularFieldSim_8cc.html#af1eda01eaa3d9dc5167d5fefd39b1d75">ALMOST_ZERO</a>)</div>
<div class="line"><a name="l03969"></a><span class="lineno"> 3969</span>&#160;  {</div>
<div class="line"><a name="l03970"></a><span class="lineno"> 3970</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion is attempting to swim with no drift field:\n&quot;</span>);</div>
<div class="line"><a name="l03971"></a><span class="lineno"> 3971</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: (%2.4f,%2.4f,%2.4f) to z=%2.4f\n&quot;</span>, start.X(), start.Y(), start.Z(), zdest);</div>
<div class="line"><a name="l03972"></a><span class="lineno"> 3972</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: fieldInt=(%E,%E,%E)\n&quot;</span>, fieldInt.X(), fieldInt.Y(), fieldInt.Z());</div>
<div class="line"><a name="l03973"></a><span class="lineno"> 3973</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 2);</div>
<div class="line"><a name="l03974"></a><span class="lineno"> 3974</span>&#160;  }</div>
<div class="line"><a name="l03975"></a><span class="lineno"> 3975</span>&#160;  <span class="comment">// float fieldz=field_[in3(x,y,0,fx,fy,fz)].Z()+E.Z();// *field[x][y][zi].Z();</span></div>
<div class="line"><a name="l03976"></a><span class="lineno"> 3976</span>&#160;  <span class="keywordtype">double</span> EfieldZ = fieldInt.Z() / zdist;  <span class="comment">// average field over the path.</span></div>
<div class="line"><a name="l03977"></a><span class="lineno"> 3977</span>&#160;  <span class="keywordtype">double</span> BfieldZ = fieldIntB.Z() / zdist;</div>
<div class="line"><a name="l03978"></a><span class="lineno"> 3978</span>&#160;  <span class="comment">// double fieldz=Enominal; // ideal field over path.</span></div>
<div class="line"><a name="l03979"></a><span class="lineno"> 3979</span>&#160;</div>
<div class="line"><a name="l03980"></a><span class="lineno"> 3980</span>&#160;  <span class="comment">// these values should be with real, not nominal field?</span></div>
<div class="line"><a name="l03981"></a><span class="lineno"> 3981</span>&#160;  <span class="comment">// double mu=abs(vdrift/Enominal);//vdrift in [cm/s], field in [V/cm] hence mu in [cm^2/(V*s)];  should be a positive value.  drift velocity over field magnitude, not field direction.</span></div>
<div class="line"><a name="l03982"></a><span class="lineno"> 3982</span>&#160;  <span class="comment">// double omegatau=-mu*Bnominal;//minus sign is for electron charge.</span></div>
<div class="line"><a name="l03983"></a><span class="lineno"> 3983</span>&#160;  <span class="keywordtype">double</span> omegatau = <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae94da38b14049881cc6c9e36b84a05d2">omegatau_nominal</a>;  <span class="comment">// don&#39;t compute this every time!</span></div>
<div class="line"><a name="l03984"></a><span class="lineno"> 3984</span>&#160;  <span class="comment">// or:  omegatau=-10*(10*B.Z()/Tesla)*(vdrift/(cm/us))/(fieldz/(V/cm)); //which is the same as my calculation up to a sign.</span></div>
<div class="line"><a name="l03985"></a><span class="lineno"> 3985</span>&#160;  <span class="comment">// printf(&quot;omegatau=%f\n&quot;,omegatau);</span></div>
<div class="line"><a name="l03986"></a><span class="lineno"> 3986</span>&#160;</div>
<div class="line"><a name="l03987"></a><span class="lineno"> 3987</span>&#160;  <span class="keywordtype">double</span> T1om = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a1062463e699885ded88f6c1a3a07a533">langevin_T1</a> * omegatau;</div>
<div class="line"><a name="l03988"></a><span class="lineno"> 3988</span>&#160;  <span class="keywordtype">double</span> T2om2 = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a217aae0018d7122b91d6cc9b5709c61b">langevin_T2</a> * omegatau * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a217aae0018d7122b91d6cc9b5709c61b">langevin_T2</a> * omegatau;</div>
<div class="line"><a name="l03989"></a><span class="lineno"> 3989</span>&#160;  <span class="keywordtype">double</span> c0 = 1 / (1 + T2om2);           <span class="comment">//</span></div>
<div class="line"><a name="l03990"></a><span class="lineno"> 3990</span>&#160;  <span class="keywordtype">double</span> c1 = T1om / (1 + T1om * T1om);  <span class="comment">// Carlos gets this term wrong.  It should be linear on top, quadratic on bottom.</span></div>
<div class="line"><a name="l03991"></a><span class="lineno"> 3991</span>&#160;  <span class="keywordtype">double</span> <a class="code" href="../../d0/d95/analysis_2blob_2master_2dNdEta__Run2023_2analysis__INTT_2plot_2sPHENIXStyle_2test__style_8C.html#ab4054a35faf3253141237ffcdba622b4">c2</a> = T2om2 / (1 + T2om2);</div>
<div class="line"><a name="l03992"></a><span class="lineno"> 3992</span>&#160;</div>
<div class="line"><a name="l03993"></a><span class="lineno"> 3993</span>&#160;  TVector3 EintOverEz = 1 / EfieldZ * fieldInt;   <span class="comment">// integral of E/E_z= integral of E / integral of E_z * delta_z</span></div>
<div class="line"><a name="l03994"></a><span class="lineno"> 3994</span>&#160;  TVector3 BintOverBz = 1 / BfieldZ * fieldIntB;  <span class="comment">// should this (and the above?) be BfieldZ or Bnominal?</span></div>
<div class="line"><a name="l03995"></a><span class="lineno"> 3995</span>&#160;</div>
<div class="line"><a name="l03996"></a><span class="lineno"> 3996</span>&#160;  <span class="comment">// really this should be the integral of the ratio, not the ratio of the integrals.</span></div>
<div class="line"><a name="l03997"></a><span class="lineno"> 3997</span>&#160;  <span class="comment">// and should be integrals over the B field, btu for now that&#39;s fixed and constant across the region, so not necessary</span></div>
<div class="line"><a name="l03998"></a><span class="lineno"> 3998</span>&#160;  <span class="comment">// there&#39;s no reason to do this as r phi.  This is an equivalent result, since I handle everything in vectors.</span></div>
<div class="line"><a name="l03999"></a><span class="lineno"> 3999</span>&#160;  <span class="keywordtype">double</span> deltaX = c0 * EintOverEz.X() + c1 * EintOverEz.Y() - c1 * BintOverBz.Y() + c2 * BintOverBz.X();</div>
<div class="line"><a name="l04000"></a><span class="lineno"> 4000</span>&#160;  <span class="keywordtype">double</span> deltaY = c0 * EintOverEz.Y() - c1 * EintOverEz.X() + c1 * BintOverBz.X() + c2 * BintOverBz.Y();</div>
<div class="line"><a name="l04001"></a><span class="lineno"> 4001</span>&#160;  <span class="comment">// strictly, for deltaZ we want to integrate v&#39;(E)*(E-E0)dz and v&#39;&#39;(E)*(E-E0)^2 dz, but over a short step the field is constant, and hence this can be a product of the integral and not an integral of the product:</span></div>
<div class="line"><a name="l04002"></a><span class="lineno"> 4002</span>&#160;</div>
<div class="line"><a name="l04003"></a><span class="lineno"> 4003</span>&#160;  <span class="keywordtype">double</span> vprime = (5000 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a50f6e78f93f158e6ab693cc119250cc6">s</a>) / (100 * <a class="code" href="../../de/d64/classAnnularFieldSim.html#add22fc45f5d33e13cfc422f3e8c8c997">V</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>);  <span class="comment">// hard-coded value for 50:50.  Eventually this needs to be part of the constructor, as do most of the repeated math terms here.</span></div>
<div class="line"><a name="l04004"></a><span class="lineno"> 4004</span>&#160;  <span class="keywordtype">double</span> vdoubleprime = 0;                           <span class="comment">// neglecting the v&#39;&#39; term for now.  Fair? It&#39;s pretty linear at our operating point, and it would require adding an additional term to the field integral.</span></div>
<div class="line"><a name="l04005"></a><span class="lineno"> 4005</span>&#160;</div>
<div class="line"><a name="l04006"></a><span class="lineno"> 4006</span>&#160;  <span class="comment">// note: as long as my step is very small, I am essentially just reading the field at a point and multiplying by the step size.</span></div>
<div class="line"><a name="l04007"></a><span class="lineno"> 4007</span>&#160;  <span class="comment">// hence integral of P dz, where P is a function of the fields, int|P(E(x,y,z))dz=P(int|E(x,y,z)dz/deltaZ)*deltaZ</span></div>
<div class="line"><a name="l04008"></a><span class="lineno"> 4008</span>&#160;  <span class="comment">// hence: , eg, int|E^2dz=(int|Edz)^2/deltaz</span></div>
<div class="line"><a name="l04009"></a><span class="lineno"> 4009</span>&#160;  <span class="keywordtype">double</span> deltaZ = vprime / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae83b1b7d69b7029daf8a9ed58314e5c1">vdrift</a> * (fieldInt.Z() - zdist * <a class="code" href="../../de/d64/classAnnularFieldSim.html#a517b31827f7563eeb6c9c54182b5655e">Enominal</a>) + vdoubleprime / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae83b1b7d69b7029daf8a9ed58314e5c1">vdrift</a> * (fieldInt.Z() - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a517b31827f7563eeb6c9c54182b5655e">Enominal</a> * zdist) * (fieldInt.Z() - <a class="code" href="../../de/d64/classAnnularFieldSim.html#a517b31827f7563eeb6c9c54182b5655e">Enominal</a> * zdist) / (2 * zdist) - 0.5 / zdist * (EintOverEz.X() * EintOverEz.X() + EintOverEz.Y() * EintOverEz.Y()) + c1 / zdist * (EintOverEz.X() * BintOverBz.Y() - EintOverEz.Y() * BintOverBz.X()) + c2 / zdist * (EintOverEz.X() * BintOverBz.X() + EintOverEz.Y() * BintOverBz.Y()) + c2 / zdist * (BintOverBz.X() * BintOverBz.X() + BintOverBz.Y() * BintOverBz.Y());  <span class="comment">// missing v&#39;&#39; term.</span></div>
<div class="line"><a name="l04010"></a><span class="lineno"> 4010</span>&#160;</div>
<div class="line"><a name="l04011"></a><span class="lineno"> 4011</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">false</span>)</div>
<div class="line"><a name="l04012"></a><span class="lineno"> 4012</span>&#160;  {</div>
<div class="line"><a name="l04013"></a><span class="lineno"> 4013</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion:  (c0,c1,c2)=(%E,%E,%E)\n&quot;</span>, c0, c1, c2);</div>
<div class="line"><a name="l04014"></a><span class="lineno"> 4014</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion:  EintOverEz==(%E,%E,%E)\n&quot;</span>, EintOverEz.X(), EintOverEz.Y(), EintOverEz.Z());</div>
<div class="line"><a name="l04015"></a><span class="lineno"> 4015</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion:  BintOverBz==(%E,%E,%E)\n&quot;</span>, BintOverBz.X(), BintOverBz.Y(), BintOverBz.Z());</div>
<div class="line"><a name="l04016"></a><span class="lineno"> 4016</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: (%2.4f,%2.4f,%2.4f) to z=%2.4f\n&quot;</span>, start.X(), start.Y(), start.Z(), zdest);</div>
<div class="line"><a name="l04017"></a><span class="lineno"> 4017</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: fieldInt=(%E,%E,%E)\n&quot;</span>, fieldInt.X(), fieldInt.Y(), fieldInt.Z());</div>
<div class="line"><a name="l04018"></a><span class="lineno"> 4018</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: delta=(%E,%E,%E)\n&quot;</span>, deltaX, deltaY, deltaZ);</div>
<div class="line"><a name="l04019"></a><span class="lineno"> 4019</span>&#160;  }</div>
<div class="line"><a name="l04020"></a><span class="lineno"> 4020</span>&#160;</div>
<div class="line"><a name="l04021"></a><span class="lineno"> 4021</span>&#160;  <span class="comment">// if (abs(deltaZ / zdist) &gt; 0.25)</span></div>
<div class="line"><a name="l04022"></a><span class="lineno"> 4022</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">false</span>)</div>
<div class="line"><a name="l04023"></a><span class="lineno"> 4023</span>&#160;  {</div>
<div class="line"><a name="l04024"></a><span class="lineno"> 4024</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion produced a very large zdistortion!\n&quot;</span>);</div>
<div class="line"><a name="l04025"></a><span class="lineno"> 4025</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: zdist=%2.4f, deltaZ=%2.4f, Delta/z=%2.4f\n&quot;</span>, zdist, deltaZ, deltaZ / zdist);</div>
<div class="line"><a name="l04026"></a><span class="lineno"> 4026</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: average field Z:  Ez=%2.4fV/cm, Bz=%2.4fT\n&quot;</span>, EfieldZ / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#add22fc45f5d33e13cfc422f3e8c8c997">V</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>), BfieldZ / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad3398b737ec329b9f9dca579bf123bb0">Tesla</a>);</div>
<div class="line"><a name="l04027"></a><span class="lineno"> 4027</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion:  (c0,c1,c2)=(%E,%E,%E)\n&quot;</span>, c0, c1, c2);</div>
<div class="line"><a name="l04028"></a><span class="lineno"> 4028</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion:  EintOverEz==(%E,%E,%E)\n&quot;</span>, EintOverEz.X(), EintOverEz.Y(), EintOverEz.Z());</div>
<div class="line"><a name="l04029"></a><span class="lineno"> 4029</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion:  BintOverBz==(%E,%E,%E)\n&quot;</span>, BintOverBz.X(), BintOverBz.Y(), BintOverBz.Z());</div>
<div class="line"><a name="l04030"></a><span class="lineno"> 4030</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: (%2.4f,%2.4f,%2.4f) to z=%2.4f\n&quot;</span>, start.X(), start.Y(), start.Z(), zdest);</div>
<div class="line"><a name="l04031"></a><span class="lineno"> 4031</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: EfieldInt=(%E,%E,%E)\n&quot;</span>, fieldInt.X(), fieldInt.Y(), fieldInt.Z());</div>
<div class="line"><a name="l04032"></a><span class="lineno"> 4032</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: BfieldInt=(%E,%E,%E)\n&quot;</span>, fieldIntB.X(), fieldIntB.Y(), fieldIntB.Z());</div>
<div class="line"><a name="l04033"></a><span class="lineno"> 4033</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: delta=(%E,%E,%E)\n&quot;</span>, deltaX, deltaY, deltaZ);</div>
<div class="line"><a name="l04034"></a><span class="lineno"> 4034</span>&#160;    <span class="comment">// assert(false);</span></div>
<div class="line"><a name="l04035"></a><span class="lineno"> 4035</span>&#160;  }</div>
<div class="line"><a name="l04036"></a><span class="lineno"> 4036</span>&#160;</div>
<div class="line"><a name="l04037"></a><span class="lineno"> 4037</span>&#160;  <span class="keywordflow">if</span> (abs(deltaX) &lt; 1<a class="code" href="../../dc/d43/Proto2ShowerCalibFit_8m.html#a93b7cb110b782e59ebd44f83181b9e0e" title="Modifier of energy of the particle, fP[6].">E</a>-20 &amp;&amp; !(<a class="code" href="../../de/d64/classAnnularFieldSim.html#aa182d2d11e0e8216fa7ebb1dcdd4a68c">chargeCase</a> == <a class="code" href="../../de/d64/classAnnularFieldSim.html#acb7667cb9f4bba130299af053fdc51f0ababca6924febfe3960a8663425f1adf2">NoSpacecharge</a>))</div>
<div class="line"><a name="l04038"></a><span class="lineno"> 4038</span>&#160;  {</div>
<div class="line"><a name="l04039"></a><span class="lineno"> 4039</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion produced a very small deltaX: %E\n&quot;</span>, deltaX);</div>
<div class="line"><a name="l04040"></a><span class="lineno"> 4040</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion:  (c0,c1,c2)=(%E,%E,%E)\n&quot;</span>, c0, c1, c2);</div>
<div class="line"><a name="l04041"></a><span class="lineno"> 4041</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion:  EintOverEz==(%E,%E,%E)\n&quot;</span>, EintOverEz.X(), EintOverEz.Y(), EintOverEz.Z());</div>
<div class="line"><a name="l04042"></a><span class="lineno"> 4042</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion:  BintOverBz==(%E,%E,%E)\n&quot;</span>, BintOverBz.X(), BintOverBz.Y(), BintOverBz.Z());</div>
<div class="line"><a name="l04043"></a><span class="lineno"> 4043</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: (%2.4f,%2.4f,%2.4f) to z=%2.4f\n&quot;</span>, start.X(), start.Y(), start.Z(), zdest);</div>
<div class="line"><a name="l04044"></a><span class="lineno"> 4044</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: fieldInt=(%E,%E,%E)\n&quot;</span>, fieldInt.X(), fieldInt.Y(), fieldInt.Z());</div>
<div class="line"><a name="l04045"></a><span class="lineno"> 4045</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: delta=(%E,%E,%E)\n&quot;</span>, deltaX, deltaY, deltaZ);</div>
<div class="line"><a name="l04046"></a><span class="lineno"> 4046</span>&#160;    <span class="comment">// assert(1==2);</span></div>
<div class="line"><a name="l04047"></a><span class="lineno"> 4047</span>&#160;  }</div>
<div class="line"><a name="l04048"></a><span class="lineno"> 4048</span>&#160;</div>
<div class="line"><a name="l04049"></a><span class="lineno"> 4049</span>&#160;  <span class="comment">// if (!(abs(deltaX) &lt; 1E3))</span></div>
<div class="line"><a name="l04050"></a><span class="lineno"> 4050</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">false</span>)</div>
<div class="line"><a name="l04051"></a><span class="lineno"> 4051</span>&#160;  {</div>
<div class="line"><a name="l04052"></a><span class="lineno"> 4052</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion produced a very large deltaX: %E\n&quot;</span>, deltaX);</div>
<div class="line"><a name="l04053"></a><span class="lineno"> 4053</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion:  (c0,c1,c2)=(%E,%E,%E)\n&quot;</span>, c0, c1, c2);</div>
<div class="line"><a name="l04054"></a><span class="lineno"> 4054</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion:  EintOverEz==(%E,%E,%E)\n&quot;</span>, EintOverEz.X(), EintOverEz.Y(), EintOverEz.Z());</div>
<div class="line"><a name="l04055"></a><span class="lineno"> 4055</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion:  BintOverBz==(%E,%E,%E)\n&quot;</span>, BintOverBz.X(), BintOverBz.Y(), BintOverBz.Z());</div>
<div class="line"><a name="l04056"></a><span class="lineno"> 4056</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: (%2.4f,%2.4f,%2.4f) (rp)=(%2.4f,%2.4f) to z=%2.4f\n&quot;</span>, start.X(), start.Y(), start.Z(), start.Perp(), start.Phi(), zdest);</div>
<div class="line"><a name="l04057"></a><span class="lineno"> 4057</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: fieldInt=(%E,%E,%E)\n&quot;</span>, fieldInt.X(), fieldInt.Y(), fieldInt.Z());</div>
<div class="line"><a name="l04058"></a><span class="lineno"> 4058</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;GetStepDistortion: delta=(%E,%E,%E)\n&quot;</span>, deltaX, deltaY, deltaZ);</div>
<div class="line"><a name="l04059"></a><span class="lineno"> 4059</span>&#160;    <a class="code" href="../../df/df7/DrawTrackingEval_8C.html#a6f56363b38edbe2c8f3f447f891ee2c0">assert</a>(1 == 2);</div>
<div class="line"><a name="l04060"></a><span class="lineno"> 4060</span>&#160;  }</div>
<div class="line"><a name="l04061"></a><span class="lineno"> 4061</span>&#160;</div>
<div class="line"><a name="l04062"></a><span class="lineno"> 4062</span>&#160;  <span class="comment">// deltaZ=0;//temporary removal.</span></div>
<div class="line"><a name="l04063"></a><span class="lineno"> 4063</span>&#160;</div>
<div class="line"><a name="l04064"></a><span class="lineno"> 4064</span>&#160;  TVector3 shift(deltaX, deltaY, deltaZ);</div>
<div class="line"><a name="l04065"></a><span class="lineno"> 4065</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Mag() &gt; 0)</div>
<div class="line"><a name="l04066"></a><span class="lineno"> 4066</span>&#160;  {  <span class="comment">// debug code to scale the resulting distortions</span></div>
<div class="line"><a name="l04067"></a><span class="lineno"> 4067</span>&#160;    shift.RotateZ(-start.Phi());</div>
<div class="line"><a name="l04068"></a><span class="lineno"> 4068</span>&#160;    <span class="comment">// TVector3 localScale=debug_distortionScale;</span></div>
<div class="line"><a name="l04069"></a><span class="lineno"> 4069</span>&#160;    <span class="comment">// localScale.RotateZ(start.Phi());</span></div>
<div class="line"><a name="l04070"></a><span class="lineno"> 4070</span>&#160;    shift.SetXYZ(shift.X() * <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.X(), shift.Y() * <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Y(), shift.Z() * <a class="code" href="../../de/d64/classAnnularFieldSim.html#adbd418bf0e1b92cde436822fd02abf74">debug_distortionScale</a>.Z());</div>
<div class="line"><a name="l04071"></a><span class="lineno"> 4071</span>&#160;    shift.RotateZ(start.Phi());</div>
<div class="line"><a name="l04072"></a><span class="lineno"> 4072</span>&#160;  }</div>
<div class="line"><a name="l04073"></a><span class="lineno"> 4073</span>&#160;</div>
<div class="line"><a name="l04074"></a><span class="lineno"> 4074</span>&#160;  <span class="keywordflow">return</span> shift;</div>
<div class="line"><a name="l04075"></a><span class="lineno"> 4075</span>&#160;}</div>
<div class="line"><a name="l04076"></a><span class="lineno"> 4076</span>&#160;</div>
<div class="line"><a name="l04077"></a><span class="lineno"> 4077</span>&#160;<span class="comment">// putting all the getters here out of the way:</span></div>
<div class="line"><a name="l04078"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a7968214559bb324459390f9cce7e8a88"> 4078</a></span>&#160;<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../de/d64/classAnnularFieldSim.html#a7968214559bb324459390f9cce7e8a88">AnnularFieldSim::GetLookupString</a>()</div>
<div class="line"><a name="l04079"></a><span class="lineno"> 4079</span>&#160;{</div>
<div class="line"><a name="l04080"></a><span class="lineno"> 4080</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == LookupCase::Full3D)</div>
<div class="line"><a name="l04081"></a><span class="lineno"> 4081</span>&#160;  {</div>
<div class="line"><a name="l04082"></a><span class="lineno"> 4082</span>&#160;    <span class="keywordflow">return</span> Form(<span class="stringliteral">&quot;Full3D (%d x %d x %d) with (%d x %d x %d) roi&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae9038e19b32063a3c67c00853cd325b8">nphi_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>);</div>
<div class="line"><a name="l04083"></a><span class="lineno"> 4083</span>&#160;  }</div>
<div class="line"><a name="l04084"></a><span class="lineno"> 4084</span>&#160;</div>
<div class="line"><a name="l04085"></a><span class="lineno"> 4085</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a117311ef87fa82b0a7cc27f7af531d81">lookupCase</a> == LookupCase::PhiSlice)</div>
<div class="line"><a name="l04086"></a><span class="lineno"> 4086</span>&#160;  {</div>
<div class="line"><a name="l04087"></a><span class="lineno"> 4087</span>&#160;    <span class="keywordflow">return</span> Form(<span class="stringliteral">&quot;PhiSlice (%d x %d x %d) with (%d x 1 x %d) roi&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a79536226ea2f16746228f2167068446e">nr</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab8baa667abbf5c7f39839623f1034b25">nphi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a320889ce4dd4f78af0db7d7771154749">nz</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6a8f9df0c18dc6bdea346575b817c152">nr_roi</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#a949b7ed609195b0cd4498e040ff262db">nz_roi</a>);</div>
<div class="line"><a name="l04088"></a><span class="lineno"> 4088</span>&#160;  }</div>
<div class="line"><a name="l04089"></a><span class="lineno"> 4089</span>&#160;</div>
<div class="line"><a name="l04090"></a><span class="lineno"> 4090</span>&#160;  <span class="keywordflow">return</span> <span class="stringliteral">&quot;broken&quot;</span>;</div>
<div class="line"><a name="l04091"></a><span class="lineno"> 4091</span>&#160;}</div>
<div class="line"><a name="l04092"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#af0c340523f69f514b60be663c0422f26"> 4092</a></span>&#160;<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../de/d64/classAnnularFieldSim.html#af0c340523f69f514b60be663c0422f26">AnnularFieldSim::GetGasString</a>()</div>
<div class="line"><a name="l04093"></a><span class="lineno"> 4093</span>&#160;{</div>
<div class="line"><a name="l04094"></a><span class="lineno"> 4094</span>&#160;  <span class="keywordflow">return</span> Form(<span class="stringliteral">&quot;vdrift=%2.2fcm/us, Enom=%2.2fV/cm, Bnom=%2.2fT, omtau=%2.4E&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae83b1b7d69b7029daf8a9ed58314e5c1">vdrift</a> / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#a4e5c8f9814a8b08c8d30cfe74b1f1ab6">us</a>), <a class="code" href="../../de/d64/classAnnularFieldSim.html#a517b31827f7563eeb6c9c54182b5655e">Enominal</a> / (<a class="code" href="../../de/d64/classAnnularFieldSim.html#add22fc45f5d33e13cfc422f3e8c8c997">V</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ac44c4053b96af444a599251c93649d0e">cm</a>), <a class="code" href="../../de/d64/classAnnularFieldSim.html#ace424fdd41ee18b156ca4356cdfa736e">Bnominal</a> / <a class="code" href="../../de/d64/classAnnularFieldSim.html#ad3398b737ec329b9f9dca579bf123bb0">Tesla</a>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#ae94da38b14049881cc6c9e36b84a05d2">omegatau_nominal</a>);</div>
<div class="line"><a name="l04095"></a><span class="lineno"> 4095</span>&#160;}</div>
<div class="line"><a name="l04096"></a><span class="lineno"> 4096</span>&#160;</div>
<div class="line"><a name="l04097"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a146ebec611255de008dd779f3092f893"> 4097</a></span>&#160;<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../de/d64/classAnnularFieldSim.html#a146ebec611255de008dd779f3092f893">AnnularFieldSim::GetFieldString</a>()</div>
<div class="line"><a name="l04098"></a><span class="lineno"> 4098</span>&#160;{</div>
<div class="line"><a name="l04099"></a><span class="lineno"> 4099</span>&#160;  <span class="keywordflow">return</span> Form(<span class="stringliteral">&quot;%s, %s&quot;</span>, <a class="code" href="../../de/d64/classAnnularFieldSim.html#aee246a62e470501dc809be946330f11c">Efieldname</a>.c_str(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#ab032b553e141c1a6add587c42458f347">Bfieldname</a>.c_str());</div>
<div class="line"><a name="l04100"></a><span class="lineno"> 4100</span>&#160;}</div>
<div class="line"><a name="l04101"></a><span class="lineno"> 4101</span>&#160;</div>
<div class="line"><a name="l04102"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#afcbd44db4d9cf22a4c80a737c35ef634"> 4102</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#afcbd44db4d9cf22a4c80a737c35ef634">AnnularFieldSim::GetFieldAt</a>(<span class="keyword">const</span> TVector3 &amp;<a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>)</div>
<div class="line"><a name="l04103"></a><span class="lineno"> 4103</span>&#160;{</div>
<div class="line"><a name="l04104"></a><span class="lineno"> 4104</span>&#160;  <span class="comment">// assume pos is in native units (see header)</span></div>
<div class="line"><a name="l04105"></a><span class="lineno"> 4105</span>&#160;</div>
<div class="line"><a name="l04106"></a><span class="lineno"> 4106</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <a class="code" href="../../dc/d78/namespacemerge__hashes.html#a63313c3a4f2b0cb6f7cea830c9ff269d">p</a>, <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>;</div>
<div class="line"><a name="l04107"></a><span class="lineno"> 4107</span>&#160;</div>
<div class="line"><a name="l04108"></a><span class="lineno"> 4108</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#af41a4754a596a90505d15a5dcb1868a6">GetRindexAndCheckBounds</a>(pos.Perp(), &amp;<a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>) == BoundsCase::OutOfBounds)</div>
<div class="line"><a name="l04109"></a><span class="lineno"> 4109</span>&#160;  {</div>
<div class="line"><a name="l04110"></a><span class="lineno"> 4110</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>;</div>
<div class="line"><a name="l04111"></a><span class="lineno"> 4111</span>&#160;  }</div>
<div class="line"><a name="l04112"></a><span class="lineno"> 4112</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#aab5dee891f7302176821ad489549a18f">GetPhiIndexAndCheckBounds</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(pos.Phi()), &amp;p) == BoundsCase::OutOfBounds)</div>
<div class="line"><a name="l04113"></a><span class="lineno"> 4113</span>&#160;  {</div>
<div class="line"><a name="l04114"></a><span class="lineno"> 4114</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>;</div>
<div class="line"><a name="l04115"></a><span class="lineno"> 4115</span>&#160;  }</div>
<div class="line"><a name="l04116"></a><span class="lineno"> 4116</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(pos.Z(), &amp;<a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>) == BoundsCase::OutOfBounds)</div>
<div class="line"><a name="l04117"></a><span class="lineno"> 4117</span>&#160;  {</div>
<div class="line"><a name="l04118"></a><span class="lineno"> 4118</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l04119"></a><span class="lineno"> 4119</span>&#160;    {</div>
<div class="line"><a name="l04120"></a><span class="lineno"> 4120</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6743c036ddac97dd925c0df7db7ea501">twin</a>-&gt;<a class="code" href="../../de/d64/classAnnularFieldSim.html#afcbd44db4d9cf22a4c80a737c35ef634">GetFieldAt</a>(pos);</div>
<div class="line"><a name="l04121"></a><span class="lineno"> 4121</span>&#160;    }</div>
<div class="line"><a name="l04122"></a><span class="lineno"> 4122</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>;</div>
<div class="line"><a name="l04123"></a><span class="lineno"> 4123</span>&#160;  }</div>
<div class="line"><a name="l04124"></a><span class="lineno"> 4124</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#aeeaac1b3cbe466eac8fec86af99172d2">Efield</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(r, p, z);</div>
<div class="line"><a name="l04125"></a><span class="lineno"> 4125</span>&#160;}</div>
<div class="line"><a name="l04126"></a><span class="lineno"> 4126</span>&#160;</div>
<div class="line"><a name="l04127"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#aacf7dde3b9fea13b430836afa2a01ffa"> 4127</a></span>&#160;TVector3 <a class="code" href="../../de/d64/classAnnularFieldSim.html#aacf7dde3b9fea13b430836afa2a01ffa">AnnularFieldSim::GetBFieldAt</a>(<span class="keyword">const</span> TVector3 &amp;<a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>)</div>
<div class="line"><a name="l04128"></a><span class="lineno"> 4128</span>&#160;{</div>
<div class="line"><a name="l04129"></a><span class="lineno"> 4129</span>&#160;  <span class="comment">// assume pos is in native units (see header)</span></div>
<div class="line"><a name="l04130"></a><span class="lineno"> 4130</span>&#160;</div>
<div class="line"><a name="l04131"></a><span class="lineno"> 4131</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>, <a class="code" href="../../dc/d78/namespacemerge__hashes.html#a63313c3a4f2b0cb6f7cea830c9ff269d">p</a>, <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>;</div>
<div class="line"><a name="l04132"></a><span class="lineno"> 4132</span>&#160;</div>
<div class="line"><a name="l04133"></a><span class="lineno"> 4133</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#af41a4754a596a90505d15a5dcb1868a6">GetRindexAndCheckBounds</a>(pos.Perp(), &amp;<a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#af81c6155a5d0b16cd581615034225ae9">r</a>) == BoundsCase::OutOfBounds)</div>
<div class="line"><a name="l04134"></a><span class="lineno"> 4134</span>&#160;  {</div>
<div class="line"><a name="l04135"></a><span class="lineno"> 4135</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>;</div>
<div class="line"><a name="l04136"></a><span class="lineno"> 4136</span>&#160;  }</div>
<div class="line"><a name="l04137"></a><span class="lineno"> 4137</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#aab5dee891f7302176821ad489549a18f">GetPhiIndexAndCheckBounds</a>(<a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(pos.Phi()), &amp;p) == BoundsCase::OutOfBounds)</div>
<div class="line"><a name="l04138"></a><span class="lineno"> 4138</span>&#160;  {</div>
<div class="line"><a name="l04139"></a><span class="lineno"> 4139</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>;</div>
<div class="line"><a name="l04140"></a><span class="lineno"> 4140</span>&#160;  }</div>
<div class="line"><a name="l04141"></a><span class="lineno"> 4141</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(pos.Z(), &amp;<a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>) == BoundsCase::OutOfBounds)</div>
<div class="line"><a name="l04142"></a><span class="lineno"> 4142</span>&#160;  {</div>
<div class="line"><a name="l04143"></a><span class="lineno"> 4143</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l04144"></a><span class="lineno"> 4144</span>&#160;    {</div>
<div class="line"><a name="l04145"></a><span class="lineno"> 4145</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6743c036ddac97dd925c0df7db7ea501">twin</a>-&gt;<a class="code" href="../../de/d64/classAnnularFieldSim.html#aacf7dde3b9fea13b430836afa2a01ffa">GetBFieldAt</a>(pos);</div>
<div class="line"><a name="l04146"></a><span class="lineno"> 4146</span>&#160;    }</div>
<div class="line"><a name="l04147"></a><span class="lineno"> 4147</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a706460f97f54eb09c18d695e436ee2b9">zero_vector</a>;</div>
<div class="line"><a name="l04148"></a><span class="lineno"> 4148</span>&#160;  }</div>
<div class="line"><a name="l04149"></a><span class="lineno"> 4149</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a8a4ff3d7e7a493f4b38408e83c7479af">Bfield</a>-&gt;<a class="code" href="../../d8/d64/classMultiArray.html#aec5a4ca1ee2a856a7574a75d6ad48568">Get</a>(r, p, z);</div>
<div class="line"><a name="l04150"></a><span class="lineno"> 4150</span>&#160;}</div>
<div class="line"><a name="l04151"></a><span class="lineno"> 4151</span>&#160;</div>
<div class="line"><a name="l04152"></a><span class="lineno"><a class="code" href="../../de/d64/classAnnularFieldSim.html#a7508f125c1980cf816424b0e3b0e0f8b"> 4152</a></span>&#160;<span class="keywordtype">float</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a7508f125c1980cf816424b0e3b0e0f8b">AnnularFieldSim::GetChargeAt</a>(<span class="keyword">const</span> TVector3 &amp;<a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a182617618c30f1ba6a9c7540ae655340">pos</a>)</div>
<div class="line"><a name="l04153"></a><span class="lineno"> 4153</span>&#160;{</div>
<div class="line"><a name="l04154"></a><span class="lineno"> 4154</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>;</div>
<div class="line"><a name="l04155"></a><span class="lineno"> 4155</span>&#160;  <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563">BoundsCase</a> zbound = <a class="code" href="../../de/d64/classAnnularFieldSim.html#a004ad992d4f49f5aba99cd82b8983163">GetZindexAndCheckBounds</a>(pos.Z(), &amp;<a class="code" href="../../da/dfb/namespacephysmon__track__finding__ttbar.html#a94611c039d3d047818ab5b8dcfa82d12">z</a>);  <span class="comment">//==BoundsCase::OutOfBounds) return zero_vector;</span></div>
<div class="line"><a name="l04156"></a><span class="lineno"> 4156</span>&#160;  <span class="keywordflow">if</span> (zbound == <a class="code" href="../../de/d64/classAnnularFieldSim.html#a548d440aa514aa75d10b01b43dd3d563a5d6b1a005f45425192fb685b714dac15">OutOfBounds</a>)</div>
<div class="line"><a name="l04157"></a><span class="lineno"> 4157</span>&#160;  {</div>
<div class="line"><a name="l04158"></a><span class="lineno"> 4158</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../de/d64/classAnnularFieldSim.html#a2725f78da3001d4b75a0d9f91b34dea9">hasTwin</a>)</div>
<div class="line"><a name="l04159"></a><span class="lineno"> 4159</span>&#160;    {</div>
<div class="line"><a name="l04160"></a><span class="lineno"> 4160</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a6743c036ddac97dd925c0df7db7ea501">twin</a>-&gt;<a class="code" href="../../de/d64/classAnnularFieldSim.html#a7508f125c1980cf816424b0e3b0e0f8b">GetChargeAt</a>(pos);</div>
<div class="line"><a name="l04161"></a><span class="lineno"> 4161</span>&#160;    }</div>
<div class="line"><a name="l04162"></a><span class="lineno"> 4162</span>&#160;    <a class="code" href="../../da/d23/msg__buffer_8cc.html#a98631211a4a8aee62f572375d5b637be">printf</a>(<span class="stringliteral">&quot;Caution:  tried to read charge at zbin=%d!  No twin available to handle this\n&quot;</span>, z);</div>
<div class="line"><a name="l04163"></a><span class="lineno"> 4163</span>&#160;    <span class="keywordflow">return</span> -999;</div>
<div class="line"><a name="l04164"></a><span class="lineno"> 4164</span>&#160;  }</div>
<div class="line"><a name="l04165"></a><span class="lineno"> 4165</span>&#160;</div>
<div class="line"><a name="l04166"></a><span class="lineno"> 4166</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="../../de/d64/classAnnularFieldSim.html#a002f26208e71c2e801523bd82a015f9e">q</a>-&gt;<a class="code" href="../../d4/d14/classChargeMapReader.html#a64364113cd14edf3a356e3a2eebd352e">GetChargeAtPosition</a>(pos.Perp(), <a class="code" href="../../de/d64/classAnnularFieldSim.html#a89886f51584b79fee6e61ca60e353545">FilterPhiPos</a>(pos.Phi()), pos.Z());  <span class="comment">// because tvectors take position to be -phi to phi, we always have to filter.</span></div>
<div class="line"><a name="l04167"></a><span class="lineno"> 4167</span>&#160;  <span class="comment">// actually, we should probably just yield to that assumption in more places to speed this up.</span></div>
<div class="line"><a name="l04168"></a><span class="lineno"> 4168</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l04169"></a><span class="lineno"> 4169</span>&#160;<span class="comment">  //assume pos is in native units (see header)</span></div>
<div class="line"><a name="l04170"></a><span class="lineno"> 4170</span>&#160;<span class="comment">  int r, p, z;</span></div>
<div class="line"><a name="l04171"></a><span class="lineno"> 4171</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04172"></a><span class="lineno"> 4172</span>&#160;<span class="comment">  //get the bounds, but we don&#39;t want to actually check the cases, because the charge can go outside the vector region.</span></div>
<div class="line"><a name="l04173"></a><span class="lineno"> 4173</span>&#160;<span class="comment">  r = GetRindex(pos.Perp());</span></div>
<div class="line"><a name="l04174"></a><span class="lineno"> 4174</span>&#160;<span class="comment">  p = GetPhiIndex(pos.Phi());</span></div>
<div class="line"><a name="l04175"></a><span class="lineno"> 4175</span>&#160;<span class="comment"></span></div>
<div class="line"><a name="l04176"></a><span class="lineno"> 4176</span>&#160;<span class="comment">  BoundsCase zbound = GetZindexAndCheckBounds(pos.Z(), &amp;z);  //==BoundsCase::OutOfBounds) return zero_vector;</span></div>
<div class="line"><a name="l04177"></a><span class="lineno"> 4177</span>&#160;<span class="comment">  if (zbound == OutOfBounds &amp;&amp; hasTwin) return twin-&gt;GetChargeAt(pos);</span></div>
<div class="line"><a name="l04178"></a><span class="lineno"> 4178</span>&#160;<span class="comment">  return q-&gt;Get(r, p, z);</span></div>
<div class="line"><a name="l04179"></a><span class="lineno"> 4179</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l04180"></a><span class="lineno"> 4180</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->

<!-- start footer part -->
<div id="nav-path" class="navpath">
	<!-- id is needed for treeview function! -->
	<ul>
		<li class="navelem"><a class="el" href="../../dir_34b5111c58c3e86475589dfb505e95b7.html">coresoftware</a></li><li class="navelem"><a class="el" href="../../dir_3e7931e6e90ebf6929d89428e4ceb4f8.html">blob</a></li><li class="navelem"><a class="el" href="../../dir_b8a5edcdb55b282a13921e9cd7fd920e.html">master</a></li><li class="navelem"><a class="el" href="../../dir_d9556802b20bf1631a87617ee9edec73.html">calibrations</a></li><li class="navelem"><a class="el" href="../../dir_496d1eb0d44f2dace8a6935396932400.html">tpc</a></li><li class="navelem"><a class="el" href="../../dir_146e58f2e38b06a79eb0b78c99b82309.html">generator</a></li><li class="navelem"><a class="el" href="../../dc/d90/AnnularFieldSim_8cc.html">AnnularFieldSim.cc</a></li>
		<li class="footer">
		Built by <a href="mailto:jhuang@bnl.gov">Jin Huang</a></em>.
			updated: <em>Sat Feb 17 2024 22:17:59</em> using <a
			href="http://www.doxygen.org/index.html"> <img class="footer"
				src="../../doxygen.png" alt="doxygen" /></a> 1.8.2 
				with <a href="https://github.com/sPHENIX-Collaboration">sPHENIX GitHub integration</a>
		</li>
	</ul>
</div>
</body>
</html>
