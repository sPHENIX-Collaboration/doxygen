<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=9" />
<title>Analysis Software: acts/blob/sPHENIX/Core/include/Acts/Propagator/detail/GenericDenseEnvironmentExtension.hpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script> <link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script> 
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-155388685-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-155388685-2');
</script>
</head>
<body>
	<div id="top">
		<!-- do not remove this div, it is closed by doxygen! -->
		<div id="titlearea">
			<table cellspacing="0" cellpadding="0">
				<tbody>
					<tr style="height: 56px;">
						<td id="projectlogo"><a href="https://wiki.bnl.gov/sPHENIX/index.php/Main_Page"><img
								alt="Logo" src="../../sphenix.png" /></a></td>
						<td style="padding-left: 0.5em;">
							<div id="projectname">
								Analysis Software
							</div> 
							<div id="projectbrief">
								Documentation for <a href="https://wiki.bnl.gov/sPHENIX/index.php/Main_Page">sPHENIX</a> simulation software
							</div> 
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Home&#160;page</span></a></li>
      <li><a href="../../pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="../../annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
      <li><a href="../../examples.html"><span>Examples</span></a></li>
      <li><a href="../../usergroup0.html"><span>External&#160;Links</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../files.html"><span>File&#160;List</span></a></li>
      <li><a href="../../globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d9/db6/GenericDenseEnvironmentExtension_8hpp_source.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">GenericDenseEnvironmentExtension.hpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d9/db6/GenericDenseEnvironmentExtension_8hpp.html">Go to the documentation of this file.</a> Or view <a target="top" href="https://github.com/sPHENIX-Collaboration/acts/blob/sPHENIX/Core/include/Acts/Propagator/detail/GenericDenseEnvironmentExtension.hpp">the newest version in sPHENIX GitHub for file GenericDenseEnvironmentExtension.hpp</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">// This file is part of the Acts project.</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// Copyright (C) 2018-2019 CERN for the benefit of the Acts project</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">// This Source Code Form is subject to the terms of the Mozilla Public</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// License, v. 2.0. If a copy of the MPL was not distributed with this</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// file, You can obtain one at http://mozilla.org/MPL/2.0/.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#pragma once</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// Workaround for building on clang+libstdc++</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d0/d75/ReferenceWrapperAnyCompat_8hpp.html">Acts/Utilities/detail/ReferenceWrapperAnyCompat.hpp</a>&quot;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d0/d47/PdgParticle_8hpp.html">Acts/Definitions/PdgParticle.hpp</a>&quot;</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d1/db8/GeometryContext_8hpp.html">Acts/Geometry/GeometryContext.hpp</a>&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d6/da8/MagneticFieldContext_8hpp.html">Acts/MagneticField/MagneticFieldContext.hpp</a>&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d2/de7/Interactions_8hpp.html">Acts/Material/Interactions.hpp</a>&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="../../d5/d20/Propagator_8hpp.html">Acts/Propagator/Propagator.hpp</a>&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &lt;array&gt;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &lt;cmath&gt;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &lt;functional&gt;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">namespace </span>Acts {</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="keyword">namespace </span>detail {</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> scalar_t&gt;</div>
<div class="line"><a name="l00034"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html">   34</a></span>&#160;<span class="keyword">struct </span><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html" title="Evaluater of the k_i&#39;s and elements of the transport matrix D of the RKN4 stepping. This implementation involves energy loss due to ioninisation, bremsstrahlung, pair production and photonuclear interaction in the propagation and the jacobian. These effects will only occur if the propagation is in a TrackingVolume with attached material.">GenericDenseEnvironmentExtension</a> {</div>
<div class="line"><a name="l00035"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a58162aa5c4fe610607057b88975a0a51">   35</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a58162aa5c4fe610607057b88975a0a51">Scalar</a> = scalar_t;</div>
<div class="line"><a name="l00037"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a02281f9d98adb7e28674240cfc843f45">   37</a></span>&#160;  <span class="keyword">using</span> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a02281f9d98adb7e28674240cfc843f45" title="Vector3 replacement for the custom scalar type.">ThisVector3</a> = Eigen::Matrix&lt;Scalar, 3, 1&gt;;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aaa544d2ee1f5a648d72638eb9cf628fd">   40</a></span>&#160;  <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a58162aa5c4fe610607057b88975a0a51">Scalar</a> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aaa544d2ee1f5a648d72638eb9cf628fd" title="Momentum at a certain point.">currentMomentum</a> = 0.;</div>
<div class="line"><a name="l00042"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aeab04a930a906266b9109fda376cbf3e">   42</a></span>&#160;  <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a58162aa5c4fe610607057b88975a0a51">Scalar</a> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aeab04a930a906266b9109fda376cbf3e" title="Particles momentum at k1.">initialMomentum</a> = 0.;</div>
<div class="line"><a name="l00045"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a71e4589da01b82697232d7d5e91625c0">   45</a></span>&#160;  <a class="code" href="../../dd/d14/classActs_1_1Material.html">Material</a> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a71e4589da01b82697232d7d5e91625c0">material</a>;</div>
<div class="line"><a name="l00047"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#af64bd521f9cc2f76750b165a72603eef">   47</a></span>&#160;  std::array&lt;Scalar, 4&gt; <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#af64bd521f9cc2f76750b165a72603eef" title="Derivatives dLambda&#39;&#39;dlambda at each sub-step point.">dLdl</a>{};</div>
<div class="line"><a name="l00049"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970">   49</a></span>&#160;  std::array&lt;Scalar, 4&gt; <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>{};</div>
<div class="line"><a name="l00051"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a334408487e7aa14759a6075af6b29e5d">   51</a></span>&#160;  std::array&lt;Scalar, 4&gt; <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a334408487e7aa14759a6075af6b29e5d" title="Derivatives dPds at each sub-step.">dPds</a>{};</div>
<div class="line"><a name="l00053"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ab32df3f9ab15c5d1d4eac66635fa13a6">   53</a></span>&#160;  <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a58162aa5c4fe610607057b88975a0a51">Scalar</a> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ab32df3f9ab15c5d1d4eac66635fa13a6" title="Derivative d(dEds)d(q/p) evaluated at the initial point.">dgdqopValue</a> = 0.;</div>
<div class="line"><a name="l00055"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae85fca55eedfd4bee280dc0fc0d82692">   55</a></span>&#160;  <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a58162aa5c4fe610607057b88975a0a51">Scalar</a> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae85fca55eedfd4bee280dc0fc0d82692" title="Derivative dEds at the initial point.">g</a> = 0.;</div>
<div class="line"><a name="l00057"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a967feda2a6729f95e81caed788d43537">   57</a></span>&#160;  std::array&lt;Scalar, 4&gt; <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a967feda2a6729f95e81caed788d43537" title="k_i equivalent for the time propagation">tKi</a>{};</div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aa5d4174b28c2ff77a3313298ef30d958">   59</a></span>&#160;  std::array&lt;Scalar, 4&gt; <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aa5d4174b28c2ff77a3313298ef30d958" title="Lambda&#39;&#39;_i.">Lambdappi</a>{};</div>
<div class="line"><a name="l00061"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569">   61</a></span>&#160;  std::array&lt;Scalar, 4&gt; <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>{};</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a68ead255284943ed70cb8bc0270b363d" title="Default constructor.">GenericDenseEnvironmentExtension</a>() = <span class="keywordflow">default</span>;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> propagator_state_t, <span class="keyword">typename</span> stepper_t,</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;            <span class="keyword">typename</span> navigator_t&gt;</div>
<div class="line"><a name="l00079"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a9a3884f8377ad036ca739976a9293a7d">   79</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a9a3884f8377ad036ca739976a9293a7d" title="Control function if the step evaluation would be valid.">bid</a>(<span class="keyword">const</span> propagator_state_t&amp; <a class="code" href="../../d1/da4/namespacefilter.html#a7ddbae181c53b04cce853b5138130875">state</a>, <span class="keyword">const</span> stepper_t&amp; <a class="code" href="../../dc/dd5/namespacepropagation__timing.html#a73ac659fd9b60e49ebcce460d4268319">stepper</a>,</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;          <span class="keyword">const</span> navigator_t&amp; <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a22e345b0a99e30930769db298f566827">navigator</a>)<span class="keyword"> const </span>{</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; <a class="code" href="../../df/d10/MultiStepperTests_8cpp.html#a9ed951743cd0a9c5f4f4e103f88454a3">particleHypothesis</a> = stepper.particleHypothesis(state.stepping);</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="keywordtype">float</span> absQ = <a class="code" href="../../df/d10/MultiStepperTests_8cpp.html#a9ed951743cd0a9c5f4f4e103f88454a3">particleHypothesis</a>.absoluteCharge();</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    <span class="keywordtype">float</span> <a class="code" href="../../d2/dcb/InteractionsTests_8cpp.html#aa19bfaf8cfd779867e9ce58c82e2e23d">mass</a> = <a class="code" href="../../df/d10/MultiStepperTests_8cpp.html#a9ed951743cd0a9c5f4f4e103f88454a3">particleHypothesis</a>.mass();</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <span class="comment">// Check for valid particle properties</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <span class="keywordflow">if</span> (absQ == 0. || mass == 0. ||</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        stepper.absoluteMomentum(state.stepping) &lt;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;            state.options.momentumCutOff) {</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;      <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;    }</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="comment">// Check existence of a volume with material</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="keywordflow">if</span> (!navigator.currentVolumeMaterial(state.navigation)) {</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;      <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    }</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="keywordflow">return</span> 2;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  }</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> propagator_state_t, <span class="keyword">typename</span> stepper_t,</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;            <span class="keyword">typename</span> navigator_t&gt;</div>
<div class="line"><a name="l00120"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aef98c7e1e80b0df05b35f6f88f1805fb">  120</a></span>&#160;  <span class="keywordtype">bool</span> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aef98c7e1e80b0df05b35f6f88f1805fb" title="Evaluater of the k_i&#39;s of the RKN4. For the case of i = 0 this step sets up member parameters...">k</a>(<span class="keyword">const</span> propagator_state_t&amp; <a class="code" href="../../d1/da4/namespacefilter.html#a7ddbae181c53b04cce853b5138130875">state</a>, <span class="keyword">const</span> stepper_t&amp; <a class="code" href="../../dc/dd5/namespacepropagation__timing.html#a73ac659fd9b60e49ebcce460d4268319">stepper</a>,</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;         <span class="keyword">const</span> navigator_t&amp; <a class="code" href="../../dd/d7e/namespaceActs_1_1Test.html#a22e345b0a99e30930769db298f566827">navigator</a>, <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a02281f9d98adb7e28674240cfc843f45" title="Vector3 replacement for the custom scalar type.">ThisVector3</a>&amp; knew, <span class="keyword">const</span> <a class="code" href="../../de/d0a/group__coordinates-types.html#gaa57032f45b21d71af17514ff34cf1de1">Vector3</a>&amp; <a class="code" href="../../d4/d0e/namespaceActs_1_1IntegrationTest.html#a91c3b20cafd8e7401c88d8274bb1a6f8">bField</a>,</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;         std::array&lt;Scalar, 4&gt;&amp; kQoP, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> = 0, <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="../../d7/dde/ctrl_8cpp.html#a41c788a90c812f238c2ba72996bb9594">h</a> = 0.,</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;         <span class="keyword">const</span> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a02281f9d98adb7e28674240cfc843f45" title="Vector3 replacement for the custom scalar type.">ThisVector3</a>&amp; kprev = ThisVector3::Zero()) {</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <span class="comment">// using because of autodiff</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="keyword">using</span> std::hypot;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="keywordtype">double</span> q = stepper.charge(state.stepping);</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; <a class="code" href="../../df/d10/MultiStepperTests_8cpp.html#a9ed951743cd0a9c5f4f4e103f88454a3">particleHypothesis</a> = stepper.particleHypothesis(state.stepping);</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="keywordtype">float</span> <a class="code" href="../../d2/dcb/InteractionsTests_8cpp.html#aa19bfaf8cfd779867e9ce58c82e2e23d">mass</a> = <a class="code" href="../../df/d10/MultiStepperTests_8cpp.html#a9ed951743cd0a9c5f4f4e103f88454a3">particleHypothesis</a>.mass();</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="comment">// i = 0 is used for setup and evaluation of k</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> == 0) {</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;      <span class="comment">// Set up container for energy loss</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;      <span class="keyword">auto</span> volumeMaterial = navigator.currentVolumeMaterial(state.navigation);</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a02281f9d98adb7e28674240cfc843f45" title="Vector3 replacement for the custom scalar type.">ThisVector3</a> <a class="code" href="../../dc/d59/Proto4ShowerCalibFit_8m.html#a7130b1618285588513fd1ff97884b9d9">position</a> = stepper.position(state.stepping);</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a71e4589da01b82697232d7d5e91625c0">material</a> = volumeMaterial-&gt;material(position.template cast&lt;double&gt;());</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aeab04a930a906266b9109fda376cbf3e" title="Particles momentum at k1.">initialMomentum</a> = stepper.absoluteMomentum(state.stepping);</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aaa544d2ee1f5a648d72638eb9cf628fd" title="Momentum at a certain point.">currentMomentum</a> = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aeab04a930a906266b9109fda376cbf3e" title="Particles momentum at k1.">initialMomentum</a>;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] = stepper.qOverP(state.stepping);</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a1895d4f4b122cef592844ff4171c192b" title="Initializer of all parameters related to a RKN4 step with energy loss of a particle in material...">initializeEnergyLoss</a>(state, stepper);</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;      <span class="comment">// Evaluate k</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;      knew = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] * stepper.direction(state.stepping).cross(bField);</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;      <span class="comment">// Evaluate k for the time propagation</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aa5d4174b28c2ff77a3313298ef30d958" title="Lambda&#39;&#39;_i.">Lambdappi</a>[0] = -<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae85fca55eedfd4bee280dc0fc0d82692" title="Derivative dEds at the initial point.">g</a> * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>[0] / (q * q);</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;      <span class="comment">//~ tKi[0] = std::hypot(1, mass / initialMomentum);</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a967feda2a6729f95e81caed788d43537" title="k_i equivalent for the time propagation">tKi</a>[0] = hypot(1, mass * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0]);</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;      kQoP[0] = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aa5d4174b28c2ff77a3313298ef30d958" title="Lambda&#39;&#39;_i.">Lambdappi</a>[0];</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;      <span class="comment">// Update parameters and check for momentum condition</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a63e52b75d7b44af8dd71a9e42e3a69af" title="Update of the kinematic parameters of the RKN4 sub-steps after initialization with energy loss of a p...">updateEnergyLoss</a>(mass, <a class="code" href="../../d7/dde/ctrl_8cpp.html#a41c788a90c812f238c2ba72996bb9594">h</a>, state, stepper, <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>);</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aaa544d2ee1f5a648d72638eb9cf628fd" title="Momentum at a certain point.">currentMomentum</a> &lt; state.options.momentumCutOff) {</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;      }</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;      <span class="comment">// Evaluate k</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;      knew = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] *</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;             (stepper.direction(state.stepping) + <a class="code" href="../../d7/dde/ctrl_8cpp.html#a41c788a90c812f238c2ba72996bb9594">h</a> * kprev).<a class="code" href="../../df/da1/namespaceActs_1_1VectorHelpers.html#a0b01658483cf4ddd01b347c72e075a5b" title="Calculates column-wise cross products of a matrix and a vector and stores the result column-wise in a...">cross</a>(bField);</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;      <span class="comment">// Evaluate k_i for the time propagation</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;      <span class="keyword">auto</span> qopNew = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] + <a class="code" href="../../d7/dde/ctrl_8cpp.html#a41c788a90c812f238c2ba72996bb9594">h</a> * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aa5d4174b28c2ff77a3313298ef30d958" title="Lambda&#39;&#39;_i.">Lambdappi</a>[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a> - 1];</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;      Lambdappi[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = -qopNew * qopNew * qopNew * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae85fca55eedfd4bee280dc0fc0d82692" title="Derivative dEds at the initial point.">g</a> * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] / (q * q);</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a967feda2a6729f95e81caed788d43537" title="k_i equivalent for the time propagation">tKi</a>[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = hypot(1, mass * qopNew);</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;      kQoP[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = Lambdappi[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>];</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    }</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;  }</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> propagator_state_t, <span class="keyword">typename</span> stepper_t,</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;            <span class="keyword">typename</span> navigator_t&gt;</div>
<div class="line"><a name="l00182"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a813d1e6b1c3ce01984b346d5bc268e6b">  182</a></span>&#160;  <span class="keywordtype">bool</span> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a813d1e6b1c3ce01984b346d5bc268e6b" title="After a RKN4 step was accepted by the stepper this method has an additional veto on the quality of th...">finalize</a>(propagator_state_t&amp; state, <span class="keyword">const</span> stepper_t&amp; stepper,</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                <span class="keyword">const</span> navigator_t&amp; <span class="comment">/*navigator*/</span>, <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="../../d7/dde/ctrl_8cpp.html#a41c788a90c812f238c2ba72996bb9594">h</a>)<span class="keyword"> const </span>{</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="comment">// using because of autodiff</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    <span class="keyword">using</span> std::hypot;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; <a class="code" href="../../df/d10/MultiStepperTests_8cpp.html#a9ed951743cd0a9c5f4f4e103f88454a3">particleHypothesis</a> = stepper.particleHypothesis(state.stepping);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="keywordtype">float</span> <a class="code" href="../../d2/dcb/InteractionsTests_8cpp.html#aa19bfaf8cfd779867e9ce58c82e2e23d">mass</a> = <a class="code" href="../../df/d10/MultiStepperTests_8cpp.html#a9ed951743cd0a9c5f4f4e103f88454a3">particleHypothesis</a>.mass();</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="comment">// Evaluate the new momentum</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <span class="keyword">auto</span> newMomentum =</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        stepper.absoluteMomentum(state.stepping) +</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;        (h / 6.) * (<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a334408487e7aa14759a6075af6b29e5d" title="Derivatives dPds at each sub-step.">dPds</a>[0] + 2. * (<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a334408487e7aa14759a6075af6b29e5d" title="Derivatives dPds at each sub-step.">dPds</a>[1] + <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a334408487e7aa14759a6075af6b29e5d" title="Derivatives dPds at each sub-step.">dPds</a>[2]) + <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a334408487e7aa14759a6075af6b29e5d" title="Derivatives dPds at each sub-step.">dPds</a>[3]);</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <span class="comment">// Break propagation if momentum becomes below cut-off</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    <span class="keywordflow">if</span> (newMomentum &lt; state.options.momentumCutOff) {</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    }</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <span class="comment">// Add derivative dlambda/ds = Lambda&#39;&#39;</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    state.stepping.derivative(7) = -hypot(mass, newMomentum) * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae85fca55eedfd4bee280dc0fc0d82692" title="Derivative dEds at the initial point.">g</a> /</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;                                   (newMomentum * newMomentum * newMomentum);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="comment">// Update momentum</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    state.stepping.pars[<a class="code" href="../../da/d7b/namespaceActs.html#a6c086a09086424ffb3ace68710e8e92cab2fad9ef29e2cec612213d6174338fed">eFreeQOverP</a>] =</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        stepper.charge(state.stepping) / newMomentum;</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="comment">// Add derivative dt/ds = 1/(beta * c) = sqrt(m^2 * p^{-2} + c^{-2})</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    state.stepping.derivative(3) = hypot(1, mass / newMomentum);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="comment">// Update time</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    state.stepping.pars[<a class="code" href="../../da/d7b/namespaceActs.html#a6c086a09086424ffb3ace68710e8e92ca73bbfd1eb6084375bbd8cf207abcf2d2">eFreeTime</a>] +=</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        (h / 6.) * (<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a967feda2a6729f95e81caed788d43537" title="k_i equivalent for the time propagation">tKi</a>[0] + 2. * (<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a967feda2a6729f95e81caed788d43537" title="k_i equivalent for the time propagation">tKi</a>[1] + <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a967feda2a6729f95e81caed788d43537" title="k_i equivalent for the time propagation">tKi</a>[2]) + <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a967feda2a6729f95e81caed788d43537" title="k_i equivalent for the time propagation">tKi</a>[3]);</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  }</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> propagator_state_t, <span class="keyword">typename</span> stepper_t,</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;            <span class="keyword">typename</span> navigator_t&gt;</div>
<div class="line"><a name="l00236"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a1e8225a53f248d248c1c18501074d1cb">  236</a></span>&#160;  <span class="keywordtype">bool</span> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a813d1e6b1c3ce01984b346d5bc268e6b" title="After a RKN4 step was accepted by the stepper this method has an additional veto on the quality of th...">finalize</a>(propagator_state_t&amp; state, <span class="keyword">const</span> stepper_t&amp; stepper,</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                <span class="keyword">const</span> navigator_t&amp; navigator, <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="../../d7/dde/ctrl_8cpp.html#a41c788a90c812f238c2ba72996bb9594">h</a>,</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                <a class="code" href="../../da/d7b/namespaceActs.html#a811887c3d21b9b51dc21cea3783d5dd2">FreeMatrix</a>&amp; <a class="code" href="../../d7/db3/structD.html">D</a>)<span class="keyword"> const </span>{</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a813d1e6b1c3ce01984b346d5bc268e6b" title="After a RKN4 step was accepted by the stepper this method has an additional veto on the quality of th...">finalize</a>(state, stepper, navigator, h) &amp;&amp;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;           <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae0f8345174ba3d77d9cea1909d43bad7" title="Evaluates the transport matrix D for the jacobian.">transportMatrix</a>(state, stepper, navigator, h, D);</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  }</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; <span class="keyword">private</span>:</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> propagator_state_t, <span class="keyword">typename</span> stepper_t,</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;            <span class="keyword">typename</span> navigator_t&gt;</div>
<div class="line"><a name="l00257"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae0f8345174ba3d77d9cea1909d43bad7">  257</a></span>&#160;  <span class="keywordtype">bool</span> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae0f8345174ba3d77d9cea1909d43bad7" title="Evaluates the transport matrix D for the jacobian.">transportMatrix</a>(propagator_state_t&amp; state, <span class="keyword">const</span> stepper_t&amp; stepper,</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;                       <span class="keyword">const</span> navigator_t&amp; <span class="comment">/*navigator*/</span>, <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="../../d7/dde/ctrl_8cpp.html#a41c788a90c812f238c2ba72996bb9594">h</a>,</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;                       <a class="code" href="../../da/d7b/namespaceActs.html#a811887c3d21b9b51dc21cea3783d5dd2">FreeMatrix</a>&amp; <a class="code" href="../../d7/db3/structD.html">D</a>)<span class="keyword"> const </span>{</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    <span class="comment">// using because of autodiff</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="keyword">using</span> std::hypot;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="keyword">auto</span>&amp; sd = state.stepping.stepData;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="keyword">auto</span> dir = stepper.direction(state.stepping);</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; <a class="code" href="../../df/d10/MultiStepperTests_8cpp.html#a9ed951743cd0a9c5f4f4e103f88454a3">particleHypothesis</a> = stepper.particleHypothesis(state.stepping);</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <span class="keywordtype">float</span> <a class="code" href="../../d2/dcb/InteractionsTests_8cpp.html#aa19bfaf8cfd779867e9ce58c82e2e23d">mass</a> = <a class="code" href="../../df/d10/MultiStepperTests_8cpp.html#a9ed951743cd0a9c5f4f4e103f88454a3">particleHypothesis</a>.mass();</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    D = FreeMatrix::Identity();</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">double</span> half_h = h * 0.5;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    <span class="comment">// This sets the reference to the sub matrices</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="comment">// dFdx is already initialised as (3x3) zero</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <span class="keyword">auto</span> dFdT = D.block&lt;3, 3&gt;(0, 4);</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    <span class="keyword">auto</span> dFdL = D.block&lt;3, 1&gt;(0, 7);</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    <span class="comment">// dGdx is already initialised as (3x3) identity</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;    <span class="keyword">auto</span> dGdT = D.block&lt;3, 3&gt;(4, 4);</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="keyword">auto</span> dGdL = D.block&lt;3, 1&gt;(4, 7);</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <a class="code" href="../../d3/d2f/group__acts-algebra-types.html#gaf4797648cc059a04b6776b9206cd2bb0">ActsMatrix&lt;3, 3&gt;</a> dk1dT = <a class="code" href="../../d3/d2f/group__acts-algebra-types.html#gaf4797648cc059a04b6776b9206cd2bb0">ActsMatrix&lt;3, 3&gt;::Zero</a>();</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    <a class="code" href="../../d3/d2f/group__acts-algebra-types.html#gaf4797648cc059a04b6776b9206cd2bb0">ActsMatrix&lt;3, 3&gt;</a> dk2dT = <a class="code" href="../../d3/d2f/group__acts-algebra-types.html#gaf4797648cc059a04b6776b9206cd2bb0">ActsMatrix&lt;3, 3&gt;::Identity</a>();</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;    <a class="code" href="../../d3/d2f/group__acts-algebra-types.html#gaf4797648cc059a04b6776b9206cd2bb0">ActsMatrix&lt;3, 3&gt;</a> dk3dT = <a class="code" href="../../d3/d2f/group__acts-algebra-types.html#gaf4797648cc059a04b6776b9206cd2bb0">ActsMatrix&lt;3, 3&gt;::Identity</a>();</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <a class="code" href="../../d3/d2f/group__acts-algebra-types.html#gaf4797648cc059a04b6776b9206cd2bb0">ActsMatrix&lt;3, 3&gt;</a> dk4dT = <a class="code" href="../../d3/d2f/group__acts-algebra-types.html#gaf4797648cc059a04b6776b9206cd2bb0">ActsMatrix&lt;3, 3&gt;::Identity</a>();</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    <a class="code" href="../../de/d0a/group__coordinates-types.html#gaa57032f45b21d71af17514ff34cf1de1">Vector3</a> dk1dL = Vector3::Zero();</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;    <a class="code" href="../../de/d0a/group__coordinates-types.html#gaa57032f45b21d71af17514ff34cf1de1">Vector3</a> dk2dL = Vector3::Zero();</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    <a class="code" href="../../de/d0a/group__coordinates-types.html#gaa57032f45b21d71af17514ff34cf1de1">Vector3</a> dk3dL = Vector3::Zero();</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <a class="code" href="../../de/d0a/group__coordinates-types.html#gaa57032f45b21d71af17514ff34cf1de1">Vector3</a> dk4dL = Vector3::Zero();</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    std::array&lt;double, 4&gt; jdL{};</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    <span class="comment">// Evaluation of the rightmost column without the last term.</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    jdL[0] = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#af64bd521f9cc2f76750b165a72603eef" title="Derivatives dLambda&#39;&#39;dlambda at each sub-step point.">dLdl</a>[0];</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    dk1dL = dir.cross(sd.B_first);</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    jdL[1] = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#af64bd521f9cc2f76750b165a72603eef" title="Derivatives dLambda&#39;&#39;dlambda at each sub-step point.">dLdl</a>[1] * (1. + half_h * jdL[0]);</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    dk2dL = (1. + half_h * jdL[0]) * (dir + half_h * sd.k1).cross(sd.B_middle) +</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;            <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[1] * half_h * dk1dL.cross(sd.B_middle);</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;    jdL[2] = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#af64bd521f9cc2f76750b165a72603eef" title="Derivatives dLambda&#39;&#39;dlambda at each sub-step point.">dLdl</a>[2] * (1. + half_h * jdL[1]);</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;    dk3dL = (1. + half_h * jdL[1]) * (dir + half_h * sd.k2).cross(sd.B_middle) +</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;            <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[2] * half_h * dk2dL.cross(sd.B_middle);</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    jdL[3] = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#af64bd521f9cc2f76750b165a72603eef" title="Derivatives dLambda&#39;&#39;dlambda at each sub-step point.">dLdl</a>[3] * (1. + h * jdL[2]);</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    dk4dL = (1. + h * jdL[2]) * (dir + h * sd.k3).cross(sd.B_last) +</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;            <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[3] * h * dk3dL.cross(sd.B_last);</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    dk1dT(0, 1) = sd.B_first.z();</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    dk1dT(0, 2) = -sd.B_first.y();</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    dk1dT(1, 0) = -sd.B_first.z();</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    dk1dT(1, 2) = sd.B_first.x();</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    dk1dT(2, 0) = sd.B_first.y();</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    dk1dT(2, 1) = -sd.B_first.x();</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    dk1dT *= <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0];</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    dk2dT += half_h * dk1dT;</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    dk2dT = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[1] * <a class="code" href="../../df/da1/namespaceActs_1_1VectorHelpers.html#a0b01658483cf4ddd01b347c72e075a5b" title="Calculates column-wise cross products of a matrix and a vector and stores the result column-wise in a...">VectorHelpers::cross</a>(dk2dT, sd.B_middle);</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    dk3dT += half_h * dk2dT;</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    dk3dT = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[2] * <a class="code" href="../../df/da1/namespaceActs_1_1VectorHelpers.html#a0b01658483cf4ddd01b347c72e075a5b" title="Calculates column-wise cross products of a matrix and a vector and stores the result column-wise in a...">VectorHelpers::cross</a>(dk3dT, sd.B_middle);</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    dk4dT += h * dk3dT;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    dk4dT = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[3] * <a class="code" href="../../df/da1/namespaceActs_1_1VectorHelpers.html#a0b01658483cf4ddd01b347c72e075a5b" title="Calculates column-wise cross products of a matrix and a vector and stores the result column-wise in a...">VectorHelpers::cross</a>(dk4dT, sd.B_last);</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    dFdT.setIdentity();</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    dFdT += h / 6. * (dk1dT + dk2dT + dk3dT);</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;    dFdT *= <a class="code" href="../../d7/dde/ctrl_8cpp.html#a41c788a90c812f238c2ba72996bb9594">h</a>;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    dFdL = h * h / 6. * (dk1dL + dk2dL + dk3dL);</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    dGdT += h / 6. * (dk1dT + 2. * (dk2dT + dk3dT) + dk4dT);</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    dGdL = h / 6. * (dk1dL + 2. * (dk2dL + dk3dL) + dk4dL);</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    <span class="comment">// Evaluation of the dLambda&#39;&#39;/dlambda term</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    D(7, 7) += (h / 6.) * (jdL[0] + 2. * (jdL[1] + jdL[2]) + jdL[3]);</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <span class="comment">// The following comment lines refer to the application of the time being</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="comment">// treated as a position. Since t and qop are treated independently for now,</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;    <span class="comment">// this just serves as entry point for building their relation</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    <span class="comment">//~ double dtpp1dl = -mass * mass * qop[0] * qop[0] *</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <span class="comment">//~ (3. * g + qop[0] * dgdqop(energy[0], .mass,</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="comment">//~ absPdg, meanEnergyLoss));</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="keywordtype">double</span> dtp1dl = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] * mass * mass / hypot(1, <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] * mass);</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <span class="keywordtype">double</span> qopNew = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] + half_h * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aa5d4174b28c2ff77a3313298ef30d958" title="Lambda&#39;&#39;_i.">Lambdappi</a>[0];</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    <span class="comment">//~ double dtpp2dl = -mass * mass * qopNew *</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <span class="comment">//~ qopNew *</span></div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="comment">//~ (3. * g * (1. + half_h * jdL[0]) +</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <span class="comment">//~ qopNew * dgdqop(energy[1], mass, absPdgCode, meanEnergyLoss));</span></div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    <span class="keywordtype">double</span> dtp2dl = qopNew * mass * mass / std::hypot(1, qopNew * mass);</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    qopNew = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] + half_h * Lambdappi[1];</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;    <span class="comment">//~ double dtpp3dl = -mass * mass * qopNew *</span></div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    <span class="comment">//~ qopNew *</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    <span class="comment">//~ (3. * g * (1. + half_h * jdL[1]) +</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <span class="comment">//~ qopNew * dgdqop(energy[2], mass, absPdg, meanEnergyLoss));</span></div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    <span class="keywordtype">double</span> dtp3dl = qopNew * mass * mass / hypot(1, qopNew * mass);</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    qopNew = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] + half_h * Lambdappi[2];</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    <span class="keywordtype">double</span> dtp4dl = qopNew * mass * mass / hypot(1, qopNew * mass);</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    <span class="comment">//~ D(3, 7) = h * mass * mass * qop[0] /</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    <span class="comment">//~ hypot(1., mass * qop[0])</span></div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    <span class="comment">//~ + h * h / 6. * (dtpp1dl + dtpp2dl + dtpp3dl);</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    D(3, 7) = (h / 6.) * (dtp1dl + 2. * (dtp2dl + dtp3dl) + dtp4dl);</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;  }</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> propagator_state_t, <span class="keyword">typename</span> stepper_t&gt;</div>
<div class="line"><a name="l00401"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a1895d4f4b122cef592844ff4171c192b">  401</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a1895d4f4b122cef592844ff4171c192b" title="Initializer of all parameters related to a RKN4 step with energy loss of a particle in material...">initializeEnergyLoss</a>(<span class="keyword">const</span> propagator_state_t&amp; state,</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                            <span class="keyword">const</span> stepper_t&amp; stepper) {</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    <span class="comment">// using because of autodiff</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    <span class="keyword">using</span> std::hypot;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="keyword">const</span> <span class="keyword">auto</span>&amp; <a class="code" href="../../df/d10/MultiStepperTests_8cpp.html#a9ed951743cd0a9c5f4f4e103f88454a3">particleHypothesis</a> = stepper.particleHypothesis(state.stepping);</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <span class="keywordtype">float</span> <a class="code" href="../../d2/dcb/InteractionsTests_8cpp.html#aa19bfaf8cfd779867e9ce58c82e2e23d">mass</a> = <a class="code" href="../../df/d10/MultiStepperTests_8cpp.html#a9ed951743cd0a9c5f4f4e103f88454a3">particleHypothesis</a>.mass();</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <a class="code" href="../../da/d7b/namespaceActs.html#aa3f3085bffa01dd7ae2a17d52b13acdf" title="Symbolic values for commonly used PDG particle numbers.">PdgParticle</a> absPdg = <a class="code" href="../../df/d10/MultiStepperTests_8cpp.html#a9ed951743cd0a9c5f4f4e103f88454a3">particleHypothesis</a>.absolutePdg();</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;    <span class="keywordtype">float</span> absQ = <a class="code" href="../../df/d10/MultiStepperTests_8cpp.html#a9ed951743cd0a9c5f4f4e103f88454a3">particleHypothesis</a>.absoluteCharge();</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>[0] = hypot(<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aeab04a930a906266b9109fda376cbf3e" title="Particles momentum at k1.">initialMomentum</a>, mass);</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;    <span class="comment">// use unit length as thickness to compute the energy loss per unit length</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <a class="code" href="../../da/ddf/classActs_1_1MaterialSlab.html">Acts::MaterialSlab</a> slab(<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a71e4589da01b82697232d7d5e91625c0">material</a>, 1);</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    <span class="comment">// Use the same energy loss throughout the step.</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="keywordflow">if</span> (state.options.meanEnergyLoss) {</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae85fca55eedfd4bee280dc0fc0d82692" title="Derivative dEds at the initial point.">g</a> = -<a class="code" href="../../da/d7b/namespaceActs.html#a87160e91db5e1f254b03ea77a3e67775">computeEnergyLossMean</a>(slab, absPdg, mass, static_cast&lt;float&gt;(<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0]),</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;                                 absQ);</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;      <span class="comment">// TODO using the unit path length is not quite right since the most</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;      <span class="comment">//      probably energy loss is not independent from the path length.</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae85fca55eedfd4bee280dc0fc0d82692" title="Derivative dEds at the initial point.">g</a> = -<a class="code" href="../../da/d7b/namespaceActs.html#acece53e8206433adba38168d0458c746">computeEnergyLossMode</a>(slab, absPdg, mass, static_cast&lt;float&gt;(<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0]),</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;                                 absQ);</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    }</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    <span class="comment">// Change of the momentum per path length</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    <span class="comment">// dPds = dPdE * dEds</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a334408487e7aa14759a6075af6b29e5d" title="Derivatives dPds at each sub-step.">dPds</a>[0] = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae85fca55eedfd4bee280dc0fc0d82692" title="Derivative dEds at the initial point.">g</a> * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>[0] / <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aeab04a930a906266b9109fda376cbf3e" title="Particles momentum at k1.">initialMomentum</a>;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    <span class="keywordflow">if</span> (state.stepping.covTransport) {</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;      <span class="comment">// Calculate the change of the energy loss per path length and</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;      <span class="comment">// inverse momentum</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;      <span class="keywordflow">if</span> (state.options.includeGgradient) {</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        <span class="keywordflow">if</span> (state.options.meanEnergyLoss) {</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;          <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ab32df3f9ab15c5d1d4eac66635fa13a6" title="Derivative d(dEds)d(q/p) evaluated at the initial point.">dgdqopValue</a> = <a class="code" href="../../da/d7b/namespaceActs.html#a4b9c3ee258cd4e8b1cbdd3ef01f65bac">deriveEnergyLossMeanQOverP</a>(</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;              slab, absPdg, mass, static_cast&lt;float&gt;(<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0]), absQ);</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;          <span class="comment">// TODO path length dependence; see above</span></div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;          <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ab32df3f9ab15c5d1d4eac66635fa13a6" title="Derivative d(dEds)d(q/p) evaluated at the initial point.">dgdqopValue</a> = <a class="code" href="../../da/d7b/namespaceActs.html#a3e4407067c869e4f7253adc947e05f4e">deriveEnergyLossModeQOverP</a>(</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;              slab, absPdg, mass, static_cast&lt;float&gt;(<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0]), absQ);</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        }</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;      }</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;      <span class="comment">// Calculate term for later error propagation</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#af64bd521f9cc2f76750b165a72603eef" title="Derivatives dLambda&#39;&#39;dlambda at each sub-step point.">dLdl</a>[0] = (-<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae85fca55eedfd4bee280dc0fc0d82692" title="Derivative dEds at the initial point.">g</a> * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>[0] *</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;                     (3. - (<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aeab04a930a906266b9109fda376cbf3e" title="Particles momentum at k1.">initialMomentum</a> * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aeab04a930a906266b9109fda376cbf3e" title="Particles momentum at k1.">initialMomentum</a>) /</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;                               (<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>[0] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>[0])) -</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                 <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[0] * energy[0] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ab32df3f9ab15c5d1d4eac66635fa13a6" title="Derivative d(dEds)d(q/p) evaluated at the initial point.">dgdqopValue</a>);</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    }</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  }</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> propagator_state_t, <span class="keyword">typename</span> stepper_t&gt;</div>
<div class="line"><a name="l00458"></a><span class="lineno"><a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a63e52b75d7b44af8dd71a9e42e3a69af">  458</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a63e52b75d7b44af8dd71a9e42e3a69af" title="Update of the kinematic parameters of the RKN4 sub-steps after initialization with energy loss of a p...">updateEnergyLoss</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="../../d2/dcb/InteractionsTests_8cpp.html#aa19bfaf8cfd779867e9ce58c82e2e23d">mass</a>, <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="../../d7/dde/ctrl_8cpp.html#a41c788a90c812f238c2ba72996bb9594">h</a>,</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                        <span class="keyword">const</span> propagator_state_t&amp; state,</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                        <span class="keyword">const</span> stepper_t&amp; stepper, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>) {</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    <span class="comment">// using because of autodiff</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    <span class="keyword">using</span> std::hypot;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;    <span class="comment">// Update parameters related to a changed momentum</span></div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aaa544d2ee1f5a648d72638eb9cf628fd" title="Momentum at a certain point.">currentMomentum</a> = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aeab04a930a906266b9109fda376cbf3e" title="Particles momentum at k1.">initialMomentum</a> + h * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a334408487e7aa14759a6075af6b29e5d" title="Derivatives dPds at each sub-step.">dPds</a>[i - 1];</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = hypot(<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aaa544d2ee1f5a648d72638eb9cf628fd" title="Momentum at a certain point.">currentMomentum</a>, mass);</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;    dPds[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae85fca55eedfd4bee280dc0fc0d82692" title="Derivative dEds at the initial point.">g</a> * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] / <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aaa544d2ee1f5a648d72638eb9cf628fd" title="Momentum at a certain point.">currentMomentum</a>;</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = stepper.charge(state.stepping) / <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aaa544d2ee1f5a648d72638eb9cf628fd" title="Momentum at a certain point.">currentMomentum</a>;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    <span class="comment">// Calculate term for later error propagation</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    <span class="keywordflow">if</span> (state.stepping.covTransport) {</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;      <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#af64bd521f9cc2f76750b165a72603eef" title="Derivatives dLambda&#39;&#39;dlambda at each sub-step point.">dLdl</a>[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] = (-<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ae85fca55eedfd4bee280dc0fc0d82692" title="Derivative dEds at the initial point.">g</a> * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>[<a class="code" href="../../d7/d87/fasthadv4_8C.html#a6f6ccfcf58b31cb6412107d9d5281426">i</a>] *</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                     (3. - (<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aaa544d2ee1f5a648d72638eb9cf628fd" title="Momentum at a certain point.">currentMomentum</a> * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#aaa544d2ee1f5a648d72638eb9cf628fd" title="Momentum at a certain point.">currentMomentum</a>) /</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;                               (<a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>[i] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>[i])) -</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;                 <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[i] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[i] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a4a46c0236a099fef746edc61082af970" title="q/p at each sub-step">qop</a>[i] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#a411483e55ae466c3331f57150d1c6569" title="Energy at each sub-step.">energy</a>[i] * <a class="code" href="../../da/daf/structActs_1_1detail_1_1GenericDenseEnvironmentExtension.html#ab32df3f9ab15c5d1d4eac66635fa13a6" title="Derivative d(dEds)d(q/p) evaluated at the initial point.">dgdqopValue</a>);</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    }</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;  }</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;};</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;}  <span class="comment">// namespace detail</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;}  <span class="comment">// namespace Acts</span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->

<!-- start footer part -->
<div id="nav-path" class="navpath">
	<!-- id is needed for treeview function! -->
	<ul>
		<li class="navelem"><a class="el" href="../../dir_8a083ba67d76eaacec681de2105f81ce.html">acts</a></li><li class="navelem"><a class="el" href="../../dir_dd639112a1a9a96ce5326d38dc5b798f.html">blob</a></li><li class="navelem"><a class="el" href="../../dir_ed4d3476f51c55226233cecea75738c3.html">sPHENIX</a></li><li class="navelem"><a class="el" href="../../dir_51e7d6847640e5d2f01a85c1304ba077.html">Core</a></li><li class="navelem"><a class="el" href="../../dir_ee461149df729c95963c24485489b3ba.html">include</a></li><li class="navelem"><a class="el" href="../../dir_e6781aa1281b1f2739bb25effdda533d.html">Acts</a></li><li class="navelem"><a class="el" href="../../dir_39a06a5be12d5a68f7fbbbf9a4142917.html">Propagator</a></li><li class="navelem"><a class="el" href="../../dir_ae61ddf9c2921ba19ea44817bbd64766.html">detail</a></li><li class="navelem"><a class="el" href="../../d9/db6/GenericDenseEnvironmentExtension_8hpp.html">GenericDenseEnvironmentExtension.hpp</a></li>
		<li class="footer">
		Built by <a href="mailto:jhuang@bnl.gov">Jin Huang</a></em>.
			updated: <em>Sat Feb 17 2024 22:17:33</em> using <a
			href="http://www.doxygen.org/index.html"> <img class="footer"
				src="../../doxygen.png" alt="doxygen" /></a> 1.8.2 
				with <a href="https://github.com/sPHENIX-Collaboration">sPHENIX GitHub integration</a>
		</li>
	</ul>
</div>
</body>
</html>
